<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hunt • Admin Dashboard</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        /* ============================================
           VERCEL-STYLE DARK THEME - STAR QUALITY
           ============================================ */
        :root {
            /* Color Palette */
            --black: #000000;
            --gray-900: #111111;
            --gray-800: #1a1a1a;
            --gray-700: #2a2a2a;
            --gray-600: #444444;
            --gray-500: #666666;
            --gray-400: #888888;
            --gray-300: #aaaaaa;
            --gray-200: #cccccc;
            --gray-100: #e5e5e5;
            --white: #ffffff;
            
            /* Accent Colors */
            --blue: #0070f3;
            --blue-light: #3291ff;
            --red: #ff0000;
            --red-light: #ff3333;
            --green: #00cc66;
            --green-light: #33ff99;
            --yellow: #ffcc00;
            --yellow-light: #ffdd44;
            
            /* UI Colors */
            --bg-primary: var(--black);
            --bg-secondary: var(--gray-900);
            --bg-tertiary: var(--gray-800);
            --bg-card: var(--gray-800);
            --border-color: var(--gray-700);
            --text-primary: var(--white);
            --text-secondary: var(--gray-300);
            --text-muted: var(--gray-500);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.5);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        /* ============================================
           RESET & BASE STYLES
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
        }

        /* ============================================
           TYPOGRAPHY
           ============================================ */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.25;
            margin-bottom: 0.5em;
        }

        h1 { font-size: 24px; }
        h2 { font-size: 20px; }
        h3 { font-size: 16px; }
        h4 { font-size: 14px; }

        .text-sm { font-size: 12px; }
        .text-xs { font-size: 11px; }

        /* ============================================
           ADMIN LOGIN SCREEN
           ============================================ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10000;
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            color: var(--white);
            margin-bottom: 8px;
            font-size: 28px;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .login-form input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all var(--transition-fast);
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .login-btn:hover {
            background: var(--blue-light);
            transform: translateY(-1px);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .login-error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid var(--red);
            color: var(--red-light);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            display: none;
        }

        /* ============================================
           ADMIN DASHBOARD LAYOUT
           ============================================ */
        .admin-dashboard {
            display: none;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: var(--bg-primary);
        }

        /* Top Header */
        .admin-header {
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
            color: var(--white);
        }

        .logo i {
            color: var(--blue);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .notification-bell {
            position: relative;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all var(--transition-fast);
        }

        .notification-bell:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--red);
            color: white;
            font-size: 10px;
            font-weight: 600;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all var(--transition-fast);
        }

        .admin-profile:hover {
            background: var(--bg-tertiary);
        }

        .admin-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--blue);
            object-fit: cover;
        }

        .admin-info h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .admin-info p {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Sidebar */
        .admin-sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 60px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 20px 0;
            z-index: 90;
        }

        .sidebar-section {
            margin-bottom: 24px;
            padding: 0 16px;
        }

        .sidebar-section h3 {
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: 6px;
            margin-bottom: 4px;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: rgba(0, 112, 243, 0.1);
            color: var(--blue);
            border-left-color: var(--blue);
        }

        .sidebar-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .sidebar-item span {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }

        .sidebar-badge {
            background: var(--red);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
            display: none;
        }

        /* Main Content */
        .admin-content {
            margin-left: 240px;
            margin-top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-primary);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           DASHBOARD OVERVIEW
           ============================================ */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            transition: all var(--transition-fast);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--blue);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-icon.users { background: rgba(0, 112, 243, 0.1); color: var(--blue); }
        .stat-icon.missions { background: rgba(255, 204, 0, 0.1); color: var(--yellow); }
        .stat-icon.zones { background: rgba(0, 204, 102, 0.1); color: var(--green); }
        .stat-icon.sos { background: rgba(255, 0, 0, 0.1); color: var(--red); }

        .stat-trend {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(0, 204, 102, 0.1);
            color: var(--green);
        }

        .stat-trend.negative {
            background: rgba(255, 0, 0, 0.1);
            color: var(--red);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--white);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }

        .action-btn {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--blue);
        }

        .action-btn.primary {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        .action-btn.danger {
            background: var(--red);
            border-color: var(--red);
            color: white;
        }

        .action-btn.success {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ============================================
           LIVE MAP SECTION
           ============================================ */
        .map-container {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
            position: relative;
        }

        #admin-map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }

        .map-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .map-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--blue);
        }

        .map-btn.active {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        .map-legend {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-color.player { background: var(--blue); }
        .legend-color.admin { background: var(--green); }
        .legend-color.sos { background: var(--red); }

        /* ============================================
           ZONE MANAGEMENT
           ============================================ */
        .zone-creator {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .zone-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .zone-form .form-group {
            margin-bottom: 0;
        }

        .zone-form label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .zone-form input,
        .zone-form textarea,
        .zone-form select {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .zone-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .zone-actions {
            display: flex;
            gap: 12px;
        }

        /* ============================================
           DATA TABLES
           ============================================ */
        .data-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .table-search {
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            width: 200px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--bg-secondary);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .status-active { background: rgba(0, 204, 102, 0.1); color: var(--green); }
        .status-pending { background: rgba(255, 204, 0, 0.1); color: var(--yellow); }
        .status-completed { background: rgba(0, 112, 243, 0.1); color: var(--blue); }
        .status-rejected { background: rgba(255, 0, 0, 0.1); color: var(--red); }

        .user-avatar-small {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            vertical-align: middle;
            margin-right: 8px;
        }

        /* ============================================
           MISSION REVIEW
           ============================================ */
        .review-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
        }

        .mission-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            max-height: 600px;
            overflow-y: auto;
        }

        .mission-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mission-item:hover {
            background: var(--bg-tertiary);
        }

        .mission-item.active {
            background: rgba(0, 112, 243, 0.1);
            border-left: 3px solid var(--blue);
        }

        .mission-item:last-child {
            border-bottom: none;
        }

        .mission-user {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .mission-user img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .mission-user-info h4 {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .mission-user-info p {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .mission-preview {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .media-item {
            aspect-ratio: 1;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-item.audio {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
        }

        .media-item.audio i {
            font-size: 24px;
            color: var(--text-secondary);
        }

        /* ============================================
           MODALS
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* SOS Alert Popup */
        .sos-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            background: var(--red);
            color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3);
            z-index: 1001;
            animation: alertPulse 2s infinite;
            display: none;
        }

        @keyframes alertPulse {
            0% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 4px 30px rgba(255, 0, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3); }
        }

        .sos-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .sos-header i {
            font-size: 24px;
        }

        .sos-header h4 {
            flex: 1;
            margin: 0;
        }

        .sos-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.8;
        }

        .sos-close:hover {
            opacity: 1;
        }

        .sos-actions {
            display: flex;
            gap: 8px;
        }

        /* ============================================
           TOAST NOTIFICATIONS
           ============================================ */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--green);
        }

        .toast.error {
            border-left: 4px solid var(--red);
        }

        .toast.info {
            border-left: 4px solid var(--blue);
        }

        .toast-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .toast-icon {
            font-size: 16px;
            margin-top: 2px;
        }

        .toast.success .toast-icon { color: var(--green); }
        .toast.error .toast-icon { color: var(--red); }
        .toast.info .toast-icon { color: var(--blue); }

        .toast-message {
            flex: 1;
            font-size: 13px;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        /* ============================================
           LOADING STATES
           ============================================ */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============================================
           PAGINATION
           ============================================ */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .page-btn {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .page-btn:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--blue);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 200px;
            }
            
            .admin-content {
                margin-left: 200px;
            }
            
            .review-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
                z-index: 99;
            }
            
            .admin-sidebar.active {
                transform: translateX(0);
            }
            
            .admin-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: block !important;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-container {
                max-width: 95vw;
            }
            
            .sos-alert {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                bottom: 20px;
            }
        }

        @media (max-width: 480px) {
            .admin-header {
                padding: 0 16px;
            }
            
            .admin-content {
                padding: 16px;
            }
            
            .zone-form {
                grid-template-columns: 1fr;
            }
            
            .table-search {
                width: 150px;
            }
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .p-4 { padding: 16px; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-card">
            <div class="login-header">
                <h1><i class="fas fa-shield-alt"></i> THE HUNT</h1>
                <p>Admin Dashboard</p>
            </div>
            
            <div id="login-error" class="login-error"></div>
            
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label>Admin Email</label>
                    <input type="email" id="admin-email" placeholder="admin@thehunt.com" required>
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="admin-password" placeholder="••••••••" required>
                </div>
                
                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="admin-dashboard">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <button class="sidebar-toggle hidden" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>THE HUNT • ADMIN</span>
                </div>
            </div>
            
            <div class="header-right">
                <button class="notification-bell" id="notifications-btn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notification-count">0</span>
                </button>
                
                <div class="admin-profile" id="admin-profile">
                    <img id="admin-avatar-img" src="https://api.dicebear.com/7.x/avataaars/svg?seed=admin" alt="Admin" class="admin-avatar">
                    <div class="admin-info">
                        <h4 id="admin-name">Loading...</h4>
                        <p id="admin-role">Super Admin</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <nav class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-section">
                <h3>Dashboard</h3>
                <div class="sidebar-item active" data-section="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </div>
                <div class="sidebar-item" data-section="live-map">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Live Map</span>
                </div>
                <div class="sidebar-item" data-section="sos-alerts">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>SOS Alerts</span>
                    <span class="sidebar-badge" id="sos-sidebar-badge">0</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Management</h3>
                <div class="sidebar-item" data-section="zones-missions">
                    <i class="fas fa-draw-polygon"></i>
                    <span>Zones & Missions</span>
                </div>
                <div class="sidebar-item" data-section="mission-review">
                    <i class="fas fa-inbox"></i>
                    <span>Mission Review</span>
                    <span class="sidebar-badge" id="review-sidebar-badge">0</span>
                </div>
                <div class="sidebar-item" data-section="prizes">
                    <i class="fas fa-gift"></i>
                    <span>Prizes</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Users</h3>
                <div class="sidebar-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>All Users</span>
                </div>
                <div class="sidebar-item" data-section="admins">
                    <i class="fas fa-user-shield"></i>
                    <span>Admins</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Analytics</h3>
                <div class="sidebar-item" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reports</span>
                </div>
                <div class="sidebar-item" data-section="export">
                    <i class="fas fa-file-export"></i>
                    <span>Export Data</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>System</h3>
                <div class="sidebar-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="sidebar-item" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="admin-content" id="admin-content">
            <!-- Dashboard Overview -->
            <section id="overview-section" class="content-section active">
                <div class="dashboard-header">
                    <h1>Dashboard Overview</h1>
                    <div class="table-actions">
                        <button class="action-btn" id="refresh-overview">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card" onclick="showSection('users')">
                        <div class="stat-header">
                            <div class="stat-icon users">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-trend" id="users-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Total Players</div>
                    </div>
                    
                    <div class="stat-card" onclick="showSection('mission-review')">
                        <div class="stat-header">
                            <div class="stat-icon missions">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="stat-trend" id="missions-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="pending-reviews">0</div>
                        <div class="stat-label">Pending Reviews</div>
                    </div>
                    
                    <div class="stat-card" onclick="showSection('zones-missions')">
                        <div class="stat-header">
                            <div class="stat-icon zones">
                                <i class="fas fa-draw-polygon"></i>
                            </div>
                            <div class="stat-trend" id="zones-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="active-zones">0</div>
                        <div class="stat-label">Active Zones</div>
                    </div>
                    
                    <div class="stat-card" onclick="showSection('sos-alerts')">
                        <div class="stat-header">
                            <div class="stat-icon sos">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-trend negative" id="sos-trend">0</div>
                        </div>
                        <div class="stat-value" id="active-sos">0</div>
                        <div class="stat-label">Active SOS Alerts</div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn primary" onclick="showCreateZoneModal()">
                        <i class="fas fa-plus"></i> Create Zone
                    </button>
                    <button class="action-btn" onclick="showSection('mission-review')">
                        <i class="fas fa-eye"></i> Review Missions
                    </button>
                    <button class="action-btn" onclick="showSection('live-map')">
                        <i class="fas fa-map"></i> View Live Map
                    </button>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>Recent Activity</h3>
                        <input type="text" class="table-search" placeholder="Search activity...">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity">
                            <tr>
                                <td colspan="4" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Live Map -->
            <section id="live-map-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Live Player Map</h1>
                    <div class="table-actions">
                        <button class="action-btn" id="refresh-map">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="action-btn" id="filter-players">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
                
                <div class="map-container">
                    <div id="admin-map">
                        <div class="loading-spinner"></div>
                    </div>
                    
                    <div class="map-controls">
                        <button class="map-btn" id="map-zoom-in" title="Zoom In">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="map-btn" id="map-zoom-out" title="Zoom Out">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="map-btn" id="map-center" title="Center Map">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="map-btn active" id="map-show-players" title="Show Players">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="map-btn active" id="map-show-zones" title="Show Zones">
                            <i class="fas fa-draw-polygon"></i>
                        </button>
                        <button class="map-btn" id="map-show-sos" title="Show SOS">
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>
                    </div>
                    
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-color player"></div>
                            <span>Players</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color admin"></div>
                            <span>Admins</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color sos"></div>
                            <span>SOS Alerts</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Zones & Missions -->
            <section id="zones-missions-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Zones & Missions Management</h1>
                    <div class="table-actions">
                        <button class="action-btn primary" onclick="showCreateZoneModal()">
                            <i class="fas fa-plus"></i> Create Zone
                        </button>
                        <button class="action-btn" onclick="showCreateMissionModal()">
                            <i class="fas fa-tasks"></i> Add Mission
                        </button>
                    </div>
                </div>
                
                <div class="zone-creator" id="zone-creator" style="display: none;">
                    <h3>Create New Zone</h3>
                    <div class="zone-form">
                        <div class="form-group">
                            <label>Zone Name *</label>
                            <input type="text" id="zone-name" placeholder="Enter zone name">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="zone-description" placeholder="Zone description (optional)"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Radius (meters)</label>
                            <input type="range" id="zone-radius" min="50" max="500" value="100">
                            <span id="radius-value" class="text-sm">100m</span>
                        </div>
                        <div class="form-group">
                            <label>Drawing Mode</label>
                            <select id="drawing-mode">
                                <option value="circle">Circle</option>
                                <option value="rectangle">Rectangle</option>
                                <option value="polygon">Polygon</option>
                            </select>
                        </div>
                    </div>
                    <div class="zone-actions">
                        <button class="action-btn primary" id="save-zone-btn">
                            <i class="fas fa-save"></i> Save Zone
                        </button>
                        <button class="action-btn" id="cancel-zone-btn">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>Existing Zones</h3>
                        <input type="text" class="table-search" placeholder="Search zones..." id="search-zones">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Zone Name</th>
                                <th>Description</th>
                                <th>Missions</th>
                                <th>Radius</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="zones-list">
                            <tr>
                                <td colspan="6" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Mission Review -->
            <section id="mission-review-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Mission Review</h1>
                    <div class="table-actions">
                        <button class="action-btn" id="filter-pending">
                            <i class="fas fa-clock"></i> Pending Only
                        </button>
                        <button class="action-btn" id="filter-approved">
                            <i class="fas fa-check"></i> Approved
                        </button>
                        <button class="action-btn" id="filter-rejected">
                            <i class="fas fa-times"></i> Rejected
                        </button>
                    </div>
                </div>
                
                <div class="review-container">
                    <div class="mission-list">
                        <div class="p-4">
                            <input type="text" class="table-search w-full" placeholder="Search submissions..." id="search-submissions">
                        </div>
                        <div id="submission-list">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                    
                    <div class="mission-preview">
                        <div id="mission-review-content">
                            <div class="text-center p-8">
                                <i class="fas fa-inbox fa-3x mb-4" style="color: var(--gray-600);"></i>
                                <h3>No Submission Selected</h3>
                                <p class="text-secondary">Select a submission from the list to review</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SOS Alerts -->
            <section id="sos-alerts-section" class="content-section">
                <div class="dashboard-header">
                    <h1>SOS Emergency Alerts</h1>
                    <div class="table-actions">
                        <button class="action-btn success" id="acknowledge-all-sos">
                            <i class="fas fa-check-double"></i> Acknowledge All
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Active SOS Alerts</h3>
                        <input type="text" class="table-search" placeholder="Search alerts...">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Location</th>
                                <th>Phone</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sos-alerts-list">
                            <tr>
                                <td colspan="6" class="text-center p-4">
                                    No active SOS alerts
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Management -->
            <section id="users-section" class="content-section">
                <div class="dashboard-header">
                    <h1>User Management</h1>
                    <div class="table-actions">
                        <input type="text" class="table-search" placeholder="Search users..." id="search-users">
                        <button class="action-btn" id="export-users">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Coins</th>
                                <th>Missions</th>
                                <th>Last Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-management-list">
                            <tr>
                                <td colspan="7" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination">
                        <button class="page-btn" id="prev-users">Previous</button>
                        <span id="users-page-info">Page 1 of 1</span>
                        <button class="page-btn" id="next-users">Next</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Create Mission Modal -->
    <div id="mission-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Create New Mission</h3>
                <button class="modal-close" id="close-mission-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="zone-form">
                    <div class="form-group">
                        <label>Mission Title *</label>
                        <input type="text" id="mission-title" placeholder="Enter mission title">
                    </div>
                    <div class="form-group">
                        <label>Mission Type *</label>
                        <select id="mission-type">
                            <option value="photo">Photo</option>
                            <option value="video">Video</option>
                            <option value="audio">Audio</option>
                            <option value="text">Text Answer</option>
                            <option value="qr_scan">QR Scan</option>
                            <option value="gps_checkin">GPS Check-in</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Zone *</label>
                        <select id="mission-zone"></select>
                    </div>
                    <div class="form-group">
                        <label>Points *</label>
                        <input type="number" id="mission-points" min="10" max="1000" value="100">
                    </div>
                    <div class="form-group">
                        <label>Question/Instruction *</label>
                        <textarea id="mission-question" placeholder="What should the player do?" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Media Required</label>
                        <input type="number" id="mission-media-count" min="0" max="10" value="1">
                    </div>
                    <div class="form-group">
                        <label>Max Video Duration (seconds)</label>
                        <input type="number" id="mission-video-duration" min="1" max="60" value="10">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancel-mission">Cancel</button>
                <button class="action-btn primary" id="save-mission">Create Mission</button>
            </div>
        </div>
    </div>

    <!-- SOS Alert Popup -->
    <div id="sos-alert" class="sos-alert">
        <div class="sos-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>🚨 EMERGENCY SOS ALERT!</h4>
            <button class="sos-close" id="close-sos-alert">&times;</button>
        </div>
        <div class="mb-4">
            <p>User <strong id="sos-user-name">John Doe</strong> has triggered an SOS alert!</p>
            <p class="text-sm mt-2">
                <i class="fas fa-map-marker-alt"></i> 
                Location: <span id="sos-location">Unknown</span>
            </p>
            <p class="text-sm">
                <i class="fas fa-phone"></i> 
                Phone: <span id="sos-phone">Not available</span>
            </p>
        </div>
        <div class="sos-actions">
            <button class="action-btn" id="call-sos-user" style="background: white; color: var(--red);">
                <i class="fas fa-phone"></i> Call User
            </button>
            <button class="action-btn primary" id="acknowledge-sos">
                <i class="fas fa-check"></i> Acknowledge
            </button>
            <button class="action-btn" id="view-sos-location">
                <i class="fas fa-map"></i> View on Map
            </button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            SUPABASE_URL: 'https://wnmncsbbtlpcwviicsbr.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubW5jc2JidGxwY3d2aWljc2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDU3MTMsImV4cCI6MjA4MTY4MTcxM30.pSOYbXWPLhKItpfDnRMfi3lyPVOvTccQudvN9YIucVs',
            MAPBOX_TOKEN: 'pk.eyJ1IjoianVzYSIsImEiOiJjbWpjanh5amEwbDEwM2dzOXVhbjZ5dzcwIn0.stWdbPHCrf9sKrRJRmShlg',
            DEFAULT_LOCATION: { lat: -22.68, lng: 17.08 },
            REFRESH_INTERVAL: 30000, // 30 seconds
            ITEMS_PER_PAGE: 20
        };

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Admin Dashboard Initializing...');
            
            // Initialize Supabase
            window.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
            
            // State management
            window.appState = {
                currentUser: null,
                currentSection: 'overview',
                map: null,
                mapMarkers: [],
                realtimeChannels: [],
                notifications: [],
                pendingReviewCount: 0,
                pendingSOSCount: 0,
                users: [],
                zones: [],
                missions: [],
                submissions: []
            };

            // Initialize the app
            initApp();
        });

        // ============================================
        // APP INITIALIZATION
        // ============================================
        async function initApp() {
            console.log('Initializing app...');
            
            // Load saved state
            loadAppState();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check authentication
            await checkAuth();
            
            // Initialize real-time subscriptions
            setupRealtimeSubscriptions();
            
            // Start auto-refresh
            setInterval(refreshDashboard, CONFIG.REFRESH_INTERVAL);
            
            console.log('App initialized successfully');
        }

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        function saveAppState() {
            try {
                const state = {
                    section: appState.currentSection,
                    timestamp: Date.now()
                };
                localStorage.setItem('hunt_admin_state', JSON.stringify(state));
            } catch (error) {
                console.error('Error saving state:', error);
            }
        }

        function loadAppState() {
            try {
                const saved = localStorage.getItem('hunt_admin_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    appState.currentSection = state.section || 'overview';
                }
            } catch (error) {
                console.error('Error loading state:', error);
            }
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        async function checkAuth() {
            console.log('Checking authentication...');
            
            const { data: { session }, error } = await supabase.auth.getSession();
            
            if (error) {
                console.error('Auth error:', error);
                showLogin();
                return;
            }
            
            if (!session) {
                console.log('No session found');
                showLogin();
                return;
            }
            
            // Verify admin role
            const { data: role } = await supabase
                .from('user_roles')
                .select('role')
                .eq('user_id', session.user.id)
                .single();
            
            if (!role || role.role !== 'admin') {
                showToast('You do not have admin privileges', 'error');
                await supabase.auth.signOut();
                showLogin();
                return;
            }
            
            // Success - load admin dashboard
            appState.currentUser = session.user;
            showAdminDashboard();
            loadDashboardData();
        }

        async function login() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const btn = document.getElementById('login-btn');
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    if (error.message.includes('Invalid login credentials')) {
                        // Try to create admin account if doesn't exist
                        const { data: signupData, error: signupError } = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: {
                                    name: 'Admin User',
                                    phone: '+264 81 234 5678'
                                }
                            }
                        });
                        
                        if (signupError) throw signupError;
                        
                        // Create user profile
                        await supabase
                            .from('users')
                            .upsert([{
                                id: signupData.user.id,
                                name: 'Admin User',
                                email: email,
                                phone: '+264 81 234 5678',
                                coins: 0,
                                created_at: new Date().toISOString()
                            }]);
                        
                        // Set admin role
                        await supabase
                            .from('user_roles')
                            .upsert([{
                                user_id: signupData.user.id,
                                role: 'admin',
                                granted_at: new Date().toISOString()
                            }]);
                        
                        appState.currentUser = signupData.user;
                    } else {
                        throw error;
                    }
                } else {
                    appState.currentUser = data.user;
                }
                
                showAdminDashboard();
                loadDashboardData();
                
            } catch (error) {
                console.error('Login error:', error);
                showError(error.message || 'Login failed');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
            }
        }

        async function logout() {
            try {
                // Close realtime channels
                appState.realtimeChannels.forEach(channel => {
                    supabase.removeChannel(channel);
                });
                
                await supabase.auth.signOut();
                showLogin();
                showToast('Logged out successfully', 'success');
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showLogin() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('admin-dashboard').style.display = 'none';
        }

        function showAdminDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            
            // Update admin info
            if (appState.currentUser) {
                document.getElementById('admin-name').textContent = 
                    appState.currentUser.user_metadata?.name || 'Admin User';
                document.getElementById('admin-email').textContent = 
                    appState.currentUser.email;
                
                // Load avatar
                const avatarImg = document.getElementById('admin-avatar-img');
                avatarImg.src = `https://api.dicebear.com/7.x/avataaars/svg?seed=${appState.currentUser.id}`;
            }
            
            // Show saved section
            showSection(appState.currentSection, false);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        function setupEventListeners() {
            // Login form
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
            
            // Sidebar navigation
            document.querySelectorAll('.sidebar-item[data-section]').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
            
            // Logout button
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // Modal close buttons
            document.getElementById('close-mission-modal')?.addEventListener('click', () => {
                closeModal('mission-modal');
            });
            
            document.getElementById('cancel-mission')?.addEventListener('click', () => {
                closeModal('mission-modal');
            });
            
            document.getElementById('close-sos-alert')?.addEventListener('click', () => {
                document.getElementById('sos-alert').style.display = 'none';
            });
            
            // Close modals on outside click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay').forEach(modal => {
                        modal.style.display = 'none';
                    });
                    document.getElementById('sos-alert').style.display = 'none';
                }
            });
            
            // Mission creation
            document.getElementById('save-mission')?.addEventListener('click', createMission);
            
            // SOS actions
            document.getElementById('call-sos-user')?.addEventListener('click', callSOSUser);
            document.getElementById('acknowledge-sos')?.addEventListener('click', acknowledgeSOS);
            document.getElementById('view-sos-location')?.addEventListener('click', viewSOSLocation);
            
            // Zone creation
            document.getElementById('zone-radius')?.addEventListener('input', function() {
                document.getElementById('radius-value').textContent = this.value + 'm';
            });
            
            document.getElementById('save-zone-btn')?.addEventListener('click', createZone);
            document.getElementById('cancel-zone-btn')?.addEventListener('click', () => {
                document.getElementById('zone-creator').style.display = 'none';
            });
            
            // Refresh buttons
            document.getElementById('refresh-overview')?.addEventListener('click', loadDashboardData);
            document.getElementById('refresh-map')?.addEventListener('click', loadLiveMap);
            
            // Search functionality
            document.getElementById('search-users')?.addEventListener('input', searchUsers);
            document.getElementById('search-zones')?.addEventListener('input', searchZones);
            
            // Pagination
            document.getElementById('prev-users')?.addEventListener('click', () => changeUserPage(-1));
            document.getElementById('next-users')?.addEventListener('click', () => changeUserPage(1));
            
            console.log('Event listeners setup complete');
        }

        // ============================================
        // SECTION NAVIGATION
        // ============================================
        function showSection(sectionId, saveState = true) {
            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.sidebar-item[data-section="${sectionId}"]`).classList.add('active');
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            const sectionElement = document.getElementById(`${sectionId}-section`);
            if (sectionElement) {
                sectionElement.classList.add('active');
                appState.currentSection = sectionId;
                
                if (saveState) {
                    saveAppState();
                }
                
                // Load section data
                loadSectionData(sectionId);
            }
        }

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'overview':
                    loadDashboardData();
                    break;
                case 'live-map':
                    initMap();
                    loadLiveMap();
                    break;
                case 'zones-missions':
                    loadZones();
                    break;
                case 'mission-review':
                    loadSubmissions();
                    break;
                case 'sos-alerts':
                    loadSOSAlerts();
                    break;
                case 'users':
                    loadUsers();
                    break;
            }
        }

        // ============================================
        // DASHBOARD DATA
        // ============================================
        async function loadDashboardData() {
            try {
                console.log('Loading dashboard data...');
                
                // Load stats in parallel
                const [usersData, missionsData, zonesData, sosData] = await Promise.all([
                    supabase.from('users').select('*', { count: 'exact' }),
                    supabase.from('missions').select('*', { count: 'exact' }).eq('status', 'active'),
                    supabase.from('zones').select('*', { count: 'exact' }).eq('is_active', true),
                    supabase.from('sos_alerts').select('*', { count: 'exact' }).eq('status', 'active')
                ]);
                
                // Update stats
                document.getElementById('total-users').textContent = usersData.count || 0;
                document.getElementById('active-zones').textContent = zonesData.count || 0;
                document.getElementById('active-sos').textContent = sosData.count || 0;
                
                // Update SOS badge
                const sosBadge = document.getElementById('sos-sidebar-badge');
                if (sosData.count > 0) {
                    sosBadge.textContent = sosData.count;
                    sosBadge.style.display = 'inline';
                    appState.pendingSOSCount = sosData.count;
                } else {
                    sosBadge.style.display = 'none';
                }
                
                // Load pending reviews
                const { count: pendingReviews } = await supabase
                    .from('submissions')
                    .select('*', { count: 'exact' })
                    .eq('review_status', 'pending');
                
                document.getElementById('pending-reviews').textContent = pendingReviews || 0;
                
                // Update review badge
                const reviewBadge = document.getElementById('review-sidebar-badge');
                if (pendingReviews > 0) {
                    reviewBadge.textContent = pendingReviews;
                    reviewBadge.style.display = 'inline';
                    appState.pendingReviewCount = pendingReviews;
                } else {
                    reviewBadge.style.display = 'none';
                }
                
                // Update notification badge
                updateNotificationBadge();
                
                // Load recent activity
                loadRecentActivity();
                
                console.log('Dashboard data loaded');
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }

        async function loadRecentActivity() {
            try {
                const { data: submissions } = await supabase
                    .from('submissions')
                    .select(`
                        *,
                        users (name, avatar_url),
                        missions (title)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                const tbody = document.getElementById('recent-activity');
                tbody.innerHTML = '';
                
                if (submissions && submissions.length > 0) {
                    submissions.forEach(sub => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <div class="flex items-center gap-2">
                                    <img src="${sub.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + sub.user_id}" 
                                         class="user-avatar-small">
                                    <span>${sub.users?.name || 'Unknown'}</span>
                                </div>
                            </td>
                            <td>Submitted mission</td>
                            <td>${sub.missions?.title || 'Unknown mission'}</td>
                            <td>${new Date(sub.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center p-4">
                                No recent activity
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        function refreshDashboard() {
            if (appState.currentSection === 'overview') {
                loadDashboardData();
            }
            if (appState.currentSection === 'live-map') {
                loadLiveMap();
            }
            if (appState.currentSection === 'sos-alerts') {
                loadSOSAlerts();
            }
            if (appState.currentSection === 'mission-review') {
                loadSubmissions();
            }
        }

        // ============================================
        // MAP FUNCTIONS
        // ============================================
        function initMap() {
            if (appState.map) return;
            
            try {
                mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;
                
                appState.map = new mapboxgl.Map({
                    container: 'admin-map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: [CONFIG.DEFAULT_LOCATION.lng, CONFIG.DEFAULT_LOCATION.lat],
                    zoom: 13
                });
                
                appState.map.addControl(new mapboxgl.NavigationControl());
                
                appState.map.on('load', function() {
                    console.log('Map loaded successfully');
                    loadZonesOnMap();
                    loadUsersOnMap();
                });
                
                // Map controls
                document.getElementById('map-zoom-in').addEventListener('click', () => appState.map.zoomIn());
                document.getElementById('map-zoom-out').addEventListener('click', () => appState.map.zoomOut());
                document.getElementById('map-center').addEventListener('click', () => {
                    appState.map.flyTo({
                        center: [CONFIG.DEFAULT_LOCATION.lng, CONFIG.DEFAULT_LOCATION.lat],
                        zoom: 13
                    });
                });
                
            } catch (error) {
                console.error('Error initializing map:', error);
                showToast('Error loading map', 'error');
            }
        }

        async function loadLiveMap() {
            if (!appState.map) return;
            
            try {
                // Load zones
                const { data: zones } = await supabase
                    .from('zones')
                    .select('*')
                    .eq('is_active', true);
                
                appState.zones = zones || [];
                loadZonesOnMap();
                
                // Load active users with locations
                const { data: users } = await supabase
                    .from('users')
                    .select('id, name, avatar_url, last_location, user_roles(role)')
                    .not('last_location', 'is', null)
                    .limit(100);
                
                appState.users = users || [];
                loadUsersOnMap();
                
                // Load active SOS alerts
                const { data: sosAlerts } = await supabase
                    .from('sos_alerts')
                    .select('*')
                    .eq('status', 'active');
                
                loadSOSOnMap(sosAlerts || []);
                
            } catch (error) {
                console.error('Error loading live map data:', error);
            }
        }

        function loadZonesOnMap() {
            if (!appState.map) return;
            
            // Clear existing zone layers
            appState.mapMarkers.forEach(marker => marker.remove());
            appState.mapMarkers = [];
            
            appState.zones.forEach(zone => {
                if (zone.coordinates && zone.coordinates.lat && zone.coordinates.lng) {
                    // Create marker
                    const el = document.createElement('div');
                    el.className = 'zone-marker';
                    el.style.width = '24px';
                    el.style.height = '24px';
                    el.style.backgroundColor = 'rgba(0, 112, 243, 0.3)';
                    el.style.borderRadius = '50%';
                    el.style.border = '2px solid #0070f3';
                    el.style.cursor = 'pointer';
                    el.title = zone.name;
                    
                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([zone.coordinates.lng, zone.coordinates.lat])
                        .setPopup(new mapboxgl.Popup().setHTML(`
                            <div style="padding: 8px; max-width: 200px;">
                                <h4 style="margin: 0 0 4px 0; color: #0070f3;">${zone.name}</h4>
                                <p style="margin: 0 0 4px 0; color: #666; font-size: 12px;">${zone.description || 'No description'}</p>
                                <p style="margin: 0; color: #888; font-size: 11px;">Radius: ${zone.radius_meters || 100}m</p>
                            </div>
                        `))
                        .addTo(appState.map);
                    
                    appState.mapMarkers.push(marker);
                }
            });
        }

        function loadUsersOnMap() {
            if (!appState.map) return;
            
            appState.users.forEach(user => {
                if (user.last_location && user.last_location.lat && user.last_location.lng) {
                    const isAdmin = user.user_roles?.[0]?.role === 'admin';
                    
                    // Create marker element
                    const el = document.createElement('div');
                    el.className = 'user-marker';
                    el.style.width = '32px';
                    el.style.height = '32px';
                    el.style.borderRadius = '50%';
                    el.style.border = `2px solid ${isAdmin ? '#00cc66' : '#0070f3'}`;
                    el.style.overflow = 'hidden';
                    el.style.cursor = 'pointer';
                    el.title = user.name || 'Unknown User';
                    
                    const img = document.createElement('img');
                    img.src = user.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    el.appendChild(img);
                    
                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([user.last_location.lng, user.last_location.lat])
                        .setPopup(new mapboxgl.Popup().setHTML(`
                            <div style="padding: 8px; max-width: 200px;">
                                <h4 style="margin: 0 0 4px 0; color: ${isAdmin ? '#00cc66' : '#0070f3'};">${user.name || 'Unknown User'}</h4>
                                <p style="margin: 0; color: #888; font-size: 11px;">
                                    ${isAdmin ? 'Admin' : 'Player'}
                                </p>
                                <button onclick="viewUser('${user.id}')" style="margin-top: 8px; padding: 4px 8px; background: #0070f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    View Details
                                </button>
                            </div>
                        `))
                        .addTo(appState.map);
                    
                    appState.mapMarkers.push(marker);
                }
            });
        }

        function loadSOSOnMap(alerts) {
            if (!appState.map) return;
            
            alerts.forEach(alert => {
                if (alert.latitude && alert.longitude) {
                    const el = document.createElement('div');
                    el.className = 'sos-marker';
                    el.style.width = '36px';
                    el.style.height = '36px';
                    el.style.backgroundColor = 'rgba(255, 0, 0, 0.3)';
                    el.style.borderRadius = '50%';
                    el.style.border = '3px solid #ff0000';
                    el.style.cursor = 'pointer';
                    el.style.display = 'flex';
                    el.style.alignItems = 'center';
                    el.style.justifyContent = 'center';
                    el.style.color = '#ff0000';
                    el.style.fontSize = '18px';
                    el.title = 'SOS Alert';
                    
                    const icon = document.createElement('i');
                    icon.className = 'fas fa-exclamation-triangle';
                    el.appendChild(icon);
                    
                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([alert.longitude, alert.latitude])
                        .setPopup(new mapboxgl.Popup().setHTML(`
                            <div style="padding: 8px; max-width: 200px;">
                                <h4 style="margin: 0 0 4px 0; color: #ff0000;">🚨 SOS ALERT</h4>
                                <p style="margin: 0 0 4px 0; color: #666; font-size: 12px;">User ID: ${alert.user_id?.substring(0, 8)}...</p>
                                <p style="margin: 0; color: #888; font-size: 11px;">${new Date(alert.created_at).toLocaleTimeString()}</p>
                                <button onclick="viewSOS('${alert.id}')" style="margin-top: 8px; padding: 4px 8px; background: #ff0000; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    View Alert
                                </button>
                            </div>
                        `))
                        .addTo(appState.map);
                    
                    appState.mapMarkers.push(marker);
                }
            });
        }

        // ============================================
        // ZONE MANAGEMENT
        // ============================================
        async function loadZones() {
            try {
                const { data: zones } = await supabase
                    .from('zones')
                    .select('*, missions(count)')
                    .order('created_at', { ascending: false });
                
                const tbody = document.getElementById('zones-list');
                tbody.innerHTML = '';
                
                if (zones && zones.length > 0) {
                    zones.forEach(zone => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <div style="font-weight: 600;">${zone.name}</div>
                                <div style="font-size: 11px; color: var(--gray-500);">
                                    ${zone.coordinates?.lat?.toFixed(6)}, ${zone.coordinates?.lng?.toFixed(6)}
                                </div>
                            </td>
                            <td>${zone.description || '—'}</td>
                            <td>${zone.missions?.[0]?.count || 0}</td>
                            <td>${zone.radius_meters || '—'}m</td>
                            <td>
                                <span class="status-badge ${zone.is_active ? 'status-active' : 'status-pending'}">
                                    ${zone.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </td>
                            <td>
                                <button class="action-btn text-sm" onclick="editZone('${zone.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn text-sm" onclick="viewZoneMissions('${zone.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center p-4">
                                No zones created yet
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading zones:', error);
                showToast('Error loading zones', 'error');
            }
        }

        function showCreateZoneModal() {
            showSection('zones-missions');
            document.getElementById('zone-creator').style.display = 'block';
        }

        async function createZone() {
            const name = document.getElementById('zone-name').value;
            const description = document.getElementById('zone-description').value;
            const radius = document.getElementById('zone-radius').value;
            
            if (!name) {
                showToast('Please enter a zone name', 'error');
                return;
            }
            
            try {
                // For now, create zone at default location
                // In production, you'd get this from map click
                const zoneData = {
                    name,
                    description,
                    radius_meters: parseInt(radius),
                    coordinates: CONFIG.DEFAULT_LOCATION,
                    is_active: true,
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('zones')
                    .insert([zoneData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Zone created successfully!', 'success');
                document.getElementById('zone-creator').style.display = 'none';
                loadZones();
                loadDashboardData();
                
                // Clear form
                document.getElementById('zone-name').value = '';
                document.getElementById('zone-description').value = '';
                
            } catch (error) {
                console.error('Error creating zone:', error);
                showToast('Error creating zone: ' + error.message, 'error');
            }
        }

        // ============================================
        // MISSION MANAGEMENT
        // ============================================
        function showCreateMissionModal() {
            // Load zones for dropdown
            loadZonesForDropdown();
            openModal('mission-modal');
        }

        async function loadZonesForDropdown() {
            try {
                const { data: zones } = await supabase
                    .from('zones')
                    .select('id, name')
                    .eq('is_active', true);
                
                const select = document.getElementById('mission-zone');
                select.innerHTML = '<option value="">Select a zone...</option>';
                
                zones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone.id;
                    option.textContent = zone.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading zones for dropdown:', error);
            }
        }

        async function createMission() {
            const title = document.getElementById('mission-title').value;
            const type = document.getElementById('mission-type').value;
            const zoneId = document.getElementById('mission-zone').value;
            const points = document.getElementById('mission-points').value;
            const question = document.getElementById('mission-question').value;
            const mediaCount = document.getElementById('mission-media-count').value;
            const videoDuration = document.getElementById('mission-video-duration').value;
            
            if (!title || !type || !zoneId || !points || !question) {
                showToast('Please fill all required fields', 'error');
                return;
            }
            
            try {
                const missionData = {
                    title,
                    mission_type: type,
                    zone_id: zoneId,
                    points: parseInt(points),
                    question,
                    media_required_count: parseInt(mediaCount) || 0,
                    video_max_duration: parseInt(videoDuration) || 10,
                    status: 'active',
                    created_at: new Date().toISOString()
                };
                
                const { data, error } = await supabase
                    .from('missions')
                    .insert([missionData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                showToast('Mission created successfully!', 'success');
                closeModal('mission-modal');
                
                // Clear form
                document.getElementById('mission-title').value = '';
                document.getElementById('mission-question').value = '';
                
            } catch (error) {
                console.error('Error creating mission:', error);
                showToast('Error creating mission: ' + error.message, 'error');
            }
        }

        // ============================================
        // MISSION REVIEW SYSTEM
        // ============================================
        async function loadSubmissions(filter = 'pending') {
            try {
                let query = supabase
                    .from('submissions')
                    .select(`
                        *,
                        users (id, name, avatar_url, email, phone),
                        missions (id, title, mission_type, points, question)
                    `)
                    .order('created_at', { ascending: false });
                
                if (filter === 'pending') {
                    query = query.eq('review_status', 'pending');
                } else if (filter === 'approved') {
                    query = query.eq('review_status', 'approved');
                } else if (filter === 'rejected') {
                    query = query.eq('review_status', 'rejected');
                }
                
                const { data: submissions } = await query;
                
                appState.submissions = submissions || [];
                renderSubmissionList(submissions || []);
                
            } catch (error) {
                console.error('Error loading submissions:', error);
                showToast('Error loading submissions', 'error');
            }
        }

        function renderSubmissionList(submissions) {
            const container = document.getElementById('submission-list');
            
            if (!submissions || submissions.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <i class="fas fa-inbox fa-2x mb-4" style="color: var(--gray-600);"></i>
                        <p class="text-secondary">No submissions found</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            submissions.forEach((sub, index) => {
                const div = document.createElement('div');
                div.className = `mission-item ${index === 0 ? 'active' : ''}`;
                div.dataset.submissionId = sub.id;
                div.addEventListener('click', () => showSubmissionReview(sub.id));
                
                div.innerHTML = `
                    <div class="mission-user">
                        <img src="${sub.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + sub.user_id}" 
                             alt="${sub.users?.name || 'User'}">
                        <div class="mission-user-info">
                            <h4>${sub.users?.name || 'Unknown User'}</h4>
                            <p>${sub.missions?.title || 'Unknown Mission'}</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="status-badge ${getStatusClass(sub.review_status)}">
                            ${sub.review_status || 'pending'}
                        </span>
                        <span class="text-xs text-secondary">
                            ${new Date(sub.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </span>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Show first submission by default
            if (submissions.length > 0) {
                showSubmissionReview(submissions[0].id);
            }
        }

        async function showSubmissionReview(submissionId) {
            const submission = appState.submissions.find(s => s.id === submissionId);
            if (!submission) return;
            
            // Update active item
            document.querySelectorAll('.mission-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.mission-item[data-submission-id="${submissionId}"]`).classList.add('active');
            
            const container = document.getElementById('mission-review-content');
            
            // Render media grid
            let mediaGrid = '';
            if (submission.media_urls && submission.media_urls.length > 0) {
                mediaGrid = `
                    <div class="media-grid mb-6">
                        ${submission.media_urls.map(url => `
                            <div class="media-item ${submission.missions?.mission_type === 'audio' ? 'audio' : ''}">
                                ${submission.missions?.mission_type === 'photo' ? 
                                    `<img src="${url}" alt="Submission">` :
                                 submission.missions?.mission_type === 'video' ?
                                    `<video controls>
                                        <source src="${url}" type="video/mp4">
                                    </video>` :
                                 submission.missions?.mission_type === 'audio' ?
                                    `<i class="fas fa-volume-up"></i>` :
                                    `<div class="p-4 text-center">
                                        <i class="fas fa-file-alt"></i>
                                        <p class="text-xs mt-2">Text Submission</p>
                                    </div>`
                                }
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            container.innerHTML = `
                <div>
                    <h3 class="mb-4">${submission.missions?.title || 'Mission'}</h3>
                    
                    <div class="mb-6">
                        <h4 class="text-sm text-secondary mb-2">Mission Question:</h4>
                        <p class="p-3 bg-gray-900 rounded">${submission.missions?.question || 'No question provided'}</p>
                    </div>
                    
                    ${mediaGrid}
                    
                    <div class="mb-6">
                        <h4 class="text-sm text-secondary mb-2">User Details:</h4>
                        <div class="flex items-center gap-3 p-3 bg-gray-900 rounded">
                            <img src="${submission.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + submission.user_id}" 
                                 class="w-10 h-10 rounded-full">
                            <div>
                                <p class="font-medium">${submission.users?.name || 'Unknown User'}</p>
                                <p class="text-xs text-secondary">${submission.users?.email || 'No email'}</p>
                                ${submission.users?.phone ? `<p class="text-xs text-secondary">${submission.users.phone}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="text-sm text-secondary mb-2">Submission Details:</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div>
                                <p class="text-secondary">Submitted:</p>
                                <p>${new Date(submission.created_at).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-secondary">Location:</p>
                                <p>${submission.location_lat && submission.location_lng ? 
                                    `${submission.location_lat.toFixed(6)}, ${submission.location_lng.toFixed(6)}` : 
                                    'Not available'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm text-secondary mb-2">Review Comments:</label>
                        <textarea id="review-comments" class="w-full p-3 bg-gray-900 border border-gray-700 rounded" 
                                  rows="3" placeholder="Add comments for the user..."></textarea>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm text-secondary mb-2">Award Points:</label>
                        <input type="number" id="review-points" class="w-full p-2 bg-gray-900 border border-gray-700 rounded" 
                               value="${submission.missions?.points || 100}" min="0" max="1000">
                    </div>
                    
                    <div class="flex gap-3">
                        <button class="action-btn danger flex-1" onclick="rejectSubmission('${submission.id}')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        <button class="action-btn success flex-1" onclick="approveSubmission('${submission.id}')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                    </div>
                </div>
            `;
        }

        async function approveSubmission(submissionId) {
            const comments = document.getElementById('review-comments')?.value || '';
            const points = parseInt(document.getElementById('review-points')?.value || 100);
            
            try {
                const submission = appState.submissions.find(s => s.id === submissionId);
                if (!submission) return;
                
                // Update submission
                await supabase
                    .from('submissions')
                    .update({
                        review_status: 'approved',
                        reviewed_by: appState.currentUser.id,
                        reviewed_at: new Date().toISOString(),
                        review_comments: comments,
                        awarded_points: points
                    })
                    .eq('id', submissionId);
                
                // Award points to user
                await supabase.rpc('increment_coins', {
                    user_id: submission.user_id,
                    amount: points
                });
                
                // Update user mission status
                await supabase
                    .from('user_missions')
                    .update({
                        status: 'completed',
                        completed_at: new Date().toISOString(),
                        earned_coins: points
                    })
                    .eq('user_id', submission.user_id)
                    .eq('mission_id', submission.mission_id);
                
                showToast('Submission approved! Points awarded.', 'success');
                loadSubmissions();
                loadDashboardData();
                
            } catch (error) {
                console.error('Error approving submission:', error);
                showToast('Error approving submission', 'error');
            }
        }

        async function rejectSubmission(submissionId) {
            const comments = document.getElementById('review-comments')?.value || '';
            
            try {
                await supabase
                    .from('submissions')
                    .update({
                        review_status: 'rejected',
                        reviewed_by: appState.currentUser.id,
                        reviewed_at: new Date().toISOString(),
                        review_comments: comments
                    })
                    .eq('id', submissionId);
                
                showToast('Submission rejected', 'success');
                loadSubmissions();
                
            } catch (error) {
                console.error('Error rejecting submission:', error);
                showToast('Error rejecting submission', 'error');
            }
        }

        // ============================================
        // SOS ALERTS
        // ============================================
        async function loadSOSAlerts() {
            try {
                const { data: alerts } = await supabase
                    .from('sos_alerts')
                    .select(`
                        *,
                        users (id, name, avatar_url, phone)
                    `)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });
                
                const tbody = document.getElementById('sos-alerts-list');
                
                if (alerts && alerts.length > 0) {
                    tbody.innerHTML = '';
                    
                    alerts.forEach(alert => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <div class="flex items-center gap-2">
                                    <img src="${alert.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + alert.user_id}" 
                                         class="user-avatar-small">
                                    <span>${alert.users?.name || 'Unknown User'}</span>
                                </div>
                            </td>
                            <td>
                                <div>${alert.latitude?.toFixed(6) || '—'}, ${alert.longitude?.toFixed(6) || '—'}</div>
                                <div class="text-xs text-secondary">Acc: ${alert.accuracy || '—'}m</div>
                            </td>
                            <td>${alert.users?.phone || '—'}</td>
                            <td>${new Date(alert.created_at).toLocaleTimeString()}</td>
                            <td>
                                <span class="status-badge status-active">Active</span>
                            </td>
                            <td>
                                <div class="flex gap-2">
                                    <button class="action-btn text-sm" onclick="callUser('${alert.users?.phone}')">
                                        <i class="fas fa-phone"></i>
                                    </button>
                                    <button class="action-btn text-sm success" onclick="acknowledgeSOSAlert('${alert.id}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                } else {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center p-4">
                                No active SOS alerts
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading SOS alerts:', error);
            }
        }

        function showSOSAlert(alert) {
            document.getElementById('sos-user-name').textContent = alert.users?.name || 'Unknown User';
            document.getElementById('sos-location').textContent = 
                alert.latitude && alert.longitude ? 
                `${alert.latitude.toFixed(6)}, ${alert.longitude.toFixed(6)}` : 
                'Unknown';
            document.getElementById('sos-phone').textContent = alert.users?.phone || 'Not available';
            
            // Store alert ID
            document.getElementById('sos-alert').dataset.alertId = alert.id;
            document.getElementById('sos-alert').style.display = 'block';
        }

        function callSOSUser() {
            const phone = document.getElementById('sos-phone').textContent;
            if (phone && phone !== 'Not available') {
                window.open(`tel:${phone}`, '_blank');
            } else {
                showToast('Phone number not available', 'error');
            }
        }

        async function acknowledgeSOS() {
            const alertId = document.getElementById('sos-alert').dataset.alertId;
            if (alertId) {
                await acknowledgeSOSAlert(alertId);
            }
        }

        async function acknowledgeSOSAlert(alertId) {
            try {
                await supabase
                    .from('sos_alerts')
                    .update({
                        status: 'acknowledged',
                        acknowledged_by: appState.currentUser.id,
                        acknowledged_at: new Date().toISOString()
                    })
                    .eq('id', alertId);
                
                document.getElementById('sos-alert').style.display = 'none';
                showToast('SOS alert acknowledged', 'success');
                loadSOSAlerts();
                loadDashboardData();
                
            } catch (error) {
                console.error('Error acknowledging SOS:', error);
                showToast('Error acknowledging alert', 'error');
            }
        }

        function viewSOSLocation() {
            // This would center map on SOS location
            showSection('live-map');
            showToast('Navigating to SOS location...', 'info');
        }

        // ============================================
        // USER MANAGEMENT
        // ============================================
        async function loadUsers(page = 1) {
            try {
                const from = (page - 1) * CONFIG.ITEMS_PER_PAGE;
                const to = from + CONFIG.ITEMS_PER_PAGE - 1;
                
                const { data: users, error, count } = await supabase
                    .from('users')
                    .select('*', { count: 'exact' })
                    .order('created_at', { ascending: false })
                    .range(from, to);
                
                if (error) throw error;
                
                renderUsersTable(users || []);
                
                // Update pagination
                const totalPages = Math.ceil((count || 0) / CONFIG.ITEMS_PER_PAGE);
                document.getElementById('users-page-info').textContent = `Page ${page} of ${totalPages}`;
                document.getElementById('prev-users').disabled = page <= 1;
                document.getElementById('next-users').disabled = page >= totalPages;
                
                // Store current page
                document.getElementById('users-management-list').dataset.currentPage = page;
                
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Error loading users', 'error');
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('users-management-list');
            
            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center p-4">
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="flex items-center gap-2">
                            <img src="${user.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.id}" 
                                 class="user-avatar-small">
                            <span>${user.name || 'Unnamed User'}</span>
                        </div>
                    </td>
                    <td>${user.email}</td>
                    <td>${user.phone || '—'}</td>
                    <td>${user.coins || 0}</td>
                    <td>${user.completed_missions || 0}</td>
                    <td>${user.last_active ? new Date(user.last_active).toLocaleDateString() : 'Never'}</td>
                    <td>
                        <button class="action-btn text-sm" onclick="viewUserDetails('${user.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function searchUsers() {
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            const rows = document.querySelectorAll('#users-management-list tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function searchZones() {
            const searchTerm = document.getElementById('search-zones').value.toLowerCase();
            const rows = document.querySelectorAll('#zones-list tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function changeUserPage(delta) {
            const currentPage = parseInt(document.getElementById('users-management-list').dataset.currentPage || 1);
            const newPage = currentPage + delta;
            if (newPage > 0) {
                loadUsers(newPage);
            }
        }

        // ============================================
        // REAL-TIME SUBSCRIPTIONS
        // ============================================
        function setupRealtimeSubscriptions() {
            // SOS Alerts
            const sosChannel = supabase
                .channel('admin-sos-alerts')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'sos_alerts', filter: 'status=eq.active' },
                    (payload) => {
                        console.log('New SOS alert:', payload.new);
                        appState.pendingSOSCount++;
                        updateNotificationBadge();
                        
                        // Show popup
                        showSOSAlert(payload.new);
                        showToast('New SOS alert received!', 'error');
                        
                        // Refresh SOS list
                        if (appState.currentSection === 'sos-alerts') {
                            loadSOSAlerts();
                        }
                        
                        // Refresh dashboard
                        loadDashboardData();
                    }
                )
                .subscribe();
            
            appState.realtimeChannels.push(sosChannel);
            
            // New Submissions
            const submissionsChannel = supabase
                .channel('admin-submissions')
                .on('postgres_changes',
                    { event: 'INSERT', schema: 'public', table: 'submissions' },
                    (payload) => {
                        console.log('New submission:', payload.new);
                        appState.pendingReviewCount++;
                        updateNotificationBadge();
                        
                        showToast('New submission to review', 'info');
                        
                        // Refresh if on review page
                        if (appState.currentSection === 'mission-review') {
                            loadSubmissions();
                        }
                        
                        // Refresh dashboard
                        loadDashboardData();
                    }
                )
                .subscribe();
            
            appState.realtimeChannels.push(submissionsChannel);
            
            console.log('Real-time subscriptions active');
        }

        function updateNotificationBadge() {
            const total = appState.pendingReviewCount + appState.pendingSOSCount;
            const badge = document.getElementById('notification-count');
            
            if (total > 0) {
                badge.textContent = total;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    </div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            // Show with animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode === container) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function showError(message) {
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 5000);
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function getStatusClass(status) {
            switch(status) {
                case 'approved': return 'status-active';
                case 'rejected': return 'status-rejected';
                case 'pending': return 'status-pending';
                default: return 'status-pending';
            }
        }

        // Expose functions to global scope for onclick handlers
        window.showSection = showSection;
        window.showCreateZoneModal = showCreateZoneModal;
        window.showCreateMissionModal = showCreateMissionModal;
        window.viewUser = function(userId) {
            showToast('View user details: ' + userId, 'info');
        };
        window.viewSOS = function(sosId) {
            showToast('View SOS alert: ' + sosId, 'info');
        };
        window.editZone = function(zoneId) {
            showToast('Edit zone: ' + zoneId, 'info');
        };
        window.viewZoneMissions = function(zoneId) {
            showToast('View zone missions: ' + zoneId, 'info');
        };
        window.viewUserDetails = function(userId) {
            showToast('View user details: ' + userId, 'info');
        };
        window.callUser = function(phone) {
            if (phone && phone !== '—') {
                window.open(`tel:${phone}`, '_blank');
            } else {
                showToast('Phone number not available', 'error');
            }
        };
        window.acknowledgeSOSAlert = acknowledgeSOSAlert;
        window.approveSubmission = approveSubmission;
        window.rejectSubmission = rejectSubmission;
    </script>
</body>
</html>
