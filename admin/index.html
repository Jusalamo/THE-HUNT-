<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Hunt • Admin Dashboard</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        /* ============================================
           VERCEL-STYLE DARK THEME
           ============================================ */
        :root {
            /* Color Palette */
            --black: #000000;
            --gray-900: #111111;
            --gray-800: #1a1a1a;
            --gray-700: #2a2a2a;
            --gray-600: #444444;
            --gray-500: #666666;
            --gray-400: #888888;
            --gray-300: #aaaaaa;
            --gray-200: #cccccc;
            --gray-100: #e5e5e5;
            --white: #ffffff;
            
            /* Accent Colors */
            --blue: #0070f3;
            --blue-light: #3291ff;
            --red: #ff0000;
            --red-light: #ff3333;
            --green: #00cc66;
            --green-light: #33ff99;
            --yellow: #ffcc00;
            --yellow-light: #ffdd44;
            --purple: #7928ca;
            --purple-light: #9a4dff;
            
            /* UI Colors */
            --bg-primary: var(--black);
            --bg-secondary: var(--gray-900);
            --bg-tertiary: var(--gray-800);
            --bg-card: var(--gray-800);
            --border-color: var(--gray-700);
            --text-primary: var(--white);
            --text-secondary: var(--gray-300);
            --text-muted: var(--gray-500);
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.4);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.5);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        /* ============================================
           RESET & BASE STYLES
           ============================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 14px;
        }

        /* ============================================
           ADMIN LOGIN SCREEN
           ============================================ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 10000;
        }

        .login-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .login-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .login-header h1 {
            color: var(--white);
            margin-bottom: 8px;
            font-size: 28px;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .login-form input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all var(--transition-fast);
        }

        .login-form input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .login-btn:hover {
            background: var(--blue-light);
            transform: translateY(-1px);
        }

        .login-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .login-error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid var(--red);
            color: var(--red-light);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 13px;
            display: none;
        }

        /* ============================================
           ADMIN DASHBOARD LAYOUT
           ============================================ */
        .admin-dashboard {
            display: none;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: var(--bg-primary);
        }

        /* Top Header */
        .admin-header {
            height: 60px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 16px;
            color: var(--white);
        }

        .logo i {
            color: var(--blue);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .notification-bell {
            position: relative;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all var(--transition-fast);
        }

        .notification-bell:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .notification-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: var(--red);
            color: white;
            font-size: 10px;
            font-weight: 600;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all var(--transition-fast);
        }

        .admin-profile:hover {
            background: var(--bg-tertiary);
        }

        .admin-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--blue);
            object-fit: cover;
        }

        .admin-info h4 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .admin-info p {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Sidebar */
        .admin-sidebar {
            width: 240px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 60px;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 20px 0;
            z-index: 90;
        }

        .sidebar-section {
            margin-bottom: 24px;
            padding: 0 16px;
        }

        .sidebar-section h3 {
            color: var(--text-muted);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-left: 8px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: 6px;
            margin-bottom: 4px;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: rgba(0, 112, 243, 0.1);
            color: var(--blue);
            border-left-color: var(--blue);
        }

        .sidebar-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .sidebar-item span {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
        }

        .sidebar-badge {
            background: var(--red);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
            display: none;
        }

        /* Main Content */
        .admin-content {
            margin-left: 240px;
            margin-top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-primary);
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ============================================
           DASHBOARD OVERVIEW
           ============================================ */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--blue);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-icon.users { background: rgba(0, 112, 243, 0.1); color: var(--blue); }
        .stat-icon.missions { background: rgba(255, 204, 0, 0.1); color: var(--yellow); }
        .stat-icon.zones { background: rgba(0, 204, 102, 0.1); color: var(--green); }
        .stat-icon.sos { background: rgba(255, 0, 0, 0.1); color: var(--red); }

        .stat-trend {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            background: rgba(0, 204, 102, 0.1);
            color: var(--green);
        }

        .stat-trend.negative {
            background: rgba(255, 0, 0, 0.1);
            color: var(--red);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--white);
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--blue);
        }

        .action-btn.primary {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        .action-btn.success {
            background: var(--green);
            border-color: var(--green);
            color: white;
        }

        .action-btn.danger {
            background: var(--red);
            border-color: var(--red);
            color: white;
        }

        .action-btn.warning {
            background: var(--yellow);
            border-color: var(--yellow);
            color: var(--black);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ============================================
           ZONE CREATION & MAP STYLING
           ============================================ */
        .map-container {
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
            position: relative;
        }

        #admin-map {
            width: 100%;
            height: 100%;
        }

        .map-controls {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10;
        }

        .map-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .map-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--blue);
        }

        .map-btn.active {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        .map-legend {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            font-size: 12px;
            z-index: 10;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-color.player { background: var(--blue); }
        .legend-color.admin { background: var(--green); }
        .legend-color.sos { background: var(--red); }
        .legend-color.zone { background: var(--purple); }

        /* Zone Creation Panel */
        .zone-creation-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .zone-creation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .zone-creation-header h3 {
            font-size: 18px;
            color: var(--text-primary);
        }

        .zone-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            transition: all var(--transition-fast);
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
        }

        /* Radius Slider - Themed */
        .radius-control {
            margin-top: 16px;
        }

        .radius-value {
            display: inline-block;
            margin-left: 10px;
            font-weight: 600;
            color: var(--blue);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: var(--gray-700);
            border-radius: 3px;
            outline: none;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--blue);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--blue);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Mission Form */
        .mission-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        /* ============================================
           DATA TABLES
           ============================================ */
        .data-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .table-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .table-search {
            padding: 8px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 13px;
            width: 200px;
            min-width: 200px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--bg-secondary);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .status-active { background: rgba(0, 204, 102, 0.1); color: var(--green); }
        .status-pending { background: rgba(255, 204, 0, 0.1); color: var(--yellow); }
        .status-completed { background: rgba(0, 112, 243, 0.1); color: var(--blue); }
        .status-rejected { background: rgba(255, 0, 0, 0.1); color: var(--red); }
        .status-inactive { background: rgba(136, 136, 136, 0.1); color: var(--text-secondary); }

        .user-avatar-small {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            vertical-align: middle;
            margin-right: 8px;
        }

        /* ============================================
           MISSION REVIEW
           ============================================ */
        .review-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            min-height: 600px;
        }

        @media (max-width: 1024px) {
            .review-container {
                grid-template-columns: 1fr;
            }
        }

        .mission-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            max-height: 600px;
            overflow-y: auto;
        }

        .mission-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mission-item:hover {
            background: var(--bg-tertiary);
        }

        .mission-item.active {
            background: rgba(0, 112, 243, 0.1);
            border-left: 3px solid var(--blue);
        }

        .mission-item:last-child {
            border-bottom: none;
        }

        .mission-user {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .mission-user img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .mission-user-info h4 {
            font-size: 13px;
            margin-bottom: 2px;
        }

        .mission-user-info p {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .mission-preview {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            max-height: 600px;
            overflow-y: auto;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .media-item {
            aspect-ratio: 1;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            border: 1px solid var(--border-color);
        }

        .media-item:hover {
            border-color: var(--blue);
            transform: translateY(-2px);
        }

        .media-item img,
        .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-item.audio {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
        }

        .media-item.audio i {
            font-size: 24px;
            color: var(--text-secondary);
        }

        /* ============================================
           MODALS
           ============================================ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            margin: 0;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
            border-radius: 4px;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 20px;
            max-height: calc(90vh - 140px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Image Upload Preview */
        .image-upload-container {
            margin-bottom: 20px;
        }

        .image-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .image-preview:hover {
            border-color: var(--blue);
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview.empty {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .image-preview.empty i {
            font-size: 36px;
        }

        /* ============================================
           SETTINGS SECTIONS
           ============================================ */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .settings-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
        }

        .settings-section h4 {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--text-primary);
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            flex: 1;
        }

        .setting-label h5 {
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .setting-label p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-700);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--blue);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* ============================================
           SOS ALERT POPUP
           ============================================ */
        .sos-alert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            background: var(--red);
            color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3);
            z-index: 1001;
            animation: alertPulse 2s infinite;
            display: none;
        }

        @keyframes alertPulse {
            0% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 4px 30px rgba(255, 0, 0, 0.5); }
            100% { transform: scale(1); box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3); }
        }

        .sos-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .sos-header i {
            font-size: 24px;
        }

        .sos-header h4 {
            flex: 1;
            margin: 0;
        }

        .sos-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.8;
        }

        .sos-close:hover {
            opacity: 1;
        }

        .sos-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* ============================================
           TOAST NOTIFICATIONS
           ============================================ */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 8px;
            min-width: 300px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--green);
        }

        .toast.error {
            border-left: 4px solid var(--red);
        }

        .toast.info {
            border-left: 4px solid var(--blue);
        }

        .toast.warning {
            border-left: 4px solid var(--yellow);
        }

        .toast-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .toast-icon {
            font-size: 16px;
            margin-top: 2px;
        }

        .toast.success .toast-icon { color: var(--green); }
        .toast.error .toast-icon { color: var(--red); }
        .toast.info .toast-icon { color: var(--blue); }
        .toast.warning .toast-icon { color: var(--yellow); }

        .toast-message {
            flex: 1;
            font-size: 13px;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        /* ============================================
           LOADING STATES
           ============================================ */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--blue);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ============================================
           PAGINATION
           ============================================ */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            border-top: 1px solid var(--border-color);
        }

        .page-btn {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .page-btn:hover:not(:disabled) {
            background: var(--bg-tertiary);
            border-color: var(--blue);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: var(--blue);
            border-color: var(--blue);
            color: white;
        }

        /* ============================================
           RESPONSIVE DESIGN
           ============================================ */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 200px;
            }
            
            .admin-content {
                margin-left: 200px;
            }
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                transform: translateX(-100%);
                transition: transform var(--transition-normal);
                z-index: 99;
                width: 280px;
            }
            
            .admin-sidebar.active {
                transform: translateX(0);
            }
            
            .admin-content {
                margin-left: 0;
            }
            
            .sidebar-toggle {
                display: block !important;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .zone-form-grid,
            .mission-form-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-container {
                max-width: 95vw;
            }
            
            .sos-alert {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                bottom: 20px;
            }
            
            .review-container {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .table-search {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .admin-header {
                padding: 0 16px;
            }
            
            .admin-content {
                padding: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
            
            .map-controls {
                flex-direction: row;
                bottom: 16px;
                top: auto;
                right: 16px;
                left: 16px;
                justify-content: center;
            }
            
            .map-legend {
                display: none;
            }
        }

        /* ============================================
           UTILITY CLASSES
           ============================================ */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        .p-4 { padding: 16px; }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-card">
            <div class="login-header">
                <h1><i class="fas fa-shield-alt"></i> THE HUNT</h1>
                <p>Admin Dashboard</p>
            </div>
            
            <div id="login-error" class="login-error"></div>
            
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label>Admin Email</label>
                    <input type="email" id="admin-email" placeholder="admin@thehunt.com" required>
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="admin-password" placeholder="••••••••" required>
                </div>
                
                <button type="submit" class="login-btn" id="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="admin-dashboard">
        <!-- Header -->
        <header class="admin-header">
            <div class="header-left">
                <button class="sidebar-toggle hidden" id="sidebar-toggle">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>THE HUNT • ADMIN</span>
                </div>
            </div>
            
            <div class="header-right">
                <button class="notification-bell" id="notifications-btn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notification-count">0</span>
                </button>
                
                <div class="admin-profile" id="admin-profile">
                    <img id="admin-avatar-img" src="https://api.dicebear.com/7.x/avataaars/svg?seed=admin" alt="Admin" class="admin-avatar">
                    <div class="admin-info">
                        <h4 id="admin-name">Loading...</h4>
                        <p id="admin-role">Super Admin</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <nav class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-section">
                <h3>Dashboard</h3>
                <div class="sidebar-item active" data-section="overview">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Overview</span>
                </div>
                <div class="sidebar-item" data-section="live-map">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Live Map</span>
                </div>
                <div class="sidebar-item" data-section="sos-alerts">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>SOS Alerts</span>
                    <span class="sidebar-badge" id="sos-sidebar-badge">0</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Management</h3>
                <div class="sidebar-item" data-section="zones-missions">
                    <i class="fas fa-draw-polygon"></i>
                    <span>Zones & Missions</span>
                </div>
                <div class="sidebar-item" data-section="mission-review">
                    <i class="fas fa-inbox"></i>
                    <span>Mission Review</span>
                    <span class="sidebar-badge" id="review-sidebar-badge">0</span>
                </div>
                <div class="sidebar-item" data-section="prizes">
                    <i class="fas fa-gift"></i>
                    <span>Prizes</span>
                </div>
                <div class="sidebar-item" data-section="game-settings">
                    <i class="fas fa-gamepad"></i>
                    <span>Game Settings</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Users</h3>
                <div class="sidebar-item" data-section="users">
                    <i class="fas fa-users"></i>
                    <span>All Users</span>
                </div>
                <div class="sidebar-item" data-section="admins">
                    <i class="fas fa-user-shield"></i>
                    <span>Admins</span>
                </div>
                <div class="sidebar-item" data-section="reports">
                    <i class="fas fa-flag"></i>
                    <span>Reports</span>
                    <span class="sidebar-badge" id="reports-sidebar-badge">0</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Analytics</h3>
                <div class="sidebar-item" data-section="analytics">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </div>
                <div class="sidebar-item" data-section="export">
                    <i class="fas fa-file-export"></i>
                    <span>Export Data</span>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>System</h3>
                <div class="sidebar-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="sidebar-item" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="admin-content" id="admin-content">
            <!-- Dashboard Overview -->
            <section id="overview-section" class="content-section active">
                <div class="dashboard-header">
                    <h1>Dashboard Overview</h1>
                    <div class="table-actions">
                        <button class="action-btn" id="refresh-overview">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="action-btn primary" onclick="showCreateZoneModal()">
                            <i class="fas fa-plus"></i> Create Zone
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card" onclick="showSection('users')">
                        <div class="stat-header">
                            <div class="stat-icon users">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-trend" id="users-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Total Players</div>
                    </div>
                    
                    <div class="stat-card" onclick="showSection('mission-review')">
                        <div class="stat-header">
                            <div class="stat-icon missions">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="stat-trend" id="missions-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="pending-reviews">0</div>
                        <div class="stat-label">Pending Reviews</div>
                    </div>
                    
                    <div class="stat-card" onclick="showSection('zones-missions')">
                        <div class="stat-header">
                            <div class="stat-icon zones">
                                <i class="fas fa-draw-polygon"></i>
                            </div>
                            <div class="stat-trend" id="zones-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="active-zones">0</div>
                        <div class="stat-label">Active Zones</div>
                    </div>
                    
                    <div class="stat-card" onclick="showSection('sos-alerts')">
                        <div class="stat-header">
                            <div class="stat-icon sos">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-trend negative" id="sos-trend">0</div>
                        </div>
                        <div class="stat-value" id="active-sos">0</div>
                        <div class="stat-label">Active SOS Alerts</div>
                    </div>
                </div>
                
                <div class="quick-actions">
                    <button class="action-btn primary" onclick="showCreateZoneModal()">
                        <i class="fas fa-plus"></i> Create Zone
                    </button>
                    <button class="action-btn" onclick="showCreateMissionModal()">
                        <i class="fas fa-tasks"></i> Create Mission
                    </button>
                    <button class="action-btn" onclick="showCreatePrizeModal()">
                        <i class="fas fa-gift"></i> Add Prize
                    </button>
                    <button class="action-btn" onclick="showSection('mission-review')">
                        <i class="fas fa-eye"></i> Review Missions
                    </button>
                    <button class="action-btn" onclick="showSection('live-map')">
                        <i class="fas fa-map"></i> View Live Map
                    </button>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>Recent Activity</h3>
                        <input type="text" class="table-search" placeholder="Search activity..." id="search-activity">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recent-activity">
                            <tr>
                                <td colspan="5" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Live Map -->
            <section id="live-map-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Live Player Map</h1>
                    <div class="table-actions">
                        <button class="action-btn" id="refresh-map">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                        <button class="action-btn primary" onclick="showCreateZoneModal()">
                            <i class="fas fa-plus"></i> Create Zone
                        </button>
                        <button class="action-btn" id="export-map-data">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="zone-creation-panel" id="zone-creation-panel" style="display: none;">
                    <div class="zone-creation-header">
                        <h3>Create New Zone</h3>
                        <button class="action-btn" onclick="hideZoneCreation()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    <div class="zone-form-grid">
                        <div class="form-group">
                            <label>Zone Name *</label>
                            <input type="text" id="zone-name" placeholder="Enter zone name">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="zone-description" placeholder="Zone description (optional)"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Radius (meters)</label>
                            <div class="radius-control">
                                <input type="range" id="zone-radius" min="50" max="500" value="100" step="10">
                                <span id="radius-value" class="radius-value">100m</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Drawing Mode</label>
                            <select id="drawing-mode">
                                <option value="circle">Circle</option>
                                <option value="rectangle">Rectangle</option>
                                <option value="polygon">Polygon</option>
                            </select>
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="action-btn primary" id="save-zone-btn">
                            <i class="fas fa-save"></i> Save Zone
                        </button>
                        <button class="action-btn" id="clear-zone-btn">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                        <button class="action-btn" onclick="hideZoneCreation()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <div class="map-container">
                    <div id="admin-map">
                        <div class="loading-spinner"></div>
                    </div>
                    
                    <div class="map-controls">
                        <button class="map-btn" id="map-zoom-in" title="Zoom In">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="map-btn" id="map-zoom-out" title="Zoom Out">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="map-btn" id="map-center" title="Center Map">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="map-btn active" id="map-show-players" title="Show Players">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="map-btn active" id="map-show-zones" title="Show Zones">
                            <i class="fas fa-draw-polygon"></i>
                        </button>
                        <button class="map-btn" id="map-show-sos" title="Show SOS">
                            <i class="fas fa-exclamation-triangle"></i>
                        </button>
                    </div>
                    
                    <div class="map-legend">
                        <div class="legend-item">
                            <div class="legend-color player"></div>
                            <span>Players</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color admin"></div>
                            <span>Admins</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color sos"></div>
                            <span>SOS Alerts</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color zone"></div>
                            <span>Zones</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Zones & Missions -->
            <section id="zones-missions-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Zones & Missions Management</h1>
                    <div class="table-actions">
                        <button class="action-btn primary" onclick="showCreateZoneModal()">
                            <i class="fas fa-plus"></i> Create Zone
                        </button>
                        <button class="action-btn" onclick="showCreateMissionModal()">
                            <i class="fas fa-tasks"></i> Add Mission
                        </button>
                        <button class="action-btn" onclick="exportZonesData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="zone-creation-panel" style="display: none;" id="zone-creation-static">
                    <div class="zone-creation-header">
                        <h3>Create New Zone</h3>
                        <button class="action-btn" onclick="hideZoneCreation()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                    <div class="zone-form-grid">
                        <div class="form-group">
                            <label>Zone Name *</label>
                            <input type="text" id="zone-name-static" placeholder="Enter zone name">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="zone-description-static" placeholder="Zone description (optional)"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Radius (meters)</label>
                            <div class="radius-control">
                                <input type="range" id="zone-radius-static" min="50" max="500" value="100" step="10">
                                <span id="radius-value-static" class="radius-value">100m</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Drawing Mode</label>
                            <select id="drawing-mode-static">
                                <option value="circle">Circle</option>
                                <option value="rectangle">Rectangle</option>
                                <option value="polygon">Polygon</option>
                            </select>
                        </div>
                    </div>
                    <div class="quick-actions">
                        <button class="action-btn primary" id="save-zone-btn-static">
                            <i class="fas fa-save"></i> Save Zone
                        </button>
                        <button class="action-btn" id="clear-zone-btn-static">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                        <button class="action-btn" onclick="hideZoneCreation()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>Existing Zones</h3>
                        <input type="text" class="table-search" placeholder="Search zones..." id="search-zones">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Zone Name</th>
                                <th>Description</th>
                                <th>Missions</th>
                                <th>Radius</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="zones-list">
                            <tr>
                                <td colspan="6" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>Zone Missions</h3>
                        <input type="text" class="table-search" placeholder="Search missions..." id="search-missions">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Mission Title</th>
                                <th>Type</th>
                                <th>Zone</th>
                                <th>Points</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="missions-list">
                            <tr>
                                <td colspan="6" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Mission Review -->
            <section id="mission-review-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Mission Review</h1>
                    <div class="table-actions">
                        <button class="action-btn" id="filter-pending">
                            <i class="fas fa-clock"></i> Pending Only
                        </button>
                        <button class="action-btn" id="filter-approved">
                            <i class="fas fa-check"></i> Approved
                        </button>
                        <button class="action-btn" id="filter-rejected">
                            <i class="fas fa-times"></i> Rejected
                        </button>
                        <button class="action-btn primary" onclick="showBulkReviewModal()">
                            <i class="fas fa-check-double"></i> Bulk Review
                        </button>
                    </div>
                </div>
                
                <div class="review-container">
                    <div class="mission-list">
                        <div class="p-4">
                            <input type="text" class="table-search w-full" placeholder="Search submissions..." id="search-submissions">
                        </div>
                        <div id="submission-list">
                            <div class="p-8 text-center">
                                <div class="loading-spinner"></div>
                                <p class="mt-4 text-secondary">Loading submissions...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mission-preview">
                        <div id="mission-review-content">
                            <div class="text-center p-8">
                                <i class="fas fa-inbox fa-3x mb-4" style="color: var(--gray-600);"></i>
                                <h3>No Submission Selected</h3>
                                <p class="text-secondary">Select a submission from the list to review</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Prizes Management -->
            <section id="prizes-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Prizes Management</h1>
                    <div class="table-actions">
                        <button class="action-btn primary" onclick="showCreatePrizeModal()">
                            <i class="fas fa-plus"></i> Add Prize
                        </button>
                        <button class="action-btn" onclick="exportPrizesData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Available Prizes</h3>
                        <input type="text" class="table-search" placeholder="Search prizes..." id="search-prizes">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prizes-list">
                            <tr>
                                <td colspan="8" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>Recent Purchases</h3>
                        <input type="text" class="table-search" placeholder="Search purchases..." id="search-purchases">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Prize</th>
                                <th>Price</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-list">
                            <tr>
                                <td colspan="6" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Game Settings -->
            <section id="game-settings-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Game Settings</h1>
                    <div class="table-actions">
                        <button class="action-btn primary" onclick="saveGameSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        <button class="action-btn" onclick="resetGameSettings()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div class="settings-grid">
                    <div class="settings-section">
                        <h4>Event Timer</h4>
                        <div class="form-group">
                            <label>Event Name</label>
                            <input type="text" id="event-name" placeholder="Enter event name">
                        </div>
                        <div class="form-group">
                            <label>Start Time</label>
                            <input type="datetime-local" id="event-start">
                        </div>
                        <div class="form-group">
                            <label>End Time</label>
                            <input type="datetime-local" id="event-end">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Event Active</h5>
                                <p>Enable or disable the event</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="event-active" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Points & Rewards</h4>
                        <div class="form-group">
                            <label>Mission Points Multiplier</label>
                            <input type="number" id="points-multiplier" min="0.1" max="10" step="0.1" value="1">
                        </div>
                        <div class="form-group">
                            <label>Bonus Points per Zone</label>
                            <input type="number" id="zone-bonus" min="0" max="1000" step="10" value="50">
                        </div>
                        <div class="form-group">
                            <label>Daily Login Bonus</label>
                            <input type="number" id="login-bonus" min="0" max="1000" step="10" value="10">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Enable Leaderboard</h5>
                                <p>Show leaderboard to players</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="leaderboard-enabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Game Rules</h4>
                        <div class="form-group">
                            <label>Max Missions per Zone</label>
                            <input type="number" id="max-missions" min="1" max="50" value="10">
                        </div>
                        <div class="form-group">
                            <label>Mission Time Limit (minutes)</label>
                            <input type="number" id="mission-time-limit" min="1" max="120" value="30">
                        </div>
                        <div class="form-group">
                            <label>GPS Check-in Radius (meters)</label>
                            <input type="number" id="gps-radius" min="10" max="500" value="50">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Allow Multiple Submissions</h5>
                                <p>Players can submit multiple times</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="multiple-submissions">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Notifications</h4>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Email Notifications</h5>
                                <p>Send email updates to players</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="email-notifications" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Push Notifications</h5>
                                <p>Send push notifications</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="push-notifications" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>SMS Alerts</h5>
                                <p>Send SMS for important updates</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="sms-alerts">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Notification Schedule</label>
                            <select id="notification-schedule">
                                <option value="immediate">Immediate</option>
                                <option value="daily">Daily Digest</option>
                                <option value="weekly">Weekly Summary</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Users Management -->
            <section id="users-section" class="content-section">
                <div class="dashboard-header">
                    <h1>User Management</h1>
                    <div class="table-actions">
                        <input type="text" class="table-search" placeholder="Search users..." id="search-users">
                        <button class="action-btn" id="export-users">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="action-btn primary" onclick="showAddUserModal()">
                            <i class="fas fa-user-plus"></i> Add User
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Profile</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Coins</th>
                                <th>Missions</th>
                                <th>Last Active</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-management-list">
                            <tr>
                                <td colspan="9" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="pagination">
                        <button class="page-btn" id="prev-users">Previous</button>
                        <span id="users-page-info">Page 1 of 1</span>
                        <button class="page-btn" id="next-users">Next</button>
                    </div>
                </div>
            </section>

            <!-- Admins Management -->
            <section id="admins-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Admin Management</h1>
                    <div class="table-actions">
                        <button class="action-btn primary" onclick="showAddAdminModal()">
                            <i class="fas fa-user-plus"></i> Add Admin
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Profile</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Permissions</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="admins-list">
                            <tr>
                                <td colspan="8" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Reports -->
            <section id="reports-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Reports & Issues</h1>
                    <div class="table-actions">
                        <button class="action-btn" id="filter-reported">
                            <i class="fas fa-flag"></i> Reported
                        </button>
                        <button class="action-btn" id="filter-resolved">
                            <i class="fas fa-check"></i> Resolved
                        </button>
                        <button class="action-btn" onclick="exportReportsData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Reporter</th>
                                <th>Reported User</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Reported At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-list">
                            <tr>
                                <td colspan="7" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Analytics -->
            <section id="analytics-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Analytics Dashboard</h1>
                    <div class="table-actions">
                        <select id="analytics-period" style="padding: 8px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month" selected>This Month</option>
                            <option value="quarter">This Quarter</option>
                            <option value="year">This Year</option>
                        </select>
                        <button class="action-btn" onclick="exportAnalyticsData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon users">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="stat-trend" id="new-users-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="new-users">0</div>
                        <div class="stat-label">New Users</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon missions">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="stat-trend" id="completed-missions-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="completed-missions">0</div>
                        <div class="stat-label">Completed Missions</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon zones">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="stat-trend" id="coins-earned-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="coins-earned">0</div>
                        <div class="stat-label">Coins Earned</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon sos">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-trend" id="purchases-trend">+0%</div>
                        </div>
                        <div class="stat-value" id="purchases-count">0</div>
                        <div class="stat-label">Purchases</div>
                    </div>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>Top Performing Zones</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Zone</th>
                                <th>Missions</th>
                                <th>Completions</th>
                                <th>Success Rate</th>
                                <th>Avg Time</th>
                            </tr>
                        </thead>
                        <tbody id="zones-analytics">
                            <tr>
                                <td colspan="5" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>User Activity Timeline</h3>
                    </div>
                    <div id="activity-timeline" class="p-4" style="min-height: 200px;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </section>

            <!-- Export Data -->
            <section id="export-section" class="content-section">
                <div class="dashboard-header">
                    <h1>Export Data</h1>
                    <div class="table-actions">
                        <button class="action-btn primary" onclick="exportAllData()">
                            <i class="fas fa-download"></i> Export All Data
                        </button>
                    </div>
                </div>
                
                <div class="settings-grid">
                    <div class="settings-section">
                        <h4>Export Options</h4>
                        <div class="form-group">
                            <label>Export Format</label>
                            <select id="export-format">
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                                <option value="excel">Excel</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Date Range</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <input type="date" id="export-start-date">
                                <input type="date" id="export-end-date">
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Include Media Files</h5>
                                <p>Export submitted photos/videos</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="include-media">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Include User Data</h5>
                                <p>Export user profiles and data</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="include-users" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Data Categories</h4>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>User Data</h5>
                                <p>User profiles, coins, activity</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="export-users-data" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Mission Data</h5>
                                <p>Missions, submissions, reviews</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="export-missions-data" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Zone Data</h5>
                                <p>Zones, coordinates, radius</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="export-zones-data" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Prize Data</h5>
                                <p>Prizes, purchases, inventory</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="export-prizes-data" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>SOS Data</h5>
                                <p>Emergency alerts, responses</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="export-sos-data" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Analytics Data</h5>
                                <p>Statistics, trends, reports</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="export-analytics-data" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Export Actions</h4>
                        <div class="quick-actions" style="grid-template-columns: 1fr;">
                            <button class="action-btn" onclick="exportUserData()">
                                <i class="fas fa-users"></i> Export User Data
                            </button>
                            <button class="action-btn" onclick="exportMissionData()">
                                <i class="fas fa-tasks"></i> Export Mission Data
                            </button>
                            <button class="action-btn" onclick="exportZoneData()">
                                <i class="fas fa-draw-polygon"></i> Export Zone Data
                            </button>
                            <button class="action-btn" onclick="exportPrizeData()">
                                <i class="fas fa-gift"></i> Export Prize Data
                            </button>
                            <button class="action-btn" onclick="exportSOSData()">
                                <i class="fas fa-exclamation-triangle"></i> Export SOS Data
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>Export History</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Export Date</th>
                                <th>Type</th>
                                <th>Format</th>
                                <th>Size</th>
                                <th>Download</th>
                            </tr>
                        </thead>
                        <tbody id="export-history">
                            <tr>
                                <td colspan="5" class="text-center p-4">
                                    No export history
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- System Settings -->
            <section id="settings-section" class="content-section">
                <div class="dashboard-header">
                    <h1>System Settings</h1>
                    <div class="table-actions">
                        <button class="action-btn primary" onclick="saveSystemSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        <button class="action-btn" onclick="resetSystemSettings()">
                            <i class="fas fa-undo"></i> Reset to Default
                        </button>
                    </div>
                </div>
                
                <div class="settings-grid">
                    <div class="settings-section">
                        <h4>General Settings</h4>
                        <div class="form-group">
                            <label>Site Title</label>
                            <input type="text" id="site-title" value="The Hunt">
                        </div>
                        <div class="form-group">
                            <label>Admin Email</label>
                            <input type="email" id="admin-email-settings" placeholder="admin@example.com">
                        </div>
                        <div class="form-group">
                            <label>Contact Phone</label>
                            <input type="tel" id="contact-phone" placeholder="+264 81 234 5678">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Maintenance Mode</h5>
                                <p>Temporarily disable the site</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="maintenance-mode">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Security</h4>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Require Email Verification</h5>
                                <p>Users must verify email</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="email-verification" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Two-Factor Authentication</h5>
                                <p>Require 2FA for admins</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="two-factor-auth">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Session Timeout (minutes)</label>
                            <input type="number" id="session-timeout" min="5" max="480" value="60">
                        </div>
                        <div class="form-group">
                            <label>Max Login Attempts</label>
                            <input type="number" id="max-login-attempts" min="1" max="10" value="5">
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>Storage & Backup</h4>
                        <div class="form-group">
                            <label>Max File Size (MB)</label>
                            <input type="number" id="max-file-size" min="1" max="100" value="10">
                        </div>
                        <div class="form-group">
                            <label>Allowed File Types</label>
                            <input type="text" id="allowed-file-types" value="jpg,jpeg,png,gif,mp4,webm">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Auto Backup</h5>
                                <p>Automatically backup data</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="auto-backup" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label>Backup Frequency</label>
                            <select id="backup-frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>API & Integrations</h4>
                        <div class="form-group">
                            <label>Mapbox Access Token</label>
                            <input type="password" id="mapbox-token" placeholder="Enter Mapbox token">
                        </div>
                        <div class="form-group">
                            <label>SMS Gateway API Key</label>
                            <input type="password" id="sms-api-key" placeholder="Enter SMS API key">
                        </div>
                        <div class="form-group">
                            <label>Email Service</label>
                            <select id="email-service">
                                <option value="smtp">SMTP</option>
                                <option value="sendgrid">SendGrid</option>
                                <option value="mailgun">Mailgun</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Enable API</h5>
                                <p>Enable REST API access</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="enable-api">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>System Information</h3>
                    </div>
                    <table class="data-table">
                        <tbody id="system-info">
                            <tr>
                                <td style="width: 200px; font-weight: 600;">Database Size</td>
                                <td id="db-size">Loading...</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">Storage Usage</td>
                                <td id="storage-usage">Loading...</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">Last Backup</td>
                                <td id="last-backup">Never</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">System Version</td>
                                <td id="system-version">1.0.0</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">Uptime</td>
                                <td id="system-uptime">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- SOS Alerts -->
            <section id="sos-alerts-section" class="content-section">
                <div class="dashboard-header">
                    <h1>SOS Emergency Alerts</h1>
                    <div class="table-actions">
                        <button class="action-btn success" id="acknowledge-all-sos">
                            <i class="fas fa-check-double"></i> Acknowledge All
                        </button>
                        <button class="action-btn" onclick="exportSOSData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Active SOS Alerts</h3>
                        <input type="text" class="table-search" placeholder="Search alerts..." id="search-sos">
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Location</th>
                                <th>Phone</th>
                                <th>Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sos-alerts-list">
                            <tr>
                                <td colspan="6" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="data-table-container mt-4">
                    <div class="table-header">
                        <h3>SOS Alert History</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Location</th>
                                <th>Time</th>
                                <th>Acknowledged By</th>
                                <th>Response Time</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="sos-history-list">
                            <tr>
                                <td colspan="6" class="text-center p-4">
                                    <div class="loading-spinner"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Create Mission Modal -->
    <div id="mission-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Create New Mission</h3>
                <button class="modal-close" id="close-mission-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mission-form-grid">
                    <div class="form-group">
                        <label>Mission Title *</label>
                        <input type="text" id="mission-title" placeholder="Enter mission title">
                    </div>
                    <div class="form-group">
                        <label>Mission Type *</label>
                        <select id="mission-type">
                            <option value="photo">Photo</option>
                            <option value="video">Video</option>
                            <option value="audio">Audio</option>
                            <option value="text">Text Answer</option>
                            <option value="qr_scan">QR Scan</option>
                            <option value="gps_checkin">GPS Check-in</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Zone *</label>
                        <select id="mission-zone"></select>
                    </div>
                    <div class="form-group">
                        <label>Points *</label>
                        <input type="number" id="mission-points" min="10" max="1000" value="100">
                    </div>
                    <div class="form-group">
                        <label>Question/Instruction *</label>
                        <textarea id="mission-question" placeholder="What should the player do?" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Media Required</label>
                        <input type="number" id="mission-media-count" min="0" max="10" value="1">
                    </div>
                    <div class="form-group">
                        <label>Max Video Duration (seconds)</label>
                        <input type="number" id="mission-video-duration" min="1" max="60" value="10">
                    </div>
                    <div class="form-group">
                        <label>Difficulty</label>
                        <select id="mission-difficulty">
                            <option value="easy">Easy</option>
                            <option value="medium" selected>Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Time Limit (minutes, 0 = no limit)</label>
                        <input type="number" id="mission-time-limit" min="0" max="120" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label>Additional Instructions</label>
                    <textarea id="mission-instructions" placeholder="Additional instructions for the player..." rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>GPS Coordinates (for GPS missions)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <input type="number" id="mission-latitude" step="any" placeholder="Latitude">
                        <input type="number" id="mission-longitude" step="any" placeholder="Longitude">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancel-mission">Cancel</button>
                <button class="action-btn primary" id="save-mission">Create Mission</button>
            </div>
        </div>
    </div>

    <!-- Create Prize Modal -->
    <div id="prize-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Add New Prize</h3>
                <button class="modal-close" id="close-prize-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-upload-container">
                    <label>Prize Image</label>
                    <div class="image-preview empty" id="prize-image-preview">
                        <i class="fas fa-camera"></i>
                    </div>
                    <input type="file" id="prize-image-upload" accept="image/*" style="display: none;">
                    <button class="action-btn mt-2" onclick="document.getElementById('prize-image-upload').click()">
                        <i class="fas fa-upload"></i> Upload Image
                    </button>
                </div>
                
                <div class="mission-form-grid">
                    <div class="form-group">
                        <label>Prize Name *</label>
                        <input type="text" id="prize-name" placeholder="Enter prize name">
                    </div>
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="prize-description" placeholder="Enter prize description" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Price (coins) *</label>
                        <input type="number" id="prize-price" min="1" value="100">
                    </div>
                    <div class="form-group">
                        <label>Quantity *</label>
                        <input type="number" id="prize-quantity" min="1" value="10">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="prize-category">
                            <option value="physical">Physical</option>
                            <option value="digital">Digital</option>
                            <option value="voucher">Voucher</option>
                            <option value="experience">Experience</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Expiry Date (optional)</label>
                        <input type="date" id="prize-expiry">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Redemption Instructions</label>
                    <textarea id="prize-redemption" placeholder="How to redeem this prize..." rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancel-prize">Cancel</button>
                <button class="action-btn primary" id="save-prize">Add Prize</button>
            </div>
        </div>
    </div>

    <!-- Edit Zone Modal -->
    <div id="edit-zone-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Edit Zone</h3>
                <button class="modal-close" id="close-edit-zone-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="zone-form-grid">
                    <div class="form-group">
                        <label>Zone Name *</label>
                        <input type="text" id="edit-zone-name" placeholder="Enter zone name">
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="edit-zone-description" placeholder="Zone description"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Radius (meters)</label>
                        <div class="radius-control">
                            <input type="range" id="edit-zone-radius" min="50" max="500" value="100" step="10">
                            <span id="edit-radius-value" class="radius-value">100m</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="edit-zone-status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" id="edit-zone-lat" step="any" placeholder="Latitude">
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" id="edit-zone-lng" step="any" placeholder="Longitude">
                    </div>
                </div>
                <div class="form-group">
                    <label>Zone Missions</label>
                    <div id="zone-missions-list" class="p-3 bg-gray-900 rounded">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn danger" id="delete-zone-btn">Delete Zone</button>
                <button class="action-btn" id="cancel-edit-zone">Cancel</button>
                <button class="action-btn primary" id="save-edit-zone">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Add New User</h3>
                <button class="modal-close" id="close-add-user-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mission-form-grid">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" id="new-user-name" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" id="new-user-email" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="new-user-phone" placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label>Initial Coins</label>
                        <input type="number" id="new-user-coins" min="0" value="100">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select id="new-user-role">
                            <option value="player">Player</option>
                            <option value="admin">Admin</option>
                            <option value="moderator">Moderator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" id="new-user-password" placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <input type="password" id="new-user-confirm-password" placeholder="Confirm password">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancel-add-user">Cancel</button>
                <button class="action-btn primary" id="save-add-user">Add User</button>
            </div>
        </div>
    </div>

    <!-- Add Admin Modal -->
    <div id="add-admin-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>Add New Admin</h3>
                <button class="modal-close" id="close-add-admin-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mission-form-grid">
                    <div class="form-group">
                        <label>Select User</label>
                        <select id="select-admin-user">
                            <option value="">Select a user...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Admin Level</label>
                        <select id="admin-level">
                            <option value="super_admin">Super Admin</option>
                            <option value="admin">Admin</option>
                            <option value="moderator">Moderator</option>
                            <option value="support">Support</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Permissions</label>
                    <div id="admin-permissions" class="p-3 bg-gray-900 rounded">
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>User Management</h5>
                                <p>Manage users and permissions</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="perm-users" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Mission Management</h5>
                                <p>Create and edit missions</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="perm-missions" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Zone Management</h5>
                                <p>Create and edit zones</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="perm-zones" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Prize Management</h5>
                                <p>Manage prizes and inventory</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="perm-prizes" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Review Missions</h5>
                                <p>Approve/reject submissions</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="perm-reviews" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>SOS Management</h5>
                                <p>Handle emergency alerts</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="perm-sos" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Settings Access</h5>
                                <p>Change system settings</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="perm-settings">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <h5>Export Data</h5>
                                <p>Export system data</p>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="perm-export">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="cancel-add-admin">Cancel</button>
                <button class="action-btn primary" id="save-add-admin">Add Admin</button>
            </div>
        </div>
    </div>

    <!-- Bulk Review Modal -->
    <div id="bulk-review-modal" class="modal-overlay">
        <div class="modal-container" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Bulk Mission Review</h3>
                <button class="modal-close" id="close-bulk-review-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Missions to Approve</label>
                    <div id="bulk-mission-list" class="p-3 bg-gray-900 rounded" style="max-height: 300px; overflow-y: auto;">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Points to Award</label>
                    <input type="number" id="bulk-points" min="0" value="100">
                </div>
                <div class="form-group">
                    <label>Comments (optional)</label>
                    <textarea id="bulk-comments" placeholder="Comments for all selected missions..." rows="2"></textarea>
                </div>
            </div>
                        <div class="modal-footer">
                <button class="action-btn" id="cancel-bulk-review">Cancel</button>
                <button class="action-btn success" id="approve-bulk-btn">Approve Selected</button>
                <button class="action-btn danger" id="reject-bulk-btn">Reject Selected</button>
            </div>
        </div>
    </div>

    <!-- SOS Details Modal -->
    <div id="sos-details-modal" class="modal-overlay">
        <div class="modal-container" style="max-width: 600px;">
            <div class="modal-header">
                <h3 style="color: var(--red);"><i class="fas fa-exclamation-triangle"></i> SOS Alert Details</h3>
                <button class="modal-close" id="close-sos-details-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mission-form-grid">
                    <div class="form-group">
                        <label>User</label>
                        <div id="sos-user-info" style="display: flex; align-items: center; gap: 12px;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <div id="sos-location" style="font-weight: 600; color: var(--red);">
                            <i class="fas fa-map-marker-alt"></i> Loading location...
                        </div>
                        <div id="sos-accuracy" style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;"></div>
                    </div>
                    <div class="form-group">
                        <label>Time</label>
                        <div id="sos-time" style="font-weight: 600;"></div>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <div id="sos-phone" style="font-weight: 600;">
                            <i class="fas fa-phone"></i> <span id="sos-phone-number">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Additional Notes</label>
                    <textarea id="sos-notes" placeholder="Add notes about this emergency..." rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Emergency Contacts Called</label>
                    <div class="quick-actions">
                        <button class="action-btn" id="call-ambulance" style="background: var(--red); color: white;">
                            <i class="fas fa-ambulance"></i> Call Ambulance
                        </button>
                        <button class="action-btn" id="call-police" style="background: var(--blue); color: white;">
                            <i class="fas fa-shield-alt"></i> Call Police
                        </button>
                        <button class="action-btn" id="call-user" style="background: var(--green); color: white;">
                            <i class="fas fa-phone"></i> Call User
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="acknowledge-sos-btn">
                    <i class="fas fa-check"></i> Acknowledge
                </button>
                <button class="action-btn danger" id="resolve-sos-btn">
                    <i class="fas fa-check-double"></i> Mark Resolved
                </button>
            </div>
        </div>
    </div>

    <!-- Media View Modal -->
    <div id="media-view-modal" class="modal-overlay">
        <div class="modal-container" style="max-width: 90vw; max-height: 90vh;">
            <div class="modal-header">
                <h3>Media Submission</h3>
                <button class="modal-close" id="close-media-view-modal">&times;</button>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0;">
                <div id="media-view-container" style="width: 100%; max-height: 70vh; display: flex; align-items: center; justify-content: center;">
                    <div class="loading-spinner"></div>
                </div>
                <div id="media-info" style="padding: 20px; text-align: center; width: 100%;">
                    <p id="media-submission-info" style="color: var(--text-secondary); font-size: 13px;">Loading...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn" id="prev-media">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button class="action-btn primary" id="approve-media">
                    <i class="fas fa-check"></i> Approve
                </button>
                <button class="action-btn danger" id="reject-media">
                    <i class="fas fa-times"></i> Reject
                </button>
                <button class="action-btn" id="next-media">
                    <i class="fas fa-chevron-right"></i> Next
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- SOS Alert Popup -->
    <div id="sos-alert-popup" class="sos-alert">
        <div class="sos-header">
            <i class="fas fa-exclamation-triangle"></i>
            <h4>NEW SOS ALERT!</h4>
            <button class="sos-close" id="close-sos-alert">&times;</button>
        </div>
        <div class="sos-content" style="margin-bottom: 16px;">
            <p id="sos-alert-message" style="margin: 0; font-size: 13px;">
                User is requesting emergency assistance
            </p>
            <p id="sos-alert-location" style="margin: 8px 0 0 0; font-size: 12px; color: rgba(255,255,255,0.8);">
                <i class="fas fa-map-marker-alt"></i> Loading location...
            </p>
        </div>
        <div class="sos-actions">
            <button class="action-btn" id="view-sos-alert" style="background: white; color: var(--red);">
                <i class="fas fa-eye"></i> View Details
            </button>
            <button class="action-btn" id="acknowledge-sos-alert" style="background: transparent; border: 1px solid white;">
                <i class="fas fa-check"></i> Acknowledge
            </button>
        </div>
    </div>

    <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
        SUPABASE_URL: 'https://wnmncsbbtlpcwviicsbr.supabase.co',
        SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubW5jc2JidGxwY3d2aWljc2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDU3MTMsImV4cCI6MjA4MTY4MTcxM30.pSOYbXWPLhKItpfDnRMfi3lyPVOvTccQudvN9YIucVs',
        MAPBOX_TOKEN: 'pk.eyJ1IjoianVzYSIsImEiOiJjbWpjanh5amEwbDEwM2dzOXVhbjZ5dzcwIn0.stWdbPHCrf9sKrRJRmShlg',
        DEFAULT_LOCATION: { lat: -22.68, lng: 17.08 },
        ADMIN_ROLES: {
            SUPER_ADMIN: 'super_admin',
            ADMIN: 'admin',
            MODERATOR: 'moderator',
            SUPPORT: 'support'
        },
        MISSION_STATUS: {
            PENDING: 'pending',
            APPROVED: 'approved',
            REJECTED: 'rejected'
        }
    };

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Admin App Initializing...');
        
        // Initialize Supabase
        window.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        
        // Global State
        window.adminState = {
            currentAdmin: null,
            currentSession: null,
            map: null,
            drawingMode: false,
            currentZone: null,
            selectedSubmission: null,
            selectedSOS: null,
            currentSection: 'overview',
            zones: [],
            missions: [],
            users: [],
            pendingReviews: 0,
            activeSOS: 0,
            mapMarkers: [],
            mapLayers: [],
            realTimeChannels: [],
            selectedZone: null
        };

        // Initialize the app
        initAdminApp();
    });

    // ============================================
    // ADMIN APP INITIALIZATION
    // ============================================
    async function initAdminApp() {
        console.log('Initializing admin app...');
        
        // Setup event listeners
        setupAdminEventListeners();
        
        // Check authentication
        await checkAdminAuth();
        
        console.log('Admin app initialized successfully');
    }

    // ============================================
    // ADMIN AUTHENTICATION
    // ============================================
    async function checkAdminAuth() {
        console.log('Checking admin authentication...');
        
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
            console.error('Auth error:', error);
            showLogin();
            return;
        }
        
        if (session) {
            adminState.currentSession = session;
            await loadAdminProfile(session.user.id);
            showDashboard();
            setupRealTimeSubscriptions();
            loadDashboardData();
        } else {
            showLogin();
        }
    }

    async function adminLogin() {
        const email = document.getElementById('admin-email').value;
        const password = document.getElementById('admin-password').value;
        
        if (!email || !password) {
            showAdminError('Please fill in all fields');
            return;
        }

        const btn = document.getElementById('login-btn');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;

            console.log('Admin login successful:', data.user.email);
            adminState.currentSession = data.session;
            await loadAdminProfile(data.user.id);
            showDashboard();
            showToast('Signed in successfully', 'success');
        } catch (error) {
            showAdminError(error.message || 'Login failed');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function loadAdminProfile(userId) {
        console.log('Loading admin profile:', userId);
        
        // First check if user exists in admin_users table
        const { data: adminData, error: adminError } = await supabase
            .from('admin_users')
            .select('*')
            .eq('user_id', userId)
            .maybeSingle();
        
        if (adminError) {
            console.error('Error loading admin profile:', adminError);
            await logoutAdmin();
            return;
        }
        
        if (!adminData) {
            // Not an admin - redirect or show error
            showAdminError('Access denied. Admin privileges required.');
            await logoutAdmin();
            return;
        }
        
        // Get user details from users table
        const { data: userData, error: userError } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();
        
        if (userError) {
            console.error('Error loading user details:', userError);
            // Still allow admin login with basic info
            adminState.currentAdmin = {
                id: userId,
                name: adminData.name || 'Admin',
                email: adminData.email || '',
                role: adminData.role || 'admin',
                permissions: adminData.permissions || {},
                avatar_url: adminData.avatar_url || ''
            };
        } else {
            adminState.currentAdmin = {
                ...userData,
                role: adminData.role,
                permissions: adminData.permissions || {},
                admin_id: adminData.id
            };
        }
        
        console.log('Admin loaded:', adminState.currentAdmin.name);
        
        // Update UI
        document.getElementById('admin-name').textContent = adminState.currentAdmin.name;
        document.getElementById('admin-role').textContent = adminState.currentAdmin.role;
        
        if (adminState.currentAdmin.avatar_url) {
            document.getElementById('admin-avatar-img').src = adminState.currentAdmin.avatar_url;
        }
    }

    async function logoutAdmin() {
        try {
            await supabase.auth.signOut();
            adminState.currentAdmin = null;
            adminState.currentSession = null;
            
            // Stop all real-time subscriptions
            if (adminState.realTimeChannels.length > 0) {
                adminState.realTimeChannels.forEach(channel => {
                    supabase.removeChannel(channel);
                });
                adminState.realTimeChannels = [];
            }
            
            showLogin();
            showToast('Logged out successfully', 'success');
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    // ============================================
    // EVENT LISTENERS SETUP
    // ============================================
    function setupAdminEventListeners() {
        console.log('Setting up admin event listeners...');
        
        // Login form
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            adminLogin();
        });
        
        // Sidebar navigation
        document.querySelectorAll('.sidebar-item').forEach(item => {
            if (!item.id.includes('logout')) {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            }
        });
        
        // Logout button
        document.getElementById('logout-btn').addEventListener('click', logoutAdmin);
        
        // Sidebar toggle for mobile
        const sidebarToggle = document.getElementById('sidebar-toggle');
        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', function() {
                document.getElementById('admin-sidebar').classList.toggle('active');
            });
        }
        
        // Notification bell
        document.getElementById('notifications-btn').addEventListener('click', function() {
            showSection('mission-review');
        });
        
        // Refresh buttons
        document.getElementById('refresh-overview')?.addEventListener('click', loadDashboardData);
        document.getElementById('refresh-map')?.addEventListener('click', refreshMapData);
        
        // Zone creation buttons
        document.getElementById('save-zone-btn')?.addEventListener('click', saveZone);
        document.getElementById('save-zone-btn-static')?.addEventListener('click', saveZone);
        document.getElementById('clear-zone-btn')?.addEventListener('click', clearZoneDrawing);
        document.getElementById('clear-zone-btn-static')?.addEventListener('click', clearZoneDrawing);
        
        // Mission modal
        document.getElementById('close-mission-modal')?.addEventListener('click', closeMissionModal);
        document.getElementById('cancel-mission')?.addEventListener('click', closeMissionModal);
        document.getElementById('save-mission')?.addEventListener('click', saveMission);
        
        // Prize modal
        document.getElementById('close-prize-modal')?.addEventListener('click', closePrizeModal);
        document.getElementById('cancel-prize')?.addEventListener('click', closePrizeModal);
        document.getElementById('save-prize')?.addEventListener('click', savePrize);
        document.getElementById('prize-image-upload')?.addEventListener('change', handlePrizeImageUpload);
        
        // Edit zone modal
        document.getElementById('close-edit-zone-modal')?.addEventListener('click', closeEditZoneModal);
        document.getElementById('cancel-edit-zone')?.addEventListener('click', closeEditZoneModal);
        document.getElementById('save-edit-zone')?.addEventListener('click', updateZone);
        document.getElementById('delete-zone-btn')?.addEventListener('click', deleteZone);
        
        // Add user modal
        document.getElementById('close-add-user-modal')?.addEventListener('click', closeAddUserModal);
        document.getElementById('cancel-add-user')?.addEventListener('click', closeAddUserModal);
        document.getElementById('save-add-user')?.addEventListener('click', saveNewUser);
        
        // Add admin modal
        document.getElementById('close-add-admin-modal')?.addEventListener('click', closeAddAdminModal);
        document.getElementById('cancel-add-admin')?.addEventListener('click', closeAddAdminModal);
        document.getElementById('save-add-admin')?.addEventListener('click', saveNewAdmin);
        
        // SOS alert popup
        document.getElementById('close-sos-alert')?.addEventListener('click', closeSOSAlert);
        document.getElementById('view-sos-alert')?.addEventListener('click', viewSOSAlert);
        document.getElementById('acknowledge-sos-alert')?.addEventListener('click', acknowledgeSOSAlert);
        
        // SOS details modal
        document.getElementById('close-sos-details-modal')?.addEventListener('click', closeSOSDetailsModal);
        document.getElementById('acknowledge-sos-btn')?.addEventListener('click', acknowledgeSOS);
        document.getElementById('resolve-sos-btn')?.addEventListener('click', resolveSOS);
        document.getElementById('call-ambulance')?.addEventListener('click', () => callEmergency('ambulance'));
        document.getElementById('call-police')?.addEventListener('click', () => callEmergency('police'));
        document.getElementById('call-user')?.addEventListener('click', callSOSUser);
        
        // Media view modal
        document.getElementById('close-media-view-modal')?.addEventListener('click', closeMediaViewModal);
        document.getElementById('approve-media')?.addEventListener('click', approveMedia);
        document.getElementById('reject-media')?.addEventListener('click', rejectMedia);
        document.getElementById('prev-media')?.addEventListener('click', showPrevMedia);
        document.getElementById('next-media')?.addEventListener('click', showNextMedia);
        
        // Bulk review modal
        document.getElementById('close-bulk-review-modal')?.addEventListener('click', closeBulkReviewModal);
        document.getElementById('cancel-bulk-review')?.addEventListener('click', closeBulkReviewModal);
        document.getElementById('approve-bulk-btn')?.addEventListener('click', approveBulk);
        document.getElementById('reject-bulk-btn')?.addEventListener('click', rejectBulk);
        
        // Map controls
        document.getElementById('map-zoom-in')?.addEventListener('click', () => adminState.map?.zoomIn());
        document.getElementById('map-zoom-out')?.addEventListener('click', () => adminState.map?.zoomOut());
        document.getElementById('map-center')?.addEventListener('click', centerMap);
        document.getElementById('map-show-players')?.addEventListener('click', togglePlayers);
        document.getElementById('map-show-zones')?.addEventListener('click', toggleZones);
        document.getElementById('map-show-sos')?.addEventListener('click', toggleSOS);
        
        // Filter buttons
        document.getElementById('filter-pending')?.addEventListener('click', () => filterSubmissions('pending'));
        document.getElementById('filter-approved')?.addEventListener('click', () => filterSubmissions('approved'));
        document.getElementById('filter-rejected')?.addEventListener('click', () => filterSubmissions('rejected'));
        document.getElementById('filter-reported')?.addEventListener('click', () => filterReports('reported'));
        document.getElementById('filter-resolved')?.addEventListener('click', () => filterReports('resolved'));
        
        // Export buttons
        document.getElementById('export-users')?.addEventListener('click', exportUserData);
        document.getElementById('export-map-data')?.addEventListener('click', exportMapData);
        
        // Search inputs
        setupSearchListeners();
        
        console.log('Admin event listeners setup complete');
    }

    function setupSearchListeners() {
        const searchInputs = [
            { id: 'search-zones', callback: searchZones },
            { id: 'search-missions', callback: searchMissions },
            { id: 'search-prizes', callback: searchPrizes },
            { id: 'search-purchases', callback: searchPurchases },
            { id: 'search-users', callback: searchUsers },
            { id: 'search-sos', callback: searchSOS },
            { id: 'search-activity', callback: searchActivity },
            { id: 'search-submissions', callback: searchSubmissions }
        ];
        
        searchInputs.forEach(({ id, callback }) => {
            const input = document.getElementById(id);
            if (input) {
                input.addEventListener('input', callback);
            }
        });
    }

    // ============================================
    // UI FUNCTIONS
    // ============================================
    function showLogin() {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('admin-dashboard').style.display = 'none';
        clearAdminError();
    }

    function showDashboard() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('admin-dashboard').style.display = 'block';
        
        // Initialize map if needed
        if (!adminState.map && adminState.currentSection === 'live-map') {
            setTimeout(initializeMap, 100);
        }
    }

    function showSection(sectionName) {
        // Close sidebar on mobile
        if (window.innerWidth <= 768) {
            document.getElementById('admin-sidebar').classList.remove('active');
        }
        
        // Update current section
        adminState.currentSection = sectionName;
        
        // Hide all sections
        document.querySelectorAll('.content-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Remove active from all sidebar items
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Show selected section
        const sectionElement = document.getElementById(`${sectionName}-section`);
        if (sectionElement) {
            sectionElement.classList.add('active');
            
            // Set active sidebar item
            document.querySelectorAll('.sidebar-item').forEach(item => {
                if (item.getAttribute('data-section') === sectionName) {
                    item.classList.add('active');
                }
            });
            
            // Load section data
            switch(sectionName) {
                case 'overview':
                    loadDashboardData();
                    break;
                case 'live-map':
                    if (!adminState.map) {
                        initializeMap();
                    } else {
                        refreshMapData();
                    }
                    break;
                case 'zones-missions':
                    loadZones();
                    loadMissions();
                    break;
                case 'mission-review':
                    loadSubmissions();
                    break;
                case 'prizes':
                    loadPrizes();
                    loadPurchases();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'admins':
                    loadAdmins();
                    break;
                case 'reports':
                    loadReports();
                    break;
                case 'sos-alerts':
                    loadSOSAlerts();
                    loadSOSHistory();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;
                case 'settings':
                    loadSystemInfo();
                    break;
            }
        }
    }

    function showAdminError(message) {
        const errorEl = document.getElementById('login-error');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        setTimeout(() => errorEl.style.display = 'none', 5000);
    }

    function clearAdminError() {
        document.getElementById('login-error').style.display = 'none';
    }

    // ============================================
    // TOAST NOTIFICATIONS
    // ============================================
    function showToast(message, type = 'info') {
        console.log('Admin Toast:', message);
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <div class="toast-icon">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                </div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        const container = document.getElementById('toast-container');
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode === container) {
                    container.removeChild(toast);
                }
            }, 300);
        }, 5000);
    }

    // ============================================
    // MODAL MANAGEMENT
    // ============================================
    function showCreateZoneModal() {
        document.getElementById('zone-creation-panel').style.display = 'block';
        document.getElementById('zone-creation-static').style.display = 'block';
        startZoneDrawing();
    }

    function hideZoneCreation() {
        document.getElementById('zone-creation-panel').style.display = 'none';
        document.getElementById('zone-creation-static').style.display = 'none';
        stopZoneDrawing();
    }

    function showCreateMissionModal() {
        loadZonesForMission();
        document.getElementById('mission-modal').style.display = 'flex';
    }

    function closeMissionModal() {
        document.getElementById('mission-modal').style.display = 'none';
        resetMissionForm();
    }

    function showCreatePrizeModal() {
        document.getElementById('prize-modal').style.display = 'flex';
    }

    function closePrizeModal() {
        document.getElementById('prize-modal').style.display = 'none';
        resetPrizeForm();
    }

    function showEditZoneModal(zoneId) {
        loadZoneForEdit(zoneId);
        document.getElementById('edit-zone-modal').style.display = 'flex';
    }

    function closeEditZoneModal() {
        document.getElementById('edit-zone-modal').style.display = 'none';
        adminState.selectedZone = null;
    }

    function showAddUserModal() {
        document.getElementById('add-user-modal').style.display = 'flex';
    }

    function closeAddUserModal() {
        document.getElementById('add-user-modal').style.display = 'none';
        resetAddUserForm();
    }

    function showAddAdminModal() {
        loadUsersForAdmin();
        document.getElementById('add-admin-modal').style.display = 'flex';
    }

    function closeAddAdminModal() {
        document.getElementById('add-admin-modal').style.display = 'none';
        resetAddAdminForm();
    }

    function showBulkReviewModal() {
        loadSubmissionsForBulk();
        document.getElementById('bulk-review-modal').style.display = 'flex';
    }

    function closeBulkReviewModal() {
        document.getElementById('bulk-review-modal').style.display = 'none';
    }

    function showSOSDetailsModal(sosId) {
        loadSOSDetails(sosId);
        document.getElementById('sos-details-modal').style.display = 'flex';
    }

    function closeSOSDetailsModal() {
        document.getElementById('sos-details-modal').style.display = 'none';
        adminState.selectedSOS = null;
    }

    function showMediaViewModal(submissionId) {
        loadMediaForView(submissionId);
        document.getElementById('media-view-modal').style.display = 'flex';
    }

    function closeMediaViewModal() {
        document.getElementById('media-view-modal').style.display = 'none';
        adminState.selectedSubmission = null;
    }

    function showSOSAlert(sosData) {
        const popup = document.getElementById('sos-alert-popup');
        document.getElementById('sos-alert-message').textContent = 
            `${sosData.user_name} is requesting emergency assistance`;
        document.getElementById('sos-alert-location').innerHTML = 
            `<i class="fas fa-map-marker-alt"></i> ${sosData.latitude.toFixed(4)}, ${sosData.longitude.toFixed(4)}`;
        
        popup.style.display = 'block';
        popup.dataset.sosId = sosData.id;
        
        // Auto-close after 30 seconds
        setTimeout(() => {
            if (popup.style.display === 'block') {
                closeSOSAlert();
            }
        }, 30000);
    }

    function closeSOSAlert() {
        document.getElementById('sos-alert-popup').style.display = 'none';
    }

    // ============================================
    // DASHBOARD FUNCTIONS
    // ============================================
    async function loadDashboardData() {
        console.log('Loading dashboard data...');
        
        try {
            // Load stats concurrently
            const [
                usersCount,
                zonesCount,
                pendingReviews,
                activeSOS,
                recentActivity
            ] = await Promise.all([
                getTotalUsers(),
                getActiveZones(),
                getPendingReviews(),
                getActiveSOS(),
                getRecentActivity()
            ]);
            
            // Update stats
            document.getElementById('total-users').textContent = usersCount;
            document.getElementById('active-zones').textContent = zonesCount;
            document.getElementById('pending-reviews').textContent = pendingReviews;
            document.getElementById('active-sos').textContent = activeSOS;
            
            // Update sidebar badges
            updateSidebarBadges(pendingReviews, activeSOS);
            
            // Update recent activity
            updateRecentActivity(recentActivity);
            
            // Load trends (simplified for now)
            updateTrends();
            
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showToast('Failed to load dashboard data', 'error');
        }
    }

    async function getTotalUsers() {
        const { count, error } = await supabase
            .from('users')
            .select('*', { count: 'exact', head: true });
        
        return error ? 0 : count || 0;
    }

    async function getActiveZones() {
        const { count, error } = await supabase
            .from('zones')
            .select('*', { count: 'exact', head: true })
            .eq('is_active', true);
        
        return error ? 0 : count || 0;
    }

    async function getPendingReviews() {
        const { count, error } = await supabase
            .from('submissions')
            .select('*', { count: 'exact', head: true })
            .eq('review_status', 'pending');
        
        return error ? 0 : count || 0;
    }

    async function getActiveSOS() {
        const { count, error } = await supabase
            .from('sos_alerts')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'active');
        
        return error ? 0 : count || 0;
    }

    async function getRecentActivity() {
        const { data, error } = await supabase
            .from('submissions')
            .select(`
                *,
                users (name, avatar_url),
                missions (title)
            `)
            .order('created_at', { ascending: false })
            .limit(10);
        
        if (error) throw error;
        return data || [];
    }

    function updateRecentActivity(activities) {
        const tbody = document.getElementById('recent-activity');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (!activities || activities.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center p-4">
                        No recent activity
                    </td>
                </tr>
            `;
            return;
        }
        
        activities.forEach(activity => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${activity.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + activity.user_id}" 
                             class="user-avatar-small">
                        <span>${activity.users?.name || 'Unknown User'}</span>
                    </div>
                </td>
                <td>${getActivityType(activity.file_type)}</td>
                <td>${activity.missions?.title || 'Mission'}</td>
                <td>${formatTime(activity.created_at)}</td>
                <td>
                    <span class="status-badge status-${activity.review_status}">
                        ${activity.review_status}
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function getActivityType(fileType) {
        switch(fileType) {
            case 'photo': return 'Photo Submission';
            case 'video': return 'Video Submission';
            case 'audio': return 'Audio Submission';
            case 'text': return 'Text Answer';
            case 'gps': return 'GPS Check-in';
            default: return 'Mission Submission';
        }
    }

    function updateSidebarBadges(pendingReviews, activeSOS) {
        adminState.pendingReviews = pendingReviews;
        adminState.activeSOS = activeSOS;
        
        const reviewBadge = document.getElementById('review-sidebar-badge');
        const sosBadge = document.getElementById('sos-sidebar-badge');
        
        if (reviewBadge) {
            reviewBadge.textContent = pendingReviews;
            reviewBadge.style.display = pendingReviews > 0 ? 'inline-block' : 'none';
        }
        
        if (sosBadge) {
            sosBadge.textContent = activeSOS;
            sosBadge.style.display = activeSOS > 0 ? 'inline-block' : 'none';
        }
    }

    function updateTrends() {
        // Simplified trend calculation
        const trends = {
            users: '+12%',
            missions: '+8%',
            zones: '+5%',
            sos: '0'
        };
        
        document.getElementById('users-trend').textContent = trends.users;
        document.getElementById('missions-trend').textContent = trends.missions;
        document.getElementById('zones-trend').textContent = trends.zones;
        document.getElementById('sos-trend').textContent = trends.sos;
    }

    // ============================================
    // MAP FUNCTIONS
    // ============================================
    function initializeMap() {
        try {
            if (!mapboxgl.supported()) {
                console.warn('WebGL not supported');
                document.getElementById('admin-map').innerHTML = 
                    '<div class="text-center p-8"><i class="fas fa-exclamation-triangle"></i><p>Map not supported</p></div>';
                return;
            }
            
            mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;
            
            adminState.map = new mapboxgl.Map({
                container: 'admin-map',
                style: 'mapbox://styles/mapbox/dark-v11',
                center: [CONFIG.DEFAULT_LOCATION.lng, CONFIG.DEFAULT_LOCATION.lat],
                zoom: 13,
                attributionControl: false,
                maxZoom: 18,
                minZoom: 10
            });
            
            // Add navigation controls
            adminState.map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            
            adminState.map.on('load', function() {
                console.log('Admin map loaded successfully');
                loadMapData();
                
                // Start drawing if zone creation is active
                if (adminState.drawingMode) {
                    startZoneDrawing();
                }
            });
            
        } catch (error) {
            console.error('Map initialization error:', error);
            showToast('Map loading failed', 'error');
        }
    }

    async function loadMapData() {
        try {
            // Load players
            const { data: players, error: playersError } = await supabase
                .from('users')
                .select('id, name, avatar_url, last_location, last_active')
                .not('last_location', 'is', null)
                .limit(50);
            
            if (!playersError && players) {
                addPlayersToMap(players);
            }
            
            // Load zones
            const { data: zones, error: zonesError } = await supabase
                .from('zones')
                .select('*')
                .eq('is_active', true);
            
            if (!zonesError && zones) {
                addZonesToMap(zones);
            }
            
            // Load SOS alerts
            const { data: sosAlerts, error: sosError } = await supabase
                .from('sos_alerts')
                .select('*')
                .eq('status', 'active');
            
            if (!sosError && sosAlerts) {
                addSOSToMap(sosAlerts);
            }
            
        } catch (error) {
            console.error('Error loading map data:', error);
        }
    }

    function addPlayersToMap(players) {
        // Clear existing player markers
        adminState.mapMarkers = adminState.mapMarkers.filter(marker => {
            if (marker.type === 'player') {
                marker.marker.remove();
                return false;
            }
            return true;
        });
        
        // Add player markers
        players.forEach(player => {
            if (player.last_location?.lat && player.last_location?.lng) {
                const el = document.createElement('div');
                el.className = 'player-marker';
                el.style.width = '16px';
                el.style.height = '16px';
                el.style.backgroundColor = 'var(--blue)';
                el.style.borderRadius = '50%';
                el.style.border = '2px solid white';
                el.style.cursor = 'pointer';
                el.title = player.name;
                
                const marker = new mapboxgl.Marker(el)
                    .setLngLat([player.last_location.lng, player.last_location.lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`
                            <div style="padding: 8px; max-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <img src="${player.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + player.id}" 
                                         style="width: 32px; height: 32px; border-radius: 50%;">
                                    <div>
                                        <h4 style="margin: 0; font-size: 14px;">${player.name}</h4>
                                        <p style="margin: 0; font-size: 11px; color: #666;">
                                            Last active: ${formatTime(player.last_active)}
                                        </p>
                                    </div>
                                </div>
                                <button onclick="viewUser('${player.id}')" 
                                        style="width: 100%; padding: 6px 12px; background: var(--blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    View Profile
                                </button>
                            </div>
                        `))
                    .addTo(adminState.map);
                
                adminState.mapMarkers.push({ type: 'player', marker, id: player.id });
            }
        });
    }

    function addZonesToMap(zones) {
        // Clear existing zone layers
        if (adminState.map.getLayer('zones-layer')) {
            adminState.map.removeLayer('zones-layer');
        }
        if (adminState.map.getSource('zones')) {
            adminState.map.removeSource('zones');
        }
        
        // Prepare zone features
        const zoneFeatures = zones.map(zone => ({
            type: 'Feature',
            geometry: {
                type: 'Point',
                coordinates: [zone.coordinates?.lng || CONFIG.DEFAULT_LOCATION.lng, 
                             zone.coordinates?.lat || CONFIG.DEFAULT_LOCATION.lat]
            },
            properties: {
                id: zone.id,
                name: zone.name,
                radius: zone.radius_meters || 100
            }
        }));
        
        // Add zones as circles
        adminState.map.addSource('zones', {
            type: 'geojson',
            data: {
                type: 'FeatureCollection',
                features: zoneFeatures
            }
        });
        
        adminState.map.addLayer({
            id: 'zones-layer',
            type: 'circle',
            source: 'zones',
            paint: {
                'circle-radius': {
                    property: 'radius',
                    type: 'exponential',
                    stops: [
                        [0, 0],
                        [100, 10],
                        [500, 50]
                    ]
                },
                'circle-color': 'var(--purple)',
                'circle-opacity': 0.3,
                'circle-stroke-width': 2,
                'circle-stroke-color': 'var(--purple-light)'
            }
        });
        
        // Add click event for zones
        adminState.map.on('click', 'zones-layer', function(e) {
            const features = adminState.map.queryRenderedFeatures(e.point, {
                layers: ['zones-layer']
            });
            
            if (features.length > 0) {
                const zone = zones.find(z => z.id === features[0].properties.id);
                if (zone) {
                    new mapboxgl.Popup()
                        .setLngLat(e.lngLat)
                        .setHTML(`
                            <div style="padding: 8px; max-width: 200px;">
                                <h3 style="margin: 0 0 8px 0; color: var(--purple);">${zone.name}</h3>
                                <p style="margin: 0 0 4px 0; color: #666; font-size: 12px;">${zone.description || 'No description'}</p>
                                <p style="margin: 0; color: #888; font-size: 11px;">
                                    Radius: ${zone.radius_meters || 100}m
                                </p>
                                <button onclick="showEditZoneModal('${zone.id}')" 
                                        style="margin-top: 8px; padding: 6px 12px; background: var(--purple); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    Edit Zone
                                </button>
                            </div>
                        `)
                        .addTo(adminState.map);
                }
            }
        });
    }

    function addSOSToMap(sosAlerts) {
        // Clear existing SOS markers
        adminState.mapMarkers = adminState.mapMarkers.filter(marker => {
            if (marker.type === 'sos') {
                marker.marker.remove();
                return false;
            }
            return true;
        });
        
        // Add SOS markers
        sosAlerts.forEach(sos => {
            const el = document.createElement('div');
            el.className = 'sos-marker';
            el.style.width = '20px';
            el.style.height = '20px';
            el.style.backgroundColor = 'var(--red)';
            el.style.borderRadius = '50%';
            el.style.border = '2px solid white';
            el.style.cursor = 'pointer';
            el.style.animation = 'pulse 1s infinite';
            el.title = 'SOS Alert';
            
            const marker = new mapboxgl.Marker(el)
                .setLngLat([sos.longitude, sos.latitude])
                .setPopup(new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`
                        <div style="padding: 8px; max-width: 200px;">
                            <h3 style="margin: 0 0 8px 0; color: var(--red);">SOS ALERT</h3>
                            <p style="margin: 0 0 4px 0; font-size: 12px;">
                                <strong>${sos.user_name}</strong>
                            </p>
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: #666;">
                                Phone: ${sos.user_phone || 'Not provided'}
                            </p>
                            <p style="margin: 0 0 8px 0; font-size: 11px; color: #666;">
                                Time: ${formatTime(sos.created_at)}
                            </p>
                            <button onclick="showSOSDetailsModal('${sos.id}')" 
                                    style="width: 100%; padding: 6px 12px; background: var(--red); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                View Details
                            </button>
                        </div>
                    `))
                .addTo(adminState.map);
            
            adminState.mapMarkers.push({ type: 'sos', marker, id: sos.id });
        });
    }

    function startZoneDrawing() {
        if (!adminState.map) return;
        
        adminState.drawingMode = true;
        adminState.currentZone = {
            coordinates: null,
            radius: 100
        };
        
        // Update radius slider
        const radiusSlider = document.getElementById('zone-radius') || document.getElementById('zone-radius-static');
        const radiusValue = document.getElementById('radius-value') || document.getElementById('radius-value-static');
        
        if (radiusSlider && radiusValue) {
            radiusSlider.value = adminState.currentZone.radius;
            radiusValue.textContent = `${adminState.currentZone.radius}m`;
            
            radiusSlider.addEventListener('input', function() {
                adminState.currentZone.radius = parseInt(this.value);
                radiusValue.textContent = `${adminState.currentZone.radius}m`;
                updateZonePreview();
            });
        }
        
        // Add click event for map
        adminState.map.on('click', handleMapClick);
        
        showToast('Click on the map to place zone center', 'info');
    }

    function stopZoneDrawing() {
        if (!adminState.map) return;
        
        adminState.drawingMode = false;
        adminState.map.off('click', handleMapClick);
        clearZonePreview();
    }

    function handleMapClick(e) {
        if (!adminState.drawingMode) return;
        
        adminState.currentZone.coordinates = {
            lat: e.lngLat.lat,
            lng: e.lngLat.lng
        };
        
        updateZonePreview();
        showToast('Zone center placed. Adjust radius and save.', 'success');
    }

    function updateZonePreview() {
        if (!adminState.map || !adminState.currentZone.coordinates) return;
        
        // Clear previous preview
        clearZonePreview();
        
        // Add circle for zone preview
        adminState.map.addSource('zone-preview', {
            type: 'geojson',
            data: {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [adminState.currentZone.coordinates.lng, adminState.currentZone.coordinates.lat]
                },
                properties: {
                    radius: adminState.currentZone.radius
                }
            }
        });
        
        adminState.map.addLayer({
            id: 'zone-preview-layer',
            type: 'circle',
            source: 'zone-preview',
            paint: {
                'circle-radius': {
                    stops: [
                        [0, 0],
                        [20, adminState.currentZone.radius]
                    ],
                    base: 2
                },
                'circle-color': 'var(--blue)',
                'circle-opacity': 0.3,
                'circle-stroke-width': 2,
                'circle-stroke-color': 'var(--blue-light)'
            }
        });
        
        adminState.mapLayers.push('zone-preview-layer');
    }

    function clearZonePreview() {
        if (!adminState.map) return;
        
        adminState.mapLayers.forEach(layer => {
            if (adminState.map.getLayer(layer)) {
                adminState.map.removeLayer(layer);
            }
        });
        
        if (adminState.map.getSource('zone-preview')) {
            adminState.map.removeSource('zone-preview');
        }
        
        adminState.mapLayers = [];
    }

    function clearZoneDrawing() {
        adminState.currentZone = null;
        clearZonePreview();
        
        // Reset form
        document.getElementById('zone-name').value = '';
        document.getElementById('zone-description').value = '';
        const radiusSlider = document.getElementById('zone-radius') || document.getElementById('zone-radius-static');
        if (radiusSlider) radiusSlider.value = 100;
        
        showToast('Zone drawing cleared', 'info');
    }

    async function saveZone() {
        const name = document.getElementById('zone-name')?.value || 
                    document.getElementById('zone-name-static')?.value;
        const description = document.getElementById('zone-description')?.value || 
                          document.getElementById('zone-description-static')?.value;
        const radius = adminState.currentZone?.radius || 100;
        const coordinates = adminState.currentZone?.coordinates;
        
        if (!name) {
            showToast('Please enter zone name', 'error');
            return;
        }
        
        if (!coordinates) {
            showToast('Please place zone center on map', 'error');
            return;
        }
        
        try {
            const { data, error } = await supabase
                .from('zones')
                .insert([{
                    name,
                    description,
                    coordinates,
                    radius_meters: radius,
                    is_active: true,
                    created_at: new Date().toISOString()
                }]);
            
            if (error) throw error;
            
            showToast('Zone created successfully', 'success');
            hideZoneCreation();
            
            // Refresh data
            if (adminState.currentSection === 'zones-missions') {
                loadZones();
            }
            if (adminState.currentSection === 'live-map') {
                refreshMapData();
            }
            
        } catch (error) {
            console.error('Error creating zone:', error);
            showToast('Failed to create zone', 'error');
        }
    }

    function centerMap() {
        if (!adminState.map) return;
        
        adminState.map.flyTo({
            center: [CONFIG.DEFAULT_LOCATION.lng, CONFIG.DEFAULT_LOCATION.lat],
            zoom: 13,
            essential: true
        });
    }

    function togglePlayers() {
        const btn = document.getElementById('map-show-players');
        const show = !btn.classList.contains('active');
        
        btn.classList.toggle('active');
        
        // Toggle player markers
        adminState.mapMarkers.forEach(marker => {
            if (marker.type === 'player') {
                if (show) {
                    marker.marker.addTo(adminState.map);
                } else {
                    marker.marker.remove();
                }
            }
        });
    }

    function toggleZones() {
        const btn = document.getElementById('map-show-zones');
        const show = !btn.classList.contains('active');
        
        btn.classList.toggle('active');
        
        // Toggle zone layer
        if (adminState.map.getLayer('zones-layer')) {
            adminState.map.setLayoutProperty('zones-layer', 'visibility', show ? 'visible' : 'none');
        }
    }

    function toggleSOS() {
        const btn = document.getElementById('map-show-sos');
        const show = !btn.classList.contains('active');
        
        btn.classList.toggle('active');
        
        // Toggle SOS markers
        adminState.mapMarkers.forEach(marker => {
            if (marker.type === 'sos') {
                if (show) {
                    marker.marker.addTo(adminState.map);
                } else {
                    marker.marker.remove();
                }
            }
        });
    }

    function refreshMapData() {
        if (!adminState.map) return;
        
        loadMapData();
        showToast('Map data refreshed', 'success');
    }

    // ============================================
    // ZONES MANAGEMENT
    // ============================================
    async function loadZones() {
        try {
            const { data: zones, error } = await supabase
                .from('zones')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            updateZonesTable(zones || []);
        } catch (error) {
            console.error('Error loading zones:', error);
            showToast('Failed to load zones', 'error');
        }
    }

    function updateZonesTable(zones) {
        const tbody = document.getElementById('zones-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (zones.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center p-4">
                        No zones created yet
                    </td>
                </tr>
            `;
            return;
        }
        
        zones.forEach(zone => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${zone.name}</strong>
                </td>
                <td>${zone.description || '-'}</td>
                <td>
                    <button class="action-btn" onclick="viewZoneMissions('${zone.id}')" style="padding: 4px 8px; font-size: 12px;">
                        View Missions
                    </button>
                </td>
                <td>${zone.radius_meters || 100}m</td>
                <td>
                    <span class="status-badge ${zone.is_active ? 'status-active' : 'status-inactive'}">
                        ${zone.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="quick-actions" style="gap: 4px;">
                        <button class="action-btn" onclick="showEditZoneModal('${zone.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn ${zone.is_active ? 'danger' : 'success'}" 
                                onclick="toggleZoneStatus('${zone.id}', ${!zone.is_active})" 
                                style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-${zone.is_active ? 'pause' : 'play'}"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function loadZoneForEdit(zoneId) {
        try {
            const { data: zone, error } = await supabase
                .from('zones')
                .select('*')
                .eq('id', zoneId)
                .single();
            
            if (error) throw error;
            
            adminState.selectedZone = zone;
            
            // Update form
            document.getElementById('edit-zone-name').value = zone.name;
            document.getElementById('edit-zone-description').value = zone.description || '';
            document.getElementById('edit-zone-radius').value = zone.radius_meters || 100;
            document.getElementById('edit-radius-value').textContent = `${zone.radius_meters || 100}m`;
            document.getElementById('edit-zone-status').value = zone.is_active ? 'active' : 'inactive';
            document.getElementById('edit-zone-lat').value = zone.coordinates?.lat || '';
            document.getElementById('edit-zone-lng').value = zone.coordinates?.lng || '';
            
            // Load zone missions
            loadZoneMissions(zoneId);
            
        } catch (error) {
            console.error('Error loading zone:', error);
            showToast('Failed to load zone details', 'error');
        }
    }

    async function loadZoneMissions(zoneId) {
        try {
            const { data: missions, error } = await supabase
                .from('missions')
                .select('*')
                .eq('zone_id', zoneId)
                .order('created_at', { ascending: false });
            
            const container = document.getElementById('zone-missions-list');
            if (!container) return;
            
            if (error) {
                container.innerHTML = '<p class="text-secondary">Error loading missions</p>';
                return;
            }
            
            if (!missions || missions.length === 0) {
                container.innerHTML = '<p class="text-secondary">No missions in this zone</p>';
                return;
            }
            
            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            missions.forEach(mission => {
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg-tertiary); border-radius: 4px;">
                        <div>
                            <strong>${mission.title}</strong>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                ${mission.mission_type} • ${mission.points} points
                            </div>
                        </div>
                        <button class="action-btn" onclick="editMission('${mission.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Error loading zone missions:', error);
        }
    }

    async function updateZone() {
        if (!adminState.selectedZone) return;
        
        const name = document.getElementById('edit-zone-name').value;
        const description = document.getElementById('edit-zone-description').value;
        const radius = parseInt(document.getElementById('edit-zone-radius').value);
        const status = document.getElementById('edit-zone-status').value === 'active';
        const lat = parseFloat(document.getElementById('edit-zone-lat').value);
        const lng = parseFloat(document.getElementById('edit-zone-lng').value);
        
        if (!name) {
            showToast('Please enter zone name', 'error');
            return;
        }
        
        try {
            const updateData = {
                name,
                description,
                radius_meters: radius,
                is_active: status,
                updated_at: new Date().toISOString()
            };
            
            // Update coordinates if provided
            if (!isNaN(lat) && !isNaN(lng)) {
                updateData.coordinates = { lat, lng };
            }
            
            const { error } = await supabase
                .from('zones')
                .update(updateData)
                .eq('id', adminState.selectedZone.id);
            
            if (error) throw error;
            
            showToast('Zone updated successfully', 'success');
            closeEditZoneModal();
            loadZones();
            refreshMapData();
            
        } catch (error) {
            console.error('Error updating zone:', error);
            showToast('Failed to update zone', 'error');
        }
    }

    async function deleteZone() {
        if (!adminState.selectedZone) return;
        
        if (!confirm(`Are you sure you want to delete zone "${adminState.selectedZone.name}"? This will also delete all missions in this zone.`)) {
            return;
        }
        
        try {
            // First delete missions in this zone
            await supabase
                .from('missions')
                .delete()
                .eq('zone_id', adminState.selectedZone.id);
            
            // Then delete the zone
            const { error } = await supabase
                .from('zones')
                .delete()
                .eq('id', adminState.selectedZone.id);
            
            if (error) throw error;
            
            showToast('Zone deleted successfully', 'success');
            closeEditZoneModal();
            loadZones();
            refreshMapData();
            
        } catch (error) {
            console.error('Error deleting zone:', error);
            showToast('Failed to delete zone', 'error');
        }
    }

    async function toggleZoneStatus(zoneId, newStatus) {
        try {
            const { error } = await supabase
                .from('zones')
                .update({
                    is_active: newStatus,
                    updated_at: new Date().toISOString()
                })
                .eq('id', zoneId);
            
            if (error) throw error;
            
            showToast(`Zone ${newStatus ? 'activated' : 'deactivated'}`, 'success');
            loadZones();
            
        } catch (error) {
            console.error('Error toggling zone status:', error);
            showToast('Failed to update zone status', 'error');
        }
    }

    function viewZoneMissions(zoneId) {
        showSection('zones-missions');
        // TODO: Filter missions by zone
    }

    // ============================================
    // MISSIONS MANAGEMENT
    // ============================================
    async function loadMissions() {
        try {
            const { data: missions, error } = await supabase
                .from('missions')
                .select(`
                    *,
                    zones (name)
                `)
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            updateMissionsTable(missions || []);
        } catch (error) {
            console.error('Error loading missions:', error);
            showToast('Failed to load missions', 'error');
        }
    }

    function updateMissionsTable(missions) {
        const tbody = document.getElementById('missions-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (missions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center p-4">
                        No missions created yet
                    </td>
                </tr>
            `;
            return;
        }
        
        missions.forEach(mission => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${mission.title}</strong>
                </td>
                <td>
                    <span class="status-badge" style="text-transform: capitalize;">
                        ${mission.mission_type.replace('_', ' ')}
                    </span>
                </td>
                <td>${mission.zones?.name || 'Unknown Zone'}</td>
                <td>${mission.points}</td>
                <td>
                    <span class="status-badge ${mission.status === 'active' ? 'status-active' : 'status-inactive'}">
                        ${mission.status}
                    </span>
                </td>
                <td>
                    <div class="quick-actions" style="gap: 4px;">
                        <button class="action-btn" onclick="editMission('${mission.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn ${mission.status === 'active' ? 'danger' : 'success'}" 
                                onclick="toggleMissionStatus('${mission.id}', '${mission.status === 'active' ? 'inactive' : 'active'}')" 
                                style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-${mission.status === 'active' ? 'pause' : 'play'}"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function loadZonesForMission() {
        try {
            const { data: zones, error } = await supabase
                .from('zones')
                .select('id, name')
                .eq('is_active', true)
                .order('name');
            
            const select = document.getElementById('mission-zone');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select a zone</option>';
            
            if (zones) {
                zones.forEach(zone => {
                    const option = document.createElement('option');
                    option.value = zone.id;
                    option.textContent = zone.name;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading zones for mission:', error);
        }
    }

    function resetMissionForm() {
        document.getElementById('mission-title').value = '';
        document.getElementById('mission-question').value = '';
        document.getElementById('mission-points').value = '100';
        document.getElementById('mission-media-count').value = '1';
        document.getElementById('mission-video-duration').value = '10';
        document.getElementById('mission-time-limit').value = '0';
        document.getElementById('mission-instructions').value = '';
        document.getElementById('mission-latitude').value = '';
        document.getElementById('mission-longitude').value = '';
    }

    async function saveMission() {
        const title = document.getElementById('mission-title').value;
        const type = document.getElementById('mission-type').value;
        const zoneId = document.getElementById('mission-zone').value;
        const points = parseInt(document.getElementById('mission-points').value);
        const question = document.getElementById('mission-question').value;
        const mediaCount = parseInt(document.getElementById('mission-media-count').value);
        const videoDuration = parseInt(document.getElementById('mission-video-duration').value);
        const timeLimit = parseInt(document.getElementById('mission-time-limit').value);
        const instructions = document.getElementById('mission-instructions').value;
        const difficulty = document.getElementById('mission-difficulty').value;
        
        if (!title || !zoneId || !question) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            const missionData = {
                title,
                mission_type: type,
                zone_id: zoneId,
                points,
                question,
                description: instructions,
                media_required_count: mediaCount,
                video_max_duration: videoDuration,
                time_limit_minutes: timeLimit,
                difficulty,
                status: 'active',
                created_at: new Date().toISOString()
            };
            
            // Add GPS coordinates for GPS missions
            if (type === 'gps_checkin') {
                const lat = parseFloat(document.getElementById('mission-latitude').value);
                const lng = parseFloat(document.getElementById('mission-longitude').value);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    missionData.options = {
                        target: { lat, lng },
                        radius: 50
                    };
                }
            }
            
            const { data, error } = await supabase
                .from('missions')
                .insert([missionData]);
            
            if (error) throw error;
            
            showToast('Mission created successfully', 'success');
            closeMissionModal();
            loadMissions();
            
        } catch (error) {
            console.error('Error creating mission:', error);
            showToast('Failed to create mission', 'error');
        }
    }

    async function editMission(missionId) {
        // TODO: Implement mission editing
        showToast('Mission editing coming soon', 'info');
    }

    async function toggleMissionStatus(missionId, newStatus) {
        try {
            const { error } = await supabase
                .from('missions')
                .update({
                    status: newStatus,
                    updated_at: new Date().toISOString()
                })
                .eq('id', missionId);
            
            if (error) throw error;
            
            showToast(`Mission ${newStatus === 'active' ? 'activated' : 'deactivated'}`, 'success');
            loadMissions();
            
        } catch (error) {
            console.error('Error toggling mission status:', error);
            showToast('Failed to update mission status', 'error');
        }
    }

    // ============================================
    // PRIZES MANAGEMENT
    // ============================================
    async function loadPrizes() {
        try {
            const { data: prizes, error } = await supabase
                .from('prizes')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            updatePrizesTable(prizes || []);
        } catch (error) {
            console.error('Error loading prizes:', error);
            showToast('Failed to load prizes', 'error');
        }
    }

    function updatePrizesTable(prizes) {
        const tbody = document.getElementById('prizes-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (prizes.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center p-4">
                        No prizes added yet
                    </td>
                </tr>
            `;
            return;
        }
        
        prizes.forEach(prize => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    ${prize.image_url ? 
                        `<img src="${prize.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">` :
                        `<div style="width: 50px; height: 50px; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                            <i class="fas fa-gift"></i>
                        </div>`
                    }
                </td>
                <td><strong>${prize.name}</strong></td>
                <td>${prize.description || '-'}</td>
                <td>${prize.price} coins</td>
                <td>${prize.remaining_quantity || 0}</td>
                <td>
                    <span class="status-badge" style="text-transform: capitalize;">
                        ${prize.category || 'physical'}
                    </span>
                </td>
                <td>
                    <span class="status-badge ${prize.is_active ? 'status-active' : 'status-inactive'}">
                        ${prize.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="quick-actions" style="gap: 4px;">
                        <button class="action-btn" onclick="editPrize('${prize.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn ${prize.is_active ? 'danger' : 'success'}" 
                                onclick="togglePrizeStatus('${prize.id}', ${!prize.is_active})" 
                                style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-${prize.is_active ? 'pause' : 'play'}"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function loadPurchases() {
        try {
            const { data: purchases, error } = await supabase
                .from('purchases')
                .select(`
                    *,
                    users (name, avatar_url),
                    prizes (name)
                `)
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            updatePurchasesTable(purchases || []);
        } catch (error) {
            console.error('Error loading purchases:', error);
            showToast('Failed to load purchases', 'error');
        }
    }

    function updatePurchasesTable(purchases) {
        const tbody = document.getElementById('purchases-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (purchases.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center p-4">
                        No purchases yet
                    </td>
                </tr>
            `;
            return;
        }
        
        purchases.forEach(purchase => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${purchase.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + purchase.user_id}" 
                             class="user-avatar-small">
                        <span>${purchase.users?.name || 'Unknown User'}</span>
                    </div>
                </td>
                <td>${purchase.prizes?.name || 'Unknown Prize'}</td>
                <td>${purchase.price_paid} coins</td>
                <td>${formatTime(purchase.created_at)}</td>
                <td>
                    <span class="status-badge status-${purchase.status}">
                        ${purchase.status}
                    </span>
                </td>
                <td>
                    <button class="action-btn" onclick="viewPurchase('${purchase.id}')" style="padding: 4px 8px; font-size: 12px;">
                        Details
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function handlePrizeImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showToast('Please select an image file', 'error');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('prize-image-preview');
            preview.classList.remove('empty');
            preview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
        };
        reader.readAsDataURL(file);
    }

    function resetPrizeForm() {
        document.getElementById('prize-name').value = '';
        document.getElementById('prize-description').value = '';
        document.getElementById('prize-price').value = '100';
        document.getElementById('prize-quantity').value = '10';
        document.getElementById('prize-category').value = 'physical';
        document.getElementById('prize-expiry').value = '';
        document.getElementById('prize-redemption').value = '';
        
        const preview = document.getElementById('prize-image-preview');
        preview.classList.add('empty');
        preview.innerHTML = '<i class="fas fa-camera"></i>';
    }

    async function savePrize() {
        const name = document.getElementById('prize-name').value;
        const description = document.getElementById('prize-description').value;
        const price = parseInt(document.getElementById('prize-price').value);
        const quantity = parseInt(document.getElementById('prize-quantity').value);
        const category = document.getElementById('prize-category').value;
        const expiry = document.getElementById('prize-expiry').value;
        const redemption = document.getElementById('prize-redemption').value;
        const imageFile = document.getElementById('prize-image-upload').files[0];
        
        if (!name || !description || isNaN(price) || isNaN(quantity)) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        try {
            let imageUrl = null;
            
            // Upload image if provided
            if (imageFile) {
                const fileName = `prizes/${Date.now()}_${imageFile.name}`;
                const { error: uploadError } = await supabase.storage
                    .from('prize-images')
                    .upload(fileName, imageFile);
                
                if (uploadError) throw uploadError;
                
                const { data: urlData } = supabase.storage
                    .from('prize-images')
                    .getPublicUrl(fileName);
                
                imageUrl = urlData.publicUrl;
            }
            
            const prizeData = {
                name,
                description,
                price,
                total_quantity: quantity,
                remaining_quantity: quantity,
                category,
                image_url: imageUrl,
                is_active: true,
                created_at: new Date().toISOString()
            };
            
            if (expiry) {
                prizeData.expiry_date = expiry;
            }
            
            if (redemption) {
                prizeData.redemption_instructions = redemption;
            }
            
            const { data, error } = await supabase
                .from('prizes')
                .insert([prizeData]);
            
            if (error) throw error;
            
            showToast('Prize added successfully', 'success');
            closePrizeModal();
            loadPrizes();
            
        } catch (error) {
            console.error('Error creating prize:', error);
            showToast('Failed to add prize', 'error');
        }
    }

    async function editPrize(prizeId) {
        // TODO: Implement prize editing
        showToast('Prize editing coming soon', 'info');
    }

    async function togglePrizeStatus(prizeId, newStatus) {
        try {
            const { error } = await supabase
                .from('prizes')
                .update({
                    is_active: newStatus,
                    updated_at: new Date().toISOString()
                })
                .eq('id', prizeId);
            
            if (error) throw error;
            
            showToast(`Prize ${newStatus ? 'activated' : 'deactivated'}`, 'success');
            loadPrizes();
            
        } catch (error) {
            console.error('Error toggling prize status:', error);
            showToast('Failed to update prize status', 'error');
        }
    }

    function viewPurchase(purchaseId) {
        // TODO: Implement purchase view
        showToast('Purchase details coming soon', 'info');
    }

    // ============================================
    // MISSION REVIEW
    // ============================================
    async function loadSubmissions() {
        try {
            const { data: submissions, error } = await supabase
                .from('submissions')
                .select(`
                    *,
                    users (id, name, avatar_url),
                    missions (id, title, mission_type, points)
                `)
                .eq('review_status', 'pending')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            updateSubmissionList(submissions || []);
        } catch (error) {
            console.error('Error loading submissions:', error);
            showToast('Failed to load submissions', 'error');
        }
    }

    function updateSubmissionList(submissions) {
        const container = document.getElementById('submission-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (submissions.length === 0) {
            container.innerHTML = `
                <div class="text-center p-8">
                    <i class="fas fa-check-circle fa-3x" style="color: var(--green); margin-bottom: 16px;"></i>
                    <h3>All Caught Up!</h3>
                    <p class="text-secondary">No pending submissions to review.</p>
                </div>
            `;
            return;
        }
        
        submissions.forEach(sub => {
            const item = document.createElement('div');
            item.className = 'mission-item';
            item.dataset.submissionId = sub.id;
            item.addEventListener('click', () => loadSubmissionDetails(sub.id));
            
            item.innerHTML = `
                <div class="mission-user">
                    <img src="${sub.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + sub.user_id}" 
                         style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                    <div class="mission-user-info">
                        <h4>${sub.users?.name || 'Unknown User'}</h4>
                        <p>${sub.missions?.title || 'Mission'}</p>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <span class="status-badge" style="text-transform: capitalize;">
                        ${sub.file_type}
                    </span>
                    <span style="font-size: 11px; color: var(--text-secondary);">
                        ${formatTime(sub.created_at)}
                    </span>
                </div>
            `;
            
            container.appendChild(item);
        });
    }

    async function loadSubmissionDetails(submissionId) {
        try {
            const { data: submission, error } = await supabase
                .from('submissions')
                .select(`
                    *,
                    users (id, name, avatar_url, email, phone),
                    missions (id, title, mission_type, points, question)
                `)
                .eq('id', submissionId)
                .single();
            
            if (error) throw error;
            
            adminState.selectedSubmission = submission;
            
            // Update active item in list
            document.querySelectorAll('.mission-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.submissionId === submissionId) {
                    item.classList.add('active');
                }
            });
            
            // Load submission details
            await renderSubmissionDetails(submission);
            
        } catch (error) {
            console.error('Error loading submission details:', error);
            showToast('Failed to load submission details', 'error');
        }
    }

    async function renderSubmissionDetails(submission) {
        const container = document.getElementById('mission-review-content');
        if (!container) return;
        
        let mediaHTML = '';
        
        if (submission.file_type === 'text') {
            mediaHTML = `
                <div class="form-group">
                    <label>Text Answer</label>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 12px 0;">
                        <p style="white-space: pre-wrap;">${submission.text_answer || 'No answer provided'}</p>
                    </div>
                </div>
            `;
        } else if (submission.file_type === 'gps') {
            mediaHTML = `
                <div class="form-group">
                    <label>GPS Check-in Location</label>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 12px 0;">
                        <p><strong>Latitude:</strong> ${submission.gps_location?.lat || 'N/A'}</p>
                        <p><strong>Longitude:</strong> ${submission.gps_location?.lng || 'N/A'}</p>
                        <p><strong>Accuracy:</strong> ${submission.gps_location?.accuracy || 'N/A'} meters</p>
                        <button onclick="viewLocationOnMap(${submission.gps_location?.lat}, ${submission.gps_location?.lng})" 
                                class="action-btn" style="margin-top: 8px;">
                            <i class="fas fa-map-marker-alt"></i> View on Map
                        </button>
                    </div>
                </div>
            `;
        } else if (submission.file_url) {
            mediaHTML = `
                <div class="form-group">
                    <label>Submitted Media</label>
                    <div class="media-grid" style="margin: 12px 0;">
                        <div class="media-item ${submission.file_type}" onclick="showMediaViewModal('${submission.id}')">
                            ${submission.file_type === 'photo' ? 
                                `<img src="${submission.file_url}" style="width: 100%; height: 100%; object-fit: cover;">` :
                             submission.file_type === 'video' ?
                                `<video src="${submission.file_url}" style="width: 100%; height: 100%; object-fit: cover;"></video>` :
                             submission.file_type === 'audio' ?
                                `<i class="fas fa-volume-up"></i>` :
                                `<i class="fas fa-file"></i>`
                            }
                        </div>
                    </div>
                    <button onclick="showMediaViewModal('${submission.id}')" class="action-btn">
                        <i class="fas fa-expand"></i> View Fullscreen
                    </button>
                </div>
            `;
        }
        
        container.innerHTML = `
            <div>
                <div class="mission-user" style="margin-bottom: 20px;">
                    <img src="${submission.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + submission.user_id}" 
                         style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">
                    <div class="mission-user-info">
                        <h3 style="margin: 0 0 4px 0;">${submission.users?.name || 'Unknown User'}</h3>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            ${submission.users?.email || ''}
                        </p>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">
                            Phone: ${submission.users?.phone || 'Not provided'}
                        </p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Mission</label>
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin: 12px 0;">
                        <h4 style="margin: 0 0 8px 0;">${submission.missions?.title || 'Mission'}</h4>
                        <p style="margin: 0 0 4px 0; color: var(--text-secondary);">
                            <strong>Type:</strong> ${submission.missions?.mission_type || 'N/A'}
                        </p>
                        <p style="margin: 0 0 4px 0; color: var(--text-secondary);">
                            <strong>Points:</strong> ${submission.missions?.points || 0}
                        </p>
                        <p style="margin: 0; color: var(--text-secondary);">
                            <strong>Question:</strong> ${submission.missions?.question || 'No question'}
                        </p>
                    </div>
                </div>
                
                ${mediaHTML}
                
                <div class="form-group">
                    <label>Review Status</label>
                    <div style="display: flex; gap: 12px; margin: 12px 0;">
                        <span class="status-badge status-${submission.review_status}">
                            ${submission.review_status}
                        </span>
                        <span style="font-size: 13px; color: var(--text-secondary);">
                            Submitted: ${formatTime(submission.created_at)}
                        </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Reviewer Comments</label>
                    <textarea id="review-comments" placeholder="Add comments for the user..." 
                              style="width: 100%; min-height: 100px; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); resize: vertical;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Award Points</label>
                    <input type="number" id="award-points" value="${submission.missions?.points || 100}" min="0" max="1000" 
                           style="width: 100%; padding: 8px 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                </div>
                
                <div class="quick-actions" style="margin-top: 24px;">
                    <button class="action-btn success" onclick="approveSubmission('${submission.id}')">
                        <i class="fas fa-check"></i> Approve
                    </button>
                    <button class="action-btn danger" onclick="rejectSubmission('${submission.id}')">
                        <i class="fas fa-times"></i> Reject
                    </button>
                    <button class="action-btn" onclick="requestResubmission('${submission.id}')">
                        <i class="fas fa-redo"></i> Request Resubmission
                    </button>
                </div>
            </div>
        `;
    }

    async function approveSubmission(submissionId) {
        const comments = document.getElementById('review-comments')?.value || '';
        const points = parseInt(document.getElementById('award-points')?.value || '100');
        
        try {
            // Update submission
            await supabase
                .from('submissions')
                .update({
                    review_status: 'approved',
                    reviewed_at: new Date().toISOString(),
                    reviewed_by: adminState.currentAdmin.id,
                    reviewer_comments: comments,
                    earned_points: points
                })
                .eq('id', submissionId);
            
            // Update user mission
            const submission = adminState.selectedSubmission;
            if (submission) {
                await supabase
                    .from('user_missions')
                    .update({
                        status: 'completed',
                        completed_at: new Date().toISOString(),
                        earned_coins: points
                    })
                    .eq('user_id', submission.user_id)
                    .eq('mission_id', submission.mission_id);
                
                // Update user coins
                await supabase.rpc('increment_user_coins', {
                    user_id: submission.user_id,
                    amount: points
                });
            }
            
            showToast('Submission approved', 'success');
            
            // Refresh data
            loadSubmissions();
            updateSidebarBadges(adminState.pendingReviews - 1, adminState.activeSOS);
            
            // Clear details view
            document.getElementById('mission-review-content').innerHTML = `
                <div class="text-center p-8">
                    <i class="fas fa-check-circle fa-3x" style="color: var(--green); margin-bottom: 16px;"></i>
                    <h3>Submission Approved</h3>
                    <p class="text-secondary">${points} coins awarded to user.</p>
                </div>
            `;
            
        } catch (error) {
            console.error('Error approving submission:', error);
            showToast('Failed to approve submission', 'error');
        }
    }

    async function rejectSubmission(submissionId) {
        const comments = document.getElementById('review-comments')?.value || '';
        
        if (!comments && !confirm('Reject without comments?')) {
            return;
        }
        
        try {
            // Update submission
            await supabase
                .from('submissions')
                .update({
                    review_status: 'rejected',
                    reviewed_at: new Date().toISOString(),
                    reviewed_by: adminState.currentAdmin.id,
                    reviewer_comments: comments
                })
                .eq('id', submissionId);
            
            // Update user mission
            const submission = adminState.selectedSubmission;
            if (submission) {
                await supabase
                    .from('user_missions')
                    .update({
                        status: 'unlocked', // Allow retry
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', submission.user_id)
                    .eq('mission_id', submission.mission_id);
            }
            
            showToast('Submission rejected', 'success');
            
            // Refresh data
            loadSubmissions();
            updateSidebarBadges(adminState.pendingReviews - 1, adminState.activeSOS);
            
            // Clear details view
            document.getElementById('mission-review-content').innerHTML = `
                <div class="text-center p-8">
                    <i class="fas fa-times-circle fa-3x" style="color: var(--red); margin-bottom: 16px;"></i>
                    <h3>Submission Rejected</h3>
                    <p class="text-secondary">User can resubmit the mission.</p>
                </div>
            `;
            
        } catch (error) {
            console.error('Error rejecting submission:', error);
            showToast('Failed to reject submission', 'error');
        }
    }

    async function requestResubmission(submissionId) {
        const comments = document.getElementById('review-comments')?.value || '';
        
        if (!comments) {
            showToast('Please add comments for resubmission', 'error');
            return;
        }
        
        try {
            // Update submission
            await supabase
                .from('submissions')
                .update({
                    review_status: 'needs_resubmission',
                    reviewed_at: new Date().toISOString(),
                    reviewed_by: adminState.currentAdmin.id,
                    reviewer_comments: comments
                })
                .eq('id', submissionId);
            
            // Update user mission
            const submission = adminState.selectedSubmission;
            if (submission) {
                await supabase
                    .from('user_missions')
                    .update({
                        status: 'unlocked', // Allow retry
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', submission.user_id)
                    .eq('mission_id', submission.mission_id);
            }
            
            showToast('Resubmission requested', 'success');
            
            // Refresh data
            loadSubmissions();
            updateSidebarBadges(adminState.pendingReviews - 1, adminState.activeSOS);
            
        } catch (error) {
            console.error('Error requesting resubmission:', error);
            showToast('Failed to request resubmission', 'error');
        }
    }

    function filterSubmissions(status) {
        // TODO: Implement filtering
        showToast(`Filtering by ${status}`, 'info');
    }

    // ============================================
    // USERS MANAGEMENT
    // ============================================
    async function loadUsers(page = 1, limit = 20) {
        try {
            const from = (page - 1) * limit;
            const to = from + limit - 1;
            
            const { data: users, error, count } = await supabase
                .from('users')
                .select('*', { count: 'exact' })
                .range(from, to)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            updateUsersTable(users || [], page, Math.ceil((count || 0) / limit));
        } catch (error) {
            console.error('Error loading users:', error);
            showToast('Failed to load users', 'error');
        }
    }

    function updateUsersTable(users, currentPage = 1, totalPages = 1) {
        const tbody = document.getElementById('users-management-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (users.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="text-center p-4">
                        No users found
                    </td>
                </tr>
            `;
            return;
        }
        
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <img src="${user.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + user.id}" 
                         class="user-avatar-small">
                </td>
                <td><strong>${user.name}</strong></td>
                <td>${user.email}</td>
                <td>${user.phone || '-'}</td>
                <td>${user.coins || 0}</td>
                <td>
                    <button class="action-btn" onclick="viewUserMissions('${user.id}')" style="padding: 4px 8px; font-size: 12px;">
                        View
                    </button>
                </td>
                <td>${formatTime(user.last_active)}</td>
                <td>
                    <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
                        ${user.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="quick-actions" style="gap: 4px;">
                        <button class="action-btn" onclick="editUser('${user.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn ${user.is_active ? 'danger' : 'success'}" 
                                onclick="toggleUserStatus('${user.id}', ${!user.is_active})" 
                                style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-${user.is_active ? 'ban' : 'check'}"></i>
                        </button>
                        <button class="action-btn warning" onclick="addCoins('${user.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-coins"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Update pagination
        updateUsersPagination(currentPage, totalPages);
    }

    function updateUsersPagination(currentPage, totalPages) {
        const prevBtn = document.getElementById('prev-users');
        const nextBtn = document.getElementById('next-users');
        const pageInfo = document.getElementById('users-page-info');
        
        if (pageInfo) {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        }
        
        if (prevBtn) {
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => loadUsers(currentPage - 1);
        }
        
        if (nextBtn) {
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => loadUsers(currentPage + 1);
        }
    }

    function resetAddUserForm() {
        document.getElementById('new-user-name').value = '';
        document.getElementById('new-user-email').value = '';
        document.getElementById('new-user-phone').value = '';
        document.getElementById('new-user-coins').value = '100';
        document.getElementById('new-user-role').value = 'player';
        document.getElementById('new-user-password').value = '';
        document.getElementById('new-user-confirm-password').value = '';
    }

    async function saveNewUser() {
        const name = document.getElementById('new-user-name').value;
        const email = document.getElementById('new-user-email').value;
        const phone = document.getElementById('new-user-phone').value;
        const coins = parseInt(document.getElementById('new-user-coins').value);
        const role = document.getElementById('new-user-role').value;
        const password = document.getElementById('new-user-password').value;
        const confirmPassword = document.getElementById('new-user-confirm-password').value;
        
        if (!name || !email || !password || !confirmPassword) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            showToast('Passwords do not match', 'error');
            return;
        }
        
        if (password.length < 6) {
            showToast('Password must be at least 6 characters', 'error');
            return;
        }
        
        try {
            // Create auth user
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: { name, phone }
                }
            });
            
            if (authError) {
                if (authError.message.includes('User already registered')) {
                    throw new Error('This email is already registered.');
                }
                throw authError;
            }
            
            // Create user profile
            const userData = {
                id: authData.user.id,
                name,
                email,
                phone,
                coins,
                is_active: true,
                created_at: new Date().toISOString()
            };
            
            await supabase
                .from('users')
                .upsert([userData]);
            
            // If role is admin, add to admin_users
            if (role !== 'player') {
                await supabase
                    .from('admin_users')
                    .insert([{
                        user_id: authData.user.id,
                        name,
                        email,
                        role,
                        permissions: getDefaultPermissions(role),
                        created_at: new Date().toISOString()
                    }]);
            }
            
            showToast('User created successfully', 'success');
            closeAddUserModal();
            loadUsers();
            
        } catch (error) {
            console.error('Error creating user:', error);
            showToast(error.message || 'Failed to create user', 'error');
        }
    }

    function getDefaultPermissions(role) {
        switch(role) {
            case 'admin':
                return {
                    users: true,
                    missions: true,
                    zones: true,
                    prizes: true,
                    reviews: true,
                    sos: true,
                    settings: false,
                    export: true
                };
            case 'moderator':
                return {
                    users: false,
                    missions: true,
                    zones: true,
                    prizes: true,
                    reviews: true,
                    sos: true,
                    settings: false,
                    export: false
                };
            default:
                return {};
        }
    }

    async function editUser(userId) {
        // TODO: Implement user editing
        showToast('User editing coming soon', 'info');
    }

    async function toggleUserStatus(userId, newStatus) {
        try {
            const { error } = await supabase
                .from('users')
                .update({
                    is_active: newStatus,
                    updated_at: new Date().toISOString()
                })
                .eq('id', userId);
            
            if (error) throw error;
            
            showToast(`User ${newStatus ? 'activated' : 'deactivated'}`, 'success');
            loadUsers();
            
        } catch (error) {
            console.error('Error toggling user status:', error);
            showToast('Failed to update user status', 'error');
        }
    }

    async function addCoins(userId) {
        const amount = prompt('Enter number of coins to add:');
        if (!amount || isNaN(amount) || parseInt(amount) <= 0) return;
        
        try {
            await supabase.rpc('increment_user_coins', {
                user_id: userId,
                amount: parseInt(amount)
            });
            
            showToast(`${amount} coins added to user`, 'success');
            loadUsers();
            
        } catch (error) {
            console.error('Error adding coins:', error);
            showToast('Failed to add coins', 'error');
        }
    }

    function viewUserMissions(userId) {
        // TODO: Implement user missions view
        showToast('User missions view coming soon', 'info');
    }

    // ============================================
    // ADMINS MANAGEMENT
    // ============================================
    async function loadAdmins() {
        try {
            const { data: admins, error } = await supabase
                .from('admin_users')
                .select(`
                    *,
                    users (name, email, avatar_url)
                `)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            updateAdminsTable(admins || []);
        } catch (error) {
            console.error('Error loading admins:', error);
            showToast('Failed to load admins', 'error');
        }
    }

    function updateAdminsTable(admins) {
        const tbody = document.getElementById('admins-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (admins.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center p-4">
                        No admins found
                    </td>
                </tr>
            `;
            return;
        }
        
        admins.forEach(admin => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <img src="${admin.users?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + admin.user_id}" 
                         class="user-avatar-small">
                </td>
                <td><strong>${admin.users?.name || admin.name}</strong></td>
                <td>${admin.users?.email || admin.email}</td>
                <td>
                    <span class="status-badge" style="text-transform: capitalize;">
                        ${admin.role.replace('_', ' ')}
                    </span>
                </td>
                <td>
                    <button class="action-btn" onclick="viewAdminPermissions('${admin.id}')" style="padding: 4px 8px; font-size: 12px;">
                        View
                    </button>
                </td>
                <td>${formatTime(admin.last_login)}</td>
                <td>
                    <span class="status-badge ${admin.is_active ? 'status-active' : 'status-inactive'}">
                        ${admin.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <div class="quick-actions" style="gap: 4px;">
                        <button class="action-btn" onclick="editAdmin('${admin.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn ${admin.is_active ? 'danger' : 'success'}" 
                                onclick="toggleAdminStatus('${admin.id}', ${!admin.is_active})" 
                                style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-${admin.is_active ? 'ban' : 'check'}"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function loadUsersForAdmin() {
        try {
            const { data: users, error } = await supabase
                .from('users')
                .select('id, name, email')
                .order('name');
            
            const select = document.getElementById('select-admin-user');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select a user</option>';
            
            if (users) {
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.email})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading users for admin:', error);
        }
    }

    function resetAddAdminForm() {
        document.getElementById('select-admin-user').value = '';
        document.getElementById('admin-level').value = 'super_admin';
        
        // Reset permissions
        document.querySelectorAll('#admin-permissions input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
        });
        document.getElementById('perm-settings').checked = false;
        document.getElementById('perm-export').checked = false;
    }

    async function saveNewAdmin() {
        const userId = document.getElementById('select-admin-user').value;
        const level = document.getElementById('admin-level').value;
        
        if (!userId) {
            showToast('Please select a user', 'error');
            return;
        }
        
        // Get selected permissions
        const permissions = {
            users: document.getElementById('perm-users').checked,
            missions: document.getElementById('perm-missions').checked,
            zones: document.getElementById('perm-zones').checked,
            prizes: document.getElementById('perm-prizes').checked,
            reviews: document.getElementById('perm-reviews').checked,
            sos: document.getElementById('perm-sos').checked,
            settings: document.getElementById('perm-settings').checked,
            export: document.getElementById('perm-export').checked
        };
        
        try {
            // Get user details
            const { data: user, error: userError } = await supabase
                .from('users')
                .select('name, email')
                .eq('id', userId)
                .single();
            
            if (userError) throw userError;
            
            // Check if already admin
            const { data: existingAdmin, error: checkError } = await supabase
                .from('admin_users')
                .select('id')
                .eq('user_id', userId)
                .maybeSingle();
            
            if (checkError) throw checkError;
            
            if (existingAdmin) {
                showToast('User is already an admin', 'error');
                return;
            }
            
            // Add as admin
            const { error } = await supabase
                .from('admin_users')
                .insert([{
                    user_id: userId,
                    name: user.name,
                    email: user.email,
                    role: level,
                    permissions,
                    is_active: true,
                    created_at: new Date().toISOString()
                }]);
            
            if (error) throw error;
            
            showToast('Admin added successfully', 'success');
            closeAddAdminModal();
            loadAdmins();
            
        } catch (error) {
            console.error('Error adding admin:', error);
            showToast('Failed to add admin', 'error');
        }
    }

    function viewAdminPermissions(adminId) {
        // TODO: Implement admin permissions view
        showToast('Admin permissions view coming soon', 'info');
    }

    async function editAdmin(adminId) {
        // TODO: Implement admin editing
        showToast('Admin editing coming soon', 'info');
    }

    async function toggleAdminStatus(adminId, newStatus) {
        try {
            const { error } = await supabase
                .from('admin_users')
                .update({
                    is_active: newStatus,
                    updated_at: new Date().toISOString()
                })
                .eq('id', adminId);
            
            if (error) throw error;
            
            showToast(`Admin ${newStatus ? 'activated' : 'deactivated'}`, 'success');
            loadAdmins();
            
        } catch (error) {
            console.error('Error toggling admin status:', error);
            showToast('Failed to update admin status', 'error');
        }
    }

    // ============================================
    // SOS MANAGEMENT
    // ============================================
    async function loadSOSAlerts() {
        try {
            const { data: alerts, error } = await supabase
                .from('sos_alerts')
                .select('*')
                .eq('status', 'active')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            updateSOSAlertsTable(alerts || []);
        } catch (error) {
            console.error('Error loading SOS alerts:', error);
            showToast('Failed to load SOS alerts', 'error');
        }
    }

    function updateSOSAlertsTable(alerts) {
        const tbody = document.getElementById('sos-alerts-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (alerts.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center p-4">
                        No active SOS alerts
                    </td>
                </tr>
            `;
            return;
        }
        
        alerts.forEach(alert => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 8px; height: 8px; background: var(--red); border-radius: 50%; animation: pulse 1s infinite;"></div>
                        <strong>${alert.user_name}</strong>
                    </div>
                </td>
                <td>
                    <div style="font-size: 12px;">
                        ${alert.latitude.toFixed(4)}, ${alert.longitude.toFixed(4)}
                    </div>
                    <div style="font-size: 11px; color: var(--text-secondary);">
                        Accuracy: ${alert.accuracy || 'Unknown'}m
                    </div>
                </td>
                <td>${alert.user_phone || 'Not provided'}</td>
                <td>${formatTime(alert.created_at)}</td>
                <td>
                    <span class="status-badge" style="background: rgba(255, 0, 0, 0.1); color: var(--red);">
                        Active
                    </span>
                </td>
                <td>
                    <div class="quick-actions" style="gap: 4px;">
                        <button class="action-btn" onclick="showSOSDetailsModal('${alert.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn success" onclick="acknowledgeSOSAlert('${alert.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function loadSOSHistory() {
        try {
            const { data: history, error } = await supabase
                .from('sos_alerts')
                .select('*')
                .neq('status', 'active')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            updateSOSHistoryTable(history || []);
        } catch (error) {
            console.error('Error loading SOS history:', error);
            showToast('Failed to load SOS history', 'error');
        }
    }

    function updateSOSHistoryTable(history) {
        const tbody = document.getElementById('sos-history-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (history.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center p-4">
                        No SOS history
                    </td>
                </tr>
            `;
            return;
        }
        
        history.forEach(alert => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${alert.user_name}</td>
                <td>${alert.latitude.toFixed(4)}, ${alert.longitude.toFixed(4)}</td>
                <td>${formatTime(alert.created_at)}</td>
                <td>${alert.acknowledged_by || 'Not acknowledged'}</td>
                <td>
                    ${alert.acknowledged_at ? 
                        `${Math.round((new Date(alert.acknowledged_at) - new Date(alert.created_at)) / 1000)}s` : 
                        'N/A'
                    }
                </td>
                <td>
                    <span class="status-badge ${alert.status === 'resolved' ? 'status-completed' : 'status-pending'}">
                        ${alert.status}
                    </span>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function loadSOSDetails(sosId) {
        try {
            const { data: sos, error } = await supabase
                .from('sos_alerts')
                .select('*')
                .eq('id', sosId)
                .single();
            
            if (error) throw error;
            
            adminState.selectedSOS = sos;
            
            // Update UI
            document.getElementById('sos-user-info').innerHTML = `
                <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${sos.user_id}" 
                     style="width: 48px; height: 48px; border-radius: 50%;">
                <div>
                    <h4 style="margin: 0 0 4px 0;">${sos.user_name}</h4>
                    <p style="margin: 0; color: var(--text-secondary); font-size: 13px;">User ID: ${sos.user_id}</p>
                </div>
            `;
            
            document.getElementById('sos-location').innerHTML = `
                <i class="fas fa-map-marker-alt"></i> 
                ${sos.latitude.toFixed(6)}, ${sos.longitude.toFixed(6)}
            `;
            
            document.getElementById('sos-accuracy').textContent = 
                `Accuracy: ${sos.accuracy || 'Unknown'} meters`;
            
            document.getElementById('sos-time').textContent = formatTime(sos.created_at);
            document.getElementById('sos-phone-number').textContent = sos.user_phone || 'Not provided';
            document.getElementById('sos-notes').value = sos.admin_notes || '';
            
        } catch (error) {
            console.error('Error loading SOS details:', error);
            showToast('Failed to load SOS details', 'error');
        }
    }

    async function acknowledgeSOS() {
        if (!adminState.selectedSOS) return;
        
        const notes = document.getElementById('sos-notes').value;
        
        try {
            await supabase
                .from('sos_alerts')
                .update({
                    status: 'acknowledged',
                    acknowledged_at: new Date().toISOString(),
                    acknowledged_by: adminState.currentAdmin.name,
                    admin_notes: notes
                })
                .eq('id', adminState.selectedSOS.id);
            
            showToast('SOS alert acknowledged', 'success');
            closeSOSDetailsModal();
            loadSOSAlerts();
            loadSOSHistory();
            updateSidebarBadges(adminState.pendingReviews, adminState.activeSOS - 1);
            
        } catch (error) {
            console.error('Error acknowledging SOS:', error);
            showToast('Failed to acknowledge SOS', 'error');
        }
    }

    async function resolveSOS() {
        if (!adminState.selectedSOS) return;
        
        const notes = document.getElementById('sos-notes').value;
        
        try {
            await supabase
                .from('sos_alerts')
                .update({
                    status: 'resolved',
                    resolved_at: new Date().toISOString(),
                    resolved_by: adminState.currentAdmin.name,
                    admin_notes: notes
                })
                .eq('id', adminState.selectedSOS.id);
            
            showToast('SOS alert resolved', 'success');
            closeSOSDetailsModal();
            loadSOSAlerts();
            loadSOSHistory();
            updateSidebarBadges(adminState.pendingReviews, adminState.activeSOS - 1);
            
        } catch (error) {
            console.error('Error resolving SOS:', error);
            showToast('Failed to resolve SOS', 'error');
        }
    }

    function callEmergency(type) {
        if (!adminState.selectedSOS) return;
        
        const phoneNumber = type === 'ambulance' ? '0644106000' : '10111';
        const message = `Calling ${type} for user ${adminState.selectedSOS.user_name} at ${adminState.selectedSOS.user_phone || 'no phone'}`;
        
        showToast(message, 'info');
        
        // In a real app, this would initiate a phone call
        // For now, we'll just log it
        console.log(`Emergency call to ${type}: ${phoneNumber}`);
        
        // Update notes
        const notes = document.getElementById('sos-notes');
        notes.value += `\n[${new Date().toLocaleTimeString()}] Called ${type}: ${phoneNumber}\n`;
    }

    function callSOSUser() {
        if (!adminState.selectedSOS || !adminState.selectedSOS.user_phone) {
            showToast('No phone number provided by user', 'error');
            return;
        }
        
        const phoneNumber = adminState.selectedSOS.user_phone;
        showToast(`Calling user: ${phoneNumber}`, 'info');
        
        // In a real app, this would initiate a phone call
        console.log(`Calling user: ${phoneNumber}`);
        
        // Update notes
        const notes = document.getElementById('sos-notes');
        notes.value += `\n[${new Date().toLocaleTimeString()}] Called user: ${phoneNumber}\n`;
    }

    async function acknowledgeSOSAlert(sosId) {
        try {
            await supabase
                .from('sos_alerts')
                .update({
                    status: 'acknowledged',
                    acknowledged_at: new Date().toISOString(),
                    acknowledged_by: adminState.currentAdmin.name
                })
                .eq('id', sosId);
            
            showToast('SOS alert acknowledged', 'success');
            loadSOSAlerts();
            updateSidebarBadges(adminState.pendingReviews, adminState.activeSOS - 1);
            
        } catch (error) {
            console.error('Error acknowledging SOS alert:', error);
            showToast('Failed to acknowledge SOS alert', 'error');
        }
    }

    async function acknowledgeAllSOS() {
        if (!confirm('Acknowledge all active SOS alerts?')) return;
        
        try {
            await supabase
                .from('sos_alerts')
                .update({
                    status: 'acknowledged',
                    acknowledged_at: new Date().toISOString(),
                    acknowledged_by: adminState.currentAdmin.name
                })
                .eq('status', 'active');
            
            showToast('All SOS alerts acknowledged', 'success');
            loadSOSAlerts();
            updateSidebarBadges(adminState.pendingReviews, 0);
            
        } catch (error) {
            console.error('Error acknowledging all SOS:', error);
            showToast('Failed to acknowledge all SOS alerts', 'error');
        }
    }

    function viewSOSAlert() {
        const sosId = document.getElementById('sos-alert-popup').dataset.sosId;
        if (sosId) {
            closeSOSAlert();
            showSOSDetailsModal(sosId);
        }
    }

    // ============================================
    // MEDIA VIEWER
    // ============================================
    async function loadMediaForView(submissionId) {
        try {
            const { data: submission, error } = await supabase
                .from('submissions')
                .select(`
                    *,
                    users (name),
                    missions (title)
                `)
                .eq('id', submissionId)
                .single();
            
            if (error) throw error;
            
            adminState.selectedSubmission = submission;
            
            // Update media viewer
            const container = document.getElementById('media-view-container');
            const info = document.getElementById('media-submission-info');
            
            if (!container || !info) return;
            
            info.textContent = `Submitted by ${submission.users?.name || 'Unknown'} for "${submission.missions?.title || 'Mission'}"`;
            
            if (submission.file_type === 'photo' && submission.file_url) {
                container.innerHTML = `
                    <img src="${submission.file_url}" 
                         style="max-width: 100%; max-height: 70vh; object-fit: contain;">
                `;
            } else if (submission.file_type === 'video' && submission.file_url) {
                container.innerHTML = `
                    <video src="${submission.file_url}" 
                           controls 
                           style="max-width: 100%; max-height: 70vh;">
                    </video>
                `;
            } else if (submission.file_type === 'audio' && submission.file_url) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-volume-up fa-4x" style="color: var(--blue); margin-bottom: 20px;"></i>
                        <audio src="${submission.file_url}" controls style="width: 100%;"></audio>
                    </div>
                `;
            } else if (submission.file_type === 'text') {
                container.innerHTML = `
                    <div style="padding: 40px; max-width: 600px; margin: 0 auto;">
                        <div style="background: var(--bg-tertiary); padding: 24px; border-radius: 8px;">
                            <h4 style="margin: 0 0 16px 0;">Text Answer</h4>
                            <p style="white-space: pre-wrap; line-height: 1.6;">${submission.text_answer || 'No answer provided'}</p>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-file fa-4x" style="color: var(--text-secondary); margin-bottom: 20px;"></i>
                        <p>No media available</p>
                    </div>
                `;
            }
            
        } catch (error) {
            console.error('Error loading media:', error);
            showToast('Failed to load media', 'error');
        }
    }

    async function approveMedia() {
        if (!adminState.selectedSubmission) return;
        await approveSubmission(adminState.selectedSubmission.id);
        closeMediaViewModal();
    }

    async function rejectMedia() {
        if (!adminState.selectedSubmission) return;
        await rejectSubmission(adminState.selectedSubmission.id);
        closeMediaViewModal();
    }

    function showPrevMedia() {
        // TODO: Implement previous media navigation
        showToast('Previous media navigation coming soon', 'info');
    }

    function showNextMedia() {
        // TODO: Implement next media navigation
        showToast('Next media navigation coming soon', 'info');
    }

    // ============================================
    // BULK REVIEW
    // ============================================
    async function loadSubmissionsForBulk() {
        try {
            const { data: submissions, error } = await supabase
                .from('submissions')
                .select(`
                    id,
                    file_type,
                    created_at,
                    users (name),
                    missions (title)
                `)
                .eq('review_status', 'pending')
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            updateBulkSubmissionList(submissions || []);
        } catch (error) {
            console.error('Error loading submissions for bulk:', error);
            showToast('Failed to load submissions', 'error');
        }
    }

    function updateBulkSubmissionList(submissions) {
        const container = document.getElementById('bulk-mission-list');
        if (!container) return;
        
        container.innerHTML = '';
        
        if (submissions.length === 0) {
            container.innerHTML = '<p class="text-center p-4 text-secondary">No pending submissions</p>';
            return;
        }
        
        submissions.forEach(sub => {
            const item = document.createElement('div');
            item.style.cssText = `
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px;
                border-bottom: 1px solid var(--border-color);
                cursor: pointer;
            `;
            item.innerHTML = `
                <input type="checkbox" class="bulk-select" value="${sub.id}" 
                       style="width: 18px; height: 18px; cursor: pointer;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; margin-bottom: 4px;">${sub.missions?.title || 'Mission'}</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        ${sub.users?.name || 'Unknown'} • ${sub.file_type} • ${formatTime(sub.created_at)}
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    async function approveBulk() {
        const selected = Array.from(document.querySelectorAll('.bulk-select:checked'))
            .map(cb => cb.value);
        
        if (selected.length === 0) {
            showToast('Please select at least one submission', 'error');
            return;
        }
        
        const points = parseInt(document.getElementById('bulk-points').value);
        const comments = document.getElementById('bulk-comments').value;
        
        if (!confirm(`Approve ${selected.length} submissions with ${points} points each?`)) {
            return;
        }
        
        try {
            for (const submissionId of selected) {
                // Get submission details
                const { data: submission, error: fetchError } = await supabase
                    .from('submissions')
                    .select('user_id, mission_id')
                    .eq('id', submissionId)
                    .single();
                
                if (fetchError) continue;
                
                // Update submission
                await supabase
                    .from('submissions')
                    .update({
                        review_status: 'approved',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: adminState.currentAdmin.id,
                        reviewer_comments: comments,
                        earned_points: points
                    })
                    .eq('id', submissionId);
                
                // Update user mission
                await supabase
                    .from('user_missions')
                    .update({
                        status: 'completed',
                        completed_at: new Date().toISOString(),
                        earned_coins: points
                    })
                    .eq('user_id', submission.user_id)
                    .eq('mission_id', submission.mission_id);
                
                // Update user coins
                await supabase.rpc('increment_user_coins', {
                    user_id: submission.user_id,
                    amount: points
                });
            }
            
            showToast(`${selected.length} submissions approved`, 'success');
            closeBulkReviewModal();
            loadSubmissions();
            
        } catch (error) {
            console.error('Error approving bulk:', error);
            showToast('Failed to approve submissions', 'error');
        }
    }

    async function rejectBulk() {
        const selected = Array.from(document.querySelectorAll('.bulk-select:checked'))
            .map(cb => cb.value);
        
        if (selected.length === 0) {
            showToast('Please select at least one submission', 'error');
            return;
        }
        
        const comments = document.getElementById('bulk-comments').value;
        
        if (!comments && !confirm('Reject selected submissions without comments?')) {
            return;
        }
        
        if (!confirm(`Reject ${selected.length} submissions?`)) {
            return;
        }
        
        try {
            for (const submissionId of selected) {
                // Get submission details
                const { data: submission, error: fetchError } = await supabase
                    .from('submissions')
                    .select('user_id, mission_id')
                    .eq('id', submissionId)
                    .single();
                
                if (fetchError) continue;
                
                // Update submission
                await supabase
                    .from('submissions')
                    .update({
                        review_status: 'rejected',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: adminState.currentAdmin.id,
                        reviewer_comments: comments
                    })
                    .eq('id', submissionId);
                
                // Update user mission
                await supabase
                    .from('user_missions')
                    .update({
                        status: 'unlocked',
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', submission.user_id)
                    .eq('mission_id', submission.mission_id);
            }
            
            showToast(`${selected.length} submissions rejected`, 'success');
            closeBulkReviewModal();
            loadSubmissions();
            
        } catch (error) {
            console.error('Error rejecting bulk:', error);
            showToast('Failed to reject submissions', 'error');
        }
    }

    // ============================================
    // REPORTS MANAGEMENT
    // ============================================
    async function loadReports() {
        try {
            const { data: reports, error } = await supabase
                .from('reports')
                .select(`
                    *,
                    reporter:users!reporter_id (name, avatar_url),
                    reported_user:users!reported_user_id (name, avatar_url)
                `)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            updateReportsTable(reports || []);
        } catch (error) {
            console.error('Error loading reports:', error);
            showToast('Failed to load reports', 'error');
        }
    }

    function updateReportsTable(reports) {
        const tbody = document.getElementById('reports-list');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (reports.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center p-4">
                        No reports found
                    </td>
                </tr>
            `;
            return;
        }
        
        reports.forEach(report => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${report.reporter?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + report.reporter_id}" 
                             class="user-avatar-small">
                        <span>${report.reporter?.name || 'Unknown'}</span>
                    </div>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${report.reported_user?.avatar_url || 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + report.reported_user_id}" 
                             class="user-avatar-small">
                        <span>${report.reported_user?.name || 'Unknown'}</span>
                    </div>
                </td>
                <td>
                    <span class="status-badge" style="text-transform: capitalize;">
                        ${report.report_type}
                    </span>
                </td>
                <td>${report.description || 'No description'}</td>
                <td>
                    <span class="status-badge ${report.status === 'resolved' ? 'status-completed' : 'status-pending'}">
                        ${report.status}
                    </span>
                </td>
                <td>${formatTime(report.created_at)}</td>
                <td>
                    <div class="quick-actions" style="gap: 4px;">
                        <button class="action-btn" onclick="viewReport('${report.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn success" onclick="resolveReport('${report.id}')" style="padding: 4px 8px; font-size: 12px;">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function filterReports(status) {
        // TODO: Implement report filtering
        showToast(`Filtering reports by ${status}`, 'info');
    }

    function viewReport(reportId) {
        // TODO: Implement report view
        showToast('Report view coming soon', 'info');
    }

    async function resolveReport(reportId) {
        try {
            await supabase
                .from('reports')
                .update({
                    status: 'resolved',
                    resolved_at: new Date().toISOString(),
                    resolved_by: adminState.currentAdmin.id
                })
                .eq('id', reportId);
            
            showToast('Report resolved', 'success');
            loadReports();
            
        } catch (error) {
            console.error('Error resolving report:', error);
            showToast('Failed to resolve report', 'error');
        }
    }

    // ============================================
    // ANALYTICS
    // ============================================
    async function loadAnalytics() {
        try {
            const period = document.getElementById('analytics-period').value;
            
            // Load analytics data based on period
            const [newUsers, completedMissions, coinsEarned, purchases] = await Promise.all([
                getNewUsersCount(period),
                getCompletedMissionsCount(period),
                getCoinsEarned(period),
                getPurchasesCount(period)
            ]);
            
            // Update stats
            document.getElementById('new-users').textContent = newUsers;
            document.getElementById('completed-missions').textContent = completedMissions;
            document.getElementById('coins-earned').textContent = coinsEarned;
            document.getElementById('purchases-count').textContent = purchases;
            
            // Load zone analytics
            loadZoneAnalytics(period);
            
        } catch (error) {
            console.error('Error loading analytics:', error);
            showToast('Failed to load analytics', 'error');
        }
    }

    async function getNewUsersCount(period) {
        const { count, error } = await supabase
            .from('users')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', getDateRange(period).start);
        
        return error ? 0 : count || 0;
    }

    async function getCompletedMissionsCount(period) {
        const { count, error } = await supabase
            .from('user_missions')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'completed')
            .gte('completed_at', getDateRange(period).start);
        
        return error ? 0 : count || 0;
    }

    async function getCoinsEarned(period) {
        const { data, error } = await supabase
            .from('user_missions')
            .select('earned_coins')
            .eq('status', 'completed')
            .gte('completed_at', getDateRange(period).start);
        
        if (error) return 0;
        
        return data.reduce((sum, mission) => sum + (mission.earned_coins || 0), 0);
    }

    async function getPurchasesCount(period) {
        const { count, error } = await supabase
            .from('purchases')
            .select('*', { count: 'exact', head: true })
            .gte('created_at', getDateRange(period).start);
        
        return error ? 0 : count || 0;
    }

    function getDateRange(period) {
        const now = new Date();
        const start = new Date();
        
        switch(period) {
            case 'today':
                start.setHours(0, 0, 0, 0);
                break;
            case 'week':
                start.setDate(now.getDate() - 7);
                break;
            case 'month':
                start.setMonth(now.getMonth() - 1);
                break;
            case 'quarter':
                start.setMonth(now.getMonth() - 3);
                break;
            case 'year':
                start.setFullYear(now.getFullYear() - 1);
                break;
            default:
                start.setMonth(now.getMonth() - 1);
        }
        
        return {
            start: start.toISOString(),
            end: now.toISOString()
        };
    }

    async function loadZoneAnalytics(period) {
        try {
            const { data, error } = await supabase
                .from('zones')
                .select(`
                    id,
                    name,
                    missions (
                        id,
                        user_missions (
                            id,
                            status,
                            completed_at
                        )
                    )
                `)
                .eq('is_active', true);
            
            if (error) throw error;
            
            updateZoneAnalyticsTable(data || []);
        } catch (error) {
            console.error('Error loading zone analytics:', error);
        }
    }

    function updateZoneAnalyticsTable(zones) {
        const tbody = document.getElementById('zones-analytics');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (zones.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center p-4">
                        No zone data available
                    </td>
                </tr>
            `;
            return;
        }
        
        zones.forEach(zone => {
            // Calculate zone statistics
            const missions = zone.missions || [];
            const totalMissions = missions.length;
            
            let totalCompletions = 0;
            let totalTime = 0;
            let completedCount = 0;
            
            missions.forEach(mission => {
                const userMissions = mission.user_missions || [];
                const completed = userMissions.filter(um => um.status === 'completed');
                totalCompletions += completed.length;
                
                completed.forEach(um => {
                    if (um.completed_at) {
                        // Calculate time difference (simplified)
                        totalTime += 30; // Assuming 30 minutes average
                        completedCount++;
                    }
                });
            });
            
            const successRate = totalCompletions > 0 ? 
                Math.round((totalCompletions / (totalCompletions + missions.length)) * 100) : 0;
            const avgTime = completedCount > 0 ? Math.round(totalTime / completedCount) : 0;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${zone.name}</strong></td>
                <td>${totalMissions}</td>
                <td>${totalCompletions}</td>
                <td>${successRate}%</td>
                <td>${avgTime}m</td>
            `;
            tbody.appendChild(row);
        });
    }

    // ============================================
    // EXPORT FUNCTIONS
    // ============================================
    async function exportAllData() {
        showToast('Exporting all data...', 'info');
        
        try {
            // Get export options
            const format = document.getElementById('export-format').value;
            const includeUsers = document.getElementById('export-users-data').checked;
            const includeMissions = document.getElementById('export-missions-data').checked;
            const includeZones = document.getElementById('export-zones-data').checked;
            const includePrizes = document.getElementById('export-prizes-data').checked;
            const includeSOS = document.getElementById('export-sos-data').checked;
            
            // Collect data
            const data = {};
            
            if (includeUsers) {
                const { data: users } = await supabase.from('users').select('*');
                data.users = users;
            }
            
            if (includeMissions) {
                const { data: missions } = await supabase.from('missions').select('*');
                data.missions = missions;
            }
            
            if (includeZones) {
                const { data: zones } = await supabase.from('zones').select('*');
                data.zones = zones;
            }
            
            if (includePrizes) {
                const { data: prizes } = await supabase.from('prizes').select('*');
                data.prizes = prizes;
            }
            
            if (includeSOS) {
                const { data: sos } = await supabase.from('sos_alerts').select('*');
                data.sos = sos;
            }
            
            // Create export file
            let blob, filename;
            
            if (format === 'json') {
                blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                filename = `thehunt_export_${Date.now()}.json`;
            } else if (format === 'csv') {
                // Convert to CSV (simplified)
                let csv = '';
                for (const [key, value] of Object.entries(data)) {
                    if (value && value.length > 0) {
                        csv += `${key.toUpperCase()}\n`;
                        const headers = Object.keys(value[0]).join(',');
                        csv += headers + '\n';
                        value.forEach(row => {
                            const values = Object.values(row).map(v => 
                                typeof v === 'object' ? JSON.stringify(v) : v
                            ).join(',');
                            csv += values + '\n';
                        });
                        csv += '\n';
                    }
                }
                blob = new Blob([csv], { type: 'text/csv' });
                filename = `thehunt_export_${Date.now()}.csv`;
            } else {
                // Excel (using CSV for simplicity)
                let csv = '';
                for (const [key, value] of Object.entries(data)) {
                    if (value && value.length > 0) {
                        csv += `${key.toUpperCase()}\n`;
                        const headers = Object.keys(value[0]).join(',');
                        csv += headers + '\n';
                        value.forEach(row => {
                            const values = Object.values(row).map(v => 
                                typeof v === 'object' ? JSON.stringify(v) : v
                            ).join(',');
                            csv += values + '\n';
                        });
                        csv += '\n';
                    }
                }
                blob = new Blob([csv], { type: 'application/vnd.ms-excel' });
                filename = `thehunt_export_${Date.now()}.xls`;
            }
            
            // Download file
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Export completed', 'success');
            
            // Add to export history
            addExportHistory(filename, format, blob.size);
            
        } catch (error) {
            console.error('Error exporting data:', error);
            showToast('Export failed', 'error');
        }
    }

    function addExportHistory(filename, format, size) {
        const tbody = document.getElementById('export-history');
        if (!tbody) return;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date().toLocaleString()}</td>
            <td>${filename.split('_')[1]}</td>
            <td>${format.toUpperCase()}</td>
            <td>${formatBytes(size)}</td>
            <td>
                <button class="action-btn" style="padding: 4px 8px; font-size: 12px;">
                    <i class="fas fa-download"></i>
                </button>
            </td>
        `;
        
        tbody.insertBefore(row, tbody.firstChild);
        
        // Limit to 10 entries
        if (tbody.children.length > 10) {
            tbody.removeChild(tbody.lastChild);
        }
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function exportUserData() {
        showToast('Exporting user data...', 'info');
        // Similar to exportAllData but only users
    }

    async function exportMissionData() {
        showToast('Exporting mission data...', 'info');
        // Similar to exportAllData but only missions
    }

    async function exportZoneData() {
        showToast('Exporting zone data...', 'info');
        // Similar to exportAllData but only zones
    }

    async function exportPrizeData() {
        showToast('Exporting prize data...', 'info');
        // Similar to exportAllData but only prizes
    }

    async function exportSOSData() {
        showToast('Exporting SOS data...', 'info');
        // Similar to exportAllData but only SOS
    }

    async function exportMapData() {
        showToast('Exporting map data...', 'info');
        // Export map-related data
    }

    async function exportReportsData() {
        showToast('Exporting reports data...', 'info');
        // Export reports data
    }

    async function exportAnalyticsData() {
        showToast('Exporting analytics data...', 'info');
        // Export analytics data
    }

    async function exportZonesData() {
        showToast('Exporting zones data...', 'info');
        // Export zones data
    }

    async function exportPrizesData() {
        showToast('Exporting prizes data...', 'info');
        // Export prizes data
    }

    // ============================================
    // SETTINGS
    // ============================================
    async function loadSystemInfo() {
        try {
            // Get database size (simplified)
            const { count: userCount } = await supabase
                .from('users')
                .select('*', { count: 'exact', head: true });
            
            const { count: missionCount } = await supabase
                .from('missions')
                .select('*', { count: 'exact', head: true });
            
            const { count: submissionCount } = await supabase
                .from('submissions')
                .select('*', { count: 'exact', head: true });
            
            // Calculate approximate sizes
            const dbSize = (userCount * 1024) + (missionCount * 512) + (submissionCount * 2048); // bytes
            
            document.getElementById('db-size').textContent = formatBytes(dbSize);
            document.getElementById('storage-usage').textContent = 'Calculating...';
            document.getElementById('system-uptime').textContent = 'Since ' + new Date().toLocaleDateString();
            
        } catch (error) {
            console.error('Error loading system info:', error);
        }
    }

    function saveGameSettings() {
        // Get all game settings
        const settings = {
            event_name: document.getElementById('event-name').value,
            event_start: document.getElementById('event-start').value,
            event_end: document.getElementById('event-end').value,
            event_active: document.getElementById('event-active').checked,
            points_multiplier: parseFloat(document.getElementById('points-multiplier').value),
            zone_bonus: parseInt(document.getElementById('zone-bonus').value),
            login_bonus: parseInt(document.getElementById('login-bonus').value),
            leaderboard_enabled: document.getElementById('leaderboard-enabled').checked,
            max_missions: parseInt(document.getElementById('max-missions').value),
            mission_time_limit: parseInt(document.getElementById('mission-time-limit').value),
            gps_radius: parseInt(document.getElementById('gps-radius').value),
            multiple_submissions: document.getElementById('multiple-submissions').checked,
            email_notifications: document.getElementById('email-notifications').checked,
            push_notifications: document.getElementById('push-notifications').checked,
            sms_alerts: document.getElementById('sms-alerts').checked,
            notification_schedule: document.getElementById('notification-schedule').value
        };
        
        // Save to localStorage
        localStorage.setItem('hunt_game_settings', JSON.stringify(settings));
        
        showToast('Game settings saved', 'success');
    }

    function resetGameSettings() {
        if (confirm('Reset all game settings to default?')) {
            localStorage.removeItem('hunt_game_settings');
            
            // Reset form values to defaults
            document.getElementById('event-name').value = 'The Hunt';
            document.getElementById('event-start').value = '';
            document.getElementById('event-end').value = '';
            document.getElementById('event-active').checked = true;
            document.getElementById('points-multiplier').value = 1;
            document.getElementById('zone-bonus').value = 50;
            document.getElementById('login-bonus').value = 10;
            document.getElementById('leaderboard-enabled').checked = true;
            document.getElementById('max-missions').value = 10;
            document.getElementById('mission-time-limit').value = 30;
            document.getElementById('gps-radius').value = 50;
            document.getElementById('multiple-submissions').checked = false;
            document.getElementById('email-notifications').checked = true;
            document.getElementById('push-notifications').checked = true;
            document.getElementById('sms-alerts').checked = false;
            document.getElementById('notification-schedule').value = 'immediate';
            
            showToast('Game settings reset to default', 'success');
        }
    }

    function saveSystemSettings() {
        const settings = {
            site_title: document.getElementById('site-title').value,
            admin_email: document.getElementById('admin-email-settings').value,
            contact_phone: document.getElementById('contact-phone').value,
            maintenance_mode: document.getElementById('maintenance-mode').checked,
            email_verification: document.getElementById('email-verification').checked,
            two_factor_auth: document.getElementById('two-factor-auth').checked,
            session_timeout: parseInt(document.getElementById('session-timeout').value),
            max_login_attempts: parseInt(document.getElementById('max-login-attempts').value),
            max_file_size: parseInt(document.getElementById('max-file-size').value),
            allowed_file_types: document.getElementById('allowed-file-types').value,
            auto_backup: document.getElementById('auto-backup').checked,
            backup_frequency: document.getElementById('backup-frequency').value,
            mapbox_token: document.getElementById('mapbox-token').value,
            sms_api_key: document.getElementById('sms-api-key').value,
            email_service: document.getElementById('email-service').value,
            enable_api: document.getElementById('enable-api').checked
        };
        
        localStorage.setItem('hunt_system_settings', JSON.stringify(settings));
        showToast('System settings saved', 'success');
    }

    function resetSystemSettings() {
        if (confirm('Reset all system settings to default?')) {
            localStorage.removeItem('hunt_system_settings');
            
            document.getElementById('site-title').value = 'The Hunt';
            document.getElementById('admin-email-settings').value = '';
            document.getElementById('contact-phone').value = '';
            document.getElementById('maintenance-mode').checked = false;
            document.getElementById('email-verification').checked = true;
            document.getElementById('two-factor-auth').checked = false;
            document.getElementById('session-timeout').value = 60;
            document.getElementById('max-login-attempts').value = 5;
            document.getElementById('max-file-size').value = 10;
            document.getElementById('allowed-file-types').value = 'jpg,jpeg,png,gif,mp4,webm';
            document.getElementById('auto-backup').checked = true;
            document.getElementById('backup-frequency').value = 'daily';
            document.getElementById('mapbox-token').value = '';
            document.getElementById('sms-api-key').value = '';
            document.getElementById('email-service').value = 'smtp';
            document.getElementById('enable-api').checked = false;
            
            showToast('System settings reset to default', 'success');
        }
    }

    // ============================================
    // REAL-TIME SUBSCRIPTIONS
    // ============================================
    function setupRealTimeSubscriptions() {
        console.log('Setting up real-time subscriptions...');
        
        // Subscribe to SOS alerts
        const sosChannel = supabase
            .channel('sos-alerts')
            .on('postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'sos_alerts' },
                (payload) => {
                    console.log('New SOS alert:', payload.new);
                    adminState.activeSOS++;
                    updateSidebarBadges(adminState.pendingReviews, adminState.activeSOS);
                    showSOSAlert(payload.new);
                    
                    if (adminState.currentSection === 'sos-alerts') {
                        loadSOSAlerts();
                    }
                    if (adminState.currentSection === 'live-map' && adminState.map) {
                        addSOSToMap([payload.new]);
                    }
                }
            )
            .subscribe();
        
        // Subscribe to new submissions
        const submissionsChannel = supabase
            .channel('new-submissions')
            .on('postgres_changes',
                { event: 'INSERT', schema: 'public', table: 'submissions' },
                (payload) => {
                    console.log('New submission:', payload.new);
                    adminState.pendingReviews++;
                    updateSidebarBadges(adminState.pendingReviews, adminState.activeSOS);
                    
                    if (adminState.currentSection === 'mission-review') {
                        loadSubmissions();
                    }
                }
            )
            .subscribe();
        
        // Subscribe to user updates
        const usersChannel = supabase
            .channel('user-updates')
            .on('postgres_changes',
                { event: 'UPDATE', schema: 'public', table: 'users' },
                (payload) => {
                    console.log('User updated:', payload.new);
                    if (adminState.currentSection === 'live-map' && adminState.map) {
                        // Update player on map
                        refreshMapData();
                    }
                }
            )
            .subscribe();
        
        adminState.realTimeChannels = [sosChannel, submissionsChannel, usersChannel];
        console.log('Real-time subscriptions active');
    }

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function formatTime(dateString) {
        if (!dateString) return 'Never';
        
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) {
            return 'Just now';
        } else if (diffMins < 60) {
            return `${diffMins}m ago`;
        } else if (diffHours < 24) {
            return `${diffHours}h ago`;
        } else if (diffDays < 7) {
            return `${diffDays}d ago`;
        } else {
            return date.toLocaleDateString();
        }
    }

    function searchZones() {
        const search = document.getElementById('search-zones').value.toLowerCase();
        const rows = document.querySelectorAll('#zones-list tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function searchMissions() {
        const search = document.getElementById('search-missions').value.toLowerCase();
        const rows = document.querySelectorAll('#missions-list tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function searchPrizes() {
        const search = document.getElementById('search-prizes').value.toLowerCase();
        const rows = document.querySelectorAll('#prizes-list tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function searchPurchases() {
        const search = document.getElementById('search-purchases').value.toLowerCase();
        const rows = document.querySelectorAll('#purchases-list tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function searchUsers() {
        const search = document.getElementById('search-users').value.toLowerCase();
        const rows = document.querySelectorAll('#users-management-list tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function searchSOS() {
        const search = document.getElementById('search-sos').value.toLowerCase();
        const rows = document.querySelectorAll('#sos-alerts-list tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function searchActivity() {
        const search = document.getElementById('search-activity').value.toLowerCase();
        const rows = document.querySelectorAll('#recent-activity tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function searchSubmissions() {
        const search = document.getElementById('search-submissions').value.toLowerCase();
        const items = document.querySelectorAll('#submission-list .mission-item');
        
        items.forEach(item => {
            const text = item.textContent.toLowerCase();
            item.style.display = text.includes(search) ? '' : 'none';
        });
    }

    function viewUser(userId) {
        showSection('users');
        // TODO: Scroll to and highlight user
    }

    function viewLocationOnMap(lat, lng) {
        showSection('live-map');
        
        setTimeout(() => {
            if (adminState.map) {
                adminState.map.flyTo({
                    center: [lng, lat],
                    zoom: 15,
                    essential: true
                });
            }
        }, 500);
    }

    // ============================================
    // EXPOSE FUNCTIONS FOR HTML ONCLICK HANDLERS
    // ============================================
    window.showSection = showSection;
    window.showToast = showToast;
    window.showCreateZoneModal = showCreateZoneModal;
    window.hideZoneCreation = hideZoneCreation;
    window.showCreateMissionModal = showCreateMissionModal;
    window.showCreatePrizeModal = showCreatePrizeModal;
    window.showEditZoneModal = showEditZoneModal;
    window.showAddUserModal = showAddUserModal;
    window.showAddAdminModal = showAddAdminModal;
    window.showBulkReviewModal = showBulkReviewModal;
    window.showSOSDetailsModal = showSOSDetailsModal;
    window.showMediaViewModal = showMediaViewModal;
    window.viewSOSAlert = viewSOSAlert;
    window.acknowledgeSOSAlert = acknowledgeSOSAlert;
    window.acknowledgeAllSOS = acknowledgeAllSOS;
    window.viewZoneMissions = viewZoneMissions;
    window.viewUserMissions = viewUserMissions;
    window.viewUser = viewUser;
    window.viewLocationOnMap = viewLocationOnMap;
    window.editMission = editMission;
    window.toggleMissionStatus = toggleMissionStatus;
    window.editPrize = editPrize;
    window.togglePrizeStatus = togglePrizeStatus;
    window.viewPurchase = viewPurchase;
    window.toggleZoneStatus = toggleZoneStatus;
    window.editUser = editUser;
    window.toggleUserStatus = toggleUserStatus;
    window.addCoins = addCoins;
    window.viewAdminPermissions = viewAdminPermissions;
    window.editAdmin = editAdmin;
    window.toggleAdminStatus = toggleAdminStatus;
    window.viewReport = viewReport;
    window.resolveReport = resolveReport;
    window.exportUserData = exportUserData;
    window.exportMissionData = exportMissionData;
    window.exportZoneData = exportZoneData;
    window.exportPrizeData = exportPrizeData;
    window.exportSOSData = exportSOSData;
    window.exportMapData = exportMapData;
    window.exportReportsData = exportReportsData;
    window.exportAnalyticsData = exportAnalyticsData;
    window.exportZonesData = exportZonesData;
    window.exportPrizesData = exportPrizesData;
    window.exportAllData = exportAllData;
    window.saveGameSettings = saveGameSettings;
    window.resetGameSettings = resetGameSettings;
    window.saveSystemSettings = saveSystemSettings;
    window.resetSystemSettings = resetSystemSettings;
    </script>
</body>
</html>
