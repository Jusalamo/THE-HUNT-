<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>The Hunt - Treasure Hunt Adventure</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
    /* ============================================
       VERCEL-STYLE DARK THEME (Matching Admin)
       ============================================ */
    :root {
        /* Color Palette - Matching Admin */
        --black: #000000;
        --gray-900: #111111;
        --gray-800: #1a1a1a;
        --gray-700: #2a2a2a;
        --gray-600: #444444;
        --gray-500: #666666;
        --gray-400: #888888;
        --gray-300: #aaaaaa;
        --gray-200: #cccccc;
        --gray-100: #e5e5e5;
        --white: #ffffff;
        
        /* Accent Colors */
        --blue: #0070f3;
        --blue-light: #3291ff;
        --red: #ff0000;
        --red-light: #ff3333;
        --green: #00cc66;
        --green-light: #33ff99;
        --yellow: #ffcc00;
        --yellow-light: #ffdd44;
        
        /* UI Colors */
        --bg-primary: var(--black);
        --bg-secondary: var(--gray-900);
        --bg-tertiary: var(--gray-800);
        --bg-card: var(--gray-800);
        --border-color: var(--gray-700);
        --text-primary: var(--white);
        --text-secondary: var(--gray-300);
        --text-muted: var(--gray-500);
        
        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.4);
        --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
        --shadow-lg: 0 10px 25px rgba(0,0,0,0.5);
        
        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-normal: 250ms ease;
        --transition-slow: 350ms ease;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        position: fixed;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        overflow: hidden;
        position: relative;
        line-height: 1.5;
        font-size: 14px;
    }

    /* ============================================
       AUTH SCREENS
       ============================================ */
    .auth-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 10000;
        overflow-y: auto;
    }

    .auth-container {
        width: 100%;
        max-width: 400px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 40px 30px;
        box-shadow: var(--shadow-lg);
    }

    .logo {
        text-align: center;
        margin-bottom: 40px;
    }

    .logo h1 {
        font-size: 2.2rem;
        color: var(--white);
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: 1px;
    }

    .logo p {
        color: var(--text-secondary);
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control {
        width: 100%;
        padding: 14px;
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 15px;
        transition: all var(--transition-fast);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--blue);
        box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
        background: var(--bg-primary);
    }

    .btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        letter-spacing: 0.5px;
    }

    .btn-primary {
        background: var(--blue);
        color: white;
    }

    .btn-primary:hover {
        background: var(--blue-light);
        transform: translateY(-1px);
    }

    .btn-danger {
        background: var(--red);
        color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    .auth-switch {
        text-align: center;
        margin-top: 24px;
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .auth-switch a {
        color: var(--blue);
        text-decoration: none;
        font-weight: 600;
        margin-left: 5px;
    }

    .error-message {
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid var(--red);
        color: var(--red-light);
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 0.85rem;
        display: none;
        line-height: 1.4;
    }

    .success-message {
        background: rgba(0, 204, 102, 0.1);
        border: 1px solid var(--green);
        color: var(--green-light);
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 0.85rem;
        display: none;
        line-height: 1.4;
    }

    /* ============================================
       MAIN APP CONTAINER
       ============================================ */
    .app-container {
        display: none;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        position: relative;
        background: var(--bg-primary);
    }

    /* ============================================
       HEADER
       ============================================ */
    .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 60px;
        background: var(--bg-secondary);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        z-index: 1000;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
    }

    .profile-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid var(--blue);
        background: var(--bg-card);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        flex-shrink: 0;
    }

    .profile-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-btn i {
        font-size: 18px;
    }

    .timer {
        background: var(--bg-card);
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 1px;
        border: 1px solid var(--border-color);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 0;
        color: var(--blue);
    }

    .coins-display {
        display: flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
        flex-shrink: 0;
        margin-left: auto;
        background: var(--bg-card);
        padding: 6px 12px;
        border-radius: 20px;
        border: 1px solid var(--border-color);
    }

    .coins-display i {
        color: var(--yellow);
    }

    /* ============================================
       SOS BUTTON
       ============================================ */
    .sos-btn {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: var(--red);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.3rem;
        box-shadow: 0 4px 20px rgba(255, 0, 0, 0.3);
        cursor: pointer;
        z-index: 9999;
        border: none;
        animation: pulse 2s infinite;
        flex-shrink: 0;
        transition: all var(--transition-fast);
    }

    .sos-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(255, 0, 0, 0.5);
    }

    .sos-btn:active {
        transform: scale(0.95);
    }

    @keyframes pulse {
        0% { 
            transform: scale(1); 
            box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); 
        }
        70% { 
            transform: scale(1.05); 
            box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); 
        }
        100% { 
            transform: scale(1); 
            box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); 
        }
    }

    /* ============================================
       MAIN CONTENT
       ============================================ */
    .main-content {
        flex: 1;
        padding: 16px;
        padding-top: 76px;
        padding-bottom: 70px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
        position: relative;
    }

    /* ============================================
       TAB CONTAINERS
       ============================================ */
    .tab-container {
        display: none;
        width: 100%;
        min-height: 100%;
    }

    .tab-container.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ============================================
       MAP CONTAINER
       ============================================ */
    .map-container {
        height: 50vh;
        min-height: 300px;
        width: 100%;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        margin-bottom: 16px;
    }

    #map {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .map-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: var(--bg-card);
        color: var(--text-secondary);
        gap: 16px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    /* Location Permission Banner */
    .location-permission {
        text-align: center;
        padding: 20px;
        background: var(--bg-card);
        border-radius: 8px;
        margin: 16px 0;
        border: 1px solid var(--border-color);
        width: 100%;
        animation: fadeIn 0.5s ease;
    }

    .location-permission button {
        margin-top: 12px;
        padding: 12px 24px;
        background: var(--blue);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all var(--transition-fast);
    }

    .location-permission button:hover {
        background: var(--blue-light);
        transform: translateY(-1px);
    }

    /* ============================================
       ZONE LIST
       ============================================ */
    .zone-list {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 8px 0;
        margin-bottom: 16px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        width: 100%;
    }

    .zone-list::-webkit-scrollbar {
        display: none;
    }

    .zone-item {
        flex: 0 0 auto;
        padding: 10px 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        cursor: pointer;
        transition: all var(--transition-fast);
        white-space: nowrap;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .zone-item:hover {
        background: var(--bg-tertiary);
    }

    .zone-item.active {
        background: var(--blue);
        color: white;
        border-color: transparent;
    }

    /* ============================================
       MISSION CARDS
       ============================================ */
    .missions-list-container {
        width: 100%;
        overflow: hidden;
    }

    .mission-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid var(--border-color);
        transition: all var(--transition-fast);
        width: 100%;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .mission-card.completed {
        border-color: var(--green);
        background: rgba(0, 204, 102, 0.05);
    }

    .mission-card.unlocked {
        border-color: var(--blue);
        background: rgba(0, 112, 243, 0.05);
    }

    .mission-card.locked {
        opacity: 0.6;
    }

    .mission-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        width: 100%;
        gap: 8px;
    }

    .mission-title {
        font-size: 1rem;
        font-weight: 600;
        flex: 1;
        color: var(--text-primary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .mission-points {
        background: var(--blue);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.8rem;
        flex-shrink: 0;
    }

    .mission-type-badge {
        display: inline-block;
        padding: 4px 8px;
        background: rgba(0, 112, 243, 0.2);
        color: var(--blue);
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .mission-question {
        color: var(--text-primary);
        margin-bottom: 12px;
        line-height: 1.5;
        font-size: 14px;
        padding: 10px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        width: 100%;
        overflow-wrap: break-word;
    }

    .mission-description {
        color: var(--text-secondary);
        margin-bottom: 12px;
        line-height: 1.5;
        font-size: 13px;
        width: 100%;
        overflow-wrap: break-word;
    }

    .mission-actions {
        display: flex;
        gap: 8px;
        width: 100%;
    }

    .action-btn {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: none;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .action-btn:hover:not(:disabled) {
        background: var(--gray-700);
        transform: translateY(-1px);
    }

    .action-btn.record {
        background: var(--blue);
        color: white;
    }

    .action-btn.record:hover:not(:disabled) {
        background: var(--blue-light);
    }

    .action-btn.completed {
        background: var(--green);
        color: white;
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* ============================================
       SHOP & PRIZES
       ============================================ */
    .shop-categories {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        margin-bottom: 16px;
        padding: 4px 0;
    }

    .category-btn {
        padding: 8px 16px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition-fast);
        white-space: nowrap;
    }

    .category-btn:hover {
        background: var(--bg-tertiary);
    }

    .category-btn.active {
        background: var(--blue);
        color: white;
        border-color: transparent;
    }

    .prize-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
        width: 100%;
    }

    .prize-card {
        background: var(--bg-card);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        transition: all var(--transition-fast);
        width: 100%;
    }

    .prize-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--blue);
    }

    .prize-image {
        width: 100%;
        height: 120px;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }

    .prize-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .prize-content {
        padding: 12px;
    }

    .prize-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--text-primary);
        line-height: 1.3;
    }

    .prize-description {
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 8px;
        line-height: 1.4;
    }

    .prize-price {
        display: flex;
        align-items: center;
        gap: 4px;
        font-weight: 600;
        color: var(--yellow);
        margin-bottom: 4px;
    }

    .inventory-info {
        font-size: 11px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .buy-btn {
        width: 100%;
        padding: 8px;
        background: var(--blue);
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        font-size: 13px;
    }

    .buy-btn:hover:not(:disabled) {
        background: var(--blue-light);
    }

    .buy-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* ============================================
       INVENTORY
       ============================================ */
    .inventory-items {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
    }

    .inventory-item {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 12px;
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all var(--transition-fast);
    }

    .inventory-item:hover {
        border-color: var(--blue);
        background: var(--bg-tertiary);
    }

    /* ============================================
       LEADERBOARD
       ============================================ */
    .leaderboard-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .leaderboard-item {
        transition: all var(--transition-fast);
    }

    .leaderboard-item:hover {
        transform: translateX(5px);
    }

    /* ============================================
       PROFILE
       ============================================ */
    .profile-header {
        text-align: center;
        margin-bottom: 24px;
        padding: 20px;
        background: var(--bg-card);
        border-radius: 10px;
        border: 1px solid var(--border-color);
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 36px;
        margin: 0 auto 16px;
        border: 3px solid var(--blue);
        overflow: hidden;
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-name {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--text-primary);
    }

    .profile-email {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .profile-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        width: 100%;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--bg-card);
        border-radius: 10px;
        padding: 16px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    .stat-card h4 {
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--blue);
    }

    .profile-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .profile-action-btn {
        padding: 14px;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-primary);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 14px;
    }

    .profile-action-btn:hover {
        background: var(--bg-tertiary);
        border-color: var(--blue);
        transform: translateY(-1px);
    }

    .profile-action-btn.logout-btn {
        background: rgba(255, 0, 0, 0.1);
        border-color: var(--red);
        color: var(--red-light);
    }

    .profile-action-btn.logout-btn:hover {
        background: rgba(255, 0, 0, 0.2);
    }

    /* ============================================
       BOTTOM NAVIGATION
       ============================================ */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 64px;
        background: var(--bg-secondary);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 1000;
        padding-bottom: env(safe-area-inset-bottom);
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all var(--transition-fast);
        min-width: 56px;
        flex: 1;
        max-width: 80px;
    }

    .nav-item:hover {
        background: var(--bg-tertiary);
    }

    .nav-item.active {
        color: var(--blue);
        background: var(--bg-tertiary);
    }

    .nav-item i {
        font-size: 18px;
    }

    .nav-label {
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    /* ============================================
       LOADING & EMPTY STATES
       ============================================ */
    .loading-spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid var(--blue);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .empty-state {
        text-align: center;
        padding: 40px 16px;
        color: var(--text-secondary);
        width: 100%;
    }

    .empty-state i {
        font-size: 40px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    /* ============================================
       TOAST NOTIFICATIONS
       ============================================ */
    .toast-container {
        position: fixed;
        top: 80px;
        right: 16px;
        z-index: 10002;
        max-width: calc(100% - 32px);
    }

    .toast {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        min-width: 280px;
        max-width: 400px;
        transform: translateX(400px);
        transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        word-wrap: break-word;
    }

    .toast.show {
        transform: translateX(0);
    }

    .toast-success {
        border-left: 4px solid var(--green);
    }

    .toast-error {
        border-left: 4px solid var(--red);
    }

    .toast-info {
        border-left: 4px solid var(--blue);
    }

    .toast-warning {
        border-left: 4px solid var(--yellow);
    }

    /* ============================================
       MODALS
       ============================================ */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10001;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        overflow-y: auto;
        animation: fadeIn 0.3s ease;
        backdrop-filter: blur(4px);
    }

    .modal-container {
        width: 100%;
        max-width: 500px;
        background: var(--bg-card);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        border: 1px solid var(--border-color);
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
    }

    /* Emergency Modal */
    #emergency-modal .modal-container {
        background: var(--red);
        color: white;
        text-align: center;
        animation: emergencyPulse 1s infinite;
        border: 2px solid white;
    }

    @keyframes emergencyPulse {
        0% { 
            box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7), 
                        0 0 0 0 rgba(255, 255, 255, 0.3); 
        }
        70% { 
            box-shadow: 0 0 0 20px rgba(255, 0, 0, 0), 
                        0 0 0 10px rgba(255, 255, 255, 0); 
        }
        100% { 
            box-shadow: 0 0 0 0 rgba(255, 0, 0, 0), 
                        0 0 0 0 rgba(255, 255, 255, 0); 
        }
    }

    /* Settings Modal */
    .settings-section {
        margin-bottom: 24px;
    }

    .settings-section h4 {
        color: var(--text-primary);
        margin-bottom: 12px;
        font-size: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
    }

    .setting-item:last-child {
        border-bottom: none;
    }

    .setting-label {
        flex: 1;
    }

    .setting-label h5 {
        font-size: 14px;
        margin-bottom: 4px;
        color: var(--text-primary);
    }

    .setting-label p {
        font-size: 12px;
        color: var(--text-secondary);
    }

    /* Switch Toggle */
    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--gray-700);
        transition: .4s;
        border-radius: 24px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--blue);
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    /* Range Slider - Themed */
    .range-slider {
        width: 200px;
    }

    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: var(--gray-700);
        border-radius: 3px;
        outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: var(--blue);
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* ============================================
       MEDIA QUERIES
       ============================================ */
    @media (max-width: 768px) {
        .prize-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        .auth-container {
            padding: 32px 24px;
        }
        
        .mission-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .mission-title {
            white-space: normal;
        }
        
        .profile-stats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .modal-container {
            max-width: 95%;
        }
        
        .map-container {
            height: 40vh;
        }
    }

    @media (max-width: 480px) {
        .prize-grid {
            grid-template-columns: 1fr;
        }
        
        .profile-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .mission-actions {
            flex-direction: column;
        }
        
        .sos-btn {
            width: 60px;
            height: 60px;
            bottom: 90px;
            right: 16px;
        }
        
        .toast {
            min-width: 250px;
            max-width: calc(100vw - 32px);
        }
        
        .nav-item {
            padding: 6px;
            min-width: 50px;
        }
        
        .nav-item i {
            font-size: 16px;
        }
        
        .nav-label {
            font-size: 9px;
        }
        
        .zone-item {
            padding: 8px 16px;
            font-size: 12px;
        }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
        :root {
            --blue: #0066cc;
            --red: #cc0000;
            --green: #009900;
            --text-primary: #ffffff;
            --bg-primary: #000000;
        }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        .sos-btn {
            animation: none;
        }
        
        #emergency-modal .modal-container {
            animation: none;
        }
        
        .toast {
            transition: none;
        }
    }
</style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-container">
            <div class="logo">
                <h1>THE HUNT</h1>
                <p>Treasure Hunt Adventure</p>
            </div>
            
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <!-- Login Form -->
            <div id="login-form">
                <h2 style="margin-bottom: 24px; text-align: center; color: var(--blue);">Welcome Back</h2>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="login-email" class="form-control" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="••••••••" required>
                </div>
                <button id="login-button" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
                <div class="auth-switch">
                    Don't have an account? <a href="#" id="show-signup-link">Create Account</a>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" style="display: none;">
                <h2 style="margin-bottom: 24px; text-align: center; color: var(--blue);">Create Account</h2>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signup-name" class="form-control" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="signup-phone" class="form-control" placeholder="+264 81 234 5678" required>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="signup-email" class="form-control" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signup-password" class="form-control" placeholder="••••••••" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Profile Photo</label>
                    <input type="file" id="signup-photo" class="form-control" accept="image/*" capture="user">
                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">
                        Take a selfie or upload a clear photo for identification
                    </small>
                </div>
                <button id="signup-button" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i>
                    Create Account
                </button>
                <div class="auth-switch">
                    Already have an account? <a href="#" id="show-login-link">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="profile-btn" id="profile-button">
                    <i class="fas fa-user"></i>
                </div>
                <div class="timer" id="event-timer">24:00:00</div>
            </div>
            <div class="coins-display">
                <i class="fas fa-coins"></i>
                <span id="user-coins">0</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <!-- Map Tab -->
            <div id="map-tab" class="tab-container active">
                <div class="map-container">
                    <div id="map">
                        <div class="map-loading">
                            <i class="fas fa-map-marked-alt"></i>
                            <p>Loading map...</p>
                        </div>
                    </div>
                </div>
                <div id="location-permission" class="location-permission" style="display: none;">
                    <p>Location access is required to show zones and missions.</p>
                    <button id="request-location-btn">Enable Location</button>
                </div>
                <div>
                    <h2 style="margin-bottom: 12px; font-size: 18px; color: var(--text-primary);">Current Zone</h2>
                    <div id="current-zone" style="background: var(--bg-card); padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid var(--border-color);">
                        <p style="color: var(--text-secondary); font-size: 13px;">Enable location to see zones</p>
                    </div>
                    <div id="nearby-missions" style="margin-top: 16px;">
                        <div class="empty-state">
                            <i class="fas fa-map-marker-alt"></i>
                            <p>No nearby missions. Move to a zone to see missions.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Missions Tab -->
            <div id="missions-tab" class="tab-container">
                <h2 style="margin-bottom: 12px; font-size: 18px; color: var(--text-primary);">Missions</h2>
                <div class="zone-list" id="zone-list">
                    <div class="loading-spinner" style="margin: 20px auto; width: 24px; height: 24px;"></div>
                </div>
                <div class="missions-list-container">
                    <div id="missions-list">
                        <div class="empty-state">
                            <i class="fas fa-tasks"></i>
                            <p>Select a zone to see missions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shop Tab -->
            <div id="shop-tab" class="tab-container">
                <div class="shop-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="font-size: 18px; color: var(--text-primary);">Prize Shop</h2>
                    <div class="coins-balance" style="background: var(--bg-card); padding: 8px 16px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid var(--border-color);">
                        <i class="fas fa-coins"></i>
                        <span id="shop-coins">0</span>
                    </div>
                </div>
                
                <div class="shop-categories" id="shop-categories">
                    <button class="category-btn active" data-category="all">All Items</button>
                    <button class="category-btn" data-category="physical">Physical</button>
                    <button class="category-btn" data-category="digital">Digital</button>
                    <button class="category-btn" data-category="voucher">Vouchers</button>
                    <button class="category-btn" data-category="experience">Experiences</button>
                </div>
                
                <div class="prize-grid" id="prize-grid">
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-gift"></i>
                        <p>No prizes available yet. Check back soon!</p>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-tab" class="tab-container">
                <h2 style="margin-bottom: 12px; font-size: 18px; color: var(--text-primary);">My Items</h2>
                
                <div class="inventory-filters" id="inventory-filters" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="category-btn active" data-status="all">All Items</button>
                    <button class="category-btn" data-status="active">Available</button>
                    <button class="category-btn" data-status="used">Used</button>
                    <button class="category-btn" data-status="expired">Expired</button>
                </div>
                
                <div class="inventory-items" id="inventory-items">
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No items in your inventory yet.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Complete missions to earn coins and buy prizes!</p>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard-tab" class="tab-container">
                <h2 style="margin-bottom: 12px; font-size: 18px; color: var(--text-primary);">Leaderboards</h2>
                
                <div class="leaderboard-filters" id="leaderboard-filters" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="category-btn active" data-type="global">Global</button>
                    <button class="category-btn" data-type="team">Team</button>
                    <button class="category-btn" data-type="friends">Friends</button>
                </div>
                
                <div id="my-rank-card" class="my-rank-card" style="margin-bottom: 16px;">
                    <div class="loading-spinner" style="width: 24px; height: 24px;"></div>
                </div>
                
                <div class="leaderboard-list" id="leaderboard-list">
                    <div class="empty-state">
                        <i class="fas fa-trophy"></i>
                        <p>No leaderboard data available yet.</p>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 class="profile-name" id="profile-name">Loading...</h2>
                    <p class="profile-email" id="profile-email">Loading...</p>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-card">
                        <h4>Total Coins</h4>
                        <div class="stat-number" id="profile-coins">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Missions</h4>
                        <div class="stat-number" id="profile-missions">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Rank</h4>
                        <div class="stat-number" id="profile-rank">#0</div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="profile-action-btn" id="edit-profile-btn">
                        <i class="fas fa-user-edit"></i>
                        Edit Profile
                    </button>
                    <button class="profile-action-btn" id="change-password-btn">
                        <i class="fas fa-lock"></i>
                        Change Password
                    </button>
                    <button class="profile-action-btn" id="view-activity-btn">
                        <i class="fas fa-history"></i>
                        Activity History
                    </button>
                    <button class="profile-action-btn" id="settings-btn">
                        <i class="fas fa-cog"></i>
                        Settings
                    </button>
                    <button class="profile-action-btn logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- SOS Button -->
        <button class="sos-btn" id="sos-button">
            <i class="fas fa-exclamation-triangle"></i>
        </button>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-tab="map">
                <i class="fas fa-map"></i>
                <div class="nav-label">Map</div>
            </div>
            <div class="nav-item" data-tab="missions">
                <i class="fas fa-tasks"></i>
                <div class="nav-label">Missions</div>
            </div>
            <div class="nav-item" data-tab="shop">
                <i class="fas fa-store"></i>
                <div class="nav-label">Shop</div>
            </div>
            <div class="nav-item" data-tab="inventory">
                <i class="fas fa-box"></i>
                <div class="nav-label">My Items</div>
            </div>
            <div class="nav-item" data-tab="profile">
                <i class="fas fa-user"></i>
                <div class="nav-label">Profile</div>
            </div>
        </div>
    </div>

    <!-- Media Capture Modal -->
    <div id="media-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); text-align: center;">
                <h3 id="mission-modal-title" style="font-size: 18px; margin-bottom: 4px; color: var(--text-primary);">Complete Mission</h3>
                <p id="mission-modal-question" style="color: var(--text-secondary); font-size: 13px;">Take a photo at the location</p>
            </div>
            <div class="media-preview" style="width: 100%; height: 300px; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; position: relative;">
                <video id="video-preview" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>
                <canvas id="audio-visualizer" style="display: none; width: 100%; height: 100%;"></canvas>
                <img id="image-preview" style="display: none; max-width: 100%; max-height: 100%;">
                <div id="recording-indicator" style="position: absolute; top: 16px; left: 16px; background: var(--red); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 4px; display: none;">
                    <div class="dot" style="width: 6px; height: 6px; background: white; border-radius: 50%; animation: blink 1s infinite;"></div>
                    <span>REC</span>
                </div>
                <div id="media-timer" style="position: absolute; bottom: 16px; left: 0; right: 0; text-align: center; color: white; font-size: 16px; font-weight: 600; display: none;">00:00</div>
            </div>
            <div id="media-controls" style="padding: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <!-- Buttons will be dynamically added -->
            </div>
        </div>
    </div>

    <!-- Text Answer Modal -->
    <div id="text-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); text-align: center;">
                <h3 id="text-modal-title" style="font-size: 18px; margin-bottom: 4px; color: var(--text-primary);">Text Answer</h3>
                <p id="text-modal-question" style="color: var(--text-secondary); font-size: 13px;">Enter your answer below</p>
            </div>
            <div style="padding: 20px;">
                <textarea id="text-answer-input" style="width: 100%; min-height: 150px; padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px; resize: vertical;" placeholder="Type your answer here..."></textarea>
            </div>
            <div style="padding: 20px; display: flex; gap: 8px;">
                <button id="submit-text-answer" style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--blue); color: white;">
                    <i class="fas fa-paper-plane"></i> Submit Answer
                </button>
                <button id="close-text-modal" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-weight: 600; cursor: pointer; background: var(--bg-card); color: var(--text-primary);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- GPS Check-in Modal -->
    <div id="gps-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); text-align: center;">
                <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--text-primary);">GPS Check-in</h3>
                <p id="gps-modal-question" style="color: var(--text-secondary); font-size: 13px;">Check in at the specified location</p>
            </div>
            <div style="padding: 20px; text-align: center;">
                <div id="gps-distance" style="font-size: 48px; font-weight: 700; color: var(--blue); margin: 20px 0;">--</div>
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">Distance to target location</p>
                
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--red);"></div>
                    <span>Your location</span>
                    <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--green); margin-left: 20px;"></div>
                    <span>Target location</span>
                </div>
                
                <div id="gps-progress" style="background: var(--border-color); height: 8px; border-radius: 4px; margin: 20px 0; overflow: hidden;">
                    <div id="gps-progress-bar" style="height: 100%; background: var(--green); width: 0%; transition: width 0.3s;"></div>
                </div>
                
                <p id="gps-status" style="color: var(--text-secondary); font-size: 13px;">Move closer to check in</p>
            </div>
            <div style="padding: 20px; display: flex; gap: 8px;">
                <button id="check-in-btn" style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--blue); color: white;" disabled>
                    <i class="fas fa-map-marker-alt"></i> Check In
                </button>
                <button id="close-gps-modal" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-weight: 600; cursor: pointer; background: var(--bg-card); color: var(--text-primary);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Emergency Modal -->
    <div id="emergency-modal" class="modal-overlay">
        <div class="modal-container" style="background: var(--red); color: white; text-align: center;">
            <div style="padding: 24px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                <h2 style="font-size: 24px; margin-bottom: 12px;">EMERGENCY ASSISTANCE</h2>
                <p style="margin-bottom: 20px; line-height: 1.5; opacity: 0.9; font-size: 14px;">
                    Your location has been sent to event organizers. Choose an emergency option:
                </p>
                <div class="emergency-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                    <a href="tel:0644106000" style="padding: 12px; border: 2px solid white; border-radius: 8px; background: transparent; color: white; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); font-size: 13px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-ambulance"></i> Call Ambulance: 064 410 6000
                    </a>
                    <a href="tel:1411" style="padding: 12px; border: 2px solid white; border-radius: 8px; background: transparent; color: white; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); font-size: 13px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-phone-alt"></i> Call Toll-Free: 1411
                    </a>
                    <button id="close-emergency-modal-btn" style="margin-top: 16px; padding: 12px; border: 2px solid white; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-weight: 600; cursor: pointer; font-size: 13px;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); text-align: center;">
                <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--text-primary);">Settings</h3>
                <p style="color: var(--text-secondary); font-size: 13px;">Manage your app preferences</p>
            </div>
            <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                <div class="settings-section">
                    <h4>Notifications</h4>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Mission Alerts</h5>
                            <p>Get notified about new missions</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="mission-alerts" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Prize Updates</h5>
                            <p>Notifications about new prizes</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="prize-updates" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Leaderboard Updates</h5>
                            <p>Rank change notifications</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="leaderboard-updates">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Location Services</h4>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>High Accuracy Mode</h5>
                            <p>Use GPS for precise location (uses more battery)</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="high-accuracy" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Background Tracking</h5>
                            <p>Track location when app is in background</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="background-tracking">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Appearance</h4>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Dark Mode</h5>
                            <p>Use dark theme (always on for this app)</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="dark-mode" checked disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Map Style</h5>
                            <p>Choose your preferred map style</p>
                        </div>
                        <select id="map-style" style="padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary);">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                            <option value="satellite">Satellite</option>
                        </select>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Privacy</h4>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Show on Leaderboard</h5>
                            <p>Display your name on public leaderboards</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="show-on-leaderboard" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Share Location with Friends</h5>
                            <p>Allow friends to see your location</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="share-location">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <div class="settings-section">
                    <h4>Data & Storage</h4>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Auto-delete Old Media</h5>
                            <p>Remove media older than 30 days</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="auto-delete-media">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label">
                            <h5>Cache Size</h5>
                            <p>Clear cached data</p>
                        </div>
                        <button id="clear-cache" style="padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); cursor: pointer;">
                            Clear Cache (0 MB)
                        </button>
                    </div>
                </div>
            </div>
            <div style="padding: 20px; display: flex; gap: 8px; border-top: 1px solid var(--border-color);">
                <button id="save-settings" style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--blue); color: white;">
                    <i class="fas fa-save"></i> Save Settings
                </button>
                <button id="close-settings-modal" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-weight: 600; cursor: pointer; background: var(--bg-card); color: var(--text-primary);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); text-align: center;">
                <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--text-primary);">Edit Profile</h3>
                <p style="color: var(--text-secondary); font-size: 13px;">Update your profile information</p>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px;">Profile Picture</label>
                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
                        <div id="profile-preview" style="width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 2px solid var(--blue);">
                            <img id="current-avatar" src="" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div>
                            <input type="file" id="new-avatar" accept="image/*" style="display: none;">
                            <button id="upload-avatar-btn" style="padding: 8px 16px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); cursor: pointer; font-size: 13px;">
                                <i class="fas fa-camera"></i> Change Photo
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px;">Full Name</label>
                    <input type="text" id="edit-name" class="form-control" placeholder="Enter your name" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px;">Phone Number</label>
                    <input type="tel" id="edit-phone" class="form-control" placeholder="+264 81 234 5678" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px;">Bio (Optional)</label>
                    <textarea id="edit-bio" class="form-control" placeholder="Tell us about yourself..." style="width: 100%; min-height: 80px; resize: vertical;"></textarea>
                </div>
            </div>
            <div style="padding: 20px; display: flex; gap: 8px; border-top: 1px solid var(--border-color);">
                <button id="save-profile" style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--blue); color: white;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button id="close-edit-profile-modal" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-weight: 600; cursor: pointer; background: var(--bg-card); color: var(--text-primary);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); text-align: center;">
                <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--text-primary);">Change Password</h3>
                <p style="color: var(--text-secondary); font-size: 13px;">Update your password for security</p>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px;">Current Password</label>
                    <input type="password" id="current-password" class="form-control" placeholder="Enter current password" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px;">New Password</label>
                    <input type="password" id="new-password" class="form-control" placeholder="Enter new password" style="width: 100%;">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 8px; color: var(--text-secondary); font-size: 13px;">Confirm New Password</label>
                    <input type="password" id="confirm-password" class="form-control" placeholder="Confirm new password" style="width: 100%;">
                </div>
                <div id="password-requirements" style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-top: 20px;">
                    <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Password must contain:</p>
                    <ul style="color: var(--text-secondary); font-size: 11px; padding-left: 20px;">
                        <li>At least 8 characters</li>
                        <li>One uppercase letter</li>
                        <li>One lowercase letter</li>
                        <li>One number</li>
                    </ul>
                </div>
            </div>
            <div style="padding: 20px; display: flex; gap: 8px; border-top: 1px solid var(--border-color);">
                <button id="save-password" style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--blue); color: white;">
                    <i class="fas fa-key"></i> Update Password
                </button>
                <button id="close-change-password-modal" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); font-weight: 600; cursor: pointer; background: var(--bg-card); color: var(--text-primary);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Activity History Modal -->
    <div id="activity-modal" class="modal-overlay">
        <div class="modal-container" style="max-width: 800px;">
            <div style="padding: 20px; border-bottom: 1px solid var(--border-color); text-align: center;">
                <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--text-primary);">Activity History</h3>
                <p style="color: var(--text-secondary); font-size: 13px;">View your mission history and activities</p>
            </div>
            <div style="padding: 20px; max-height: 60vh; overflow-y: auto;">
                <div id="activity-filters" style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="category-btn active" data-filter="all">All Activities</button>
                    <button class="category-btn" data-filter="missions">Missions</button>
                    <button class="category-btn" data-filter="purchases">Purchases</button>
                    <button class="category-btn" data-filter="rewards">Rewards</button>
                </div>
                <div id="activity-list">
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>No activity history yet</p>
                        <p style="font-size: 13px; margin-top: 8px;">Complete missions to see your activity history</p>
                    </div>
                </div>
            </div>
            <div style="padding: 20px; display: flex; justify-content: center; border-top: 1px solid var(--border-color);">
                <button id="close-activity-modal" style="padding: 12px 24px; border-radius: 8px; border: 1px solid var(--border-color); font-weight: 600; cursor: pointer; background: var(--bg-card); color: var(--text-primary);">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const CONFIG = {
        SUPABASE_URL: 'https://wnmncsbbtlpcwviicsbr.supabase.co',
        SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubW5jc2JidGxwY3d2aWljc2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDU3MTMsImV4cCI6MjA4MTY4MTcxM30.pSOYbXWPLhKItpfDnRMfi3lyPVOvTccQudvN9YIucVs',
        MAPBOX_TOKEN: 'pk.eyJ1IjoianVzYSIsImEiOiJjbWpjanh5amEwbDEwM2dzOXVhbjZ5dzcwIn0.stWdbPHCrf9sKrRJRmShlg',
        DEFAULT_LOCATION: { lat: -22.68, lng: 17.08, accuracy: 10000 },
        MISSION_TYPES: {
            PHOTO: 'photo',
            VIDEO: 'video',
            AUDIO: 'audio',
            TEXT: 'text',
            QR_SCAN: 'qr_scan',
            GPS_CHECKIN: 'gps_checkin'
        }
    };

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Player App Initializing...');
        
        // Initialize Supabase
        window.supabase = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        
        // Global State
        window.appState = {
            currentUser: null,
            currentSession: null,
            userLocation: null,
            currentMission: null,
            currentZone: null,
            map: null,
            zones: [],
            zoneMarkers: [],
            currentTab: 'map',
            locationWatchId: null,
            mediaStream: null,
            mediaRecorder: null,
            recordedChunks: [],
            recordingTimer: null,
            recordingSeconds: 0,
            eventTimer: null,
            settings: {
                highAccuracy: true,
                backgroundTracking: false,
                missionAlerts: true,
                prizeUpdates: true,
                showOnLeaderboard: true,
                shareLocation: false
            }
        };

        // Load saved settings
        loadSettings();

        // Initialize the app
        initApp();
    });

    // ============================================
    // APP INITIALIZATION
    // ============================================
    async function initApp() {
        console.log('Initializing app...');
        
        // Load saved state
        loadAppState();
        
        // Setup event listeners
        setupEventListeners();
        
        // Check authentication
        await checkAuth();
        
        console.log('App initialized successfully');
    }

    // ============================================
    // STATE MANAGEMENT
    // ============================================
    function saveAppState() {
        try {
            const state = {
                currentTab: appState.currentTab,
                settings: appState.settings,
                timestamp: Date.now()
            };
            localStorage.setItem('hunt_player_state', JSON.stringify(state));
        } catch (error) {
            console.error('Error saving app state:', error);
        }
    }

    function loadAppState() {
        try {
            const saved = localStorage.getItem('hunt_player_state');
            if (saved) {
                const state = JSON.parse(saved);
                appState.currentTab = state.currentTab || 'map';
                appState.settings = { ...appState.settings, ...state.settings };
            }
        } catch (error) {
            console.error('Error loading app state:', error);
        }
    }

    function saveSettings() {
        try {
            localStorage.setItem('hunt_player_settings', JSON.stringify(appState.settings));
        } catch (error) {
            console.error('Error saving settings:', error);
        }
    }

    function loadSettings() {
        try {
            const saved = localStorage.getItem('hunt_player_settings');
            if (saved) {
                appState.settings = { ...appState.settings, ...JSON.parse(saved) };
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    // ============================================
    // AUTHENTICATION
    // ============================================
    async function checkAuth() {
        console.log('Checking authentication...');
        
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) {
            console.error('Auth error:', error);
            showLogin();
            return;
        }
        
        if (session) {
            appState.currentSession = session;
            await loadUserProfile(session.user.id);
            showApp();
            setupRealTimeSubscriptions();
        } else {
            showLogin();
        }
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        if (!email || !password) {
            showError('Please fill in all fields');
            return;
        }

        const btn = document.getElementById('login-button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';

        try {
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) throw error;

            console.log('Login successful:', data.user.email);
            appState.currentSession = data.session;
            await loadUserProfile(data.user.id);
            showApp();
            showToast('Signed in successfully', 'success');
        } catch (error) {
            showError(error.message || 'Login failed');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function signup() {
        const name = document.getElementById('signup-name').value;
        const phone = document.getElementById('signup-phone').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const photoFile = document.getElementById('signup-photo').files[0];

        if (!name || !phone || !email || !password) {
            showError('Please fill in all required fields');
            return;
        }

        if (password.length < 6) {
            showError('Password must be at least 6 characters');
            return;
        }

        const btn = document.getElementById('signup-button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';

        try {
            // Sign up with Supabase Auth
            const { data: authData, error: authError } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: { name, phone }
                }
            });

            if (authError) {
                if (authError.message.includes('User already registered')) {
                    throw new Error('This email is already registered. Please sign in instead.');
                }
                throw authError;
            }

            // Upload profile photo if provided
            let avatarUrl = null;
            if (photoFile) {
                try {
                    const fileName = `${authData.user.id}/profile_${Date.now()}.jpg`;
                    const { error: uploadError } = await supabase.storage
                        .from('profiles')
                        .upload(fileName, photoFile);
                    
                    if (!uploadError) {
                        const { data: urlData } = supabase.storage
                            .from('profiles')
                            .getPublicUrl(fileName);
                        avatarUrl = urlData.publicUrl;
                    }
                } catch (uploadError) {
                    console.warn('Failed to upload profile photo:', uploadError);
                }
            }

            // Create user profile
            const { error: profileError } = await supabase
                .from('users')
                .upsert([{
                    id: authData.user.id,
                    name,
                    email,
                    phone,
                    avatar_url: avatarUrl,
                    coins: 100,
                    created_at: new Date().toISOString()
                }]);

            if (profileError) {
                console.warn('Profile creation error:', profileError);
            }

            showSuccess('Account created successfully! Please check your email for verification.');
            
            // Auto login after signup
            setTimeout(() => {
                document.getElementById('login-email').value = email;
                document.getElementById('login-password').value = password;
                showLogin();
                showToast('Account created! You can now sign in.', 'success');
            }, 3000);

        } catch (error) {
            showError(error.message || 'Signup failed');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    async function loadUserProfile(userId) {
        console.log('Loading user profile:', userId);
        const { data, error } = await supabase
            .from('users')
            .select('*')
            .eq('id', userId)
            .single();

        if (error) {
            console.error('Error loading user profile:', error);
            return;
        }

        if (data) {
            appState.currentUser = data;
            console.log('User loaded:', data.name);
            
            // Update UI
            updateProfilePicture(data.avatar_url);
            document.getElementById('user-coins').textContent = data.coins;
            document.getElementById('shop-coins').textContent = data.coins;
            document.getElementById('profile-coins').textContent = data.coins;
            document.getElementById('profile-name').textContent = data.name;
            document.getElementById('profile-email').textContent = data.email;
            
            // Start services
            startEventTimer();
            requestLocationPermission();
            loadZones();
            loadShopItems();
            loadUserInventory();
            loadLeaderboard('global');
            updateProfileStats();
        }
    }

    function updateProfilePicture(avatarUrl) {
        const profileBtn = document.querySelector('.profile-btn');
        const profileAvatar = document.querySelector('.profile-avatar');
        const currentAvatar = document.getElementById('current-avatar');
        
        if (avatarUrl) {
            // Update profile button
            profileBtn.innerHTML = `<img src="${avatarUrl}" alt="Profile">`;
            // Update profile avatar in tab
            if (profileAvatar) {
                profileAvatar.innerHTML = `<img src="${avatarUrl}" alt="Profile">`;
            }
            // Update in edit modal
            if (currentAvatar) {
                currentAvatar.src = avatarUrl;
            }
        }
    }

    // ============================================
    // EVENT LISTENERS SETUP
    // ============================================
    function setupEventListeners() {
        console.log('Setting up event listeners...');
        
        // Auth links
        document.getElementById('show-signup-link').addEventListener('click', function(e) {
            e.preventDefault();
            showSignup();
        });
        
        document.getElementById('show-login-link').addEventListener('click', function(e) {
            e.preventDefault();
            showLogin();
        });
        
        // Auth buttons
        document.getElementById('login-button').addEventListener('click', login);
        document.getElementById('signup-button').addEventListener('click', signup);
        
        // Location permission
        const requestLocationBtn = document.getElementById('request-location-btn');
        if (requestLocationBtn) {
            requestLocationBtn.addEventListener('click', requestLocationPermission);
        }
        
        // Bottom navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                const tab = this.getAttribute('data-tab');
                showTab(tab);
            });
        });
        
        // Profile buttons
        document.getElementById('profile-button').addEventListener('click', function() {
            showTab('profile');
        });
        document.getElementById('edit-profile-btn').addEventListener('click', showEditProfileModal);
        document.getElementById('change-password-btn').addEventListener('click', showChangePasswordModal);
        document.getElementById('view-activity-btn').addEventListener('click', showActivityModal);
        document.getElementById('settings-btn').addEventListener('click', showSettingsModal);
        document.getElementById('logout-btn').addEventListener('click', logout);
        
        // SOS button
        document.getElementById('sos-button').addEventListener('click', showEmergencyModal);
        
        // Shop filters
        document.querySelectorAll('#shop-categories .category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const category = this.getAttribute('data-category');
                filterShop(category);
            });
        });
        
        // Inventory filters
        document.querySelectorAll('#inventory-filters .category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const status = this.getAttribute('data-status');
                filterInventory(status);
            });
        });
        
        // Leaderboard filters
        document.querySelectorAll('#leaderboard-filters .category-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const type = this.getAttribute('data-type');
                loadLeaderboard(type);
            });
        });
        
        // Emergency modal
        document.getElementById('close-emergency-modal-btn').addEventListener('click', closeEmergencyModal);
        
        // Settings
        document.getElementById('save-settings').addEventListener('click', saveSettings);
        document.getElementById('close-settings-modal').addEventListener('click', closeSettingsModal);
        document.getElementById('clear-cache').addEventListener('click', clearCache);
        
        // Profile editing
        document.getElementById('upload-avatar-btn').addEventListener('click', () => {
            document.getElementById('new-avatar').click();
        });
        document.getElementById('new-avatar').addEventListener('change', handleAvatarUpload);
        document.getElementById('save-profile').addEventListener('click', updateProfile);
        document.getElementById('close-edit-profile-modal').addEventListener('click', closeEditProfileModal);
        
        // Password change
        document.getElementById('save-password').addEventListener('click', changePassword);
        document.getElementById('close-change-password-modal').addEventListener('click', closeChangePasswordModal);
        
        // Activity modal
        document.getElementById('close-activity-modal').addEventListener('click', closeActivityModal);
        
        // Text answer modal
        document.getElementById('submit-text-answer').addEventListener('click', submitTextAnswer);
        document.getElementById('close-text-modal').addEventListener('click', closeTextModal);
        
        // GPS modal
        document.getElementById('check-in-btn').addEventListener('click', submitGPSCheckin);
        document.getElementById('close-gps-modal').addEventListener('click', closeGPSModal);
        
        console.log('Event listeners setup complete');
    }

    // ============================================
    // UI FUNCTIONS
    // ============================================
    function showLogin() {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('signup-form').style.display = 'none';
        clearMessages();
    }

    function showSignup() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('signup-form').style.display = 'block';
        clearMessages();
    }

    function showApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        showTab(appState.currentTab, false);
        
        // Initialize map after DOM is visible
        if (!appState.map) {
            setTimeout(initializeMap, 100);
        }
    }

    function showTab(tabName, pushState = true) {
        // Update current tab
        appState.currentTab = tabName;
        
        // Hide all tabs
        document.querySelectorAll('.tab-container').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Remove active from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Show selected tab
        const tabElement = document.getElementById(`${tabName}-tab`);
        if (tabElement) {
            tabElement.classList.add('active');
            
            // Set active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-tab') === tabName) {
                    item.classList.add('active');
                }
            });
            
            // Load tab data
            switch(tabName) {
                case 'shop':
                    loadShopItems();
                    break;
                case 'inventory':
                    loadUserInventory();
                    break;
                case 'leaderboard':
                    loadLeaderboard('global');
                    break;
                case 'missions':
                    loadZones();
                    break;
                case 'map':
                    if (appState.map) {
                        setTimeout(() => appState.map.resize(), 100);
                    }
                    break;
            }
            
            // Save state
            saveAppState();
        }
    }

    function showError(message) {
        const errorEl = document.getElementById('error-message');
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        setTimeout(() => errorEl.style.display = 'none', 5000);
    }

    function showSuccess(message) {
        const successEl = document.getElementById('success-message');
        successEl.textContent = message;
        successEl.style.display = 'block';
        setTimeout(() => successEl.style.display = 'none', 5000);
    }

    function clearMessages() {
        document.getElementById('error-message').style.display = 'none';
        document.getElementById('success-message').style.display = 'none';
    }

    // ============================================
    // TOAST NOTIFICATIONS
    // ============================================
    function showToast(message, type = 'info') {
        console.log('Toast:', message);
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div style="display: flex; align-items: start; gap: 10px;">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <div style="flex: 1; font-size: 13px;">${message}</div>
                <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0 4px;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        const container = document.getElementById('toast-container');
        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 100);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode === container) {
                    container.removeChild(toast);
                }
            }, 300);
        }, 5000);
    }

    // ============================================
    // MAP FUNCTIONS
    // ============================================
    function initializeMap() {
        try {
            if (!mapboxgl.supported()) {
                console.warn('WebGL not supported');
                document.getElementById('map').innerHTML = '<div class="map-loading"><i class="fas fa-exclamation-triangle"></i><p>Map not supported</p></div>';
                return;
            }
            
            mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;
            
            // Use dark theme by default
            const mapStyle = 'mapbox://styles/mapbox/dark-v11';
            
            appState.map = new mapboxgl.Map({
                container: 'map',
                style: mapStyle,
                center: [CONFIG.DEFAULT_LOCATION.lng, CONFIG.DEFAULT_LOCATION.lat],
                zoom: 13,
                attributionControl: false,
                maxZoom: 18,
                minZoom: 10
            });
            
            // Add navigation controls
            appState.map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            
            // Add geolocate control
            appState.map.addControl(new mapboxgl.GeolocateControl({
                positionOptions: { enableHighAccuracy: true },
                trackUserLocation: true,
                showUserLocation: true,
                showAccuracyCircle: true
            }), 'top-right');
            
            appState.map.on('load', function() {
                console.log('Map loaded successfully');
                document.querySelector('.map-loading').style.display = 'none';
                loadZonesForMap();
                
                // Update user location on map if available
                if (appState.userLocation) {
                    updateUserLocationOnMap();
                }
            });
            
        } catch (error) {
            console.error('Map initialization error:', error);
            showToast('Map loading failed', 'error');
        }
    }

    async function loadZonesForMap() {
        if (!appState.map) return;
        
        console.log('Loading zones for map...');
        
        const { data: zonesData, error } = await supabase
            .from('zones')
            .select('*')
            .eq('is_active', true);
        
        if (error) {
            console.error('Error loading zones:', error);
            return;
        }
        
        appState.zones = zonesData || [];
        renderZonesOnMap();
    }

    function renderZonesOnMap() {
        if (!appState.map || !appState.map.loaded()) return;
        
        // Clear existing markers
        appState.zoneMarkers.forEach(marker => marker.remove());
        appState.zoneMarkers = [];
        
        // Add zone markers
        appState.zones.forEach(zone => {
            if (zone.coordinates && zone.coordinates.lat && zone.coordinates.lng) {
                const el = document.createElement('div');
                el.className = 'zone-marker';
                el.style.width = '24px';
                el.style.height = '24px';
                el.style.backgroundColor = 'rgba(0, 112, 243, 0.3)';
                el.style.borderRadius = '50%';
                el.style.border = '2px solid #0070f3';
                el.style.cursor = 'pointer';
                el.title = zone.name;
                
                const marker = new mapboxgl.Marker(el)
                    .setLngLat([zone.coordinates.lng, zone.coordinates.lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`
                            <div style="padding: 8px; max-width: 200px;">
                                <h3 style="margin: 0 0 5px 0; color: #0070f3;">${zone.name}</h3>
                                <p style="margin: 0; color: #666; font-size: 12px;">${zone.description || 'No description'}</p>
                                <p style="margin: 5px 0 0 0; color: #888; font-size: 11px;">
                                    Radius: ${zone.radius_meters || 100}m
                                </p>
                            </div>
                        `))
                    .addTo(appState.map);
                
                appState.zoneMarkers.push(marker);
            }
        });
    }

    function updateUserLocationOnMap() {
        if (!appState.map || !appState.map.loaded() || !appState.userLocation) return;
        
        console.log('Updating user location on map');
        
        // Remove existing user marker
        const existingMarkers = document.getElementsByClassName('user-location-marker');
        while (existingMarkers.length > 0) {
            existingMarkers[0].remove();
        }
        
        // Create user marker
        const el = document.createElement('div');
        el.className = 'user-location-marker';
        el.style.width = '20px';
        el.style.height = '20px';
        el.style.backgroundColor = 'white';
        el.style.borderRadius = '50%';
        el.style.border = '3px solid #0070f3';
        el.style.boxShadow = '0 0 10px rgba(255, 255, 255, 0.7)';
        el.style.animation = 'pulse 2s infinite';
        
        new mapboxgl.Marker(el)
            .setLngLat([appState.userLocation.lng, appState.userLocation.lat])
            .addTo(appState.map);
        
        // Center map on user if this is the map tab
        if (appState.currentTab === 'map') {
            appState.map.flyTo({
                center: [appState.userLocation.lng, appState.userLocation.lat],
                zoom: 15,
                essential: true,
                duration: 1000
            });
        }
    }

    // ============================================
    // LOCATION SERVICES
    // ============================================
    function requestLocationPermission() {
        console.log('Requesting location permission...');
        
        const permissionEl = document.getElementById('location-permission');
        if (permissionEl) {
            permissionEl.style.display = 'block';
            permissionEl.innerHTML = `
                <p>Getting your location...</p>
                <div class="loading-spinner" style="margin: 12px auto; width: 24px; height: 24px;"></div>
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                    Please enable High Accuracy mode for best results
                </p>
            `;
        }
        
        if (!navigator.geolocation) {
            handleLocationError('Geolocation not supported by your browser');
            return;
        }
        
        const options = {
            enableHighAccuracy: appState.settings.highAccuracy,
            timeout: 15000,
            maximumAge: 0
        };
        
        // Get current position
        navigator.geolocation.getCurrentPosition(
            handleLocationSuccess,
            handleLocationError,
            options
        );
        
        // Start watching position
        if (appState.locationWatchId) {
            navigator.geolocation.clearWatch(appState.locationWatchId);
        }
        
        appState.locationWatchId = navigator.geolocation.watchPosition(
            handleLocationSuccess,
            handleLocationError,
            { 
                enableHighAccuracy: appState.settings.highAccuracy, 
                maximumAge: 30000, 
                timeout: 10000 
            }
        );
    }

    function handleLocationSuccess(position) {
        console.log('Location obtained - Accuracy:', position.coords.accuracy, 'meters');
        
        const newLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy,
            altitude: position.coords.altitude,
            heading: position.coords.heading,
            speed: position.coords.speed,
            timestamp: position.timestamp
        };
        
        // Update location if improved or first time
        if (!appState.userLocation || position.coords.accuracy < appState.userLocation.accuracy) {
            appState.userLocation = newLocation;
            
            console.log('Updated user location with accuracy:', appState.userLocation.accuracy, 'm');
            
            // Hide permission request
            const permissionEl = document.getElementById('location-permission');
            if (permissionEl) {
                permissionEl.style.display = 'none';
            }
            
            // Update map
            updateUserLocationOnMap();
            
            // Check zones
            checkZones();
            
            // Save location to database if user is logged in
            if (appState.currentUser) {
                saveUserLocation();
            }
            
            // Show accuracy feedback
            if (position.coords.accuracy < 20) {
                showToast(`High accuracy location: ${Math.round(position.coords.accuracy)}m`, 'success');
            }
        }
    }

    async function saveUserLocation() {
        if (!appState.currentUser || !appState.userLocation) return;
        
        try {
            // Update user's last location
            await supabase
                .from('users')
                .update({ 
                    last_location: appState.userLocation,
                    last_active: new Date().toISOString()
                })
                .eq('id', appState.currentUser.id);
                
        } catch (error) {
            console.error('Error saving user location:', error);
        }
    }

    function handleLocationError(error) {
        console.warn('Location error:', error.code, error.message);
        
        let errorMessage = 'Unable to get your location. ';
        
        switch(error.code) {
            case error.PERMISSION_DENIED:
                errorMessage += 'Please enable location services in your browser settings.';
                break;
            case error.POSITION_UNAVAILABLE:
                errorMessage += 'Location information is unavailable. Try moving to an open area.';
                break;
            case error.TIMEOUT:
                errorMessage += 'Location request timed out. Check your GPS signal.';
                break;
            default:
                errorMessage += 'An unknown error occurred.';
                break;
        }
        
        // Update permission UI
        const permissionEl = document.getElementById('location-permission');
        if (permissionEl) {
            permissionEl.innerHTML = `
                <p>${errorMessage}</p>
                <button id="request-location-btn" style="margin-top: 12px; padding: 10px 20px; background: var(--blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Try Again
                </button>
            `;
            
            // Reattach event listener
            const retryBtn = document.getElementById('request-location-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', requestLocationPermission);
            }
        }
        
        // Use default location as fallback
        if (!appState.userLocation) {
            appState.userLocation = CONFIG.DEFAULT_LOCATION;
            updateUserLocationOnMap();
            showToast('Using approximate location. Enable GPS for accurate zone detection.', 'warning');
        }
    }

    function checkZones() {
        if (!appState.userLocation || !appState.zones.length) return;
        
        let enteredNewZone = false;
        
        appState.zones.forEach(zone => {
            if (!zone.coordinates) return;
            
            const distance = getDistance(
                appState.userLocation.lat,
                appState.userLocation.lng,
                zone.coordinates.lat,
                zone.coordinates.lng
            );
            
            const zoneRadius = zone.radius_meters || 100;
            
            if (distance <= zoneRadius) {
                if (appState.currentZone?.id !== zone.id) {
                    // Entered new zone
                    appState.currentZone = zone;
                    enteredNewZone = true;
                    console.log(`Entered zone: ${zone.name}`);
                }
            }
        });
        
        // Update UI if entered new zone
        if (enteredNewZone && appState.currentZone) {
            updateCurrentZoneDisplay();
            unlockZoneMissions(appState.currentZone.id);
            showToast(`Entered ${appState.currentZone.name}! Missions unlocked.`, 'success');
        } else if (!appState.currentZone) {
            updateCurrentZoneDisplay();
        }
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3; // Earth radius in meters
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;
        
        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        
        return R * c;
    }

    function updateCurrentZoneDisplay() {
        const zoneElement = document.getElementById('current-zone');
        if (!zoneElement) return;
        
        if (appState.currentZone) {
            zoneElement.innerHTML = `
                <h4 style="margin-bottom: 8px; color: var(--blue); font-size: 16px;">${appState.currentZone.name}</h4>
                <p style="color: var(--text-secondary); font-size: 13px;">
                    ${appState.currentZone.description || 'Complete missions in this area to earn coins!'}
                </p>
                <p style="color: var(--green); font-size: 12px; margin-top: 8px;">
                    <i class="fas fa-map-marker-alt"></i> You're in the zone!
                </p>
            `;
        } else {
            zoneElement.innerHTML = `
                <p style="color: var(--text-secondary); font-size: 13px;">
                    <i class="fas fa-map-marker-alt"></i> Not in any zone. Move to a marked area to unlock missions.
                </p>
            `;
        }
    }

    // ============================================
    // ZONES & MISSIONS
    // ============================================
    async function loadZones() {
        console.log('Loading zones...');
        const zoneList = document.getElementById('zone-list');
        if (!zoneList) return;
        
        zoneList.innerHTML = '<div class="loading-spinner" style="margin: 20px auto; width: 24px; height: 24px;"></div>';
        
        const { data: zonesData, error } = await supabase
            .from('zones')
            .select('*')
            .eq('is_active', true)
            .order('name');
        
        if (error) {
            console.error('Error loading zones:', error);
            zoneList.innerHTML = '<p style="color: var(--text-secondary); padding: 20px; text-align: center; font-size: 13px;">Error loading zones.</p>';
            return;
        }
        
        if (!zonesData || zonesData.length === 0) {
            zoneList.innerHTML = '<p style="color: var(--text-secondary); padding: 20px; text-align: center; font-size: 13px;">No zones available yet.</p>';
            return;
        }
        
        appState.zones = zonesData;
        renderZoneList();
    }

    function renderZoneList() {
        const zoneList = document.getElementById('zone-list');
        if (!zoneList) return;
        
        zoneList.innerHTML = '';
        
        appState.zones.forEach((zone, index) => {
            const zoneEl = document.createElement('div');
            zoneEl.className = 'zone-item';
            if (index === 0) zoneEl.classList.add('active');
            zoneEl.textContent = zone.name;
            zoneEl.addEventListener('click', () => {
                document.querySelectorAll('.zone-item').forEach(item => item.classList.remove('active'));
                zoneEl.classList.add('active');
                loadMissionsForZone(zone.id);
            });
            zoneList.appendChild(zoneEl);
        });
        
        // Load missions for first zone
        if (appState.zones.length > 0) {
            loadMissionsForZone(appState.zones[0].id);
        }
    }

    async function loadMissionsForZone(zoneId) {
        console.log(`Loading missions for zone: ${zoneId}`);
        const missionsList = document.getElementById('missions-list');
        if (!missionsList) return;
        
        missionsList.innerHTML = '<div class="loading-spinner" style="margin: 40px auto;"></div>';
        
        const { data: missions, error } = await supabase
            .from('missions')
            .select(`
                *,
                user_missions (
                    status,
                    completed_at,
                    earned_coins
                )
            `)
            .eq('zone_id', zoneId)
            .eq('status', 'active')
            .order('created_at');
        
        if (error) {
            console.error('Error loading missions:', error);
            missionsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading missions.</p>
                </div>
            `;
            return;
        }
        
        if (!missions || missions.length === 0) {
            missionsList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-map-marker-alt"></i>
                    <p>No missions available in this zone yet.</p>
                </div>
            `;
            return;
        }
        
        renderMissions(missions, zoneId);
    }

    function renderMissions(missions, zoneId) {
        const missionsList = document.getElementById('missions-list');
        if (!missionsList) return;
        
        missionsList.innerHTML = '';
        
        missions.forEach(mission => {
            const userMission = mission.user_missions?.[0];
            const status = userMission?.status || 'locked';
            const isCompleted = status === 'completed';
            const isUnlocked = status === 'unlocked' || status === 'pending';
            
            // Get mission type icon
            let typeIcon = 'fas fa-question';
            let typeLabel = 'Unknown';
            switch(mission.mission_type) {
                case 'photo': typeIcon = 'fas fa-camera'; typeLabel = 'Photo'; break;
                case 'video': typeIcon = 'fas fa-video'; typeLabel = 'Video'; break;
                case 'audio': typeIcon = 'fas fa-microphone'; typeLabel = 'Audio'; break;
                case 'text': typeIcon = 'fas fa-font'; typeLabel = 'Text'; break;
                case 'qr_scan': typeIcon = 'fas fa-qrcode'; typeLabel = 'QR Scan'; break;
                case 'gps_checkin': typeIcon = 'fas fa-map-marker-alt'; typeLabel = 'GPS Check-in'; break;
            }
            
            const missionCard = document.createElement('div');
            missionCard.className = `mission-card ${status}`;
            if (status === 'locked') missionCard.classList.add('locked');
            if (isCompleted) missionCard.classList.add('completed');
            if (isUnlocked) missionCard.classList.add('unlocked');
            
            missionCard.innerHTML = `
                <div class="mission-header">
                    <div class="mission-title">${mission.title}</div>
                    <div class="mission-points">${mission.points} coins</div>
                </div>
                <div class="mission-type-badge">
                    <i class="${typeIcon}"></i> ${typeLabel}
                </div>
                ${mission.question ? `<div class="mission-question">${mission.question}</div>` : ''}
                ${mission.description ? `<div class="mission-description">${mission.description}</div>` : ''}
                ${mission.media_required_count > 0 ? `
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">
                        <i class="fas fa-camera"></i> Requires ${mission.media_required_count} ${mission.media_required_count === 1 ? 'file' : 'files'}
                    </div>
                ` : ''}
                ${mission.video_max_duration ? `
                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">
                        <i class="fas fa-clock"></i> Max ${mission.video_max_duration} seconds
                    </div>
                ` : ''}
                <div class="mission-actions">
                    ${isCompleted ? `
                        <button class="action-btn completed" disabled>
                            <i class="fas fa-check"></i> Completed
                            ${userMission.earned_coins ? ` (+${userMission.earned_coins} coins)` : ''}
                        </button>
                    ` : isUnlocked ? `
                        <button class="action-btn record start-mission-btn" data-mission-id="${mission.id}" data-mission-type="${mission.mission_type}">
                            <i class="fas fa-play"></i> Start Mission
                        </button>
                    ` : `
                        <button class="action-btn" disabled>
                            <i class="fas fa-lock"></i> Locked
                        </button>
                    `}
                </div>
            `;
            missionsList.appendChild(missionCard);
        });
        
        // Add event listeners to start mission buttons
        document.querySelectorAll('.start-mission-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const missionId = this.getAttribute('data-mission-id');
                const missionType = this.getAttribute('data-mission-type');
                startMission(missionId, missionType);
            });
        });
    }

    async function unlockZoneMissions(zoneId) {
        console.log(`Unlocking missions for zone: ${zoneId}`);
        if (!appState.currentUser) return;
        
        const { data: missions, error } = await supabase
            .from('missions')
            .select('*')
            .eq('zone_id', zoneId)
            .eq('status', 'active');
        
        if (error || !missions) return;
        
        for (const mission of missions) {
            // Check if user mission already exists
            const { data: existing } = await supabase
                .from('user_missions')
                .select('*')
                .eq('user_id', appState.currentUser.id)
                .eq('mission_id', mission.id)
                .single();
            
            if (!existing) {
                // Create unlocked user mission
                await supabase
                    .from('user_missions')
                    .upsert([{
                        user_id: appState.currentUser.id,
                        mission_id: mission.id,
                        status: 'unlocked',
                        created_at: new Date().toISOString()
                    }], {
                        onConflict: 'user_id,mission_id'
                    });
            } else if (existing.status === 'locked') {
                // Update locked mission to unlocked
                await supabase
                    .from('user_missions')
                    .update({ 
                        status: 'unlocked',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', existing.id);
            }
        }
        
        // Reload missions for current zone
        if (document.getElementById('missions-tab').classList.contains('active')) {
            loadMissionsForZone(zoneId);
        }
    }

    // ============================================
    // MISSION EXECUTION
    // ============================================
    async function startMission(missionId, missionType) {
        console.log(`Starting mission: ${missionId}, type: ${missionType}`);
        
        const { data: mission, error } = await supabase
            .from('missions')
            .select('*')
            .eq('id', missionId)
            .single();
        
        if (error || !mission) {
            showToast('Mission not found', 'error');
            return;
        }
        
        appState.currentMission = mission;
        
        // Handle different mission types
        switch(missionType) {
            case 'photo':
                showPhotoMission(mission);
                break;
            case 'video':
                showVideoMission(mission);
                break;
            case 'audio':
                showAudioMission(mission);
                break;
            case 'text':
                showTextMission(mission);
                break;
            case 'gps_checkin':
                showGPSMission(mission);
                break;
            default:
                showToast('Unknown mission type', 'error');
        }
    }

    function showPhotoMission(mission) {
        document.getElementById('mission-modal-title').textContent = mission.title;
        document.getElementById('mission-modal-question').textContent = mission.question || 'Take a photo';
        
        const mediaControls = document.getElementById('media-controls');
        mediaControls.innerHTML = `
            <button id="capture-photo-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary);">
                <i class="fas fa-camera"></i> Take Photo
            </button>
            <button id="close-media-modal-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary);">
                <i class="fas fa-times"></i> Cancel
            </button>
        `;
        
        document.getElementById('capture-photo-btn').addEventListener('click', capturePhoto);
        document.getElementById('close-media-modal-btn').addEventListener('click', closeMediaModal);
        
        // Initialize camera
        initCamera(true, false);
        
        // Show modal
        document.getElementById('media-modal').style.display = 'flex';
    }

    function showVideoMission(mission) {
        document.getElementById('mission-modal-title').textContent = mission.title;
        document.getElementById('mission-modal-question').textContent = mission.question || 'Record a video';
        
        const mediaControls = document.getElementById('media-controls');
        mediaControls.innerHTML = `
            <button id="record-video-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary);">
                <i class="fas fa-video"></i> Start Recording (max ${mission.video_max_duration || 10}s)
            </button>
            <button id="close-media-modal-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary);">
                <i class="fas fa-times"></i> Cancel
            </button>
        `;
        
        document.getElementById('record-video-btn').addEventListener('click', toggleVideoRecording);
        document.getElementById('close-media-modal-btn').addEventListener('click', closeMediaModal);
        
        initCamera(true, true);
        document.getElementById('media-modal').style.display = 'flex';
    }

    function showTextMission(mission) {
        document.getElementById('text-modal-title').textContent = mission.title;
        document.getElementById('text-modal-question').textContent = mission.question || 'Enter your answer';
        document.getElementById('text-answer-input').value = '';
        document.getElementById('text-modal').style.display = 'flex';
    }

    function showGPSMission(mission) {
        document.getElementById('gps-modal-question').textContent = mission.question || 'Check in at the location';
        
        // Parse target coordinates
        let targetLat, targetLng, targetRadius = 50;
        
        if (mission.options && mission.options.target) {
            targetLat = mission.options.target.lat;
            targetLng = mission.options.target.lng;
            targetRadius = mission.options.radius || 50;
        } else if (appState.currentZone && appState.currentZone.coordinates) {
            targetLat = appState.currentZone.coordinates.lat;
            targetLng = appState.currentZone.coordinates.lng;
        } else {
            showToast('GPS mission target not defined', 'error');
            return;
        }
        
        appState.currentMission.targetLocation = { lat: targetLat, lng: targetLng, radius: targetRadius };
        startGPSChecking();
        document.getElementById('gps-modal').style.display = 'flex';
    }

    async function submitTextAnswer() {
        const answer = document.getElementById('text-answer-input').value.trim();
        if (!answer || !appState.currentMission || !appState.currentUser) return;
        
        try {
            // Create submission
            await supabase
                .from('submissions')
                .insert([{
                    user_id: appState.currentUser.id,
                    mission_id: appState.currentMission.id,
                    text_answer: answer,
                    file_type: 'text',
                    review_status: 'pending',
                    created_at: new Date().toISOString()
                }]);
            
            // Update user mission status
            await supabase
                .from('user_missions')
                .update({ 
                    status: 'pending',
                    updated_at: new Date().toISOString()
                })
                .eq('user_id', appState.currentUser.id)
                .eq('mission_id', appState.currentMission.id);
            
            showToast('Answer submitted for review!', 'success');
            closeTextModal();
            
            // Reload missions
            if (appState.currentZone) {
                loadMissionsForZone(appState.currentZone.id);
            }
            
        } catch (error) {
            console.error('Text submission error:', error);
            showToast('Submission failed', 'error');
        }
    }

    // ============================================
    // MEDIA CAPTURE FUNCTIONS
    // ============================================
    async function initCamera(video = true, audio = false) {
        try {
            // Stop existing stream
            if (appState.mediaStream) {
                appState.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // Reset UI
            document.getElementById('video-preview').style.display = video ? 'block' : 'none';
            document.getElementById('audio-visualizer').style.display = 'none';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('recording-indicator').style.display = 'none';
            document.getElementById('media-timer').style.display = 'none';
            
            const constraints = {
                video: video ? {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } : false,
                audio: audio
            };
            
            appState.mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            if (video) {
                const videoElement = document.getElementById('video-preview');
                videoElement.srcObject = appState.mediaStream;
                videoElement.play();
            }
            
        } catch (error) {
            console.error('Camera initialization error:', error);
            showToast('Camera access denied. Please allow camera access.', 'error');
            closeMediaModal();
        }
    }

    function capturePhoto() {
        if (!appState.mediaStream) return;
        
        const video = document.getElementById('video-preview');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        canvas.toBlob(async (blob) => {
            console.log('Photo captured, size:', blob.size, 'bytes');
            
            // Show preview
            const imagePreview = document.getElementById('image-preview');
            imagePreview.src = URL.createObjectURL(blob);
            imagePreview.style.display = 'block';
            document.getElementById('video-preview').style.display = 'none';
            
            // Ask for confirmation
            const mediaControls = document.getElementById('media-controls');
            mediaControls.innerHTML = `
                <button id="submit-photo-btn" style="padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--blue); color: white;">
                    <i class="fas fa-check"></i> Submit Photo
                </button>
                <button id="retake-photo-btn" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary);">
                    <i class="fas fa-redo"></i> Retake
                </button>
            `;
            
            document.getElementById('submit-photo-btn').addEventListener('click', () => submitMissionMedia(blob, 'image'));
            document.getElementById('retake-photo-btn').addEventListener('click', () => {
                imagePreview.style.display = 'none';
                document.getElementById('video-preview').style.display = 'block';
                showPhotoMission(appState.currentMission);
            });
            
        }, 'image/jpeg', 0.8);
    }

    function toggleVideoRecording() {
        const recordBtn = document.getElementById('record-video-btn');
        
        if (appState.mediaRecorder && appState.mediaRecorder.state === 'recording') {
            // Stop recording
            appState.mediaRecorder.stop();
            recordBtn.innerHTML = '<i class="fas fa-video"></i> Start Recording';
            recordBtn.style.background = 'var(--bg-card)';
            
            document.getElementById('recording-indicator').style.display = 'none';
            document.getElementById('media-timer').style.display = 'none';
            clearInterval(appState.recordingTimer);
        } else {
            // Start recording
            appState.recordedChunks = [];
            const options = { mimeType: 'video/webm;codecs=vp9,opus' };
            
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm;codecs=vp8,opus';
            }
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/webm';
            }
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options.mimeType = 'video/mp4';
            }
            
            try {
                appState.mediaRecorder = new MediaRecorder(appState.mediaStream, options);
                
                appState.mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        appState.recordedChunks.push(event.data);
                    }
                };
                
                appState.mediaRecorder.onstop = async () => {
                    console.log('Video recording stopped');
                    const blob = new Blob(appState.recordedChunks, { type: options.mimeType });
                    
                    // Check duration
                    const videoElement = document.createElement('video');
                    videoElement.src = URL.createObjectURL(blob);
                    
                    videoElement.onloadedmetadata = () => {
                        const duration = videoElement.duration;
                        const maxDuration = appState.currentMission.video_max_duration || 10;
                        
                        if (duration > maxDuration) {
                            showToast(`Video too long (${duration.toFixed(1)}s). Maximum is ${maxDuration}s.`, 'error');
                            toggleVideoRecording();
                        } else {
                            // Show preview
                            const videoPreview = document.getElementById('video-preview');
                            videoPreview.src = URL.createObjectURL(blob);
                            videoPreview.controls = true;
                            videoPreview.style.display = 'block';
                            
                            // Ask for confirmation
                            const mediaControls = document.getElementById('media-controls');
                            mediaControls.innerHTML = `
                                <button id="submit-video-btn" style="padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--blue); color: white;">
                                    <i class="fas fa-check"></i> Submit Video (${duration.toFixed(1)}s)
                                </button>
                                <button id="retake-video-btn" style="padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--bg-card); color: var(--text-primary);">
                                    <i class="fas fa-redo"></i> Retake
                                </button>
                            `;
                            
                            document.getElementById('submit-video-btn').addEventListener('click', () => submitMissionMedia(blob, 'video'));
                            document.getElementById('retake-video-btn').addEventListener('click', () => {
                                videoPreview.style.display = 'none';
                                document.getElementById('video-preview').style.display = 'block';
                                showVideoMission(appState.currentMission);
                            });
                        }
                    };
                };
                
                appState.mediaRecorder.start();
                recordBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                recordBtn.style.background = 'var(--red)';
                
                document.getElementById('recording-indicator').style.display = 'flex';
                document.getElementById('media-timer').style.display = 'block';
                
                appState.recordingSeconds = 0;
                appState.recordingTimer = setInterval(() => {
                    appState.recordingSeconds++;
                    const minutes = Math.floor(appState.recordingSeconds / 60);
                    const seconds = appState.recordingSeconds % 60;
                    document.getElementById('media-timer').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Auto-stop at max duration
                    const maxDuration = appState.currentMission.video_max_duration || 10;
                    if (appState.recordingSeconds >= maxDuration) {
                        toggleVideoRecording();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('MediaRecorder error:', error);
                showToast('Video recording not supported', 'error');
            }
        }
    }

    async function submitMissionMedia(blob, mediaType) {
        if (!appState.currentMission || !appState.currentUser) return;
        
        try {
            // Upload file
            const fileName = `mission_${appState.currentMission.id}_${Date.now()}.${mediaType === 'image' ? 'jpg' : 'mp4'}`;
            const filePath = `${appState.currentUser.id}/${fileName}`;
            
            const { error: uploadError } = await supabase.storage
                .from('submissions')
                .upload(filePath, blob);
            
            if (uploadError) throw uploadError;
            
            // Get public URL
            const { data: urlData } = supabase.storage
                .from('submissions')
                .getPublicUrl(filePath);
            
            // Create submission
            await supabase
                .from('submissions')
                .insert([{
                    user_id: appState.currentUser.id,
                    mission_id: appState.currentMission.id,
                    file_url: urlData.publicUrl,
                    file_type: mediaType,
                    review_status: 'pending',
                    created_at: new Date().toISOString()
                }]);
            
            // Update user mission status
            await supabase
                .from('user_missions')
                .update({ 
                    status: 'pending',
                    updated_at: new Date().toISOString()
                })
                .eq('user_id', appState.currentUser.id)
                .eq('mission_id', appState.currentMission.id);
            
            showToast('Mission submitted for review!', 'success');
            closeMediaModal();
            
            // Reload missions
            if (appState.currentZone) {
                loadMissionsForZone(appState.currentZone.id);
            }
            
        } catch (error) {
            console.error('Submission error:', error);
            showToast('Submission failed', 'error');
        }
    }

    function startGPSChecking() {
        if (!appState.currentMission.targetLocation) return;
        
        const checkInterval = setInterval(() => {
            if (!appState.userLocation) {
                document.getElementById('gps-status').textContent = 'Waiting for GPS signal...';
                return;
            }
            
            const distance = getDistance(
                appState.userLocation.lat,
                appState.userLocation.lng,
                appState.currentMission.targetLocation.lat,
                appState.currentMission.targetLocation.lng
            );
            
            const targetRadius = appState.currentMission.targetLocation.radius || 50;
            const progress = Math.max(0, 100 - (distance / targetRadius * 100));
            
            document.getElementById('gps-distance').textContent = `${distance.toFixed(1)}m`;
            document.getElementById('gps-progress-bar').style.width = `${progress}%`;
            
            const checkInBtn = document.getElementById('check-in-btn');
            if (distance <= targetRadius) {
                checkInBtn.disabled = false;
                checkInBtn.style.background = 'var(--green)';
                document.getElementById('gps-status').textContent = 'You are in the target area!';
                document.getElementById('gps-status').style.color = 'var(--green)';
            } else {
                checkInBtn.disabled = true;
                checkInBtn.style.background = 'var(--blue)';
                document.getElementById('gps-status').textContent = `Move closer (within ${targetRadius}m)`;
                document.getElementById('gps-status').style.color = 'var(--text-secondary)';
            }
        }, 1000);
        
        appState.currentMission.gpsInterval = checkInterval;
    }

    async function submitGPSCheckin() {
        if (!appState.currentMission || !appState.currentUser) return;
        
        try {
            // Create GPS submission
            await supabase
                .from('submissions')
                .insert([{
                    user_id: appState.currentUser.id,
                    mission_id: appState.currentMission.id,
                    gps_location: appState.userLocation,
                    file_type: 'gps',
                    review_status: 'pending',
                    created_at: new Date().toISOString()
                }]);
            
            // Update user mission status
            await supabase
                .from('user_missions')
                .update({ 
                    status: 'pending',
                    updated_at: new Date().toISOString()
                })
                .eq('user_id', appState.currentUser.id)
                .eq('mission_id', appState.currentMission.id);
            
            showToast('GPS check-in submitted for review!', 'success');
            closeGPSModal();
            
            // Reload missions
            if (appState.currentZone) {
                loadMissionsForZone(appState.currentZone.id);
            }
            
        } catch (error) {
            console.error('GPS check-in error:', error);
            showToast('Check-in failed', 'error');
        }
    }

    // ============================================
    // MODAL MANAGEMENT
    // ============================================
    function closeMediaModal() {
        if (appState.mediaStream) {
            appState.mediaStream.getTracks().forEach(track => track.stop());
            appState.mediaStream = null;
        }
        
        if (appState.mediaRecorder && appState.mediaRecorder.state === 'recording') {
            appState.mediaRecorder.stop();
        }
        
        if (appState.recordingTimer) {
            clearInterval(appState.recordingTimer);
            appState.recordingTimer = null;
        }
        
        document.getElementById('media-modal').style.display = 'none';
        appState.currentMission = null;
    }

    function closeTextModal() {
        document.getElementById('text-modal').style.display = 'none';
        appState.currentMission = null;
    }

    function closeGPSModal() {
        if (appState.currentMission && appState.currentMission.gpsInterval) {
            clearInterval(appState.currentMission.gpsInterval);
        }
        document.getElementById('gps-modal').style.display = 'none';
        appState.currentMission = null;
    }

    function closeEmergencyModal() {
        document.getElementById('emergency-modal').style.display = 'none';
    }

    function showSettingsModal() {
        // Load current settings
        document.getElementById('high-accuracy').checked = appState.settings.highAccuracy;
        document.getElementById('background-tracking').checked = appState.settings.backgroundTracking;
        document.getElementById('mission-alerts').checked = appState.settings.missionAlerts;
        document.getElementById('prize-updates').checked = appState.settings.prizeUpdates;
        document.getElementById('show-on-leaderboard').checked = appState.settings.showOnLeaderboard;
        document.getElementById('share-location').checked = appState.settings.shareLocation;
        
        document.getElementById('settings-modal').style.display = 'flex';
    }

    function closeSettingsModal() {
        document.getElementById('settings-modal').style.display = 'none';
    }

    function showEditProfileModal() {
        if (!appState.currentUser) return;
        
        document.getElementById('edit-name').value = appState.currentUser.name || '';
        document.getElementById('edit-phone').value = appState.currentUser.phone || '';
        document.getElementById('edit-bio').value = appState.currentUser.bio || '';
        
        document.getElementById('edit-profile-modal').style.display = 'flex';
    }

    function closeEditProfileModal() {
        document.getElementById('edit-profile-modal').style.display = 'none';
    }

    function showChangePasswordModal() {
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';
        document.getElementById('confirm-password').value = '';
        document.getElementById('change-password-modal').style.display = 'flex';
    }

    function closeChangePasswordModal() {
        document.getElementById('change-password-modal').style.display = 'none';
    }

    function showActivityModal() {
        loadActivityHistory();
        document.getElementById('activity-modal').style.display = 'flex';
    }

    function closeActivityModal() {
        document.getElementById('activity-modal').style.display = 'none';
    }

    // ============================================
    // SHOP & INVENTORY
    // ============================================
    async function loadShopItems() {
        console.log('Loading shop items...');
        const { data: prizes, error } = await supabase
            .from('prizes')
            .select('*')
            .eq('is_active', true)
            .order('price');
        
        const prizeGrid = document.getElementById('prize-grid');
        
        if (error) {
            console.error('Error loading prizes:', error);
            prizeGrid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading prizes.</p>
                </div>
            `;
            return;
        }
        
        if (!prizes || prizes.length === 0) {
            prizeGrid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i class="fas fa-gift"></i>
                    <p>No prizes available yet. Check back soon!</p>
                </div>
            `;
            return;
        }
        
        prizeGrid.innerHTML = '';
        
        prizes.forEach(prize => {
            const isSoldOut = prize.remaining_quantity <= 0;
            const canAfford = appState.currentUser && appState.currentUser.coins >= prize.price;
            
            const prizeCard = document.createElement('div');
            prizeCard.className = `prize-card ${isSoldOut ? 'sold-out' : ''}`;
            prizeCard.dataset.category = prize.category || 'physical';
            
            prizeCard.innerHTML = `
                <div class="prize-image">
                    ${prize.image_url ? 
                        `<img src="${prize.image_url}" alt="${prize.name}">` :
                        `<i class="fas fa-gift" style="font-size:48px;color:var(--text-secondary);"></i>`
                    }
                </div>
                <div class="prize-content">
                    <h4 class="prize-title">${prize.name}</h4>
                    <p class="prize-description">${prize.description || 'No description available'}</p>
                    <div class="prize-price">
                        <i class="fas fa-coins"></i>
                        <span>${prize.price}</span> coins
                    </div>
                    <div class="inventory-info">
                        ${isSoldOut ? 'Sold Out' : `${prize.remaining_quantity} available`}
                    </div>
                    <button class="buy-btn" data-prize-id="${prize.id}" 
                            ${isSoldOut || !canAfford ? 'disabled' : ''}>
                        ${isSoldOut ? 'Sold Out' : !canAfford ? `Need ${prize.price - appState.currentUser.coins} more coins` : 'Buy Now'}
                    </button>
                </div>
            `;
            prizeGrid.appendChild(prizeCard);
        });
        
        // Add event listeners to buy buttons
        document.querySelectorAll('.buy-btn').forEach(btn => {
            if (!btn.disabled) {
                btn.addEventListener('click', function() {
                    const prizeId = this.getAttribute('data-prize-id');
                    showPurchaseModal(prizeId);
                });
            }
        });
    }

    function filterShop(category) {
        document.querySelectorAll('#shop-categories .category-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const prizeCards = document.querySelectorAll('.prize-card');
        prizeCards.forEach(card => {
            if (category === 'all' || card.dataset.category === category) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    async function showPurchaseModal(prizeId) {
        const { data: prize, error } = await supabase
            .from('prizes')
            .select('*')
            .eq('id', prizeId)
            .single();
        
        if (error || !prize) {
            showToast('Prize not found', 'error');
            return;
        }
        
        if (!appState.currentUser || appState.currentUser.coins < prize.price) {
            showToast(`You need ${prize.price - appState.currentUser.coins} more coins`, 'error');
            return;
        }
        
        if (prize.remaining_quantity <= 0) {
            showToast('This prize is sold out', 'error');
            return;
        }
        
        if (confirm(`Buy ${prize.name} for ${prize.price} coins?`)) {
            try {
                // Create purchase record
                await supabase
                    .from('purchases')
                    .insert([{
                        user_id: appState.currentUser.id,
                        prize_id: prize.id,
                        price_paid: prize.price,
                        status: 'completed',
                        created_at: new Date().toISOString()
                    }]);
                
                // Update prize quantity
                await supabase
                    .from('prizes')
                    .update({ remaining_quantity: prize.remaining_quantity - 1 })
                    .eq('id', prize.id);
                
                // Update user coins
                const newCoins = appState.currentUser.coins - prize.price;
                await supabase
                    .from('users')
                    .update({ coins: newCoins })
                    .eq('id', appState.currentUser.id);
                
                // Update local state
                appState.currentUser.coins = newCoins;
                updateCoinDisplay();
                
                // Add to inventory
                await supabase
                    .from('user_inventory')
                    .insert([{
                        user_id: appState.currentUser.id,
                        prize_id: prize.id,
                        item_name: prize.name,
                        status: 'active',
                        acquired_at: new Date().toISOString()
                    }]);
                
                showToast(`Purchased ${prize.name}! Check your inventory.`, 'success');
                
                // Reload shop and inventory
                loadShopItems();
                loadUserInventory();
                
            } catch (error) {
                console.error('Purchase error:', error);
                showToast('Purchase failed', 'error');
            }
        }
    }

    async function loadUserInventory() {
        if (!appState.currentUser) return;
        
        console.log('Loading user inventory...');
        const { data: inventory, error } = await supabase
            .from('user_inventory')
            .select('*')
            .eq('user_id', appState.currentUser.id)
            .order('acquired_at', { ascending: false });
        
        const inventoryContainer = document.getElementById('inventory-items');
        
        if (error) {
            console.error('Error loading inventory:', error);
            inventoryContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading inventory.</p>
                </div>
            `;
            return;
        }
        
        if (!inventory || inventory.length === 0) {
            inventoryContainer.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-box-open"></i>
                    <p>No items in your inventory yet.</p>
                    <p style="font-size: 13px; margin-top: 8px;">Complete missions to earn coins and buy prizes!</p>
                </div>
            `;
            return;
        }
        
        inventoryContainer.innerHTML = '';
        
        inventory.forEach(item => {
            const itemElement = document.createElement('div');
            itemElement.className = 'inventory-item';
            itemElement.dataset.status = item.status;
            
            itemElement.innerHTML = `
                <div style="width:56px;height:56px;background:var(--bg-primary);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);">
                    <i class="fas fa-gift" style="font-size:24px;"></i>
                </div>
                <div class="item-info" style="flex: 1;">
                    <h5 style="font-size: 14px; margin-bottom: 4px; color: var(--text-primary);">${item.item_name}</h5>
                    <span class="status-badge" style="background: ${item.status === 'active' ? 'rgba(0, 204, 102, 0.15)' : 'rgba(136, 136, 136, 0.15)'}; color: ${item.status === 'active' ? 'var(--green)' : 'var(--text-secondary)'}; font-size: 11px; padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 4px; font-weight: 600;">
                        ${item.status.charAt(0).toUpperCase() + item.status.slice(1)}
                    </span>
                    <p class="item-date" style="font-size: 11px; color: var(--text-secondary);">Acquired: ${new Date(item.acquired_at).toLocaleDateString()}</p>
                </div>
            `;
            inventoryContainer.appendChild(itemElement);
        });
    }

    function filterInventory(status) {
        document.querySelectorAll('#inventory-filters .category-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const items = document.querySelectorAll('.inventory-item');
        items.forEach(item => {
            if (status === 'all' || item.dataset.status === status) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // ============================================
    // LEADERBOARD
    // ============================================
    async function loadLeaderboard(type) {
        console.log('Loading leaderboard:', type);
        
        document.querySelectorAll('#leaderboard-filters .category-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const myRankCard = document.getElementById('my-rank-card');
        const leaderboardList = document.getElementById('leaderboard-list');
        
        myRankCard.innerHTML = '<div class="loading-spinner" style="width: 24px; height: 24px;"></div>';
        leaderboardList.innerHTML = '<div class="loading-spinner" style="width: 24px; height: 24px;"></div>';
        
        try {
            // Get top users by coins
            const { data: users, error } = await supabase
                .from('users')
                .select('id, name, avatar_url, coins')
                .order('coins', { ascending: false })
                .limit(50);
            
            if (error) throw error;
            
            const leaderboardData = users.map((user, index) => ({
                rank: index + 1,
                ...user
            }));
            
            // Update my rank
            if (appState.currentUser && leaderboardData.length > 0) {
                const myRankIndex = leaderboardData.findIndex(u => u.id === appState.currentUser.id);
                const myRank = myRankIndex >= 0 ? leaderboardData[myRankIndex] : null;
                
                if (myRank) {
                    myRankCard.innerHTML = `
                        <div class="my-rank-card" style="background: var(--bg-card); border-radius: 10px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border-color);">
                            <div style="width:48px;height:48px;border-radius:50%;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);">
                                ${myRank.avatar_url ? 
                                    `<img src="${myRank.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` :
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                            <div class="my-rank-info" style="flex: 1;">
                                <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--text-primary);">Rank #${myRank.rank}</h3>
                                <p style="font-size: 13px; color: var(--text-secondary);">${myRank.name}</p>
                                <p style="font-size: 13px; color: var(--text-secondary);"><i class="fas fa-coins" style="color:var(--yellow);margin-right:5px;"></i> ${myRank.coins} coins</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Update leaderboard list
            if (leaderboardData.length > 0) {
                leaderboardList.innerHTML = '';
                leaderboardData.forEach(user => {
                    const isMe = user.id === appState.currentUser?.id;
                    
                    const item = document.createElement('div');
                    item.className = `leaderboard-item ${isMe ? 'my-rank' : ''}`;
                    item.innerHTML = `
                        <div style="background: var(--bg-card); border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border-color); ${isMe ? 'background: var(--bg-tertiary); border-color: var(--blue);' : ''}">
                            <div class="rank-number" style="font-size: 16px; font-weight: 600; width: 28px; text-align: center; color: ${user.rank === 1 ? '#ffd700' : user.rank === 2 ? '#c0c0c0' : user.rank === 3 ? '#cd7f32' : 'var(--text-secondary)'};">${user.rank}</div>
                            <div style="width:36px;height:36px;border-radius:50%;background:var(--bg-primary);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);overflow:hidden;">
                                ${user.avatar_url ? 
                                    `<img src="${user.avatar_url}" style="width:100%;height:100%;object-fit:cover;">` :
                                    `<i class="fas fa-user"></i>`
                                }
                            </div>
                            <div class="leaderboard-info" style="flex: 1;">
                                <h4 style="font-size: 14px; margin-bottom: 2px; color: var(--text-primary);">${user.name} ${isMe ? '(You)' : ''}</h4>
                                <p style="font-size: 11px; color: var(--text-secondary);">${user.coins || 0} coins</p>
                            </div>
                        </div>
                    `;
                    leaderboardList.appendChild(item);
                });
            }
            
        } catch (error) {
            console.error('Error loading leaderboard:', error);
            leaderboardList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Error loading leaderboard data.</p>
                </div>
            `;
        }
    }

    // ============================================
    // PROFILE FUNCTIONS
    // ============================================
    async function updateProfileStats() {
        if (!appState.currentUser) return;
        
        try {
            // Get completed mission count
            const { count: missionCount } = await supabase
                .from('user_missions')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', appState.currentUser.id)
                .eq('status', 'completed');
            
            document.getElementById('profile-missions').textContent = missionCount || 0;
            
            // Get rank
            const { data: users } = await supabase
                .from('users')
                .select('id, coins')
                .order('coins', { ascending: false });
            
            if (users) {
                const myRank = users.findIndex(u => u.id === appState.currentUser.id) + 1;
                document.getElementById('profile-rank').textContent = myRank > 0 ? `#${myRank}` : '#0';
            }
        } catch (error) {
            console.error('Error updating profile stats:', error);
        }
    }

    function updateCoinDisplay() {
        if (!appState.currentUser) return;
        document.getElementById('user-coins').textContent = appState.currentUser.coins;
        document.getElementById('shop-coins').textContent = appState.currentUser.coins;
        document.getElementById('profile-coins').textContent = appState.currentUser.coins;
    }

    async function updateProfile() {
        const name = document.getElementById('edit-name').value;
        const phone = document.getElementById('edit-phone').value;
        const bio = document.getElementById('edit-bio').value;
        
        if (!name) {
            showToast('Please enter your name', 'error');
            return;
        }
        
        try {
            await supabase
                .from('users')
                .update({
                    name,
                    phone,
                    bio,
                    updated_at: new Date().toISOString()
                })
                .eq('id', appState.currentUser.id);
            
            // Update local state
            appState.currentUser.name = name;
            appState.currentUser.phone = phone;
            appState.currentUser.bio = bio;
            
            // Update UI
            document.getElementById('profile-name').textContent = name;
            
            showToast('Profile updated successfully', 'success');
            closeEditProfileModal();
            
        } catch (error) {
            console.error('Error updating profile:', error);
            showToast('Failed to update profile', 'error');
        }
    }

    async function handleAvatarUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
            showToast('Please select an image file', 'error');
            return;
        }
        
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
            showToast('Image size must be less than 5MB', 'error');
            return;
        }
        
        try {
            // Upload new avatar
            const fileName = `${appState.currentUser.id}/profile_${Date.now()}.jpg`;
            const { error: uploadError } = await supabase.storage
                .from('profiles')
                .upload(fileName, file, {
                    cacheControl: '3600',
                    upsert: true
                });
            
            if (uploadError) throw uploadError;
            
            // Get public URL
            const { data: urlData } = supabase.storage
                .from('profiles')
                .getPublicUrl(fileName);
            
            // Update user record
            await supabase
                .from('users')
                .update({
                    avatar_url: urlData.publicUrl,
                    updated_at: new Date().toISOString()
                })
                .eq('id', appState.currentUser.id);
            
            // Update local state and UI
            appState.currentUser.avatar_url = urlData.publicUrl;
            updateProfilePicture(urlData.publicUrl);
            
            showToast('Profile picture updated', 'success');
            
        } catch (error) {
            console.error('Error uploading avatar:', error);
            showToast('Failed to upload profile picture', 'error');
        }
    }

    async function changePassword() {
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        if (!currentPassword || !newPassword || !confirmPassword) {
            showToast('Please fill all fields', 'error');
            return;
        }
        
        if (newPassword !== confirmPassword) {
            showToast('New passwords do not match', 'error');
            return;
        }
        
        if (newPassword.length < 8) {
            showToast('Password must be at least 8 characters', 'error');
            return;
        }
        
        try {
            // Update password
            const { error } = await supabase.auth.updateUser({
                password: newPassword
            });
            
            if (error) throw error;
            
            showToast('Password updated successfully', 'success');
            closeChangePasswordModal();
            
        } catch (error) {
            console.error('Error changing password:', error);
            showToast('Failed to change password', 'error');
        }
    }

    async function loadActivityHistory() {
        if (!appState.currentUser) return;
        
        try {
            const { data: submissions } = await supabase
                .from('submissions')
                .select(`
                    *,
                    missions (title, points)
                `)
                .eq('user_id', appState.currentUser.id)
                .order('created_at', { ascending: false })
                .limit(50);
            
            const activityList = document.getElementById('activity-list');
            
            if (!submissions || submissions.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>No activity history yet</p>
                        <p style="font-size: 13px; margin-top: 8px;">Complete missions to see your activity history</p>
                    </div>
                `;
                return;
            }
            
            activityList.innerHTML = '';
            
            submissions.forEach(sub => {
                const activityItem = document.createElement('div');
                activityItem.className = 'inventory-item';
                activityItem.style.marginBottom = '8px';
                
                let activityText = '';
                let icon = 'fas fa-question';
                let color = 'var(--text-secondary)';
                
                switch(sub.file_type) {
                    case 'photo':
                        activityText = 'Photo mission submitted';
                        icon = 'fas fa-camera';
                        color = 'var(--blue)';
                        break;
                    case 'video':
                        activityText = 'Video mission submitted';
                        icon = 'fas fa-video';
                        color = 'var(--blue)';
                        break;
                    case 'audio':
                        activityText = 'Audio mission submitted';
                        icon = 'fas fa-microphone';
                        color = 'var(--blue)';
                        break;
                    case 'text':
                        activityText = 'Text answer submitted';
                        icon = 'fas fa-font';
                        color = 'var(--blue)';
                        break;
                    case 'gps':
                        activityText = 'GPS check-in submitted';
                        icon = 'fas fa-map-marker-alt';
                        color = 'var(--blue)';
                        break;
                }
                
                activityItem.innerHTML = `
                    <div style="width:36px;height:36px;border-radius:8px;background:${color}20;display:flex;align-items:center;justify-content:center;color:${color};">
                        <i class="${icon}"></i>
                    </div>
                    <div style="flex: 1;">
                        <h5 style="font-size: 14px; margin-bottom: 2px; color: var(--text-primary);">${sub.missions?.title || 'Mission'}</h5>
                        <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px;">${activityText}</p>
                        <p style="font-size: 11px; color: var(--text-secondary);">
                            ${new Date(sub.created_at).toLocaleDateString()} • 
                            Status: <span style="color: ${sub.review_status === 'approved' ? 'var(--green)' : sub.review_status === 'rejected' ? 'var(--red)' : 'var(--yellow)'}">
                                ${sub.review_status || 'pending'}
                            </span>
                        </p>
                    </div>
                `;
                activityList.appendChild(activityItem);
            });
            
        } catch (error) {
            console.error('Error loading activity history:', error);
        }
    }

    // ============================================
    // SETTINGS
    // ============================================
    function saveSettings() {
        // Update app state
        appState.settings = {
            highAccuracy: document.getElementById('high-accuracy').checked,
            backgroundTracking: document.getElementById('background-tracking').checked,
            missionAlerts: document.getElementById('mission-alerts').checked,
            prizeUpdates: document.getElementById('prize-updates').checked,
            showOnLeaderboard: document.getElementById('show-on-leaderboard').checked,
            shareLocation: document.getElementById('share-location').checked
        };
        
        // Save to localStorage
        saveSettings();
        
        // Apply settings
        if (appState.locationWatchId) {
            // Restart location tracking with new settings
            navigator.geolocation.clearWatch(appState.locationWatchId);
            requestLocationPermission();
        }
        
        showToast('Settings saved successfully', 'success');
        closeSettingsModal();
    }

    function clearCache() {
        if (confirm('Clear all cached data? This will not affect your account.')) {
            localStorage.removeItem('hunt_player_state');
            localStorage.removeItem('hunt_player_settings');
            showToast('Cache cleared successfully', 'success');
            
            // Update button text
            document.getElementById('clear-cache').textContent = 'Clear Cache (0 MB)';
        }
    }

    // ============================================
    // EMERGENCY SOS
    // ============================================
    function showEmergencyModal() {
        if (!appState.currentUser) {
            showToast('Please log in to use SOS', 'error');
            return;
        }
        
        // Check for accurate location
        if (!appState.userLocation || appState.userLocation.accuracy > 1000) {
            showToast('Getting accurate location for emergency...', 'warning');
            
            // Try to get better location
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    appState.userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: position.timestamp
                    };
                    
                    showEmergencyModalWithLocation();
                },
                function(error) {
                    showToast('Cannot get accurate location. SOS may not be precise.', 'error');
                    showEmergencyModalWithLocation();
                },
                { enableHighAccuracy: true, timeout: 5000 }
            );
            
            return;
        }
        
        showEmergencyModalWithLocation();
    }

    function showEmergencyModalWithLocation() {
        const emergencyModal = document.getElementById('emergency-modal');
        if (!emergencyModal) return;
        
        // Update modal with location info
        const locationInfo = appState.userLocation ? 
            `Location accuracy: ${Math.round(appState.userLocation.accuracy)}m` : 
            'Location unavailable';
        
        emergencyModal.innerHTML = `
            <div class="modal-container" style="background: var(--red); color: white; text-align: center;">
                <div style="padding: 24px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; animation: pulse 1s infinite;"></i>
                    <h2 style="font-size: 24px; margin-bottom: 12px;">EMERGENCY ASSISTANCE</h2>
                    <p style="margin-bottom: 10px; line-height: 1.5; opacity: 0.9; font-size: 14px;">
                        Your location has been sent to event organizers.
                    </p>
                    <p style="margin-bottom: 20px; line-height: 1.5; opacity: 0.9; font-size: 12px; color: rgba(255,255,255,0.7);">
                        ${locationInfo}
                    </p>
                    <p style="margin-bottom: 20px; line-height: 1.5; opacity: 0.9; font-size: 14px;">
                        Choose an emergency option:
                    </p>
                    <div class="emergency-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                        <a href="tel:0644106000" style="padding: 12px; border: 2px solid white; border-radius: 8px; background: transparent; color: white; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); font-size: 13px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-ambulance"></i> Call Ambulance: 064 410 6000
                        </a>
                        <a href="tel:1411" style="padding: 12px; border: 2px solid white; border-radius: 8px; background: transparent; color: white; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); font-size: 13px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                            <i class="fas fa-phone-alt"></i> Call Toll-Free: 1411
                        </a>
                        <button id="close-emergency-modal-btn" style="margin-top: 16px; padding: 12px; border: 2px solid white; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-weight: 600; cursor: pointer; font-size: 13px;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // Reattach close button event listener
        const closeBtn = emergencyModal.querySelector('#close-emergency-modal-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', closeEmergencyModal);
        }
        
        emergencyModal.style.display = 'flex';
        
        // Send SOS alert
        sendSOSAlert();
    }

    async function sendSOSAlert() {
        if (!appState.currentUser || !appState.userLocation) return;
        
        try {
            await supabase
                .from('sos_alerts')
                .insert([{
                    user_id: appState.currentUser.id,
                    user_name: appState.currentUser.name,
                    user_phone: appState.currentUser.phone,
                    latitude: appState.userLocation.lat,
                    longitude: appState.userLocation.lng,
                    accuracy: appState.userLocation.accuracy,
                    status: 'active',
                    created_at: new Date().toISOString()
                }]);
            
            console.log('SOS alert sent successfully');
            showToast('EMERGENCY ALERT SENT! Help is on the way.', 'success');
        } catch (error) {
            console.error('SOS error:', error);
            showToast('Failed to send alert', 'error');
        }
    }

    // ============================================
    // EVENT TIMER
    // ============================================
    function startEventTimer() {
        console.log('Starting event timer');
        
        // Load event timer from database or use default
        const eventEnd = new Date();
        eventEnd.setHours(eventEnd.getHours() + 24); // 24 hours from now
        appState.eventTimer = {
            endTime: eventEnd,
            isRunning: true
        };
        
        // Save timer state
        saveTimerState();
        
        updateTimer();
    }

    function updateTimer() {
        if (!appState.eventTimer || !appState.eventTimer.endTime) return;
        
        const now = new Date();
        const diff = appState.eventTimer.endTime - now;
        
        if (diff <= 0) {
            document.getElementById('event-timer').textContent = 'EVENT ENDED';
            return;
        }
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('event-timer').textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        setTimeout(updateTimer, 1000);
    }

    function saveTimerState() {
        try {
            if (appState.eventTimer) {
                localStorage.setItem('hunt_event_timer', JSON.stringify({
                    endTime: appState.eventTimer.endTime.toISOString(),
                    isRunning: appState.eventTimer.isRunning
                }));
            }
        } catch (error) {
            console.error('Error saving timer state:', error);
        }
    }

    // ============================================
    // REAL-TIME SUBSCRIPTIONS
    // ============================================
    function setupRealTimeSubscriptions() {
        if (!appState.currentUser) return;
        
        console.log('Setting up real-time subscriptions...');
        
        // Subscribe to user updates (coins, etc)
        const userChannel = supabase
            .channel('user-updates')
            .on('postgres_changes',
                { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${appState.currentUser.id}` },
                (payload) => {
                    console.log('User update received:', payload.new);
                    if (payload.new.coins !== appState.currentUser.coins) {
                        appState.currentUser.coins = payload.new.coins;
                        updateCoinDisplay();
                        showToast(`Coins updated: ${payload.new.coins}`, 'info');
                    }
                }
            )
            .subscribe();
        
        // Subscribe to mission status updates
        const missionChannel = supabase
            .channel('mission-updates')
            .on('postgres_changes',
                { event: 'UPDATE', schema: 'public', table: 'user_missions', filter: `user_id=eq.${appState.currentUser.id}` },
                (payload) => {
                    console.log('Mission update received:', payload.new);
                    if (payload.new.status === 'completed') {
                        showToast('Mission completed!', 'success');
                        if (appState.currentZone) {
                            loadMissionsForZone(appState.currentZone.id);
                        }
                        updateProfileStats();
                    }
                }
            )
            .subscribe();
        
        console.log('Real-time subscriptions active');
    }

    // ============================================
    // LOGOUT
    // ============================================
    async function logout() {
        try {
            // Stop location watching
            if (appState.locationWatchId && navigator.geolocation) {
                navigator.geolocation.clearWatch(appState.locationWatchId);
            }
            
            // Stop media streams
            if (appState.mediaStream) {
                appState.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            // Sign out
            await supabase.auth.signOut();
            
            // Clear state
            appState.currentUser = null;
            appState.currentSession = null;
            appState.userLocation = null;
            
            // Show login screen
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'flex';
            showLogin();
            
            showToast('Logged out successfully', 'success');
            
        } catch (error) {
            console.error('Logout error:', error);
        }
    }

    // ============================================
    // EXPOSE FUNCTIONS FOR HTML ONCLICK HANDLERS
    // ============================================
    window.showTab = showTab;
    window.showToast = showToast;
    </script>
</body>
</html>
