<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>The Hunt - Treasure Hunt Adventure</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
    /* Professional Black/White/Grey Theme - FIXED */
    :root {
        --primary: #ffffff;
        --primary-dark: #cccccc;
        --secondary: #666666;
        --danger: #ff4444;
        --danger-dark: #cc0000;
        --success: #44ff44;
        --warning: #ffaa44;
        --background: #000000;
        --card: #111111;
        --border: #333333;
        --text: #ffffff;
        --text-secondary: #888888;
        --accent: #4a90e2;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    html, body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        position: fixed;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--background);
        color: var(--text);
        overflow: hidden;
        position: relative;
    }

    /* Auth Screens */
    .auth-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--background);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        z-index: 10000;
        overflow-y: auto;
    }

    .auth-container {
        width: 100%;
        max-width: 400px;
        background: var(--card);
        border-radius: 12px;
        padding: 40px 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid var(--border);
    }

    .logo {
        text-align: center;
        margin-bottom: 40px;
    }

    .logo h1 {
        font-size: 2.2rem;
        color: var(--primary);
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: 1px;
    }

    .logo p {
        color: var(--text-secondary);
        font-size: 0.9rem;
        letter-spacing: 0.5px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-control {
        width: 100%;
        padding: 14px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-size: 15px;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.08);
    }

    .btn {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 8px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        letter-spacing: 0.5px;
    }

    .btn-primary {
        background: var(--primary);
        color: var(--background);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    .auth-switch {
        text-align: center;
        margin-top: 24px;
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .auth-switch a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
        margin-left: 5px;
    }

    .error-message {
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid var(--danger);
        color: #ff8888;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 0.85rem;
        display: none;
        line-height: 1.4;
    }

    .success-message {
        background: rgba(68, 255, 68, 0.1);
        border: 1px solid var(--success);
        color: #88ff88;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 0.85rem;
        display: none;
        line-height: 1.4;
    }

    /* Main App */
    .app-container {
        display: none;
        flex-direction: column;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        position: relative;
    }

    /* Header */
    .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 64px;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        z-index: 1000;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
        min-width: 0;
    }

    .profile-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid var(--primary);
        background: var(--card);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        flex-shrink: 0;
    }

    .profile-btn img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-btn i {
        font-size: 18px;
    }

    .timer {
        background: var(--card);
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        letter-spacing: 1px;
        border: 1px solid var(--border);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-shrink: 0;
    }

    .coins-display {
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: 600;
        flex-shrink: 0;
        margin-left: auto;
    }

    /* SOS Button - FIXED: Higher z-index and better styling */
    .sos-btn {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 64px;
        height: 64px;
        border-radius: 50%;
        background: var(--danger);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.3rem;
        box-shadow: 0 4px 20px rgba(255, 68, 68, 0.3);
        cursor: pointer;
        z-index: 9999; /* Higher than other elements */
        border: none;
        animation: pulse 2s infinite;
        flex-shrink: 0;
        transition: all 0.3s ease;
    }

    .sos-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 25px rgba(255, 68, 68, 0.5);
    }

    .sos-btn:active {
        transform: scale(0.95);
    }

    @keyframes pulse {
        0% { 
            transform: scale(1); 
            box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); 
        }
        70% { 
            transform: scale(1.05); 
            box-shadow: 0 0 0 15px rgba(255, 68, 68, 0); 
        }
        100% { 
            transform: scale(1); 
            box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); 
        }
    }

    /* Main Content */
    .main-content {
        flex: 1;
        padding: 16px;
        padding-top: 80px;
        padding-bottom: 70px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
        position: relative;
    }

    /* Tab Containers */
    .tab-container {
        display: none;
        width: 100%;
        min-height: 100%;
    }

    .tab-container.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Map Container */
    .map-container {
        height: 50vh;
        min-height: 300px;
        width: 100%;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--border);
        margin-bottom: 16px;
    }

    #map {
        width: 100%;
        height: 100%;
        position: relative;
    }

    .map-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        background: var(--card);
        color: var(--text-secondary);
        gap: 16px;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    .location-permission {
        text-align: center;
        padding: 20px;
        background: var(--card);
        border-radius: 8px;
        margin: 16px 0;
        border: 1px solid var(--border);
        width: 100%;
        animation: fadeIn 0.5s ease;
    }

    .location-permission button {
        margin-top: 12px;
        padding: 12px 24px;
        background: var(--primary);
        color: var(--background);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s;
    }

    .location-permission button:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
    }

    /* Zone List */
    .zone-list {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 8px 0;
        margin-bottom: 16px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        width: 100%;
    }

    .zone-list::-webkit-scrollbar {
        display: none;
    }

    .zone-item {
        flex: 0 0 auto;
        padding: 10px 20px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .zone-item:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .zone-item.active {
        background: var(--primary);
        color: var(--background);
        border-color: transparent;
    }

    /* Mission Cards */
    .missions-list-container {
        width: 100%;
        overflow: hidden;
    }

    .mission-card {
        background: var(--card);
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid var(--border);
        transition: all 0.2s;
        width: 100%;
        overflow: hidden;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .mission-card.completed {
        border-color: var(--success);
        background: rgba(68, 255, 68, 0.05);
    }

    .mission-card.unlocked {
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.05);
    }

    .mission-card.locked {
        opacity: 0.6;
    }

    .mission-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        width: 100%;
        gap: 8px;
    }

    .mission-title {
        font-size: 1rem;
        font-weight: 600;
        flex: 1;
        color: var(--primary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .mission-points {
        background: var(--accent);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.8rem;
        flex-shrink: 0;
    }

    .mission-type-badge {
        display: inline-block;
        padding: 4px 8px;
        background: rgba(74, 144, 226, 0.2);
        color: var(--accent);
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .mission-question {
        color: var(--text);
        margin-bottom: 12px;
        line-height: 1.5;
        font-size: 14px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        width: 100%;
        overflow-wrap: break-word;
    }

    .mission-description {
        color: var(--text-secondary);
        margin-bottom: 12px;
        line-height: 1.5;
        font-size: 13px;
        width: 100%;
        overflow-wrap: break-word;
    }

    .mission-actions {
        display: flex;
        gap: 8px;
        width: 100%;
    }

    .action-btn {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: var(--text);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .action-btn:hover:not(:disabled) {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
    }

    .action-btn.record {
        background: var(--primary);
        color: var(--background);
    }

    .action-btn.record:hover:not(:disabled) {
        background: var(--primary-dark);
    }

    .action-btn.completed {
        background: var(--success);
        color: var(--background);
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* Shop Grid */
    .prize-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 12px;
        width: 100%;
    }

    .prize-card {
        background: var(--card);
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid var(--border);
        transition: all 0.2s;
        width: 100%;
    }

    .prize-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border-color: var(--primary);
    }

    /* Inventory Items */
    .inventory-items {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
    }

    .inventory-item {
        background: var(--card);
        border-radius: 10px;
        padding: 12px;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
    }

    .inventory-item:hover {
        border-color: var(--primary);
        background: rgba(255, 255, 255, 0.05);
    }

    /* Leaderboard */
    .leaderboard-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .leaderboard-item {
        transition: all 0.2s;
    }

    .leaderboard-item:hover {
        transform: translateX(5px);
    }

    /* Profile */
    .profile-header {
        text-align: center;
        margin-bottom: 24px;
        padding: 20px;
        background: var(--card);
        border-radius: 10px;
        border: 1px solid var(--border);
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--background);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 36px;
        margin: 0 auto 16px;
        border: 3px solid var(--primary);
        overflow: hidden;
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-name {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--primary);
    }

    .profile-email {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    .profile-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        width: 100%;
        margin-bottom: 24px;
    }

    .stat-card {
        background: var(--card);
        border-radius: 10px;
        padding: 16px;
        text-align: center;
        border: 1px solid var(--border);
    }

    .stat-card h4 {
        color: var(--text-secondary);
        font-size: 12px;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary);
    }

    .profile-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
        width: 100%;
    }

    .profile-action-btn {
        padding: 14px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 14px;
    }

    .profile-action-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: var(--primary);
        transform: translateY(-1px);
    }

    .profile-action-btn.logout-btn {
        background: rgba(255, 68, 68, 0.1);
        border-color: var(--danger);
        color: var(--danger);
    }

    .profile-action-btn.logout-btn:hover {
        background: rgba(255, 68, 68, 0.2);
    }

    /* Bottom Navigation */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 64px;
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(10px);
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 1000;
        padding-bottom: env(safe-area-inset-bottom);
    }

    .nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s;
        min-width: 56px;
        flex: 1;
        max-width: 80px;
    }

    .nav-item:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .nav-item.active {
        color: var(--primary);
        background: rgba(255, 255, 255, 0.1);
    }

    .nav-item i {
        font-size: 18px;
    }

    .nav-label {
        font-size: 10px;
        font-weight: 600;
        letter-spacing: 0.5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    /* Loading Spinner */
    .spinner {
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        width: 36px;
        height: 36px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 16px;
        color: var(--text-secondary);
        width: 100%;
    }

    .empty-state i {
        font-size: 40px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 80px;
        right: 16px;
        z-index: 10002; /* Highest z-index */
        max-width: calc(100% - 32px);
    }

    .toast {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        min-width: 280px;
        max-width: 400px;
        transform: translateX(400px);
        transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        overflow: hidden;
        word-wrap: break-word;
    }

    .toast.show {
        transform: translateX(0);
    }

    .toast-success {
        border-left: 4px solid var(--success);
    }

    .toast-error {
        border-left: 4px solid var(--danger);
    }

    .toast-info {
        border-left: 4px solid var(--accent);
    }

    .toast-warning {
        border-left: 4px solid var(--warning);
    }

    /* Modal Overlays - FIXED: Higher z-index and proper animation */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10001; /* Higher than SOS button */
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        overflow-y: auto;
        animation: fadeIn 0.3s ease;
    }

    .modal-container {
        width: 100%;
        max-width: 500px;
        background: var(--card);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
        border: 1px solid var(--border);
        max-height: 90vh;
        overflow-y: auto;
        animation: slideUp 0.3s ease;
    }

    /* Emergency Modal - FIXED: Special styling with animations */
    #emergency-modal .modal-container {
        background: var(--danger);
        color: white;
        text-align: center;
        animation: emergencyPulse 1s infinite;
        border: 2px solid white;
    }

    @keyframes emergencyPulse {
        0% { 
            box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7), 
                        0 0 0 0 rgba(255, 255, 255, 0.3); 
        }
        70% { 
            box-shadow: 0 0 0 20px rgba(255, 68, 68, 0), 
                        0 0 0 10px rgba(255, 255, 255, 0); 
        }
        100% { 
            box-shadow: 0 0 0 0 rgba(255, 68, 68, 0), 
                        0 0 0 0 rgba(255, 255, 255, 0); 
        }
    }

    #emergency-modal .emergency-buttons {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
    }

    #emergency-modal .emergency-buttons a,
    #emergency-modal .emergency-buttons button {
        padding: 16px;
        border: 2px solid white;
        border-radius: 10px;
        background: transparent;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 14px;
        text-decoration: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    #emergency-modal .emergency-buttons a:hover,
    #emergency-modal .emergency-buttons button:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    #emergency-modal .emergency-buttons a:active,
    #emergency-modal .emergency-buttons button:active {
        transform: translateY(0);
    }

    /* QR Scanner */
    .qr-scanner {
        width: 100%;
        height: 300px;
        background: var(--background);
        position: relative;
        overflow: hidden;
    }

    .qr-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 2px solid var(--primary);
        border-radius: 8px;
    }

    /* Map User Location Marker */
    .user-location-marker {
        animation: pulse 2s infinite !important;
    }

    /* Blink animation for recording indicator */
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .prize-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .logo h1 {
            font-size: 1.8rem;
        }
        
        .auth-container {
            padding: 32px 24px;
        }
        
        .mission-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }
        
        .mission-title {
            white-space: normal;
        }
        
        .profile-stats {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .modal-container {
            max-width: 95%;
        }
    }

    @media (max-width: 480px) {
        .prize-grid {
            grid-template-columns: 1fr;
        }
        
        .profile-stats {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .mission-actions {
            flex-direction: column;
        }
        
        .sos-btn {
            width: 60px;
            height: 60px;
            bottom: 90px;
            right: 16px;
        }
        
        .toast {
            min-width: 250px;
            max-width: calc(100vw - 32px);
        }
        
        .nav-item {
            padding: 6px;
            min-width: 50px;
        }
        
        .nav-item i {
            font-size: 16px;
        }
        
        .nav-label {
            font-size: 9px;
        }
    }

    /* Dark mode optimizations */
    @media (prefers-color-scheme: dark) {
        :root {
            --background: #000000;
            --card: #111111;
            --border: #333333;
        }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
        :root {
            --primary: #ffffff;
            --danger: #ff0000;
            --success: #00ff00;
            --text: #ffffff;
            --background: #000000;
        }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        .sos-btn {
            animation: none;
        }
        
        #emergency-modal .modal-container {
            animation: none;
        }
        
        .toast {
            transition: none;
        }
    }
</style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-screen">
        <div class="auth-container">
            <div class="logo">
                <h1>THE HUNT</h1>
                <p>Treasure Hunt Adventure</p>
            </div>
            
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <!-- Login Form -->
            <div id="login-form">
                <h2 style="margin-bottom: 24px; text-align: center; color: var(--primary);">Welcome Back</h2>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="login-email" class="form-control" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" class="form-control" placeholder="••••••••" required>
                </div>
                <button id="login-button" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
                <div class="auth-switch">
                    Don't have an account? <a href="#" id="show-signup-link">Create Account</a>
                </div>
            </div>
            
            <!-- Signup Form -->
            <div id="signup-form" style="display: none;">
                <h2 style="margin-bottom: 24px; text-align: center; color: var(--primary);">Create Account</h2>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signup-name" class="form-control" placeholder="John Doe" required>
                </div>
                <div class="form-group">
                    <label>Phone Number</label>
                    <input type="tel" id="signup-phone" class="form-control" placeholder="+264 81 234 5678" required>
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" id="signup-email" class="form-control" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signup-password" class="form-control" placeholder="••••••••" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Profile Photo</label>
                    <input type="file" id="signup-photo" class="form-control" accept="image/*" capture="user">
                    <small style="color: var(--text-secondary); font-size: 11px; margin-top: 4px; display: block;">
                        Take a selfie or upload a clear photo for identification
                    </small>
                </div>
                <button id="signup-button" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i>
                    Create Account
                </button>
                <div class="auth-switch">
                    Already have an account? <a href="#" id="show-login-link">Sign In</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="profile-btn" id="profile-button">
                    <i class="fas fa-user"></i>
                </div>
                <div class="timer" id="event-timer">24:00:00</div>
            </div>
            <div class="coins-display">
                <i class="fas fa-coins" style="color: var(--accent);"></i>
                <span id="user-coins">0</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="main-content">
            <!-- Map Tab -->
            <div id="map-tab" class="tab-container active">
                <div class="map-container">
                    <div id="map">
                        <div class="map-loading">
                            <i class="fas fa-map-marked-alt"></i>
                            <p>Loading map...</p>
                        </div>
                    </div>
                </div>
                <div id="location-permission" class="location-permission" style="display: none;">
                    <p>Location access is required to show zones and missions.</p>
                    <button id="request-location-btn">Enable Location</button>
                </div>
                <div>
                    <h2 style="margin-bottom: 12px; font-size: 18px; color: var(--primary);">Current Zone</h2>
                    <div id="current-zone" style="background: var(--card); padding: 12px; border-radius: 8px; margin-bottom: 16px; border: 1px solid var(--border);">
                        <p style="color: var(--text-secondary); font-size: 13px;">Enable location to see zones</p>
                    </div>
                    <div id="nearby-missions" style="margin-top: 16px;">
                        <div class="empty-state">
                            <i class="fas fa-map-marker-alt"></i>
                            <p>No nearby missions. Move to a zone to see missions.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Missions Tab -->
            <div id="missions-tab" class="tab-container">
                <h2 style="margin-bottom: 12px; font-size: 18px; color: var(--primary);">Missions</h2>
                <div class="zone-list" id="zone-list">
                    <div class="spinner" style="margin: 20px auto;"></div>
                </div>
                <div class="missions-list-container">
                    <div id="missions-list">
                        <div class="empty-state">
                            <i class="fas fa-tasks"></i>
                            <p>Select a zone to see missions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shop Tab -->
            <div id="shop-tab" class="tab-container">
                <div class="shop-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="font-size: 18px; color: var(--primary);">Prize Shop</h2>
                    <div class="coins-balance" style="background: var(--card); padding: 8px 16px; border-radius: 20px; font-weight: 600; display: flex; align-items: center; gap: 6px; border: 1px solid var(--border);">
                        <i class="fas fa-coins"></i>
                        <span id="shop-coins">0</span>
                    </div>
                </div>
                
                <div class="shop-categories" id="shop-categories">
                    <button class="category-btn active" data-category="all">All Items</button>
                    <button class="category-btn" data-category="physical">Physical</button>
                    <button class="category-btn" data-category="digital">Digital</button>
                    <button class="category-btn" data-category="voucher">Vouchers</button>
                    <button class="category-btn" data-category="experience">Experiences</button>
                </div>
                
                <div class="prize-grid" id="prize-grid">
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-gift"></i>
                        <p>No prizes available yet. Check back soon!</p>
                    </div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div id="inventory-tab" class="tab-container">
                <h2 style="margin-bottom: 12px; font-size: 18px; color: var(--primary);">My Items</h2>
                
                <div class="inventory-filters" id="inventory-filters">
                    <button class="filter-btn active" data-status="all">All Items</button>
                    <button class="filter-btn" data-status="active">Available</button>
                    <button class="filter-btn" data-status="used">Used</button>
                    <button class="filter-btn" data-status="expired">Expired</button>
                </div>
                
                <div class="inventory-items" id="inventory-items">
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No items in your inventory yet.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Complete missions to earn coins and buy prizes!</p>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard-tab" class="tab-container">
                <h2 style="margin-bottom: 12px; font-size: 18px; color: var(--primary);">Leaderboards</h2>
                
                <div class="leaderboard-filters" id="leaderboard-filters">
                    <button class="leaderboard-btn active" data-type="global">Global</button>
                    <button class="leaderboard-btn" data-type="team">Team</button>
                    <button class="leaderboard-btn" data-type="friends">Friends</button>
                </div>
                
                <div id="my-rank-card" class="my-rank-card">
                    <div class="spinner"></div>
                </div>
                
                <div class="leaderboard-list" id="leaderboard-list">
                    <div class="empty-state">
                        <i class="fas fa-trophy"></i>
                        <p>No leaderboard data available yet.</p>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile-tab" class="tab-container">
                <div class="profile-header">
                    <div class="profile-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 class="profile-name" id="profile-name">Loading...</h2>
                    <p class="profile-email" id="profile-email">Loading...</p>
                </div>
                
                <div class="profile-stats">
                    <div class="stat-card">
                        <h4>Total Coins</h4>
                        <div class="stat-number" id="profile-coins">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Missions</h4>
                        <div class="stat-number" id="profile-missions">0</div>
                    </div>
                    <div class="stat-card">
                        <h4>Rank</h4>
                        <div class="stat-number" id="profile-rank">#0</div>
                    </div>
                </div>
                
                <div class="profile-actions">
                    <button class="profile-action-btn" id="edit-profile-btn">
                        <i class="fas fa-user-edit"></i>
                        Edit Profile
                    </button>
                    <button class="profile-action-btn" id="change-password-btn">
                        <i class="fas fa-lock"></i>
                        Change Password
                    </button>
                    <button class="profile-action-btn" id="view-activity-btn">
                        <i class="fas fa-history"></i>
                        Activity History
                    </button>
                    <button class="profile-action-btn logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- SOS Button -->
        <button class="sos-btn" id="sos-button">
            <i class="fas fa-exclamation-triangle"></i>
        </button>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-tab="map">
                <i class="fas fa-map"></i>
                <div class="nav-label">Map</div>
            </div>
            <div class="nav-item" data-tab="missions">
                <i class="fas fa-tasks"></i>
                <div class="nav-label">Missions</div>
            </div>
            <div class="nav-item" data-tab="shop">
                <i class="fas fa-store"></i>
                <div class="nav-label">Shop</div>
            </div>
            <div class="nav-item" data-tab="inventory">
                <i class="fas fa-box"></i>
                <div class="nav-label">My Items</div>
            </div>
            <div class="nav-item" data-tab="profile">
                <i class="fas fa-user"></i>
                <div class="nav-label">Profile</div>
            </div>
        </div>
    </div>

    <!-- Media Capture Modal -->
    <div id="media-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="media-header" style="padding: 16px; border-bottom: 1px solid var(--border); text-align: center;">
                <h3 id="mission-modal-title" style="font-size: 18px; margin-bottom: 4px; color: var(--primary);">Complete Mission</h3>
                <p id="mission-modal-question" style="color: var(--text-secondary); font-size: 13px;">Take a photo at the location</p>
            </div>
            <div class="media-preview" style="width: 100%; height: 300px; background: var(--background); display: flex; align-items: center; justify-content: center; position: relative;">
                <video id="video-preview" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>
                <canvas id="audio-visualizer" style="display: none; width: 100%; height: 100%;"></canvas>
                <img id="image-preview" style="display: none; max-width: 100%; max-height: 100%;">
                <div id="recording-indicator" style="position: absolute; top: 16px; left: 16px; background: var(--danger); color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; display: flex; align-items: center; gap: 4px; display: none;">
                    <div class="dot" style="width: 6px; height: 6px; background: white; border-radius: 50%; animation: blink 1s infinite;"></div>
                    <span>REC</span>
                </div>
                <div id="media-timer" style="position: absolute; bottom: 16px; left: 0; right: 0; text-align: center; color: white; font-size: 16px; font-weight: 600; display: none;">00:00</div>
            </div>
            <div id="media-controls" style="padding: 16px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                <!-- Buttons will be dynamically added based on mission type -->
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qr-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 16px; border-bottom: 1px solid var(--border); text-align: center;">
                <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--primary);">Scan QR Code</h3>
                <p style="color: var(--text-secondary); font-size: 13px;">Point your camera at the QR code</p>
            </div>
            <div class="qr-scanner">
                <video id="qr-video" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>
                <div class="qr-overlay"></div>
            </div>
            <div style="padding: 16px; display: flex; gap: 8px;">
                <button id="close-qr-modal" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-weight: 600; cursor: pointer; background: var(--card); color: var(--text);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Text Answer Modal -->
    <div id="text-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 16px; border-bottom: 1px solid var(--border); text-align: center;">
                <h3 id="text-modal-title" style="font-size: 18px; margin-bottom: 4px; color: var(--primary);">Text Answer</h3>
                <p id="text-modal-question" style="color: var(--text-secondary); font-size: 13px;">Enter your answer below</p>
            </div>
            <div style="padding: 16px;">
                <textarea id="text-answer-input" style="width: 100%; min-height: 150px; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; resize: vertical;" placeholder="Type your answer here..."></textarea>
            </div>
            <div style="padding: 16px; display: flex; gap: 8px;">
                <button id="submit-text-answer" style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--primary); color: var(--background);">
                    <i class="fas fa-paper-plane"></i> Submit Answer
                </button>
                <button id="close-text-modal" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-weight: 600; cursor: pointer; background: var(--card); color: var(--text);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- GPS Check-in Modal -->
    <div id="gps-modal" class="modal-overlay">
        <div class="modal-container">
            <div style="padding: 16px; border-bottom: 1px solid var(--border); text-align: center;">
                <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--primary);">GPS Check-in</h3>
                <p id="gps-modal-question" style="color: var(--text-secondary); font-size: 13px;">Check in at the specified location</p>
            </div>
            <div style="padding: 16px; text-align: center;">
                <div id="gps-distance" style="font-size: 48px; font-weight: 700; color: var(--primary); margin: 20px 0;">--</div>
                <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">Distance to target location</p>
                
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px;">
                    <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--danger);"></div>
                    <span>Your location</span>
                    <div style="width: 12px; height: 12px; border-radius: 50%; background: var(--success); margin-left: 20px;"></div>
                    <span>Target location</span>
                </div>
                
                <div id="gps-progress" style="background: var(--border); height: 8px; border-radius: 4px; margin: 20px 0; overflow: hidden;">
                    <div id="gps-progress-bar" style="height: 100%; background: var(--success); width: 0%; transition: width 0.3s;"></div>
                </div>
                
                <p id="gps-status" style="color: var(--text-secondary); font-size: 13px;">Move closer to check in</p>
            </div>
            <div style="padding: 16px; display: flex; gap: 8px;">
                <button id="check-in-btn" style="flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; background: var(--primary); color: var(--background);" disabled>
                    <i class="fas fa-map-marker-alt"></i> Check In
                </button>
                <button id="close-gps-modal" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); font-weight: 600; cursor: pointer; background: var(--card); color: var(--text);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Emergency Modal -->
    <div id="emergency-modal" class="modal-overlay">
        <div class="modal-container" style="background: var(--danger); color: white; text-align: center;">
            <div style="padding: 24px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                <h2 style="font-size: 24px; margin-bottom: 12px;">EMERGENCY ASSISTANCE</h2>
                <p style="margin-bottom: 20px; line-height: 1.5; opacity: 0.9; font-size: 14px;">
                    Your location has been sent to event organizers. Choose an emergency option:
                </p>
                <div class="emergency-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                    <a href="tel:0644106000" style="padding: 12px; border: 2px solid white; border-radius: 8px; background: transparent; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-ambulance"></i> Call Ambulance: 064 410 6000
                    </a>
                    <a href="tel:1411" style="padding: 12px; border: 2px solid white; border-radius: 8px; background: transparent; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-phone-alt"></i> Call Toll-Free: 1411
                    </a>
                    <button id="close-emergency-modal-btn" style="margin-top: 16px; padding: 12px; border: 2px solid white; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-weight: 600; cursor: pointer; font-size: 13px;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing app...');
        
        // Configuration
        const SUPABASE_URL = 'https://wnmncsbbtlpcwviicsbr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubW5jc2JidGxwY3d2aWljc2JyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMDU3MTMsImV4cCI6MjA4MTY4MTcxM30.pSOYbXWPLhKItpfDnRMfi3lyPVOvTccQudvN9YIucVs';
        const MAPBOX_TOKEN = 'pk.eyJ1IjoianVzYSIsImEiOiJjbWpjanh5amEwbDEwM2dzOXVhbjZ5dzcwIn0.stWdbPHCrf9sKrRJRmShlg';
        
        // App Constants
        const MISSION_TYPES = {
            PHOTO: 'photo',
            VIDEO: 'video',
            AUDIO: 'audio',
            TEXT: 'text',
            QR_SCAN: 'qr_scan',
            GPS_CHECKIN: 'gps_checkin'
        };
        
        const DEFAULT_LOCATION = {
            lat: -22.68,
            lng: 17.08,
            accuracy: 10000
        };
        
        // Initialize Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Global State
        let currentUser = null;
        let currentSession = null;
        let userLocation = null;
        let currentMission = null;
        let selectedPrize = null;
        let currentZone = null;
        let map = null;
        let zones = [];
        let zoneMarkers = [];
        let currentTab = 'map';
        let locationWatchId = null;
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;
        let eventEndTime = null;
        let cachedData = {
            zones: null,
            missions: {},
            prizes: null,
            lastUpdated: null
        };
        
        // ============================================
        // STATE MANAGEMENT (LocalStorage)
        // ============================================
        
        function saveAppState() {
            try {
                const state = {
                    currentTab: currentTab,
                    lastLocation: userLocation,
                    cachedData: cachedData,
                    timestamp: Date.now()
                };
                localStorage.setItem('hunt_app_state', JSON.stringify(state));
                console.log('App state saved');
            } catch (error) {
                console.error('Error saving app state:', error);
            }
        }
        
        function loadAppState() {
            try {
                const saved = localStorage.getItem('hunt_app_state');
                if (saved) {
                    const state = JSON.parse(saved);
                    
                    // Load cached data if not too old (1 hour)
                    if (state.cachedData && state.cachedData.lastUpdated && 
                        (Date.now() - state.cachedData.lastUpdated) < 3600000) {
                        cachedData = state.cachedData;
                        console.log('Loaded cached data');
                    }
                    
                    // Restore tab
                    if (state.currentTab) {
                        currentTab = state.currentTab;
                        console.log('Restored tab:', currentTab);
                    }
                    
                    // Restore location
                    if (state.lastLocation) {
                        userLocation = state.lastLocation;
                        console.log('Restored location from cache');
                    }
                }
            } catch (error) {
                console.error('Error loading app state:', error);
            }
        }
        
        function clearAppState() {
            try {
                localStorage.removeItem('hunt_app_state');
                console.log('App state cleared');
            } catch (error) {
                console.error('Error clearing app state:', error);
            }
        }
        
        // ============================================
        // FIXED EVENT LISTENERS SETUP
        // ============================================
        
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Auth links with preventDefault
            document.getElementById('show-signup-link').addEventListener('click', function(e) {
                e.preventDefault();
                showSignup();
            });
            
            document.getElementById('show-login-link').addEventListener('click', function(e) {
                e.preventDefault();
                showLogin();
            });
            
            // Auth buttons
            document.getElementById('login-button').addEventListener('click', login);
            document.getElementById('signup-button').addEventListener('click', signup);
            
            // Location permission button
            const requestLocationBtn = document.getElementById('request-location-btn');
            if (requestLocationBtn) {
                requestLocationBtn.addEventListener('click', requestLocationPermission);
            }
            
            // Bottom navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    showTab(tab);
                });
            });
            
            // Profile buttons
            document.getElementById('profile-button').addEventListener('click', function() {
                showTab('profile');
            });
            document.getElementById('edit-profile-btn').addEventListener('click', editProfile);
            document.getElementById('change-password-btn').addEventListener('click', changePassword);
            document.getElementById('view-activity-btn').addEventListener('click', viewActivity);
            document.getElementById('logout-btn').addEventListener('click', logout);
            
            // SOS button - FIXED: Proper event binding
            const sosButton = document.getElementById('sos-button');
            if (sosButton) {
                sosButton.addEventListener('click', showEmergencyModal);
                console.log('SOS button event listener added');
            } else {
                console.error('SOS button not found!');
            }
            
            // Shop filters
            document.querySelectorAll('#shop-categories .category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    filterShop(category);
                });
            });
            
            // Inventory filters
            document.querySelectorAll('#inventory-filters .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const status = this.getAttribute('data-status');
                    filterInventory(status);
                });
            });
            
            // Leaderboard filters
            document.querySelectorAll('#leaderboard-filters .leaderboard-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    loadLeaderboard(type);
                });
            });
            
            // Emergency modal buttons - FIXED: Added null checks
            const closeEmergencyBtn = document.getElementById('close-emergency-modal-btn');
            if (closeEmergencyBtn) {
                closeEmergencyBtn.addEventListener('click', closeEmergencyModal);
            }
            
            // QR modal
            const closeQrModalBtn = document.getElementById('close-qr-modal');
            if (closeQrModalBtn) {
                closeQrModalBtn.addEventListener('click', closeQRModal);
            }
            
            // Text modal
            const submitTextAnswerBtn = document.getElementById('submit-text-answer');
            if (submitTextAnswerBtn) {
                submitTextAnswerBtn.addEventListener('click', submitTextAnswer);
            }
            
            const closeTextModalBtn = document.getElementById('close-text-modal');
            if (closeTextModalBtn) {
                closeTextModalBtn.addEventListener('click', closeTextModal);
            }
            
            // GPS modal
            const checkInBtn = document.getElementById('check-in-btn');
            if (checkInBtn) {
                checkInBtn.addEventListener('click', submitGPSCheckin);
            }
            
            const closeGpsModalBtn = document.getElementById('close-gps-modal');
            if (closeGpsModalBtn) {
                closeGpsModalBtn.addEventListener('click', closeGPSModal);
            }
            
            // Handle browser back/forward buttons
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.tab) {
                    showTab(event.state.tab, false);
                }
            });
            
            // Save state before page unload
            window.addEventListener('beforeunload', function() {
                saveAppState();
            });
            
            // Handle orientation changes for map resize
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    if (map) {
                        map.resize();
                        console.log('Map resized after orientation change');
                    }
                }, 300);
            });
            
            console.log('Event listeners setup complete');
        }
        
        // ============================================
        // FIXED INITIALIZATION FLOW
        // ============================================
        
        function initApp() {
            console.log('Initializing app...');
            
            // Load saved state
            loadAppState();
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup auth state change handler
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state change:', event);
                
                if (event === 'SIGNED_IN' && session) {
                    console.log('User signed in:', session.user.email);
                    currentSession = session;
                    loadUserProfile(session.user.id).then(() => {
                        showApp();
                        setupRealTimeSubscriptions();
                    });
                } else if (event === 'SIGNED_OUT') {
                    console.log('User signed out');
                    cleanupApp();
                    showLogin();
                } else if (event === 'TOKEN_REFRESHED') {
                    console.log('Token refreshed');
                    if (session) {
                        currentSession = session;
                    }
                }
            });
            
            // Check existing session
            checkSession();
        }
        
        async function checkSession() {
            console.log('Checking for existing session...');
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                console.log('Session found:', session.user.email);
                currentSession = session;
                await loadUserProfile(session.user.id);
                showApp();
                setupRealTimeSubscriptions();
            } else {
                console.log('No session found');
            }
        }
        
        // ============================================
        // REAL-TIME SUBSCRIPTIONS
        // ============================================
        
        function setupRealTimeSubscriptions() {
            if (!currentUser) return;
            
            console.log('Setting up real-time subscriptions...');
            
            // Subscribe to SOS alerts
            const sosChannel = supabase
                .channel('sos-alerts')
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'sos_alerts', filter: `user_id=eq.${currentUser.id}` },
                    (payload) => {
                        console.log('SOS alert received:', payload.new);
                        handleSOSAlert(payload.new);
                    }
                )
                .subscribe();
            
            // Subscribe to user updates (coins, etc)
            const userChannel = supabase
                .channel('user-updates')
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'users', filter: `id=eq.${currentUser.id}` },
                    (payload) => {
                        console.log('User update received:', payload.new);
                        if (payload.new.coins !== currentUser.coins) {
                            currentUser.coins = payload.new.coins;
                            updateCoinDisplay();
                            showToast(`Coins updated: ${payload.new.coins}`, 'info');
                        }
                    }
                )
                .subscribe();
            
            // Subscribe to mission status updates
            const missionChannel = supabase
                .channel('mission-updates')
                .on('postgres_changes',
                    { event: 'UPDATE', schema: 'public', table: 'user_missions', filter: `user_id=eq.${currentUser.id}` },
                    (payload) => {
                        console.log('Mission update received:', payload.new);
                        if (currentZone && payload.new.status === 'completed') {
                            showToast('Mission completed!', 'success');
                            loadMissionsForZone(currentZone.id);
                        }
                    }
                )
                .subscribe();
            
            console.log('Real-time subscriptions active');
        }
        
        function handleSOSAlert(alert) {
            if (alert.status === 'acknowledged') {
                showToast('Emergency assistance is on the way!', 'success');
            } else {
                showEmergencyModal();
            }
        }
        
        // ============================================
        // FIXED MAP INITIALIZATION WITH ACCURATE LOCATION
        // ============================================
        
        function initializeMap() {
            try {
                if (!mapboxgl.supported()) {
                    console.warn('WebGL not supported, map disabled');
                    document.getElementById('map').innerHTML = '<div class="map-loading"><i class="fas fa-exclamation-triangle"></i><p>Map not supported in your browser</p></div>';
                    return;
                }
                
                if (!MAPBOX_TOKEN) {
                    console.error('Mapbox token not configured');
                    document.getElementById('map').innerHTML = '<div class="map-loading"><i class="fas fa-exclamation-triangle"></i><p>Map configuration error</p></div>';
                    return;
                }
                
                mapboxgl.accessToken = MAPBOX_TOKEN;
                
                // Use accurate user location if available, otherwise use default
                let center, zoom;
                if (userLocation && userLocation.lat !== DEFAULT_LOCATION.lat && userLocation.accuracy < 1000) {
                    center = [userLocation.lng, userLocation.lat];
                    zoom = 15;
                    console.log('Using accurate user location for map:', center);
                } else {
                    center = [DEFAULT_LOCATION.lng, DEFAULT_LOCATION.lat];
                    zoom = 13;
                    console.log('Using default location for map');
                }
                
                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/dark-v11',
                    center: center,
                    zoom: zoom,
                    attributionControl: false,
                    maxZoom: 18,
                    minZoom: 10,
                    pitchWithRotate: false,
                    dragRotate: false
                });
                
                // Add navigation controls
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                
                // Add scale control
                map.addControl(new mapboxgl.ScaleControl({
                    maxWidth: 100,
                    unit: 'metric'
                }));
                
                map.on('load', function() {
                    console.log('Map loaded successfully');
                    document.querySelector('.map-loading').style.display = 'none';
                    
                    // Add geolocate control for better location accuracy
                    map.addControl(new mapboxgl.GeolocateControl({
                        positionOptions: {
                            enableHighAccuracy: true,
                            timeout: 10000
                        },
                        trackUserLocation: true,
                        showUserLocation: true,
                        showAccuracyCircle: true
                    }), 'top-right');
                    
                    loadZonesForMap();
                    
                    // If we have accurate user location, update map
                    if (userLocation && userLocation.lat !== DEFAULT_LOCATION.lat) {
                        updateUserLocationOnMap();
                    }
                });
                
                map.on('error', function(e) {
                    console.error('Map error:', e.error);
                    showToast('Map loading failed', 'error');
                });
                
                // Handle map resize when tab becomes visible
                const mapContainer = document.getElementById('map-tab');
                if (mapContainer) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting && map) {
                                setTimeout(() => {
                                    map.resize();
                                    console.log('Map resized');
                                }, 100);
                            }
                        });
                    }, { threshold: 0.1 });
                    
                    observer.observe(mapContainer);
                }
                
            } catch (error) {
                console.error('Map initialization error:', error);
                document.getElementById('map').innerHTML = '<div class="map-loading"><i class="fas fa-exclamation-triangle"></i><p>Map loading failed</p></div>';
            }
        }
        
        async function loadZonesForMap() {
            if (!map) return;
            
            console.log('Loading zones for map...');
            
            // Check cache first
            if (cachedData.zones && cachedData.zones.length > 0) {
                zones = cachedData.zones;
                console.log(`Loaded ${zones.length} zones from cache`);
                renderZonesOnMap();
                return;
            }
            
            // Load from database
            const { data: zonesData, error } = await supabase
                .from('zones')
                .select('*')
                .eq('is_active', true);
            
            if (error) {
                console.error('Error loading zones:', error);
                showToast('Error loading zones', 'error');
                return;
            }
            
            zones = zonesData || [];
            console.log(`Loaded ${zones.length} zones from database`);
            
            // Cache the data
            cachedData.zones = zones;
            cachedData.lastUpdated = Date.now();
            saveAppState();
            
            renderZonesOnMap();
        }
        
        function renderZonesOnMap() {
            if (!map || !map.loaded()) return;
            
            // Clear existing markers
            zoneMarkers.forEach(marker => marker.remove());
            zoneMarkers = [];
            
            // Remove existing circle layers
            zones.forEach((zone) => {
                const layerId = `zone-circle-${zone.id}`;
                if (map.getLayer(layerId)) {
                    map.removeLayer(layerId);
                }
                const sourceId = `zone-${zone.id}`;
                if (map.getSource(sourceId)) {
                    map.removeSource(sourceId);
                }
            });
            
            // Add markers for each zone
            zones.forEach(zone => {
                if (!zone.coordinates || !zone.coordinates.lat || !zone.coordinates.lng) {
                    console.warn('Zone missing coordinates:', zone.name);
                    return;
                }
                
                // Create custom marker element
                const el = document.createElement('div');
                el.className = 'zone-marker';
                el.style.width = '28px';
                el.style.height = '28px';
                el.style.backgroundColor = 'rgba(74, 144, 226, 0.3)';
                el.style.borderRadius = '50%';
                el.style.border = '3px solid #4a90e2';
                el.style.cursor = 'pointer';
                el.style.display = 'flex';
                el.style.alignItems = 'center';
                el.style.justifyContent = 'center';
                el.style.color = '#4a90e2';
                el.style.fontWeight = 'bold';
                el.style.fontSize = '12px';
                el.title = zone.name;
                
                // Add zone number (1-based index)
                const zoneIndex = zones.indexOf(zone) + 1;
                el.textContent = zoneIndex;
                
                // Create marker
                const marker = new mapboxgl.Marker(el)
                    .setLngLat([zone.coordinates.lng, zone.coordinates.lat])
                    .setPopup(new mapboxgl.Popup({ offset: 25 })
                        .setHTML(`
                            <div style="padding: 8px; max-width: 200px;">
                                <h3 style="margin: 0 0 5px 0; color: #4a90e2;">${zone.name}</h3>
                                <p style="margin: 0; color: #666; font-size: 12px;">${zone.description || 'No description'}</p>
                                <p style="margin: 5px 0 0 0; color: #888; font-size: 11px;">
                                    Radius: ${zone.radius_meters || 100}m
                                </p>
                            </div>
                        `))
                    .addTo(map);
                
                zoneMarkers.push(marker);
                
                // Add zone circle if radius is defined
                if (zone.radius_meters) {
                    map.addSource(`zone-${zone.id}`, {
                        type: 'geojson',
                        data: {
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: [zone.coordinates.lng, zone.coordinates.lat]
                            }
                        }
                    });
                    
                    map.addLayer({
                        id: `zone-circle-${zone.id}`,
                        type: 'circle',
                        source: `zone-${zone.id}`,
                        paint: {
                            'circle-radius': {
                                stops: [
                                    [0, 0],
                                    [20, zone.radius_meters / 0.075]
                                ],
                                base: 2
                            },
                            'circle-color': '#4a90e2',
                            'circle-opacity': 0.1,
                            'circle-stroke-width': 2,
                            'circle-stroke-color': '#4a90e2',
                            'circle-stroke-opacity': 0.3
                        }
                    });
                }
            });
            
            console.log(`Rendered ${zoneMarkers.length} zones on map`);
        }
        
        function updateUserLocationOnMap() {
            if (!map || !map.loaded() || !userLocation) return;
            
            console.log('Updating map with user location:', userLocation);
            
            // Remove existing user marker
            const existingMarkers = document.getElementsByClassName('user-location-marker');
            while (existingMarkers.length > 0) {
                existingMarkers[0].remove();
            }
            
            // Create user marker with improved styling
            const el = document.createElement('div');
            el.className = 'user-location-marker';
            el.style.width = '20px';
            el.style.height = '20px';
            el.style.backgroundColor = 'var(--primary)';
            el.style.borderRadius = '50%';
            el.style.border = '3px solid var(--danger)';
            el.style.boxShadow = '0 0 10px rgba(255, 255, 255, 0.7)';
            el.style.zIndex = '1000';
            
            // Add pulse animation
            el.style.animation = 'pulse 2s infinite';
            
            new mapboxgl.Marker(el)
                .setLngLat([userLocation.lng, userLocation.lat])
                .addTo(map);
            
            // Add accuracy circle if available and accurate
            if (userLocation.accuracy && userLocation.accuracy < 1000) {
                const accuracySourceId = 'user-accuracy-circle';
                const accuracyLayerId = 'user-accuracy-circle-layer';
                
                // Remove existing accuracy circle
                if (map.getLayer(accuracyLayerId)) {
                    map.removeLayer(accuracyLayerId);
                }
                if (map.getSource(accuracySourceId)) {
                    map.removeSource(accuracySourceId);
                }
                
                // Add new accuracy circle
                map.addSource(accuracySourceId, {
                    type: 'geojson',
                    data: {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: [userLocation.lng, userLocation.lat]
                        }
                    }
                });
                
                map.addLayer({
                    id: accuracyLayerId,
                    type: 'circle',
                    source: accuracySourceId,
                    paint: {
                        'circle-radius': userLocation.accuracy,
                        'circle-color': 'rgba(255, 68, 68, 0.1)',
                        'circle-stroke-width': 1,
                        'circle-stroke-color': 'rgba(255, 68, 68, 0.3)',
                        'circle-stroke-opacity': 0.5
                    }
                });
            }
            
            // Center map on user if this is first location or map tab is active
            if (currentTab === 'map') {
                map.flyTo({
                    center: [userLocation.lng, userLocation.lat],
                    zoom: 15,
                    essential: true,
                    duration: 1000
                });
            }
        }
        
        // ============================================
        // IMPROVED LOCATION SERVICES WITH ACCURATE GPS
        // ============================================
        
        function requestLocationPermission() {
            console.log('Requesting location permission...');
            
            // Show permission request UI
            const permissionEl = document.getElementById('location-permission');
            if (permissionEl) {
                permissionEl.style.display = 'block';
                permissionEl.innerHTML = `
                    <p>Getting your location...</p>
                    <div class="spinner" style="margin: 12px auto; width: 24px; height: 24px;"></div>
                    <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        Please enable High Accuracy mode in your device settings for best results
                    </p>
                `;
            }
            
            if (!navigator.geolocation) {
                console.warn('Geolocation not supported');
                handleLocationError('Geolocation is not supported by your browser');
                return;
            }
            
            // Request high accuracy location with multiple attempts
            const options = {
                enableHighAccuracy: true,
                timeout: 15000, // Increased timeout
                maximumAge: 0
            };
            
            // Get current position first with high accuracy
            navigator.geolocation.getCurrentPosition(
                handleLocationSuccess,
                handleLocationErrorHighAccuracy,
                options
            );
            
            // Start watching position for updates with different strategy
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
            }
            
            locationWatchId = navigator.geolocation.watchPosition(
                handleLocationSuccess,
                handleLocationErrorWatch,
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 30000, 
                    timeout: 10000 
                }
            );
            
            console.log('Location watch started, ID:', locationWatchId);
        }
        
        function handleLocationSuccess(position) {
            console.log('Location obtained - Accuracy:', position.coords.accuracy, 'meters');
            
            // Store location with timestamp and accuracy
            const newLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                altitude: position.coords.altitude,
                heading: position.coords.heading,
                speed: position.coords.speed,
                timestamp: position.timestamp,
                source: 'gps'
            };
            
            // Only update if we have better accuracy or no location yet
            if (!userLocation || position.coords.accuracy < userLocation.accuracy || position.coords.accuracy < 50) {
                userLocation = newLocation;
                
                console.log('Updated user location with accuracy:', userLocation.accuracy, 'm');
                
                // Hide permission request UI
                const permissionEl = document.getElementById('location-permission');
                if (permissionEl) {
                    permissionEl.style.display = 'none';
                }
                
                // Update map with accurate location
                updateUserLocationOnMap();
                
                // Check zones with accurate location
                checkZones();
                
                // Save to state
                saveAppState();
                
                // Show accuracy feedback
                if (position.coords.accuracy < 20) {
                    showToast(`High accuracy location: ${Math.round(position.coords.accuracy)}m`, 'success');
                } else if (position.coords.accuracy < 100) {
                    showToast(`Good accuracy: ${Math.round(position.coords.accuracy)}m`, 'info');
                } else {
                    showToast(`Location accuracy: ${Math.round(position.coords.accuracy)}m. Move to open area for better accuracy.`, 'warning');
                }
                
                // Start geofencing if we have accurate location
                if (!window.geofenceInterval && position.coords.accuracy < 100) {
                    startGeofencing();
                }
            } else {
                console.log('Location update ignored - accuracy not improved:', position.coords.accuracy, 'vs', userLocation.accuracy);
            }
        }
        
        function handleLocationErrorHighAccuracy(error) {
            console.warn('High accuracy location failed:', error.code, error.message);
            
            // Try with lower accuracy as fallback
            const options = {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 60000
            };
            
            navigator.geolocation.getCurrentPosition(
                handleLocationSuccess,
                handleLocationError,
                options
            );
        }
        
        function handleLocationErrorWatch(error) {
            console.warn('Location watch error:', error.code, error.message);
            // Don't show error for watch, just log it
        }
        
        function handleLocationError(error) {
            console.warn('Final location error:', error.code, error.message);
            
            let errorMessage = 'Unable to get your location. ';
            let showFallback = false;
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Please enable location services in your browser settings.';
                    showFallback = true;
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable. Try moving to an open area.';
                    showFallback = true;
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out. Check your GPS signal.';
                    showFallback = true;
                    break;
                default:
                    errorMessage += 'An unknown error occurred.';
                    showFallback = true;
                    break;
            }
            
            // Update permission UI
            const permissionEl = document.getElementById('location-permission');
            if (permissionEl) {
                permissionEl.innerHTML = `
                    <p>${errorMessage}</p>
                    <button id="request-location-btn" style="margin-top: 12px; padding: 10px 20px; background: var(--primary); color: var(--background); border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        Try Again
                    </button>
                    <p style="margin-top: 12px; font-size: 12px; color: var(--text-secondary);">
                        ${showFallback ? 'Using approximate location for now.' : ''}
                    </p>
                `;
                
                // Reattach event listener
                const retryBtn = document.getElementById('request-location-btn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', requestLocationPermission);
                }
            }
            
            // Use default location only as absolute last resort
            if (showFallback && (!userLocation || userLocation.source === 'default')) {
                userLocation = {
                    ...DEFAULT_LOCATION,
                    source: 'default',
                    timestamp: Date.now()
                };
                updateUserLocationOnMap();
                showToast('Using approximate location. Enable GPS for accurate zone detection.', 'warning');
            }
            
            saveAppState();
        }
        
        function startGeofencing() {
            console.log('Starting geofencing with accurate location...');
            checkZones();
            
            // Check zones every 30 seconds
            window.geofenceInterval = setInterval(checkZones, 30000);
        }
        
        async function checkZones() {
            if (!userLocation || !zones.length || userLocation.source === 'default') {
                console.log('No accurate location or zones available for zone check');
                return;
            }
            
            console.log('Checking zones with location accuracy:', userLocation.accuracy, 'm');
            let currentZoneFound = null;
            let enteredNewZone = false;
            
            zones.forEach(zone => {
                if (!zone.coordinates || !zone.coordinates.lat || !zone.coordinates.lng) {
                    return;
                }
                
                const distance = getDistance(
                    userLocation.lat,
                    userLocation.lng,
                    zone.coordinates.lat,
                    zone.coordinates.lng
                );
                
                const zoneRadius = zone.radius_meters || 100;
                
                // Consider location accuracy in zone detection
                const effectiveDistance = distance - userLocation.accuracy;
                
                if (effectiveDistance <= zoneRadius) {
                    if (currentZone?.id !== zone.id) {
                        // Entered new zone
                        console.log(`Entered zone: ${zone.name} (distance: ${distance.toFixed(1)}m, accuracy: ${userLocation.accuracy.toFixed(1)}m)`);
                        currentZoneFound = zone;
                        enteredNewZone = true;
                    }
                }
            });
            
            // If entered new zone, unlock missions
            if (enteredNewZone && currentZoneFound) {
                unlockZoneMissions(currentZoneFound.id);
                showToast(`Entered ${currentZoneFound.name}! Missions unlocked.`, 'success');
            }
            
            // Update current zone display
            currentZone = currentZoneFound;
            updateCurrentZoneDisplay();
        }
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;
            
            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
            return R * c;
        }
        
        function updateCurrentZoneDisplay() {
            const zoneElement = document.getElementById('current-zone');
            if (!zoneElement) return;
            
            if (currentZone) {
                zoneElement.innerHTML = `
                    <h4 style="margin-bottom: 8px; color: var(--primary); font-size: 16px;">${currentZone.name}</h4>
                    <p style="color: var(--text-secondary); font-size: 13px;">
                        ${currentZone.description || 'Complete missions in this area to earn coins!'}
                    </p>
                    <p style="color: var(--accent); font-size: 12px; margin-top: 8px;">
                        <i class="fas fa-map-marker-alt"></i> You're in the zone!
                        ${userLocation ? `<span style="color: var(--text-secondary); font-size: 11px;"> (Accuracy: ${Math.round(userLocation.accuracy)}m)</span>` : ''}
                    </p>
                `;
            } else {
                zoneElement.innerHTML = `
                    <p style="color: var(--text-secondary); font-size: 13px;">
                        <i class="fas fa-map-marker-alt"></i> Not in any zone. Move to a marked area to unlock missions.
                        ${userLocation && userLocation.source !== 'default' ? `<span style="color: var(--text-secondary); font-size: 11px; display: block; margin-top: 4px;">Location accuracy: ${Math.round(userLocation.accuracy)}m</span>` : ''}
                    </p>
                `;
            }
        }
        
        // ============================================
        // FIXED SOS MODAL FUNCTIONALITY
        // ============================================
        
        function showEmergencyModal() {
            console.log('Showing emergency modal...');
            
            if (!currentUser) {
                showToast('Please log in to use SOS', 'error');
                return;
            }
            
            // Check if we have accurate location
            if (!userLocation || userLocation.source === 'default' || userLocation.accuracy > 1000) {
                showToast('Getting accurate location for emergency...', 'warning');
                
                // Try to get better location first
                const originalAccuracy = userLocation?.accuracy || 9999;
                
                // Show loading in modal
                const emergencyModal = document.getElementById('emergency-modal');
                if (emergencyModal) {
                    emergencyModal.style.display = 'flex';
                    emergencyModal.querySelector('.modal-container').innerHTML = `
                        <div style="padding: 24px; text-align: center;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <h2 style="font-size: 24px; margin-bottom: 12px;">GETTING YOUR LOCATION</h2>
                            <p style="margin-bottom: 20px; line-height: 1.5; opacity: 0.9; font-size: 14px;">
                                Please wait while we get your precise location for emergency services...
                            </p>
                        </div>
                    `;
                }
                
                // Request high accuracy location
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            // Update location with high accuracy
                            userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                timestamp: position.timestamp,
                                source: 'emergency-gps'
                            };
                            
                            console.log('Emergency location obtained:', userLocation.accuracy, 'm');
                            
                            // Close loading modal and show real emergency modal
                            closeEmergencyModal();
                            setTimeout(() => {
                                showEmergencyModalWithLocation();
                            }, 100);
                        },
                        function(error) {
                            console.error('Emergency location failed:', error);
                            closeEmergencyModal();
                            showToast('Cannot get accurate location. SOS may not be precise.', 'error');
                            // Show modal anyway with available location
                            setTimeout(() => {
                                showEmergencyModalWithLocation();
                            }, 100);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    closeEmergencyModal();
                    showEmergencyModalWithLocation();
                }
                
                return;
            }
            
            showEmergencyModalWithLocation();
        }
        
        function showEmergencyModalWithLocation() {
            console.log('Showing emergency modal with location');
            
            const emergencyModal = document.getElementById('emergency-modal');
            if (!emergencyModal) {
                console.error('Emergency modal not found!');
                return;
            }
            
            // Update modal content with location info
            const modalContainer = emergencyModal.querySelector('.modal-container');
            if (modalContainer) {
                const locationInfo = userLocation ? 
                    `Location accuracy: ${Math.round(userLocation.accuracy)}m` : 
                    'Location unavailable';
                
                modalContainer.innerHTML = `
                    <div style="padding: 24px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; animation: pulse 1s infinite;"></i>
                        <h2 style="font-size: 24px; margin-bottom: 12px;">EMERGENCY ASSISTANCE</h2>
                        <p style="margin-bottom: 10px; line-height: 1.5; opacity: 0.9; font-size: 14px;">
                            Your location has been sent to event organizers.
                        </p>
                        <p style="margin-bottom: 20px; line-height: 1.5; opacity: 0.9; font-size: 12px; color: rgba(255,255,255,0.7);">
                            ${locationInfo}
                        </p>
                        <p style="margin-bottom: 20px; line-height: 1.5; opacity: 0.9; font-size: 14px;">
                            Choose an emergency option:
                        </p>
                        <div class="emergency-buttons" style="display: flex; flex-direction: column; gap: 8px;">
                            <a href="tel:0644106000" style="padding: 12px; border: 2px solid white; border-radius: 8px; background: transparent; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-ambulance"></i> Call Ambulance: 064 410 6000
                            </a>
                            <a href="tel:1411" style="padding: 12px; border: 2px solid white; border-radius: 8px; background: transparent; color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-phone-alt"></i> Call Toll-Free: 1411
                            </a>
                            <button id="close-emergency-modal-btn" style="margin-top: 16px; padding: 12px; border: 2px solid white; border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-weight: 600; cursor: pointer; font-size: 13px;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                `;
                
                // Reattach close button event listener
                const closeBtn = modalContainer.querySelector('#close-emergency-modal-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', closeEmergencyModal);
                }
                
                // Make phone links clickable
                const phoneLinks = modalContainer.querySelectorAll('a[href^="tel:"]');
                phoneLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        console.log('Calling emergency number:', this.getAttribute('href'));
                        // Don't prevent default - let it make the call
                    });
                });
            }
            
            // Show modal with animation
            emergencyModal.style.display = 'flex';
            emergencyModal.style.animation = 'fadeIn 0.3s ease';
            
            // Send SOS alert
            sendSOSAlert();
        }
        
        function closeEmergencyModal() {
            const emergencyModal = document.getElementById('emergency-modal');
            if (emergencyModal) {
                emergencyModal.style.display = 'none';
                emergencyModal.style.animation = '';
            }
        }
        
        async function sendSOSAlert() {
            if (!currentUser || !userLocation) {
                console.error('Cannot send SOS: No user or location');
                return;
            }
            
            console.log('Sending SOS alert with location accuracy:', userLocation.accuracy);
            
            try {
                const { error } = await supabase
                    .from('sos_alerts')
                    .insert([{
                        user_id: currentUser.id,
                        user_name: currentUser.name,
                        user_phone: currentUser.phone,
                        latitude: userLocation.lat,
                        longitude: userLocation.lng,
                        accuracy: userLocation.accuracy,
                        status: 'active',
                        created_at: new Date().toISOString()
                    }]);
                
                if (error) {
                    console.error('SOS alert failed:', error);
                    showToast('Emergency alert failed to send', 'error');
                } else {
                    console.log('SOS alert sent successfully');
                    showToast('EMERGENCY ALERT SENT! Help is on the way.', 'success');
                }
            } catch (error) {
                console.error('SOS error:', error);
                showToast('Failed to send alert: ' + error.message, 'error');
            }
        }
        
        // ============================================
        // MISSION SYSTEM (Keep existing but ensure it uses accurate location)
        // ============================================
        
        async function unlockZoneMissions(zoneId) {
            console.log(`Unlocking missions for zone: ${zoneId}`);
            if (!currentUser) return;
            
            const { data: missions, error } = await supabase
                .from('missions')
                .select('*')
                .eq('zone_id', zoneId)
                .eq('status', 'active');
            
            if (error || !missions) {
                console.error('Error loading missions:', error);
                return;
            }
            
            console.log(`Found ${missions.length} missions in zone`);
            
            if (missions.length > 0) {
                for (const mission of missions) {
                    // Check if user mission already exists
                    const { data: existing } = await supabase
                        .from('user_missions')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('mission_id', mission.id)
                        .single();
                    
                    if (!existing) {
                        // Create unlocked user mission
                        console.log(`Creating user mission for: ${mission.title}`);
                        const { error: insertError } = await supabase
                            .from('user_missions')
                            .upsert([{
                                user_id: currentUser.id,
                                mission_id: mission.id,
                                status: 'unlocked',
                                created_at: new Date().toISOString(),
                                updated_at: new Date().toISOString()
                            }], {
                                onConflict: 'user_id,mission_id'
                            });
                        
                        if (insertError) {
                            console.error('Error creating user mission:', insertError);
                        }
                    } else if (existing.status === 'locked') {
                        // Update locked mission to unlocked
                        console.log(`Unlocking existing mission: ${mission.title}`);
                        await supabase
                            .from('user_missions')
                            .update({ 
                                status: 'unlocked',
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', existing.id);
                    }
                }
                
                // Reload missions for current zone
                if (document.getElementById('missions-tab').classList.contains('active')) {
                    loadMissionsForZone(zoneId);
                }
            }
        }
        
        async function loadZones() {
            console.log('Loading zones...');
            const zoneList = document.getElementById('zone-list');
            if (!zoneList) return;
            
            // Check cache first
            if (cachedData.zones && cachedData.zones.length > 0) {
                zones = cachedData.zones;
                renderZoneList();
                return;
            }
            
            // Show loading
            zoneList.innerHTML = '<div class="spinner" style="margin: 20px auto;"></div>';
            
            // Load from database
            const { data: zonesData, error } = await supabase
                .from('zones')
                .select('*')
                .eq('is_active', true)
                .order('name');
            
            if (error) {
                console.error('Error loading zones:', error);
                zoneList.innerHTML = '<p style="color: var(--text-secondary); padding: 20px; text-align: center; font-size: 13px;">Error loading zones.</p>';
                return;
            }
            
            if (!zonesData || zonesData.length === 0) {
                zoneList.innerHTML = '<p style="color: var(--text-secondary); padding: 20px; text-align: center; font-size: 13px;">No zones available yet.</p>';
                console.log('No zones found');
                return;
            }
            
            console.log(`Loaded ${zonesData.length} zones`);
            zones = zonesData;
            
            // Cache the data
            cachedData.zones = zones;
            cachedData.lastUpdated = Date.now();
            saveAppState();
            
            renderZoneList();
        }
        
        function renderZoneList() {
            const zoneList = document.getElementById('zone-list');
            if (!zoneList) return;
            
            zoneList.innerHTML = '';
            
            zones.forEach((zone, index) => {
                const zoneEl = document.createElement('div');
                zoneEl.className = 'zone-item';
                if (index === 0) zoneEl.classList.add('active');
                zoneEl.textContent = zone.name;
                zoneEl.addEventListener('click', () => {
                    document.querySelectorAll('.zone-item').forEach(item => item.classList.remove('active'));
                    zoneEl.classList.add('active');
                    loadMissionsForZone(zone.id);
                });
                zoneList.appendChild(zoneEl);
            });
            
            // Load missions for first zone
            if (zones.length > 0) {
                loadMissionsForZone(zones[0].id);
            }
        }
        
        async function loadMissionsForZone(zoneId) {
            console.log(`Loading missions for zone: ${zoneId}`);
            const missionsList = document.getElementById('missions-list');
            if (!missionsList) return;
            
            missionsList.innerHTML = '<div class="spinner" style="margin: 40px auto;"></div>';
            
            // Check cache first
            const cacheKey = `zone_${zoneId}`;
            if (cachedData.missions[cacheKey]) {
                console.log('Loading missions from cache');
                renderMissions(cachedData.missions[cacheKey], zoneId);
                return;
            }
            
            // Load from database
            const { data: missions, error } = await supabase
                .from('missions')
                .select(`
                    *,
                    user_missions (
                        status,
                        completed_at,
                        earned_coins
                    )
                `)
                .eq('zone_id', zoneId)
                .eq('status', 'active')
                .order('created_at');
            
            if (error) {
                console.error('Error loading missions:', error);
                missionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading missions.</p>
                    </div>
                `;
                return;
            }
            
            if (!missions || missions.length === 0) {
                missionsList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>No missions available in this zone yet.</p>
                    </div>
                `;
                console.log('No missions found in zone');
                return;
            }
            
            console.log(`Loaded ${missions.length} missions`);
            
            // Cache the data
            cachedData.missions[cacheKey] = missions;
            cachedData.lastUpdated = Date.now();
            saveAppState();
            
            renderMissions(missions, zoneId);
        }
        
        function renderMissions(missions, zoneId) {
            const missionsList = document.getElementById('missions-list');
            if (!missionsList) return;
            
            missionsList.innerHTML = '';
            
            missions.forEach(mission => {
                const userMission = mission.user_missions?.[0];
                const status = userMission?.status || 'locked';
                const isCompleted = status === 'completed';
                const isUnlocked = status === 'unlocked' || status === 'pending';
                
                // Get mission type icon
                let typeIcon = 'fas fa-question';
                let typeLabel = 'Unknown';
                switch(mission.mission_type) {
                    case 'photo': typeIcon = 'fas fa-camera'; typeLabel = 'Photo'; break;
                    case 'video': typeIcon = 'fas fa-video'; typeLabel = 'Video'; break;
                    case 'audio': typeIcon = 'fas fa-microphone'; typeLabel = 'Audio'; break;
                    case 'text': typeIcon = 'fas fa-font'; typeLabel = 'Text'; break;
                    case 'qr_scan': typeIcon = 'fas fa-qrcode'; typeLabel = 'QR Scan'; break;
                    case 'gps_checkin': typeIcon = 'fas fa-map-marker-alt'; typeLabel = 'GPS Check-in'; break;
                }
                
                const missionCard = document.createElement('div');
                missionCard.className = `mission-card ${status}`;
                if (status === 'locked') missionCard.classList.add('locked');
                if (isCompleted) missionCard.classList.add('completed');
                if (isUnlocked) missionCard.classList.add('unlocked');
                
                missionCard.innerHTML = `
                    <div class="mission-header">
                        <div class="mission-title">${mission.title}</div>
                        <div class="mission-points">${mission.points} coins</div>
                    </div>
                    <div class="mission-type-badge">
                        <i class="${typeIcon}"></i> ${typeLabel}
                    </div>
                    ${mission.question ? `<div class="mission-question">${mission.question}</div>` : ''}
                    ${mission.description ? `<div class="mission-description">${mission.description}</div>` : ''}
                    ${mission.media_required_count > 0 ? `
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">
                            <i class="fas fa-camera"></i> Requires ${mission.media_required_count} ${mission.media_required_count === 1 ? 'file' : 'files'}
                        </div>
                    ` : ''}
                    ${mission.video_max_duration ? `
                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">
                            <i class="fas fa-clock"></i> Max ${mission.video_max_duration} seconds
                        </div>
                    ` : ''}
                    <div class="mission-actions">
                        ${isCompleted ? `
                            <button class="action-btn completed" disabled>
                                <i class="fas fa-check"></i> Completed
                                ${userMission.earned_coins ? ` (+${userMission.earned_coins} coins)` : ''}
                            </button>
                        ` : isUnlocked ? `
                            <button class="action-btn record start-mission-btn" data-mission-id="${mission.id}" data-mission-type="${mission.mission_type}">
                                <i class="fas fa-play"></i> Start Mission
                            </button>
                        ` : `
                            <button class="action-btn" disabled>
                                <i class="fas fa-lock"></i> Locked
                            </button>
                        `}
                    </div>
                `;
                missionsList.appendChild(missionCard);
            });
            
            // Add event listeners to start mission buttons
            document.querySelectorAll('.start-mission-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const missionId = this.getAttribute('data-mission-id');
                    const missionType = this.getAttribute('data-mission-type');
                    startMission(missionId, missionType);
                });
            });
        }
        
        async function startMission(missionId, missionType) {
            console.log(`Starting mission: ${missionId}, type: ${missionType}`);
            
            // Load mission details
            const { data: mission, error } = await supabase
                .from('missions')
                .select('*')
                .eq('id', missionId)
                .single();
            
            if (error || !mission) {
                showToast('Mission not found', 'error');
                return;
            }
            
            currentMission = mission;
            
            // Handle different mission types
            switch(missionType) {
                case 'photo':
                    showPhotoMission(mission);
                    break;
                case 'video':
                    showVideoMission(mission);
                    break;
                case 'audio':
                    showAudioMission(mission);
                    break;
                case 'text':
                    showTextMission(mission);
                    break;
                case 'qr_scan':
                    showQRMission(mission);
                    break;
                case 'gps_checkin':
                    showGPSMission(mission);
                    break;
                default:
                    showToast('Unknown mission type', 'error');
            }
        }
        
        function showPhotoMission(mission) {
            document.getElementById('mission-modal-title').textContent = mission.title;
            document.getElementById('mission-modal-question').textContent = mission.question || 'Take a photo';
            
            const mediaControls = document.getElementById('media-controls');
            mediaControls.innerHTML = `
                <button id="capture-photo-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                    <i class="fas fa-camera"></i> Take Photo
                </button>
                <button id="close-media-modal-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            `;
            
            // Add event listeners
            document.getElementById('capture-photo-btn').addEventListener('click', capturePhoto);
            document.getElementById('close-media-modal-btn').addEventListener('click', closeMediaModal);
            
            // Initialize camera
            initCamera(true, false);
            
            // Show modal
            document.getElementById('media-modal').style.display = 'flex';
        }
        
        function showVideoMission(mission) {
            document.getElementById('mission-modal-title').textContent = mission.title;
            document.getElementById('mission-modal-question').textContent = mission.question || 'Record a video';
            
            const mediaControls = document.getElementById('media-controls');
            mediaControls.innerHTML = `
                <button id="record-video-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                    <i class="fas fa-video"></i> Start Recording (max ${mission.video_max_duration || 10}s)
                </button>
                <button id="close-media-modal-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            `;
            
            // Add event listeners
            document.getElementById('record-video-btn').addEventListener('click', toggleVideoRecording);
            document.getElementById('close-media-modal-btn').addEventListener('click', closeMediaModal);
            
            // Initialize camera
            initCamera(true, true);
            
            // Show modal
            document.getElementById('media-modal').style.display = 'flex';
        }
        
        function showAudioMission(mission) {
            document.getElementById('mission-modal-title').textContent = mission.title;
            document.getElementById('mission-modal-question').textContent = mission.question || 'Record audio';
            
            const mediaControls = document.getElementById('media-controls');
            mediaControls.innerHTML = `
                <button id="record-audio-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                    <i class="fas fa-microphone"></i> Start Recording (max ${mission.video_max_duration || 10}s)
                </button>
                <button id="close-media-modal-btn" style="grid-column: 1 / -1; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                    <i class="fas fa-times"></i> Cancel
                </button>
            `;
            
            // Add event listeners
            document.getElementById('record-audio-btn').addEventListener('click', toggleAudioRecording);
            document.getElementById('close-media-modal-btn').addEventListener('click', closeMediaModal);
            
            // Initialize audio
            initCamera(false, true);
            
            // Show modal
            document.getElementById('media-modal').style.display = 'flex';
        }
        
        function showTextMission(mission) {
            document.getElementById('text-modal-title').textContent = mission.title;
            document.getElementById('text-modal-question').textContent = mission.question || 'Enter your answer';
            
            // Clear previous input
            document.getElementById('text-answer-input').value = '';
            
            // Show modal
            document.getElementById('text-modal').style.display = 'flex';
        }
        
        function showQRMission(mission) {
            // Show placeholder for QR scanning
            showToast('QR scanning coming soon! Please use the admin panel to create QR codes.', 'info');
        }
        
        function showGPSMission(mission) {
            document.getElementById('gps-modal-question').textContent = mission.question || 'Check in at the location';
            
            // Parse target coordinates from mission options
            let targetLat, targetLng, targetRadius = 50;
            
            if (mission.options && mission.options.target) {
                targetLat = mission.options.target.lat;
                targetLng = mission.options.target.lng;
                targetRadius = mission.options.radius || 50;
            } else if (currentZone && currentZone.coordinates) {
                targetLat = currentZone.coordinates.lat;
                targetLng = currentZone.coordinates.lng;
            } else {
                showToast('GPS mission target not defined', 'error');
                return;
            }
            
            // Store mission target for distance calculation
            currentMission.targetLocation = { lat: targetLat, lng: targetLng, radius: targetRadius };
            
            // Start checking distance
            startGPSChecking();
            
            // Show modal
            document.getElementById('gps-modal').style.display = 'flex';
        }
        
        // ============================================
        // MEDIA CAPTURE FUNCTIONS
        // ============================================
        
        async function initCamera(video = true, audio = false) {
            try {
                // Stop any existing stream
                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                }
                
                // Reset UI
                document.getElementById('video-preview').style.display = video ? 'block' : 'none';
                document.getElementById('audio-visualizer').style.display = 'none';
                document.getElementById('image-preview').style.display = 'none';
                document.getElementById('recording-indicator').style.display = 'none';
                document.getElementById('media-timer').style.display = 'none';
                
                // Get media stream
                const constraints = {
                    video: video ? {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } : false,
                    audio: audio
                };
                
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                if (video) {
                    const videoElement = document.getElementById('video-preview');
                    videoElement.srcObject = mediaStream;
                    videoElement.play();
                }
                
                console.log('Camera initialized successfully');
                
            } catch (error) {
                console.error('Camera initialization error:', error);
                showToast('Camera access denied. Please allow camera access.', 'error');
                closeMediaModal();
            }
        }
        
        function capturePhoto() {
            if (!mediaStream) return;
            
            const video = document.getElementById('video-preview');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Compress image (quality: 0.8 = 80%)
            canvas.toBlob(async (blob) => {
                console.log('Photo captured, size:', blob.size, 'bytes');
                
                // Show preview
                const imagePreview = document.getElementById('image-preview');
                imagePreview.src = URL.createObjectURL(blob);
                imagePreview.style.display = 'block';
                document.getElementById('video-preview').style.display = 'none';
                
                // Ask for confirmation
                const mediaControls = document.getElementById('media-controls');
                mediaControls.innerHTML = `
                    <button id="submit-photo-btn" style="padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--primary); color: var(--background);">
                        <i class="fas fa-check"></i> Submit Photo
                    </button>
                    <button id="retake-photo-btn" style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                        <i class="fas fa-redo"></i> Retake
                    </button>
                `;
                
                document.getElementById('submit-photo-btn').addEventListener('click', () => submitMissionMedia(blob, 'image'));
                document.getElementById('retake-photo-btn').addEventListener('click', () => {
                    imagePreview.style.display = 'none';
                    document.getElementById('video-preview').style.display = 'block';
                    showPhotoMission(currentMission);
                });
                
            }, 'image/jpeg', 0.8);
        }
        
        function toggleVideoRecording() {
            const recordBtn = document.getElementById('record-video-btn');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Stop recording
                mediaRecorder.stop();
                recordBtn.innerHTML = '<i class="fas fa-video"></i> Start Recording';
                recordBtn.style.background = 'var(--card)';
                
                // Hide recording indicator
                document.getElementById('recording-indicator').style.display = 'none';
                document.getElementById('media-timer').style.display = 'none';
                clearInterval(recordingTimer);
            } else {
                // Start recording
                recordedChunks = [];
                const options = { mimeType: 'video/webm;codecs=vp9,opus' };
                
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm;codecs=vp8,opus';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm';
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/mp4';
                }
                
                try {
                    mediaRecorder = new MediaRecorder(mediaStream, options);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        console.log('Video recording stopped');
                        const blob = new Blob(recordedChunks, { type: options.mimeType });
                        
                        // Check duration
                        const videoElement = document.createElement('video');
                        videoElement.src = URL.createObjectURL(blob);
                        
                        videoElement.onloadedmetadata = () => {
                            const duration = videoElement.duration;
                            const maxDuration = currentMission.video_max_duration || 10;
                            
                            if (duration > maxDuration) {
                                showToast(`Video too long (${duration.toFixed(1)}s). Maximum is ${maxDuration}s.`, 'error');
                                toggleVideoRecording(); // Restart recording
                            } else {
                                // Show preview
                                const videoPreview = document.getElementById('video-preview');
                                videoPreview.src = URL.createObjectURL(blob);
                                videoPreview.controls = true;
                                videoPreview.style.display = 'block';
                                
                                // Ask for confirmation
                                const mediaControls = document.getElementById('media-controls');
                                mediaControls.innerHTML = `
                                    <button id="submit-video-btn" style="padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--primary); color: var(--background);">
                                        <i class="fas fa-check"></i> Submit Video (${duration.toFixed(1)}s)
                                    </button>
                                    <button id="retake-video-btn" style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                                        <i class="fas fa-redo"></i> Retake
                                    </button>
                                `;
                                
                                document.getElementById('submit-video-btn').addEventListener('click', () => submitMissionMedia(blob, 'video'));
                                document.getElementById('retake-video-btn').addEventListener('click', () => {
                                    videoPreview.style.display = 'none';
                                    document.getElementById('video-preview').style.display = 'block';
                                    showVideoMission(currentMission);
                                });
                            }
                        };
                    };
                    
                    mediaRecorder.start();
                    recordBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                    recordBtn.style.background = 'var(--danger)';
                    
                    // Show recording indicator
                    document.getElementById('recording-indicator').style.display = 'flex';
                    document.getElementById('media-timer').style.display = 'block';
                    
                    // Start timer
                    recordingSeconds = 0;
                    recordingTimer = setInterval(() => {
                        recordingSeconds++;
                        const minutes = Math.floor(recordingSeconds / 60);
                        const seconds = recordingSeconds % 60;
                        document.getElementById('media-timer').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Auto-stop at max duration
                        const maxDuration = currentMission.video_max_duration || 10;
                        if (recordingSeconds >= maxDuration) {
                            toggleVideoRecording();
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('MediaRecorder error:', error);
                    showToast('Video recording not supported', 'error');
                }
            }
        }
        
        function toggleAudioRecording() {
            const recordBtn = document.getElementById('record-audio-btn');
            
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                // Stop recording
                mediaRecorder.stop();
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i> Start Recording';
                recordBtn.style.background = 'var(--card)';
                
                // Hide recording indicator
                document.getElementById('recording-indicator').style.display = 'none';
                document.getElementById('media-timer').style.display = 'none';
                clearInterval(recordingTimer);
            } else {
                // Start recording
                recordedChunks = [];
                const options = { mimeType: 'audio/webm' };
                
                try {
                    mediaRecorder = new MediaRecorder(mediaStream, options);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            recordedChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = async () => {
                        console.log('Audio recording stopped');
                        const blob = new Blob(recordedChunks, { type: options.mimeType });
                        
                        // Check duration
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const arrayBuffer = await blob.arrayBuffer();
                        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                        const duration = audioBuffer.duration;
                        const maxDuration = currentMission.video_max_duration || 10;
                        
                        if (duration > maxDuration) {
                            showToast(`Audio too long (${duration.toFixed(1)}s). Maximum is ${maxDuration}s.`, 'error');
                            toggleAudioRecording();
                        } else {
                            // Ask for confirmation
                            const mediaControls = document.getElementById('media-controls');
                            mediaControls.innerHTML = `
                                <button id="submit-audio-btn" style="padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--primary); color: var(--background);">
                                    <i class="fas fa-check"></i> Submit Audio (${duration.toFixed(1)}s)
                                </button>
                                <button id="retake-audio-btn" style="padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 13px; background: var(--card); color: var(--text);">
                                    <i class="fas fa-redo"></i> Retake
                                </button>
                            `;
                            
                            document.getElementById('submit-audio-btn').addEventListener('click', () => submitMissionMedia(blob, 'audio'));
                            document.getElementById('retake-audio-btn').addEventListener('click', () => {
                                showAudioMission(currentMission);
                            });
                        }
                    };
                    
                    mediaRecorder.start();
                    recordBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                    recordBtn.style.background = 'var(--danger)';
                    
                    // Show recording indicator
                    document.getElementById('recording-indicator').style.display = 'flex';
                    document.getElementById('media-timer').style.display = 'block';
                    
                    // Start timer
                    recordingSeconds = 0;
                    recordingTimer = setInterval(() => {
                        recordingSeconds++;
                        const minutes = Math.floor(recordingSeconds / 60);
                        const seconds = recordingSeconds % 60;
                        document.getElementById('media-timer').textContent = 
                            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        
                        // Auto-stop at max duration
                        const maxDuration = currentMission.video_max_duration || 10;
                        if (recordingSeconds >= maxDuration) {
                            toggleAudioRecording();
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('MediaRecorder error:', error);
                    showToast('Audio recording not supported', 'error');
                }
            }
        }
        
        async function submitMissionMedia(blob, mediaType) {
            if (!currentMission || !currentUser) return;
            
            console.log(`Submitting ${mediaType} for mission: ${currentMission.id}`);
            
            try {
                // Upload file to Supabase Storage
                const fileName = `mission_${currentMission.id}_${Date.now()}.${mediaType === 'image' ? 'jpg' : mediaType === 'video' ? 'mp4' : 'webm'}`;
                const filePath = `${currentUser.id}/${fileName}`;
                
                const { error: uploadError } = await supabase.storage
                    .from('submissions')
                    .upload(filePath, blob);
                
                if (uploadError) {
                    throw new Error('File upload failed: ' + uploadError.message);
                }
                
                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('submissions')
                    .getPublicUrl(filePath);
                
                // Create submission record
                const { error: submissionError } = await supabase
                    .from('submissions')
                    .insert([{
                        user_id: currentUser.id,
                        mission_id: currentMission.id,
                        file_url: urlData.publicUrl,
                        file_type: mediaType,
                        review_status: 'pending',
                        created_at: new Date().toISOString()
                    }]);
                
                if (submissionError) {
                    throw new Error('Submission failed: ' + submissionError.message);
                }
                
                // Update user mission status to pending
                const { error: missionError } = await supabase
                    .from('user_missions')
                    .update({ 
                        status: 'pending',
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('mission_id', currentMission.id);
                
                showToast('Mission submitted for review!', 'success');
                closeMediaModal();
                
                // Reload missions
                if (currentZone) {
                    loadMissionsForZone(currentZone.id);
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                showToast(error.message, 'error');
            }
        }
        
        async function submitTextAnswer() {
            const answer = document.getElementById('text-answer-input').value.trim();
            if (!answer || !currentMission || !currentUser) return;
            
            console.log('Submitting text answer:', answer.substring(0, 50) + '...');
            
            try {
                // Create submission record for text
                const { error: submissionError } = await supabase
                    .from('submissions')
                    .insert([{
                        user_id: currentUser.id,
                        mission_id: currentMission.id,
                        text_answer: answer,
                        file_type: 'text',
                        review_status: 'pending',
                        created_at: new Date().toISOString()
                    }]);
                
                if (submissionError) {
                    throw new Error('Submission failed: ' + submissionError.message);
                }
                
                // Update user mission status to pending
                const { error: missionError } = await supabase
                    .from('user_missions')
                    .update({ 
                        status: 'pending',
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('mission_id', currentMission.id);
                
                showToast('Answer submitted for review!', 'success');
                closeTextModal();
                
                // Reload missions
                if (currentZone) {
                    loadMissionsForZone(currentZone.id);
                }
                
            } catch (error) {
                console.error('Text submission error:', error);
                showToast(error.message, 'error');
            }
        }
        
        function startGPSChecking() {
            if (!currentMission.targetLocation) return;
            
            const checkInterval = setInterval(() => {
                if (!userLocation || userLocation.source === 'default') {
                    document.getElementById('gps-status').textContent = 'Waiting for GPS signal...';
                    return;
                }
                
                const distance = getDistance(
                    userLocation.lat,
                    userLocation.lng,
                    currentMission.targetLocation.lat,
                    currentMission.targetLocation.lng
                );
                
                const targetRadius = currentMission.targetLocation.radius || 50;
                const progress = Math.max(0, 100 - (distance / targetRadius * 100));
                
                // Update UI
                document.getElementById('gps-distance').textContent = `${distance.toFixed(1)}m`;
                document.getElementById('gps-progress-bar').style.width = `${progress}%`;
                
                // Enable/disable check-in button
                const checkInBtn = document.getElementById('check-in-btn');
                if (distance <= targetRadius) {
                    checkInBtn.disabled = false;
                    checkInBtn.style.background = 'var(--success)';
                    document.getElementById('gps-status').textContent = 'You are in the target area!';
                    document.getElementById('gps-status').style.color = 'var(--success)';
                } else {
                    checkInBtn.disabled = true;
                    checkInBtn.style.background = 'var(--primary)';
                    document.getElementById('gps-status').textContent = `Move closer (within ${targetRadius}m) - Current accuracy: ${Math.round(userLocation.accuracy)}m`;
                    document.getElementById('gps-status').style.color = 'var(--text-secondary)';
                }
            }, 1000);
            
            // Store interval ID for cleanup
            currentMission.gpsInterval = checkInterval;
        }
        
        async function submitGPSCheckin() {
            if (!currentMission || !currentUser) return;
            
            console.log('Submitting GPS check-in');
            
            try {
                // Create submission record for GPS
                const { error: submissionError } = await supabase
                    .from('submissions')
                    .insert([{
                        user_id: currentUser.id,
                        mission_id: currentMission.id,
                        gps_location: userLocation,
                        file_type: 'gps',
                        review_status: 'pending',
                        created_at: new Date().toISOString()
                    }]);
                
                if (submissionError) {
                    throw new Error('GPS check-in failed: ' + submissionError.message);
                }
                
                // Update user mission status to pending
                const { error: missionError } = await supabase
                    .from('user_missions')
                    .update({ 
                        status: 'pending',
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', currentUser.id)
                    .eq('mission_id', currentMission.id);
                
                showToast('GPS check-in submitted for review!', 'success');
                closeGPSModal();
                
                // Reload missions
                if (currentZone) {
                    loadMissionsForZone(currentZone.id);
                }
                
            } catch (error) {
                console.error('GPS check-in error:', error);
                showToast(error.message, 'error');
            }
        }
        
        // ============================================
        // MODAL MANAGEMENT
        // ============================================
        
        function closeMediaModal() {
            // Stop media stream
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            // Stop recording if active
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            
            // Clear timer
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            // Hide modal
            document.getElementById('media-modal').style.display = 'none';
            currentMission = null;
        }
        
        function closeQRModal() {
            document.getElementById('qr-modal').style.display = 'none';
            currentMission = null;
        }
        
        function closeTextModal() {
            document.getElementById('text-modal').style.display = 'none';
            currentMission = null;
        }
        
        function closeGPSModal() {
            // Clear GPS checking interval
            if (currentMission && currentMission.gpsInterval) {
                clearInterval(currentMission.gpsInterval);
            }
            
            document.getElementById('gps-modal').style.display = 'none';
            currentMission = null;
        }
        
        // ============================================
        // AUTH FUNCTIONS
        // ============================================
        
        function showLogin() {
            console.log('Showing login form');
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('signup-form').style.display = 'none';
            clearMessages();
        }

        function showSignup() {
            console.log('Showing signup form');
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
            clearMessages();
        }

        function clearMessages() {
            document.getElementById('error-message').style.display = 'none';
            document.getElementById('success-message').style.display = 'none';
        }

        async function login() {
            console.log('Login attempt');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            const btn = document.getElementById('login-button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    showError(error.message);
                    return;
                }

                console.log('Login successful:', data.user.email);
                currentSession = data.session;
                await loadUserProfile(data.user.id);
                showApp();
                showToast('Signed in successfully', 'success');
            } catch (error) {
                showError('Login failed: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function signup() {
            console.log('Signup attempt');
            const name = document.getElementById('signup-name').value;
            const phone = document.getElementById('signup-phone').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const photoFile = document.getElementById('signup-photo').files[0];

            if (!name || !phone || !email || !password) {
                showError('Please fill in all required fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            const btn = document.getElementById('signup-button');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';

            try {
                // Sign up with Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name,
                            phone
                        }
                    }
                });

                if (authError) {
                    if (authError.message.includes('User already registered')) {
                        throw new Error('This email is already registered. Please sign in instead.');
                    }
                    throw new Error(authError.message);
                }

                // Upload profile photo if provided
                let avatarUrl = null;
                if (photoFile) {
                    console.log('Uploading profile photo...');
                    try {
                        const fileName = `${authData.user.id}/profile_${Date.now()}.jpg`;
                        const { error: uploadError } = await supabase.storage
                            .from('profiles')
                            .upload(fileName, photoFile);
                        
                        if (!uploadError) {
                            const { data: urlData } = supabase.storage
                                .from('profiles')
                                .getPublicUrl(fileName);
                            avatarUrl = urlData.publicUrl;
                            console.log('Photo uploaded:', avatarUrl);
                        }
                    } catch (uploadError) {
                        console.warn('Failed to upload profile photo:', uploadError);
                    }
                }

                // Create user profile in database
                const { error: profileError } = await supabase
                    .from('users')
                    .upsert([{
                        id: authData.user.id,
                        name,
                        email,
                        phone,
                        avatar_url: avatarUrl,
                        coins: 100,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    }], {
                        onConflict: 'id'
                    });

                if (profileError) {
                    console.warn('Profile upsert error:', profileError.message);
                }

                // Set default role as player
                try {
                    await supabase
                        .from('user_roles')
                        .upsert([{
                            user_id: authData.user.id,
                            role: 'player',
                            granted_at: new Date().toISOString()
                        }], {
                            onConflict: 'user_id'
                        });
                } catch (roleError) {
                    console.warn('Role assignment failed:', roleError);
                }

                showSuccess('Account created successfully! Please check your email for verification.');
                console.log('Signup successful, verification email sent');
                
                // Show login form after 3 seconds
                setTimeout(() => {
                    document.getElementById('login-email').value = email;
                    document.getElementById('login-password').value = '';
                    showLogin();
                    showToast('Please check your email to verify your account', 'info');
                }, 3000);

            } catch (error) {
                console.error('Signup error:', error);
                showError(error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function loadUserProfile(userId) {
            console.log('Loading user profile:', userId);
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();

            if (error) {
                console.error('Error loading user profile:', error);
                return;
            }

            if (data) {
                currentUser = data;
                console.log('User loaded:', data.name);
                
                // Update UI with profile picture
                updateProfilePicture(data.avatar_url);
                
                document.getElementById('user-coins').textContent = data.coins;
                document.getElementById('shop-coins').textContent = data.coins;
                document.getElementById('profile-coins').textContent = data.coins;
                document.getElementById('profile-name').textContent = data.name;
                document.getElementById('profile-email').textContent = data.email;
                
                // Start services with accurate location
                requestLocationPermission();
                loadZones();
                startEventTimer();
                loadShopItems();
                loadUserInventory();
                loadLeaderboard('global');
                updateProfileStats();
            }
        }

        function updateProfilePicture(avatarUrl) {
            const profileBtn = document.querySelector('.profile-btn');
            const profileAvatar = document.querySelector('.profile-avatar');
            
            if (avatarUrl) {
                // Create image element for profile button
                profileBtn.innerHTML = '';
                const img1 = document.createElement('img');
                img1.src = avatarUrl;
                img1.alt = 'Profile';
                img1.onerror = function() {
                    this.src = '';
                    profileBtn.innerHTML = '<i class="fas fa-user"></i>';
                };
                profileBtn.appendChild(img1);
                
                // Create image element for profile tab
                if (profileAvatar) {
                    profileAvatar.innerHTML = '';
                    const img2 = document.createElement('img');
                    img2.src = avatarUrl;
                    img2.alt = 'Profile';
                    img2.onerror = function() {
                        this.src = '';
                        profileAvatar.innerHTML = '<i class="fas fa-user"></i>';
                    };
                    profileAvatar.appendChild(img2);
                }
            } else {
                profileBtn.innerHTML = '<i class="fas fa-user"></i>';
                if (profileAvatar) {
                    profileAvatar.innerHTML = '<i class="fas fa-user"></i>';
                }
            }
        }

        function showApp() {
            console.log('Showing main app');
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            
            // Restore tab state
            showTab(currentTab, false);
            
            // Initialize map after DOM is visible
            if (!map) {
                setTimeout(initializeMap, 100);
            }
        }

        function showError(message) {
            console.error('Error:', message);
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => errorEl.style.display = 'none', 5000);
        }

        function showSuccess(message) {
            console.log('Success:', message);
            const successEl = document.getElementById('success-message');
            successEl.textContent = message;
            successEl.style.display = 'block';
            setTimeout(() => successEl.style.display = 'none', 5000);
        }

        function showToast(message, type = 'info') {
            console.log('Toast:', message);
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: start; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <div style="flex: 1; font-size: 13px;">${message}</div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 0 4px;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            const container = document.getElementById('toast-container');
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode === container) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        // ============================================
        // SHOP FUNCTIONS
        // ============================================
        
        async function loadShopItems() {
            console.log('Loading shop items...');
            const { data: prizes, error } = await supabase
                .from('prizes')
                .select('*')
                .eq('is_active', true)
                .order('price');
            
            const prizeGrid = document.getElementById('prize-grid');
            
            if (error) {
                console.error('Error loading prizes:', error);
                prizeGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading prizes.</p>
                    </div>
                `;
                return;
            }
            
            if (!prizes || prizes.length === 0) {
                prizeGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <i class="fas fa-gift"></i>
                        <p>No prizes available yet. Check back soon!</p>
                    </div>
                `;
                console.log('No prizes found');
                return;
            }
            
            console.log(`Loaded ${prizes.length} prizes`);
            prizeGrid.innerHTML = '';
            
            prizes.forEach(prize => {
                const isSoldOut = prize.remaining_quantity <= 0;
                const isLowStock = prize.remaining_quantity > 0 && prize.remaining_quantity <= 5;
                const canAfford = currentUser && currentUser.coins >= prize.price;
                
                const prizeCard = document.createElement('div');
                prizeCard.className = `prize-card ${isSoldOut ? 'sold-out' : ''}`;
                prizeCard.dataset.category = prize.category || 'physical';
                
                let inventoryClass = '';
                let inventoryText = '';
                
                if (isSoldOut) {
                    inventoryClass = 'sold-out';
                    inventoryText = 'Sold Out';
                } else if (isLowStock) {
                    inventoryClass = 'low-stock';
                    inventoryText = `Only ${prize.remaining_quantity} left!`;
                } else {
                    inventoryText = `${prize.remaining_quantity} available`;
                }
                
                prizeCard.innerHTML = `
                    <div class="prize-image" style="display:flex;align-items:center;justify-content:center;color:var(--text-secondary);">
                        <i class="fas fa-gift" style="font-size:48px;"></i>
                    </div>
                    <div class="prize-content" style="padding: 12px;">
                        <h4 class="prize-title" style="font-size: 14px; font-weight: 600; margin-bottom: 4px; line-height: 1.3; color: var(--primary);">${prize.name}</h4>
                        <p class="prize-description" style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px; line-height: 1.4;">${prize.description || 'No description available'}</p>
                        <div class="prize-price" style="display: flex; align-items: center; gap: 4px; font-weight: 600; color: var(--accent); margin-bottom: 4px;">
                            <i class="fas fa-coins"></i>
                            <span>${prize.price}</span> coins
                        </div>
                        <div class="inventory-info ${inventoryClass}" style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">${inventoryText}</div>
                        <button class="buy-btn" data-prize-id="${prize.id}" 
                                ${isSoldOut || !canAfford ? 'disabled' : ''} style="width: 100%; padding: 8px; background: var(--primary); border: none; border-radius: 6px; color: var(--background); font-weight: 600; cursor: pointer; transition: all 0.2s; font-size: 13px;">
                            ${isSoldOut ? 'Sold Out' : !canAfford ? `Need ${prize.price - currentUser.coins} more coins` : 'Buy Now'}
                        </button>
                    </div>
                `;
                prizeGrid.appendChild(prizeCard);
            });
            
            // Add event listeners to buy buttons
            document.querySelectorAll('.buy-btn').forEach(btn => {
                if (!btn.disabled) {
                    btn.addEventListener('click', function() {
                        const prizeId = this.getAttribute('data-prize-id');
                        showPurchaseModal(prizeId);
                    });
                }
            });
        }

        function filterShop(category) {
            console.log('Filtering shop by category:', category);
            document.querySelectorAll('#shop-categories .category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const prizeCards = document.querySelectorAll('.prize-card');
            prizeCards.forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        async function showPurchaseModal(prizeId) {
            console.log('Showing purchase modal for prize:', prizeId);
            
            // Load prize details
            const { data: prize, error } = await supabase
                .from('prizes')
                .select('*')
                .eq('id', prizeId)
                .single();
            
            if (error || !prize) {
                showToast('Prize not found', 'error');
                return;
            }
            
            // Check if user can afford
            if (!currentUser || currentUser.coins < prize.price) {
                showToast(`You need ${prize.price - currentUser.coins} more coins to buy this`, 'error');
                return;
            }
            
            // Check if prize is in stock
            if (prize.remaining_quantity <= 0) {
                showToast('This prize is sold out', 'error');
                return;
            }
            
            // Ask for confirmation
            if (confirm(`Buy ${prize.name} for ${prize.price} coins?`)) {
                try {
                    // Start transaction
                    const { error: purchaseError } = await supabase
                        .from('purchases')
                        .insert([{
                            user_id: currentUser.id,
                            prize_id: prize.id,
                            price_paid: prize.price,
                            status: 'completed',
                            created_at: new Date().toISOString()
                        }]);
                    
                    if (purchaseError) throw purchaseError;
                    
                    // Update prize quantity
                    const { error: prizeError } = await supabase
                        .from('prizes')
                        .update({ remaining_quantity: prize.remaining_quantity - 1 })
                        .eq('id', prize.id);
                    
                    if (prizeError) throw prizeError;
                    
                    // Update user coins
                    const newCoins = currentUser.coins - prize.price;
                    const { error: userError } = await supabase
                        .from('users')
                        .update({ coins: newCoins })
                        .eq('id', currentUser.id);
                    
                    if (userError) throw userError;
                    
                    // Update local state
                    currentUser.coins = newCoins;
                    updateCoinDisplay();
                    
                    // Add to inventory
                    const { error: inventoryError } = await supabase
                        .from('user_inventory')
                        .insert([{
                            user_id: currentUser.id,
                            prize_id: prize.id,
                            item_name: prize.name,
                            status: 'active',
                            acquired_at: new Date().toISOString()
                        }]);
                    
                    showToast(`Purchased ${prize.name}! Check your inventory.`, 'success');
                    
                    // Reload shop and inventory
                    loadShopItems();
                    loadUserInventory();
                    
                } catch (error) {
                    console.error('Purchase error:', error);
                    showToast('Purchase failed: ' + error.message, 'error');
                }
            }
        }
        
        // ============================================
        // INVENTORY FUNCTIONS
        // ============================================
        
        async function loadUserInventory() {
            if (!currentUser) return;
            
            console.log('Loading user inventory...');
            const { data: inventory, error } = await supabase
                .from('user_inventory')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('acquired_at', { ascending: false });
            
            const inventoryContainer = document.getElementById('inventory-items');
            
            if (error) {
                console.error('Error loading inventory:', error);
                inventoryContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading inventory.</p>
                    </div>
                `;
                return;
            }
            
            if (!inventory || inventory.length === 0) {
                inventoryContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-box-open"></i>
                        <p>No items in your inventory yet.</p>
                        <p style="font-size: 13px; margin-top: 8px;">Complete missions to earn coins and buy prizes!</p>
                    </div>
                `;
                console.log('No inventory items found');
                return;
            }
            
            console.log(`Loaded ${inventory.length} inventory items`);
            inventoryContainer.innerHTML = '';
            
            inventory.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'inventory-item';
                itemElement.dataset.status = item.status;
                
                itemElement.innerHTML = `
                    <div style="width:56px;height:56px;background:var(--background);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--text-secondary);">
                        <i class="fas fa-gift" style="font-size:24px;"></i>
                    </div>
                    <div class="item-info" style="flex: 1;">
                        <h5 style="font-size: 14px; margin-bottom: 4px; color: var(--primary);">${item.item_name}</h5>
                        <span class="item-status status-${item.status}" style="font-size: 11px; padding: 2px 8px; border-radius: 12px; display: inline-block; margin-bottom: 4px; font-weight: 600; background: ${item.status === 'active' ? 'rgba(68, 255, 68, 0.15)' : 'rgba(136, 136, 136, 0.15)'}; color: ${item.status === 'active' ? 'var(--success)' : 'var(--text-secondary)'};">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span>
                        <p class="item-date" style="font-size: 11px; color: var(--text-secondary);">Acquired: ${new Date(item.acquired_at).toLocaleDateString()}</p>
                        ${item.notes ? `<p style="font-size:11px;color:var(--text-secondary);margin-top:4px;">${item.notes}</p>` : ''}
                    </div>
                `;
                inventoryContainer.appendChild(itemElement);
            });
        }

        function filterInventory(status) {
            console.log('Filtering inventory by status:', status);
            document.querySelectorAll('#inventory-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const items = document.querySelectorAll('.inventory-item');
            items.forEach(item => {
                if (status === 'all' || item.dataset.status === status) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ============================================
        // LEADERBOARD FUNCTIONS
        // ============================================
        
        async function loadLeaderboard(type) {
            console.log('Loading leaderboard:', type);
            
            // Update active button
            document.querySelectorAll('#leaderboard-filters .leaderboard-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const myRankCard = document.getElementById('my-rank-card');
            const leaderboardList = document.getElementById('leaderboard-list');
            
            // Show loading
            myRankCard.innerHTML = '<div class="spinner"></div>';
            leaderboardList.innerHTML = '<div class="spinner"></div>';
            
            try {
                let leaderboardData = [];
                
                // Get top 50 users by coins
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, name, avatar_url, coins')
                    .order('coins', { ascending: false })
                    .limit(50);
                
                if (error) throw error;
                
                if (users) {
                    leaderboardData = users.map((user, index) => ({
                        rank: index + 1,
                        ...user,
                        score: user.coins
                    }));
                }
                
                console.log(`Loaded ${leaderboardData.length} leaderboard entries`);
                
                // Update my rank
                if (currentUser && leaderboardData.length > 0) {
                    const myRankIndex = leaderboardData.findIndex(u => u.id === currentUser.id);
                    const myRank = myRankIndex >= 0 ? leaderboardData[myRankIndex] : null;
                    
                    if (myRank) {
                        myRankCard.innerHTML = `
                            <div class="my-rank-card" style="background: var(--card); border-radius: 10px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border);">
                                <div style="width:48px;height:48px;border-radius:50%;background:var(--background);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="my-rank-info" style="flex: 1;">
                                    <h3 style="font-size: 18px; margin-bottom: 4px; color: var(--primary);">Rank #${myRank.rank}</h3>
                                    <p style="font-size: 13px; color: var(--text-secondary);">${myRank.name}</p>
                                    <p style="font-size: 13px; color: var(--text-secondary);"><i class="fas fa-coins" style="color:var(--accent);margin-right:5px;"></i> ${myRank.coins} coins</p>
                                </div>
                            </div>
                        `;
                    } else {
                        myRankCard.innerHTML = `
                            <div class="my-rank-card" style="text-align:center;width:100%;padding:20px;">
                                <p style="color:var(--text-secondary);">Complete missions to appear on the leaderboard!</p>
                            </div>
                        `;
                    }
                }
                
                // Update leaderboard list
                if (leaderboardData.length > 0) {
                    leaderboardList.innerHTML = '';
                    leaderboardData.forEach(user => {
                        const isMe = user.id === currentUser?.id;
                        const rankClass = user.rank <= 3 ? `rank-${user.rank}` : '';
                        
                        const item = document.createElement('div');
                        item.className = `leaderboard-item ${isMe ? 'my-rank' : ''}`;
                        item.innerHTML = `
                            <div style="background: var(--card); border-radius: 10px; padding: 12px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border); ${isMe ? 'background: rgba(255, 255, 255, 0.05); border-color: var(--primary);' : ''}">
                                <div class="rank-number ${rankClass}" style="font-size: 16px; font-weight: 600; width: 28px; text-align: center; color: ${user.rank === 1 ? '#ffd700' : user.rank === 2 ? '#c0c0c0' : user.rank === 3 ? '#cd7f32' : 'var(--text-secondary)'};">${user.rank}</div>
                                <div style="width:36px;height:36px;border-radius:50%;background:var(--background);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="leaderboard-info" style="flex: 1;">
                                    <h4 style="font-size: 14px; margin-bottom: 2px; color: var(--primary);">${user.name} ${isMe ? '(You)' : ''}</h4>
                                    <p style="font-size: 11px; color: var(--text-secondary);">${user.score || user.coins || 0} coins</p>
                                </div>
                            </div>
                        `;
                        leaderboardList.appendChild(item);
                    });
                } else {
                    leaderboardList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-trophy"></i>
                            <p>No leaderboard data available yet.</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
                myRankCard.innerHTML = '<div style="text-align:center;width:100%;padding:20px;"><p style="color:var(--text-secondary);">Error loading leaderboard</p></div>';
                leaderboardList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error loading leaderboard data.</p>
                    </div>
                `;
            }
        }

        // ============================================
        // PROFILE FUNCTIONS
        // ============================================
        
        async function updateProfileStats() {
            if (!currentUser) return;
            
            console.log('Updating profile stats...');
            
            try {
                // Get completed mission count
                const { count: missionCount, error: missionError } = await supabase
                    .from('user_missions')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', currentUser.id)
                    .eq('status', 'completed');
                
                if (!missionError) {
                    document.getElementById('profile-missions').textContent = missionCount || 0;
                }
                
                // Get rank
                const { data: users, error: rankError } = await supabase
                    .from('users')
                    .select('id, coins')
                    .order('coins', { ascending: false });
                
                if (!rankError && users) {
                    const myRank = users.findIndex(u => u.id === currentUser.id) + 1;
                    document.getElementById('profile-rank').textContent = myRank > 0 ? `#${myRank}` : '#0';
                }
            } catch (error) {
                console.error('Error updating profile stats:', error);
            }
        }

        function updateCoinDisplay() {
            if (!currentUser) return;
            document.getElementById('user-coins').textContent = currentUser.coins;
            document.getElementById('shop-coins').textContent = currentUser.coins;
            document.getElementById('profile-coins').textContent = currentUser.coins;
        }

        function startEventTimer() {
            console.log('Starting event timer');
            // Set event end time (24 hours from now)
            const eventEnd = new Date();
            eventEnd.setHours(eventEnd.getHours() + 24);
            eventEndTime = eventEnd;
            
            function updateTimer() {
                const now = new Date();
                const diff = eventEndTime - now;
                
                if (diff <= 0) {
                    document.getElementById('event-timer').textContent = 'EVENT ENDED';
                    return;
                }
                
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                
                document.getElementById('event-timer').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                setTimeout(updateTimer, 1000);
            }
            
            updateTimer();
        }

        // ============================================
        // UI FUNCTIONS
        // ============================================
        
        function showTab(tabName, pushState = true) {
            console.log('Showing tab:', tabName);
            
            // Update current tab
            currentTab = tabName;
            
            // Hide all tabs
            document.querySelectorAll('.tab-container').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Set active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.getAttribute('data-tab') === tabName) {
                    item.classList.add('active');
                }
            });
            
            // Push to history if requested
            if (pushState) {
                history.pushState({ tab: tabName }, '', `#${tabName}`);
            }
            
            // Load data if needed
            switch(tabName) {
                case 'shop':
                    loadShopItems();
                    break;
                case 'inventory':
                    loadUserInventory();
                    break;
                case 'leaderboard':
                    loadLeaderboard('global');
                    break;
                case 'missions':
                    loadZones();
                    break;
                case 'map':
                    if (map) {
                        setTimeout(() => map.resize(), 100);
                    }
                    break;
            }
            
            // Save state
            saveAppState();
        }

        function editProfile() {
            console.log('Edit profile clicked');
            showToast('Profile editing coming soon!', 'info');
        }

        function changePassword() {
            console.log('Change password clicked');
            showToast('Password change coming soon!', 'info');
        }

        function viewActivity() {
            console.log('View activity clicked');
            showToast('Activity history coming soon!', 'info');
        }

        function cleanupApp() {
            // Stop location watching
            if (locationWatchId && navigator.geolocation) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            
            // Stop geofencing interval
            if (window.geofenceInterval) {
                clearInterval(window.geofenceInterval);
                window.geofenceInterval = null;
            }
            
            // Stop media streams
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            // Clear state
            currentUser = null;
            currentSession = null;
            userLocation = null;
            currentMission = null;
            currentZone = null;
            zones = [];
        }

        async function logout() {
            console.log('Logging out...');
            
            cleanupApp();
            clearAppState();
            
            const { error } = await supabase.auth.signOut();
            if (!error) {
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('auth-screen').style.display = 'flex';
                showLogin();
                showToast('Logged out successfully', 'success');
            }
        }

        // ============================================
        // START THE APP
        // ============================================
        initApp();
        console.log('App initialization complete!');
    });
</script>
</body>
</html>
